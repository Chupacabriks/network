(self.webpackChunkvkweb=self.webpackChunkvkweb||[]).push([[84779],{654272:(e,t,i)=>{"use strict";var r,n;i.d(t,{Mode:()=>n,UIMode:()=>r}),function(e){e.DEFAULT="default",e.COLLAPSED="collapsed",e.FULLSCREEN="fullscreen"}(r||(r={})),function(e){e[e.READY=0]="READY",e[e.CALL=1]="CALL",e[e.INCOMING=2]="INCOMING",e[e.JOIN=3]="JOIN",e[e.ERROR=4]="ERROR",e[e.FEEDBACK=5]="FEEDBACK",e[e.START=6]="START",e[e.CALL_BY=7]="CALL_BY",e[e.CREATE_CALL=8]="CREATE_CALL",e[e.BLOCK=9]="BLOCK"}(n||(n={}))},800351:(e,t,i)=>{"use strict";var r,n;i.d(t,{ErrorHandleType:()=>r,ServerError:()=>n}),function(e){e[e.DECLINE=0]="DECLINE",e[e.PROCESS=1]="PROCESS",e[e.FATAL=2]="FATAL",e[e.EMPTY=3]="EMPTY"}(r||(r={})),function(e){e[e.UNKNOWN=1]="UNKNOWN",e[e.INVALID_REQUEST=8]="INVALID_REQUEST",e[e.FLOOD_CONTROL=9]="FLOOD_CONTROL",e[e.INTERNAL=10]="INTERNAL",e[e.MESSAGES_REQUIRE_AUTH=960]="MESSAGES_REQUIRE_AUTH",e[e.REQUIRE_AUTH=9005]="REQUIRE_AUTH",e[e.MESSAGES_PRIVACY=928]="MESSAGES_PRIVACY",e[e.MESSAGES_OLD_RECEIVER_APP=923]="MESSAGES_OLD_RECEIVER_APP",e[e.MESSAGES_BUSY=948]="MESSAGES_BUSY",e[e.MESSAGES_OUTDATED_CALL_LINK=961]="MESSAGES_OUTDATED_CALL_LINK",e[e.OUTDATED_CALL_LINK=9006]="OUTDATED_CALL_LINK",e[e.MESSAGES_CALL_JOIN_NOT_ALLOWED=963]="MESSAGES_CALL_JOIN_NOT_ALLOWED",e[e.CALL_JOIN_NOT_ALLOWED=15]="CALL_JOIN_NOT_ALLOWED",e[e.MESSAGES_CALL_NOT_FOUND=951]="MESSAGES_CALL_NOT_FOUND",e[e.CALL_NOT_FOUND=9e3]="CALL_NOT_FOUND",e[e.MESSAGES_CALL_INVALID_JOIN_LINK=954]="MESSAGES_CALL_INVALID_JOIN_LINK",e[e.CALL_INVALID_JOIN_LINK=9008]="CALL_INVALID_JOIN_LINK",e[e.CALL_PASSWORD_IS_MISSING=9015]="CALL_PASSWORD_IS_MISSING"}(n||(n={}))},505504:(e,t,i)=>{"use strict";var r,n,a;i.d(t,{ECallsBannerType:()=>r,EVideoOptionType:()=>n,NoiseCancellationTypes:()=>a}),function(e){e[e.WatchTogether=0]="WatchTogether",e[e.Reactions=1]="Reactions",e[e.SessionRooms=2]="SessionRooms",e[e.Vmoji=3]="Vmoji",e[e.ASR=4]="ASR"}(r||(r={})),function(e){e.IS_VIDEO_MIRRORED="calls_is_video_mirrored",e.LAST_SHOWN_BANNER="last_shown_banner",e.IS_SKIP_JOIN_CALL_PROMPT="skip_join_call_prompt",e.NOISE_CANCELLATION_MODE="noise_cancellation_mode",e.SIMPLE_PIP_ENABLED_BY_USER="simple_pip_enabled_by_user",e.VIDEO_SUSPEND_MODE="video_suspend_mode",e.VIDEO_SUSPEND_BANNER_TIMES="video_suspend_banner_times",e.IS_SKIP_JOIN_CALL_PROMPT_REFRESHED="is_skip_join_call_prompt_refreshed"}(n||(n={})),function(e){e.NEURAL="NEURAL",e.SIMPLE="SIMPLE",e.NONE="NONE",e.CLIENT="CLIENT"}(a||(a={}))},434262:(e,t,i)=>{"use strict";var r,n;i.d(t,{FeatureNotification:()=>r,NotificationType:()=>n}),function(e){e.AsrEnded="AsrEnded",e.AsrEndedForOwner="AsrEndedForOwner",e.AsrStarted="AsrStarted",e.RecordEnded="RecordEnded",e.VideoSuspendApplied="VideoSuspendApplied",e.VideoSuspendSuggest="VideoSuspendSuggest"}(r||(r={})),function(e){e.SPEAKING_ON_MUTE="SPEAKING_ON_MUTE",e.RAISED_HAND="RAISED_HAND",e.LOWERED_HAND="LOWERED_HAND",e.SCREEN_SHARING_STARTED="SCREEN_SHARING_STARTED",e.SCREEN_SHARING_STOPPED="SCREEN_SHARING_STOPPED",e.BAD_NETWORK_CONNECTION="BAD_NETWORK_CONNECTION",e.NETWORK_PROBLEMS="NETWORK_PROBLEMS",e.BAD_NETWORK_CONNECTION_DISABLE_CAMERA="BAD_NETWORK_CONNECTION_DISABLE_CAMERA",e.ADMIN_ROLE_GRANTED="ADMIN_ROLE_GRANTED",e.ADMIN_ROLE_REMOVED="ADMIN_ROLE_REMOVED",e.USER_GRANTED_WITH_ADMIN_ROLE="USER_GRANTED_WITH_ADMIN_ROLE",e.PINNED_BY_ADMIN="PINNED_BY_ADMIN",e.USER_PINNED_BY_ADMIN="USER_PINNED_BY_ADMIN",e.PUSH_TO_TALK="PUSH_TO_TALK",e.CONNECTING="CONNECTING",e.LINK_COPIED_TO_CLIPBOARD="LINK_COPIED_TO_CLIPBOARD",e.ENTER_TO_ROOM="ENTER_TO_ROOM",e.EXIT_FROM_ROOM="EXIT_FROM_ROOM",e.ROOM_HELP_REQUESTED="ROOM_HELP_REQUESTED",e.ROOMS_OPENED="ROOMS_OPENED",e.ROOMS_CLOSED="ROOMS_CLOSED",e.ROOMS_CLOSED_BY_ADMIN="ROOMS_CLOSED_BY_ADMIN",e.ROOMS_ADMIN_MESSAGE_SENT="ROOMS_ADMIN_MESSAGE_SENT",e.ADMIN_MUTE="ADMIN_MUTE",e.ADMIN_MUTE_AUDIO="ADMIN_MUTE_AUDIO",e.ADMIN_MUTE_AUDIO_COMMON="ADMIN_MUTE_AUDIO_COMMON",e.ADMIN_MUTE_VIDEO="ADMIN_MUTE_VIDEO",e.ADMIN_MUTE_VIDEO_COMMON="ADMIN_MUTE_VIDEO_COMMON",e.ADMIN_MUTE_VIDEO_AND_SCREENSHARING="ADMIN_MUTE_VIDEO_AND_SCREENSHARING",e.ADMIN_MUTE_SCREENSHARING="ADMIN_MUTE_SCREENSHARING",e.ADMIN_MUTE_SCREENSHARING_COMMON="ADMIN_MUTE_SCREENSHARING_COMMON",e.ADMIN_MUTE_PERMANENT="ADMIN_MUTE_PERMANENT",e.ADMIN_MUTE_PERMANENT_AUDIO="ADMIN_MUTE_PERMANENT_AUDIO",e.ADMIN_MUTE_PERMANENT_VIDEO="ADMIN_MUTE_PERMANENT_VIDEO",e.ADMIN_MUTE_PERMANENT_VIDEO_AND_SCREENSHARING="ADMIN_MUTE_PERMANENT_VIDEO_AND_SCREENSHARING",e.ADMIN_MUTE_PERMANENT_SCREENSHARING="ADMIN_MUTE_PERMANENT_SCREENSHARING",e.ADMIN_MUTE_PERMANENT_WATCH_TOGETHER="ADMIN_MUTE_PERMANENT_WATCH_TOGETHER",e.ADMIN_UNMUTE_PERMANENT="ADMIN_UNMUTE_PERMANENT",e.ADMIN_UNMUTE_PERMANENT_AUDIO="ADMIN_UNMUTE_PERMANENT_AUDIO",e.ADMIN_UNMUTE_PERMANENT_VIDEO="ADMIN_UNMUTE_PERMANENT_VIDEO",e.ADMIN_UNMUTE_PERMANENT_VIDEO_AND_SCREENSHARING="ADMIN_UNMUTE_PERMANENT_VIDEO_AND_SCREENSHARING",e.ADMIN_UNMUTE_PERMANENT_SCREENSHARING="ADMIN_UNMUTE_PERMANENT_SCREENSHARING",e.ADMIN_UNMUTE_PERMANENT_WATCH_TOGETHER="ADMIN_UNMUTE_PERMANENT_WATCH_TOGETHER",e.MOVIE_ALREADY_STARTED="MOVIE_ALREADY_STARTED",e.PARTICIPANT_JOINED_THE_CALL="PARTICIPANT_JOINED_THE_CALL",e.PARTICIPANT_LEFT_THE_CALL="PARTICIPANT_LEFT_THE_CALL",e.SHARE_MOVIE_STARTED="SHARE_MOVIE_STARTED",e.SHARE_MOVIE_STOPPED="SHARE_MOVIE_STOPPED",e.PARTICIPANT_CALL_RECORD_STARTED="PARTICIPANT_CALL_RECORD_STARTED",e.PARTICIPANT_CALL_RECORD_STOPPED="PARTICIPANT_CALL_RECORD_STOPPED",e.PARTICIPANT_CALL_STREAM_STARTED="PARTICIPANT_CALL_STREAM_STARTED",e.PARTICIPANT_CALL_STREAM_STOPPED="PARTICIPANT_CALL_STREAM_STOPPED",e.PARTICIPANT_TURNED_ON_CAMERA="PARTICIPANT_TURNED_ON_CAMERA",e.PARTICIPANT_TURNED_OFF_CAMERA="PARTICIPANT_TURNED_OFF_CAMERA"}(n||(n={}))},328783:(e,t,i)=>{"use strict";i.d(t,{clearMediaSharingPinnedParticipant:()=>a,setAdminPinnedParticipant:()=>s,setMediaSharingPinnedParticipant:()=>n,setOrator:()=>c,setPinnedParticipant:()=>o});var r=i(619447);function n(e,t,i){return{type:r.E_ACTION.SET_MEDIA_SHARING_PINNED_PARTICIPANT,mediaSharingPinnedParticipant:e,mediaSharingNeedDisableOratorModeAfterStop:t,mediaSharingOldPinnedParticipant:i}}function a(){return n(null,!1,null)}function s(e){return{type:r.E_ACTION.SET_ADMIN_PINNED_PARTICIPANT,data:e}}function o(e){return{type:r.E_ACTION.SET_PINNED_PARTICIPANT,pinnedParticipant:e}}function c(e){return{type:r.E_ACTION.SET_ORATOR,orator:e}}},619447:(e,t,i)=>{"use strict";i.d(t,{CALLS_DESKTOP_APP_NOTIFICATION:()=>h,CALL_MAX_H:()=>ce,CALL_MIN_H:()=>le,CLIENT_ERROR_UNKNOWN:()=>O,COUNT_OF_CHAT_MEMBERS_TO_LOAD:()=>Re,COUNT_OF_FRIENDS_TO_LOAD:()=>Ie,COUNT_OF_GROUP_MEMBERS_TO_LOAD:()=>J,CallByNameProfileType:()=>fe,CallErrorType:()=>f,CallType:()=>T,DEFAULT_TIMER_MINS:()=>Ae,DESKTOP_CALLS_DOWNLOAD_PAGE:()=>u,DESKTOP_CALLS_HOST:()=>d,DESKTOP_CALLS_SCHEME:()=>l,EMPTY_PEER_ID:()=>P,EMPTY_USER_ID:()=>A,EVideoEffectType:()=>Y,E_ACTION:()=>E,FatalError:()=>S,GRID_SCROLL_NUMBER_OF_VISIBLE:()=>ie,HANGUP_DELAY:()=>D,HANGUP_TYPE_BUSY:()=>N,HANGUP_TYPE_CALLEE_IS_OFFLINE:()=>w,HANGUP_TYPE_CALLER_IS_BLOCKED:()=>M,HANGUP_TYPE_CANCELED:()=>k,HANGUP_TYPE_EXTERNAL_API_ERROR:()=>L,HANGUP_TYPE_FAILED:()=>U,HANGUP_TYPE_HUNGUP:()=>x,HANGUP_TYPE_MISSED:()=>V,HANGUP_TYPE_NOT_FOUND:()=>K,HANGUP_TYPE_NOT_FRIENDS:()=>B,HANGUP_TYPE_OLD_VERSION:()=>F,HANGUP_TYPE_REJECTED:()=>j,HANGUP_TYPE_REMOVED:()=>G,HANGUP_TYPE_SERVICE_DISABLED:()=>H,HANGUP_TYPE_UNKNOWN_ERROR:()=>W,HANGUP_TYPE_UNSUPPORTED:()=>$,ID_CALLS_PARTICIPANTS_BOX:()=>ae,INBOX_MESSAGE_MAX_LENGTH:()=>De,INCOMING_CALL:()=>q,KeyboardCodes:()=>me,LOCALSTORAGE_IS_CALLS_APP_DOWNLOADED:()=>o,LOCALSTORAGE_IS_MESSENGER_APP_DOWNLOADED:()=>c,LS_KEYS:()=>Q,LS_SFERUM_KEYS:()=>X,MAX_PARTICIPANTS_IN_GRID_LINE:()=>re,MAX_PARTICIPANTS_IN_GRID_LINE_WITH_IN_CALL_CHAT:()=>ne,MIN_NAME_LENGTH:()=>Se,MediaError:()=>g,NAME_REGEX:()=>ge,REACTION_FADE_OUT_DELAY:()=>se,ROOMS_ASSIGN_RANDOMLY:()=>he,ROOMS_COUNT:()=>ue,ROOMS_MAX_COUNT:()=>pe,ROOMS_MAX_PARTICIPANTS_COUNT:()=>_e,ROOMS_NAME_MAX_LENGTH:()=>de,ROOM_MAIN_ID:()=>te,ROOM_UNDEFINED_ID:()=>ee,SDK_ERROR_AUTH:()=>b,SHORT_LINK_REGEX:()=>Oe,SdkErrorType:()=>y,SdkParticipantState:()=>C,SearchResultType:()=>v,Sounds:()=>z,TIMER_INPUT_TYPE:()=>Pe,TIMESPENT_EVENT_COUNTER:()=>Te,TOOLTIP_DELAY:()=>oe,VIDEO_RESOLUTION_STORAGE_KEY:()=>n,VIRTUAL_BACKGROUND_BLUR_ID:()=>Z,VMOJI_CAPTURE_STORAGE_KEY:()=>a,VMOJI_INVALID_URL_PATTERN:()=>ye,VOLUME_LEVEL_DETECTION:()=>R,VideoHeight:()=>p,VideoWidth:()=>_,VmojiErrorReason:()=>Ce,dateFormatter:()=>ve,defaultNotificationLifeSpan:()=>I,skippedErrorCodes:()=>Ee});var r=i(330262);const n="calls_video_resolution",a="calls_vmoji_capture",s="vk.com",o="vkcalls:calls_app_downloaded",c="vkcalls:messenger_app_downloaded",l="vkcalls://",d=s,u=`${`https://${s}`}/video-calls`,h="calls_desktop_app_notification";var p,_,m,f,g,S,v,E,T,C,y;!function(e){e[e.SD=360]="SD",e[e.HD=720]="HD",e[e.FHD=1080]="FHD"}(p||(p={})),function(e){e[e.SD=640]="SD",e[e.HD=1280]="HD",e[e.FHD=1920]="FHD"}(_||(_={})),function(e){e[e.DENY=0]="DENY",e[e.ONCE=1]="ONCE",e[e.ALLOW=1/0]="ALLOW"}(m||(m={})),function(e){e.ALREADY_HAS_INCOMING_CALL="already_has_incoming_call",e.ALREADY_IN_CALL="already_in_call",e.CANT_REACH_API="cant_reach_api"}(f||(f={})),function(e){e.MIC_CAMERA_PERMISSION="mic_camera",e.CAMERA_PERMISSION="camera",e.MIC_PERMISSION="mic",e.CAMERA_ACCESS="cameralock",e.MIC_ACCESS="miclock",e.MIC_NOT_FOUND="nomic",e.SCREEN_PERMISSION="screenpermission",e.SCREEN_ACCESS="screenlock"}(g||(g={})),function(e){e.AUTH="auth"}(S||(S={})),function(e){e[e.HEADER=0]="HEADER",e[e.CALL_ALL_IN_CHAT=1]="CALL_ALL_IN_CHAT",e[e.MEMBERS_MORE=2]="MEMBERS_MORE",e[e.FRIENDS_MORE=3]="FRIENDS_MORE",e[e.GROUP_MEMBERS_MORE=4]="GROUP_MEMBERS_MORE"}(v||(v={})),function(e){e.LOAD_PEERS="load_peer",e.CHANGE_MODE="change_mode",e.CALL_STATE="call_state",e.REMOVE_USER="remove_user",e.TIME_START="time_start",e.LOCAL_TIME_START="local_time_start",e.HANGUP="hangup",e.GROUP_CALL_SETUP="group_call_setup",e.TOGGLE_MODAL="toggle_modal",e.TOGGLE_CHILD_MODAL="toggle_child_modal",e.CHANGE_UI_MODE="change_ui_mode",e.SET_ORATOR="set_orator",e.TOGGLE_ORATOR_MODE="toggle_orator_mode",e.TOGGLE_PARTICIPANTS_ASIDE="toggle_participants_aside",e.SET_PINNED_PARTICIPANT="set_pinned_participant",e.SET_ADMIN_PINNED_PARTICIPANT="set_admin_pinned_participant",e.SET_MEDIA_SHARING_PINNED_PARTICIPANT="set_media_sharing_pinned_participant",e.CALL_NOTIFICATION="call_notification",e.JOIN="join",e.CALL_BY_NAME="call_by_name",e.ERROR="error",e.CHANGE_PARTICIPANT_ROLES="change_participant_roles",e.SET_MEDIA_SHARER="set_media_sharer",e.OFF_MEDIA_SHARERS="off_media_sharers",e.UPDATE_PARTICIPANTS_BATCH="update_participants_batch",e.REMOVE_DEVICE_FROM_CACHE="remove_device_from_cache",e.SET_UNREAD_COUNT="set_unread_count",e.SHOW_CAUTION_BOX="show_caution_box",e.SHOW_LOADER="show_loader",e.SET_TOOLTIP="set_tooltip",e.SET_ENTRYPOINT="set_entrypoint",e.MANUAL_ADD_PARTICIPANTS="manual_add_participants",e.SET_TRANSLATION="set_translation",e.UPDATE_ANON_SECRET="update_anon_token",e.SET_NOISE_CANCELLATION="set_noise_cancellation",e.CHANGE_LOCAL_VIDEO_RESOLUTION="change_local_video_resolution",e.SET_CONVERSATION_OPTIONS="set_conversation_options",e.SET_PRIVACY_SETTINGS="set_privacy_settings",e.SET_GROUP="set_group",e.SET_WAITING_HALL="set_waiting_hall",e.SET_GRID_SCROLL_POSITION="set_grid_scroll_position",e.SET_ORATOR_SCROLL_POSITION="set_orator_scroll_position",e.SET_SHOW_DESKTOP_NOTIFICATION="set_show_desktop_notification",e.SET_SHOW_WARNING_DESKTOP_NOTIFICATION="set_show_warning_desktop_notification",e.SET_START_OPTIONS="set_start_params",e.VB_SET_USER_PHOTOS="vb_set_user_photos",e.VB_ADD_USER_PHOTO="vb_add_user_photo",e.VB_REMOVE_USER_PHOTO="vb_remove_user_photo",e.VB_SET_VIDEO_OPTIONS="vb_set_video_options",e.SET_CALL_PERMISSIONS="set_call_permissions",e.SET_PARTICIPANTS_CHUNK="set_participants_chunk",e.SET_PARTICIPANT_HAND_STATE="set_participant_hand_state",e.SET_PARTICIPANT_DRAT_STATE="set_participant_drat_state",e.CLEAN_LAST_CALL_DATA="clean_last_call_data",e.SET_LAST_CALL_DATA="set_last_call_data",e.SET_LOCAL_DEVICE="set_local_device",e.SET_REACTIONS="set_reactions",e.UPDATE_REACTIONS_HISTORY="update_reactions_history",e.SET_GLOBAL_MOVIE_SHARE_PERMISSION="set_global_movie_share_permission",e.SET_CALLS_QUEUE_RESPONSE="set_calls_queue_response",e.SET_ASR="set_asr",e.SET_WATCH_TOGETHER="set_watch_together",e.SUBTITLES_SET_ENABLED="subtitles_set_enabled",e.SUBTITLES_SET_LINES="subtitles_set_lines",e.SUBTITLES_SET_HISTORY="subtitles_set_history",e.SET_FEATURE_NOTIFICATION="set_feature_notification",e.SET_GLOBAL_CALL_FEATURES="set_global_call_features",e.SET_RESTRICTED_CONVERSATION="set_restricted_conversation",e.TOGGLE_SIMPLE_PIP="toggle_simple_pip",e.TOGGLE_SIMPLE_PIP_ENABLED_BY_USER="toggle_simple_pip_enabled_by_user",e.SET_TARGET_ELEMENT_FOR_PIP="set_target_element_for_pip",e.SET_VIDEO_SUSPEND_MODE="set_video_suspend_mode",e.CHANGE_PARTICIPANT_ID="change_participant_id",e.SET_IS_VOICE_ROOM="set_is_voice_room",e.SET_CHAT_MESSAGE="set_chat_message",e.REMOVE_CHAT_MESSAGE="remove_chat_message",e.REMOVE_CHAT_MESSAGES="remove_chat_messages",e.SET_HAS_IN_CALL_CHAT="set_has_chat",e.SET_WAS_NETWORK_INDICATOR_SHOWN="set_was_network_indicator_shown",e.SET_JOIN_LINK="set_join_link",e.TOGGLE_IN_CALL_CHAT="toggle_in_call_chat",e.SET_SHOW_CHAT_HISTORY="show_chat_history",e.SET_EFFECT_VOICE_CHANGE="set_effect_voice_change"}(E||(E={})),function(e){e.AUDIO="audio",e.VIDEO="video"}(T||(T={})),function(e){e.OFF="0",e.ON="1"}(C||(C={})),function(e){e.NETWORK="network_error",e.API="api_error"}(y||(y={}));const I=5e3,R=.25,A=0,P="0",D=2,O=-2,b=401,N=r.HangupType.BUSY,w=r.HangupType.CALLEE_IS_OFFLINE,M=r.HangupType.CALLER_IS_BLOCKED,k=r.HangupType.CANCELED,L=r.HangupType.EXTERNAL_API_ERROR,U=r.HangupType.FAILED,x=r.HangupType.HUNGUP,V=r.HangupType.MISSED,B=r.HangupType.NOT_FRIENDS,F=r.HangupType.OLD_VERSION,j=r.HangupType.REJECTED,G=r.HangupType.REMOVED,H=r.HangupType.SERVICE_DISABLED,W=r.HangupType.UNKNOWN_ERROR,$=r.HangupType.UNSUPPORTED,K=r.HangupType.NOT_FOUND;var z;!function(e){e.INCOMING="incoming",e.OUTGOING="outgoing",e.CONNECTING="connecting",e.CONNECTED="connected",e.END="end"}(z||(z={}));const q="incoming_call",J=500;var Y;!function(e){e.BACKGROUND="calls_background",e.BLUR="calls_blur",e.NONE="calls_none",e.ADD="calls_add",e.OVERLAY="calls_overlay"}(Y||(Y={}));const Q={VIRTUAL_BACKGROUND_EFFECT:"calls_virtual_background_effect",VIRTUAL_BACKGROUND_EFFECT_SELECTED_TS:"calls_virtual_background_effect_selected_ts",VIDEO_OPTIONS:"calls_video_options",CUSTOM_EXTERNAL_DOMAIN:"calls_custom_external_domain",CHANGED_NAME:"calls_changed_name"},X={VIRTUAL_BACKGROUND_EFFECT:"sferum_virtual_background_effect",VIRTUAL_BACKGROUND_EFFECT_SELECTED_TS:"sferum_virtual_background_effect_selected_ts",VIDEO_OPTIONS:"sferum_video_options"},Z=-16,ee=-1,te=null,ie=30,re=5,ne=3,ae="CallsParticipantsBox-1669373178177",se=1e4,oe=300,ce=693,le=500,de=50,ue=2,he=!0,pe=50,_e=256;var me,fe;!function(e){e.KeyM="KeyM",e.Escape="Escape",e.Tab="Tab",e.Enter="Enter",e.Space="Space",e.ArrowUp="ArrowUp",e.ArrowDown="ArrowDown",e.ArrowLeft="ArrowLeft",e.ArrowRight="ArrowRight"}(me||(me={})),function(e){e[e.PROFILE=0]="PROFILE",e[e.GROUP=1]="GROUP",e[e.ANONYM=2]="ANONYM"}(fe||(fe={}));const ge=/^[A-Za-zА-Яа-яЁё0-9_ \-іїєґІЇЄҐїЇ]{2,25}$/,Se=2,ve=new Intl.DateTimeFormat("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit"}),Ee=[8,951,1007,917,927,9e3,9004];var Te,Ce;!function(e){e[e.SUCCESSFUL_CALL_OF_AUTHENTICATED_VK_MEMBERS=22]="SUCCESSFUL_CALL_OF_AUTHENTICATED_VK_MEMBERS",e[e.SUCCESSFUL_GROUP_CALL_OF_AUTHENTICATED_VK_MEMBERS=23]="SUCCESSFUL_GROUP_CALL_OF_AUTHENTICATED_VK_MEMBERS",e[e.SUCCESSFUL_CALL_OF_AUTHENTICATED_VK_MEMBERS_WITH_CAMERA=24]="SUCCESSFUL_CALL_OF_AUTHENTICATED_VK_MEMBERS_WITH_CAMERA"}(Te||(Te={})),function(e){e.NO_ANIMATED_AVATAR="no_animated_avatar",e.NO_URL="no_url",e.INVALID_URL="invalid_url",e.INVALID_SVG="invalid_svg",e.FAILED_TO_DECRYPT="failed_to_decrypt",e.BAD_HTTP_STATUS="bad_http_status"}(Ce||(Ce={}));const ye="AAAAAAAAAAA.bin",Ie=100,Re=100,Ae="";var Pe;!function(e){e.MANUAL="manual",e.PRESET="preset"}(Pe||(Pe={}));const De=4096,Oe=/(sferum\.ru\/\?call=.+)|(\/call\/(?!join))/i},629271:(e,t,i)=>{"use strict";i.d(t,{getMiniAppIdSharedFromDevice:()=>s,isSharedMiniAppShownFromDevice:()=>a});var r=i(330262),n=i(493083);const a=e=>e.streamMode===r.MediaType.SHARED_URL,s=e=>{if(e.streamMode!==r.MediaType.SHARED_URL)return;const{sharedMiniAppId:t,sharedUrl:i}=e;return t??(i?(0,n.getSharedMiniAppIdFromUrl)(i):void 0)}},543688:(e,t,i)=>{"use strict";i.d(t,{getSharingMiniAppParticipantId:()=>n});var r=i(629271);function n(e){if((0,r.isSharedMiniAppShownFromDevice)(e.localDevice))return e.externalId;const t=Object.values(e.devices).find((e=>(0,r.isSharedMiniAppShownFromDevice)(e)));return t?.externalId}},493083:(e,t,i)=>{"use strict";i.d(t,{buildCustomMiniAppStatEvent:()=>h,createErrorHandler:()=>d,getSharedMiniAppIdFromUrl:()=>a,getSharedMiniHashFromUrl:()=>s,getSuccessfulResponse:()=>l,logFeatureDebug:()=>o,logFeatureError:()=>c});var r=i(365815),n=i(330262);const a=e=>{try{const{pathname:t}=new URL(e),i=/\d+/.exec(t)?.[0];return i?Number(i):void 0}catch(e){return}},s=e=>{try{const{hash:t}=new URL(e);return t}catch(e){return}},o=(e,...t)=>{(0,n.debugMessage)(n.DebugMessageType.WARN,`miniApps: ${e}`,...t)},c=e=>{(0,n.debugMessage)(n.DebugMessageType.ERROR,e)};function l(e){return{type:`${e}Result`,data:{result:!0}}}const d=e=>(t,i)=>(c(t),i??(i="string"==typeof t?t:"Unexpected internal error"),{type:`${e}Failed`,data:{error_type:"client_error",error_data:{error_code:r.ERROR_CODES.UNKNOWN,error_reason:i}}}),u="none";function h({app:e,bridgeParams:t,hash:i,miniAppsStatPlatform:r,userId:n}){const a=t.type||"type_action";return{type:a,[a]:{type:"type_mini_app_custom_event_item"},client_time:t.timestamp??Date.now(),event:t.event,json:t.json??"",mini_app_id:e.id,screen:t.screen??u,timezone:t.timezone??"",url:`${e.url}${i??""}`,user_id:n,vk_platform:t.vk_platform??r}}},933934:(e,t,i)=>{"use strict";i.d(t,{isMiniAppSource:()=>n});var r=i(862032);const n=e=>e===r.CallStatSource.MINI_APP},96450:(e,t,i)=>{"use strict";i.d(t,{getCallsCount:()=>g,getDefaultConversation:()=>m,getMediaModifiers:()=>v,increaseCallsCount:()=>S,isAuthedByGroupId:()=>f,isGroupCallByPeer:()=>u,isGroupCallByPeerAndMe:()=>h,isGroupCallByVkId:()=>d,isRequireAuthToJoin:()=>p,isWaitingHallEnabled:()=>_});var r=i(900667),n=i(619447),a=i(505504),s=i(330262),o=i(8520),c=(i(955349),i(193053)),l=i(342985);const d=e=>e===n.EMPTY_USER_ID||null===e||(0,r.isChatPeer)(e),u=e=>d((0,l.peerIdToVkId)(e)),h=(e,t)=>t&&(0,c.isParticipantContact)(t)||u(e);function p(e){return e.conversationOptions.includes(s.ConversationOption.REQUIRE_AUTH_TO_JOIN)}function _(e){return e.conversationOptions.includes(s.ConversationOption.WAITING_HALL)}function m(e){return{peerId:"",canAddMembers:!0,tab:e("calls_new_call_title")}}function f(e){return!!e.groupId}function g(){return Number(o.localStorage.getItem(n.CALLS_DESKTOP_APP_NOTIFICATION)??0)}function S(){const e=Number(o.localStorage.getItem(n.CALLS_DESKTOP_APP_NOTIFICATION)??0)+1;o.localStorage.setItem(n.CALLS_DESKTOP_APP_NOTIFICATION,String(e))}const v=({noiseReductionMode:e,enableNoiseReductionMode:t})=>{const i={1:{denoise:!0,denoiseAnn:!0},2:{denoise:!0,denoiseAnn:!1},3:{denoise:!1,denoiseAnn:!1}},r=t&&Boolean(i[e])?i[e]:i[1];return{noiseCancellationModesByType:{[a.NoiseCancellationTypes.NEURAL]:r,[a.NoiseCancellationTypes.SIMPLE]:i[2],[a.NoiseCancellationTypes.NONE]:i[3],[a.NoiseCancellationTypes.CLIENT]:i[3]}}}},981949:(e,t,i)=>{"use strict";i.d(t,{currentBrowser:()=>n});var r=i(330262);const n={isChrome:"Chrome"===r.browser.browserName(),isSafari:"Safari"===r.browser.browserName(),isFirefox:"Firefox"===r.browser.browserName(),isYandex:"Yandex"===r.browser.browserName(),isOpera:"Opera"===r.browser.browserName(),isSferum:"Sferum"===r.browser.browserName(),isEdge:"Edge"===r.browser.browserName(),isIE:"IE"===r.browser.browserName(),get isUnknown(){const{isUnknown:e,...t}=this;return Object.values(t).every((e=>!1===e))}}},955349:(e,t,i)=>{"use strict";i.d(t,{anyMatchInArray:()=>ne,binarySearch:()=>te,calculateCallDuration:()=>y,calculateTimeLeft:()=>R,capitalize:()=>X,compose:()=>x,conditionalPausedPromise:()=>H,convertCallerFromLongpoll:()=>S,convertChatFromLongpoll:()=>v,convertClientData:()=>m,convertServerData:()=>g,createImmediate:()=>de,createPayload:()=>L,createTimeout:()=>le,deepClone:()=>oe,exponentialRetry:()=>V,fetchUserShortName:()=>_,getCallable:()=>ee,getDetailedTextForApiErrorByCode:()=>P,getErrorCode:()=>M,getJoinCallLabel:()=>j,getMessageForTextLimit:()=>k,getParticipantsListLabel:()=>F,getServerCustomError:()=>N,getTextForApiErrorByCode:()=>A,getTextForClientError:()=>b,getTextForServerError:()=>O,getVkIdFromLongpoll:()=>E,hasIn:()=>W,isAnyoneWithVideo:()=>C,isArraysEqual:()=>ae,isBoolean:()=>ie,isEmpty:()=>$,isGroupCallEvent:()=>T,isInReconnect:()=>U,last:()=>se,minmax:()=>re,noop:()=>Q,normalizePreviewData:()=>G,normalizeProfiles:()=>f,objectFilter:()=>K,objectForEach:()=>J,objectMap:()=>z,objectReduce:()=>q,objectSome:()=>Y,shorten:()=>Z,shuffle:()=>ce,tokenValidateRetryWrapper:()=>B,vou:()=>ue});var r=i(900667),n=i(96450),a=i(619447),s=i(800351),o=i(525697),c=i(8520),l=i(342985),d=i(330262),u=i(193053),h=i(468073);function p(e){let t=e.shortName,i=e.firstName,r=e.lastName;return t&&i||([i,r]=e.name.split(" "),t=_(i,r,e.name)),{...e,peerId:(0,l.vkIdToPeerId)(e.id),tab:e.name,shortName:t,firstName:i}}function _(e,t,i){if(e){const i=t?t.length>2?t.substring(0,1)+".":t:"";return i?`${e} ${i}`:e}return i??""}function m([e,t]){const i=e&&function({callInProgress:e=!1,...t}){return!t.call_in_progress&&e&&(t.call_in_progress=e),t}(e);return[i&&("peerId"in i?i:p(i)),t?t.map(p):[]]}function f(e){return e.map(l.normalizeUser)}function g({items:e,profiles:t=[]}){const[i]=e,n=function(e){if(e.chat_settings){let t={peerId:(0,l.vkIdToPeerId)(e.peer.id),tab:e.chat_settings.title,name:e.chat_settings.title,canAddMembers:e.chat_settings.acl.can_invite,adminIds:e.chat_settings.admin_ids,ownerId:e.chat_settings.owner_id||-1};return e.chat_settings.photo&&(t.photo=e.chat_settings.photo.photo_200||e.chat_settings.photo.photo_100),t}return{canAddMembers:!0,peerId:(0,l.vkIdToPeerId)(e.peer.id)}}(i),a=f(t);return[{...n,tab:n.name},(0,r.isUserPeer)((0,l.peerIdToVkId)(n.peerId)??0)?[{...a&&a.filter((({peerId:e})=>e===n.peerId))[0],...n}]:a,i]}function S(e){const t=e.caller_info,i=t.first_name+" "+t.last_name;return{id:t.user_id,peerId:(0,l.vkIdToPeerId)(t.user_id),name:i,tab:i,photo:t.photo_400,firstName:t.first_name,lastName:t.last_name,shortName:_(t.first_name,t.last_name,i),is_nft:!!t.is_nft}}function v(e){return{peerId:(0,l.vkIdToPeerId)(h.Ranges.convertChatIdToChatPeerId(e.chat_id)),tab:e.title,name:e.title,photo:e.photo_400}}function E(e){const t=e.caller_info,i=e.chat_info;return i?h.Ranges.convertChatIdToChatPeerId(i.chat_id):t.user_id}function T(e){return!!e.payload.chat_info}function C(e){return!!(0,u.isParticipantWithVideo)(e.localDevice)||Y(e.devices,(e=>!(!e.wasConnected||!(0,u.isParticipantWithVideo)(e))))}function y(e){const t=Date.now(),i=Math.max(0,Math.floor((t-e)/1e3));return 0===i?"00:00":i<=599?"0"+(0,c.formatDuration)(i):(0,c.formatDuration)(i)}function I(e){const t=Math.floor(e/3600),i=Math.floor(e%3600/60),r=e%60,n=(0,c.leadingZero)(t),a=(0,c.leadingZero)(i),s=(0,c.leadingZero)(r);return t>0?`${n}:${a}:${s}`:`${a}:${s}`}function R(e){const t=Math.max(0,Math.floor((e-Date.now())/1e3));return 0===t?{timeString:"00:00",shouldSetWarning:!0,timeFinished:!0}:{timeString:I(t),shouldSetWarning:t<60,timeFinished:t<=0}}function A(e,t,i,r){switch(+e){case s.ServerError.CALL_JOIN_NOT_ALLOWED:case s.ServerError.MESSAGES_CALL_JOIN_NOT_ALLOWED:return i("calls_join_error_require_access");case s.ServerError.MESSAGES_OUTDATED_CALL_LINK:case s.ServerError.OUTDATED_CALL_LINK:return i("calls_join_error_outdated_link");case s.ServerError.CALL_NOT_FOUND:case s.ServerError.MESSAGES_CALL_NOT_FOUND:return i("calls_join_error_text");case s.ServerError.CALL_INVALID_JOIN_LINK:case s.ServerError.MESSAGES_CALL_INVALID_JOIN_LINK:return i("calls_invalid_join_link");case s.ServerError.MESSAGES_PRIVACY:return i("edu_callee_is_unavailable_by_its_schedule"===r?"calls_privacy_error_due_schedule":"calls_privacy_error");case s.ServerError.MESSAGES_BUSY:return i(t?"calls_chat_busy_error":"calls_busy_error");case s.ServerError.FLOOD_CONTROL:return i("calls_flood_error");case s.ServerError.MESSAGES_REQUIRE_AUTH:case s.ServerError.REQUIRE_AUTH:return i("calls_join_error_require_auth");case s.ServerError.UNKNOWN:case s.ServerError.INTERNAL:case s.ServerError.INVALID_REQUEST:case s.ServerError.MESSAGES_OLD_RECEIVER_APP:default:return i("calls_start_error")}}function P(e,t,i){switch(+e){case s.ServerError.CALL_JOIN_NOT_ALLOWED:case s.ServerError.MESSAGES_CALL_JOIN_NOT_ALLOWED:return{title:i("calls_join_error_common_join_to_title"),message:i("calls_join_error_require_access_message")};case s.ServerError.OUTDATED_CALL_LINK:case s.ServerError.MESSAGES_OUTDATED_CALL_LINK:return{title:i("calls_join_error_outdated_link_title"),message:i("calls_join_error_outdated_link_message")};case s.ServerError.CALL_NOT_FOUND:case s.ServerError.MESSAGES_CALL_NOT_FOUND:return{title:i("calls_join_error_common_join_to_title"),message:i("calls_join_error_text")};case s.ServerError.CALL_INVALID_JOIN_LINK:case s.ServerError.MESSAGES_CALL_INVALID_JOIN_LINK:return{title:i("calls_join_error_common_join_to_title"),message:i("calls_invalid_join_link")};case s.ServerError.MESSAGES_PRIVACY:return{title:i("calls_join_error_common_call_to_title"),message:i("calls_privacy_error_message")};case s.ServerError.MESSAGES_BUSY:return t?{title:i("calls_chat_busy_error_title"),message:i("calls_chat_busy_error_message")}:{title:i("calls_join_error_common_call_to_title"),message:i("calls_busy_error")};case s.ServerError.FLOOD_CONTROL:return{title:i("calls_join_error_common_call_to_title"),message:i("calls_flood_error_message")};case s.ServerError.MESSAGES_REQUIRE_AUTH:case s.ServerError.REQUIRE_AUTH:return{title:i("calls_join_error_common_join_to_title"),message:i("calls_join_error_require_auth")};case s.ServerError.UNKNOWN:case s.ServerError.INTERNAL:case s.ServerError.INVALID_REQUEST:case s.ServerError.MESSAGES_OLD_RECEIVER_APP:default:return{title:i("calls_join_error_common_call_to_title"),message:i("calls_start_error_message")}}}function D(e){return e.startsWith("EXTERNAL_API_ERROR")}function O(e,t,i,r){const n=D(e),s=e.match(/\d+/g),o=s?Number(e.match(/\d+/g)?.[1]):a.CLIENT_ERROR_UNKNOWN,c=s?Number(e.match(/\d+/g)?.[0]):a.CLIENT_ERROR_UNKNOWN;if(!n||Number.isNaN(o))return c===a.SDK_ERROR_AUTH?i("calls_start_error_auth"):function(e,t,i){switch(!0){case-1!==e.search("error.webrtc.auth.required"):return i("calls_join_error_require_auth");case-1!==e.search("error.webrtc.auth.banned"):return i("calls_join_error_banned");case-1!==e.search("error.webrtc.participant.check.blacklisted_by_caller"):return i("calls_join_error_blacklisted_by_caller");case-1!==e.search("error.webrtc.participant.check.privacy"):return i("calls_join_error_banned");case-1!==e.search("error.webrtc.participant.check.killed_call"):return i("calls_join_error_killed_call");case-1!==e.search("not.found.webrtc.conversation"):return i("calls_join_error_not_found_conversation");case-1!==e.search("error.participants.limit.exceeded"):return i("calls_join_error_room_participants_exceeded");default:return i("calls_start_error")}}(e,0,i);switch(e){case d.HangupType.CANCELED:return i("calls_hangup_error_canceled");case d.HangupType.REJECTED:return i("calls_hangup_error_rejected");case d.HangupType.REMOVED:return i("calls_hangup_error_removed");case d.HangupType.HUNGUP:return i("calls_hangup_error_hangup");case d.HangupType.MISSED:return i("calls_hangup_error_missed");case d.HangupType.BUSY:return i("calls_hangup_error_busy");case d.HangupType.FAILED:return i("calls_hangup_error_failed");case d.HangupType.NETWORK_ERROR:return i("calls_hangup_error_network_error");case d.HangupType.CALLER_IS_BLOCKED:return i("calls_hangup_error_caller_is_blocked");case d.HangupType.NOT_FRIENDS:return i("calls_hangup_error_not_friends");case d.HangupType.CALLEE_IS_OFFLINE:return i("calls_hangup_error_callee_is_offline");case d.HangupType.UNKNOWN_ERROR:return i("calls_hangup_error_unknown_error");case d.HangupType.UNSUPPORTED:return i("calls_hangup_error_unsupported");case d.HangupType.OLD_VERSION:return i("calls_hangup_error_old_version");case d.HangupType.SERVICE_DISABLED:return i("calls_hangup_error_service_disabled");case d.HangupType.EXTERNAL_API_ERROR:return i("calls_hangup_error_external_api_error");case d.HangupType.SOCKET_CLOSED:return i("calls_hangup_error_socket_closed");case d.HangupType.NOT_FOUND:return i("calls_hangup_error_not_found")}return A(+o,t,i,r)}function b(e,t,i){return i("calls_sorry_error")}function N(e){const t=e.message.match(/\d+/g)?.[1];if(!t)return;const i=e?.custom_error?.vchat_external_api_error?.extended_code,r=`${t}:`;return i?.startsWith(r)?i.slice(r.length):void 0}function w(e){const t=D(e),i=e.match(/\d+/g);return Number(t&&i?.[1]||i?.[0]||0)}function M(e){if((0,c.isString)(e))return w(e);const t=(0,c.isObjectLike)(e?.apiError)&&e.apiError||(0,c.isObjectLike)(e?.error)&&e.error||e;if(!(0,c.isObjectLike)(t))return 0;const i=t.message||t.error_msg;return(0,c.isString)(i)&&D(i)&&w(i)||t.error_code||t.code||0}function k(e,t,i){if(e>t-100)return e>t?i("text_exceeds_symbol_limit",e-t):i("text_N_symbols_remain",t-e)}function L(e,t,i,a=0){const s=(0,n.isGroupCallByVkId)(e),o={is_video:t.includes(d.MediaOption.VIDEO),chat_id:(0,r.isChatPeer)(e)?h.Ranges.convertChatPeerIdToChatId(e):void 0,with_join_link:s,join_by_link:s,community_user_id:a,caller_app_id:i};return JSON.stringify(o)}function U(e){return e.localDevice.status===d.ParticipantStatus.RECONNECT||Y(e.devices,(e=>e.status===d.ParticipantStatus.RECONNECT))}const x=(e,...t)=>(...i)=>t.reduce(((e,t)=>t(e)),e)(...i);function V(e,{attempts:t=10,errorType:i=a.CallErrorType.CANT_REACH_API,timeout:r=0}={}){return(...n)=>t>0?(0,o.pause)(r,null).then((()=>e(...n))).catch((s=>V(e,{attempts:s.type===a.SdkErrorType.API?0:t-1,errorType:i,timeout:Math.min(2*(r||1),300)})(...n))):Promise.reject(i)}const B=(e,t)=>(...i)=>t(...i).catch((r=>{if(r.error===a.FatalError.AUTH)return e().then((()=>t(...i)));throw r}));function F(e,t,i,r,n,a=0,s=3){const o=e=>(0,c.decodeHTMLEntities)(i(e)||"");if(0===a&&e.length>0&&(a=e.length),a>t.length){const i=a-t.length,c=e.slice(0,s).map(o).join(", ");return n(i,"calls_members_list_label",r("calls_members_list_label","raw")).replace("{name}",c)}if(t.length>1){const i=t.length>2?e.slice(0,2).map(o).join(", "):o(e[0]),n=o(e[t.length-1]);return r("calls_and").replace("{before}",i).replace("{after}",n)}return 1===t.length?o(e[0]):""}function j(e,t,i=0){return i>0?t(i,"calls_members_count_label",e("calls_members_count_label",i)).replace("%s",String(i)):e("calls_empty_call")}function G(e,{join_link:t,preview:i,profiles:r,anonyms:n,call_id:s,room:o}){const c=[...n||[],...r||[]].map(l.normalizeUser);return{joinLink:t,room:o,callId:s,title:i?.title,membersCount:i?.members_count,photo_100:i?.photo?.photo_100,photo_200:i?.photo?.photo_200,members:c,conversationData:{peerId:a.EMPTY_PEER_ID,canAddMembers:!0,tab:e("calls_new_call_title")}}}const H=e=>"number"!=typeof e||Number.isNaN(e)?Promise.resolve():(0,o.pause)(e,void 0),W=(e,...t)=>t.includes(e),$=e=>{switch(typeof e){case"boolean":case"string":case"undefined":case"number":return!e;case"function":case"bigint":case"symbol":return!0;case"object":return null!==e&&(Array.isArray(e)?!e.length:!Object.keys(e).length)}},K=(e,t)=>{const i=[];for(const r in e)e.hasOwnProperty(r)&&t(e[r])&&i.push(e[r]);return i},z=(e,t)=>{const i=[];for(const r in e)e.hasOwnProperty(r)&&i.push(t(e[r],r));return i},q=(e,t,i)=>{let r=i;for(const i in e)e.hasOwnProperty(i)&&(r=t(r,e[i],i));return r},J=(e,t)=>{for(const i in e)e.hasOwnProperty(i)&&t(e[i],i)};function Y(e,t){for(const i in e)if(e.hasOwnProperty(i)&&t(e[i],i))return!0;return!1}const Q=(...e)=>{},X=e=>e.length?e.charAt(0)?.toLocaleUpperCase()+e.slice(1):"",Z=(e,t)=>e.length<=t?e:e.slice(0,Math.max(t-3,0)).trim().concat("..."),ee=e=>"function"==typeof e?e():e;function te(e,t){let i=0,r=e.length,n=!1;for(;i<r;){const a=Math.floor((i+r)/2),s=t(e[a],a);s>0?i=a+1:(r=a,n=!s)}return n?i:~i}const ie=e=>"boolean"==typeof e,re=(e,t,i,r=!0)=>r?e>=t&&e<=i:e>t&&e<i,ne=(e,t)=>{if(!e||!t)return!1;const i=Array.isArray(t)?t:[t];if(!e.length&&!i.length)return!0;if(e.length&&!i.length)return!1;const r=new Set(e);return i.every((e=>r.has(e)))},ae=(e,t)=>!e&&!t||!(!e||!t)&&(e.length===t.length&&e.every(((e,i)=>e===t[i]))),se=e=>{if(e.length)return e[e.length-1]},oe=e=>Array.isArray(e)?e.map((e=>oe(e))):e instanceof Date?new Date(e.getTime()):e&&"object"==typeof e?Object.getOwnPropertyNames(e).reduce(((t,i)=>{const r=Object.getOwnPropertyDescriptor(e,i);return r&&Object.defineProperty(t,i,r),t[i]=oe(e[i]),t}),Object.create(Object.getPrototypeOf(e))):e,ce=e=>{const t=e.length,i=e.slice();let r=-1;for(;++r<t;){const e=Math.floor(Math.random()*t),n=i[e];i[e]=i[r],i[r]=n}return i},le=(e,t)=>{const i=setTimeout(e,t);return()=>clearTimeout(i)},de=e=>{setTimeout(e,0)};function ue(e,t){return e?t:void 0}},904346:(e,t,i)=>{"use strict";i.d(t,{handlePromiseError:()=>n});var r=i(330262);const n=(...e)=>{(0,r.debugMessage)(r.DebugMessageType.ERROR,...e)}},193053:(e,t,i)=>{"use strict";i.d(t,{PARTICIPANTS_LIST_BUFFER_SIZE:()=>g,canMuteParticipants:()=>U,canPinParticipants:()=>M,convertParticipantStateFromSdk:()=>re,createSdkParticipantState:()=>ne,externalIdToString:()=>q,getActiveDevices:()=>D,getActiveDevicesCount:()=>Z,getActiveParticipantsCount:()=>O,getAllPeerDeviceIds:()=>ee,getAvailableStreamModes:()=>le,getDefaultExternalId:()=>te,getDeviceHasVideo:()=>me,getDeviceStreamData:()=>_e,getFirstMatchedId:()=>Q,getIsHandRaised:()=>x,getIsHelpRequested:()=>V,getMeId:()=>H,getMediaSettingsWithStreamMode:()=>pe,getNewStreamModeByDevice:()=>ce,getNonAnonymousConnectParticipantsCount:()=>N,getParticipantExternalId:()=>A,getParticipantsInfo:()=>b,getPeerIdDeviceInfo:()=>J,getPreviousAvailableStreamMode:()=>de,getRaisedHands:()=>B,getSingleLetter:()=>fe,getStream:()=>W,isAdmin:()=>k,isCallHaveOtherParticipants:()=>ie,isChatOrChannel:()=>R,isCreator:()=>L,isMessagesContact:()=>C,isParticipantAnonym:()=>E,isParticipantAnonymOrContact:()=>y,isParticipantContact:()=>T,isParticipantGroup:()=>I,isParticipantScreenSharingEnabled:()=>z,isParticipantWithMovie:()=>K,isParticipantWithVideo:()=>$,isSameExternalId:()=>Y,isStreamModeAvailable:()=>he,kickParticipant:()=>F,participantIsAdmin:()=>G,participantIsChatAdmin:()=>j,someDeviceByParticipant:()=>X,toggleScreenSharing:()=>se,toggleUrlSharingForParticipant:()=>oe});var r=i(619447),n=i(434262),a=i(96450),s=i(330262),o=i(955349),c=i(920590),l=i(926733),d=i(796938),u=i(468073),h=i(89872),p=i(342985),_=i(629271),m=i(543688),f=i(328783);const g={ORATOR:30,GRID:60},S=/^c\d+_\d+$/,v=e=>"object"==typeof e?(0,p.peerIdToVkId)(e.id):(0,p.isIPeerId)(e)?(0,p.peerIdToVkId)(e):e,E=e=>u.Ranges.isAnonymousCallPeerId(v(e)),T=e=>{const t="object"==typeof e?e.id:(0,p.isIPeerId)(e)?e:"";return S.test(t)},C=e=>"string"==typeof e.calls_id&&S.test(e.calls_id)&&"string"==typeof e.name,y=e=>E(e)||T(e),I=e=>u.Ranges.isGroupId(v(e)),R=e=>u.Ranges.isChatOrChannelPeer(v(e)),A=e=>e?.peerId?{id:e.peerId,type:s.ExternalIdType.USER}:null;let P=[];function D(e){const t=e.devices,i=e.adminPinnedParticipant,r=[],n=[],a=[],s=[],o=[],c=[],d=[],u=[],p=[],m=t=>{t.status&&(t.statusData?.hand?.state?r.push(t):Y(t.externalId,i)?n.push(t):Y(t.externalId,e.externalId)?a.push(t):t.movieStreamInfo&&t.movieStream?s.push(t):(0,_.isSharedMiniAppShownFromDevice)(t)?o.push(t):z(t)?c.push(t):t.mediaSettings?.isVideoEnabled?d.push(t):t.mediaSettings?.isAnimojiEnabled?u.push(t):p.push(t)),t.screenSharingStream&&h.screenShareNotVisibleStat.measure(t.externalId)},f=e.rooms.roomParticipantIds[(0,l.roomIdToString)(e.rooms.roomId)]??[];for(const e of f)t[e.idString]&&m(t[e.idString]);e.externalId&&m({...e.localDevice,externalId:e.externalId});const g=[...r.sort(((e,t)=>(e.statusData?.hand?.ts??0)-(t?.statusData?.hand?.ts??0))),...n,...a,...s,...o,...c,...d,...u,...p];if(g.length!==P.length)P=g;else for(let e=0;e<g.length;e++)if(g[e]!==P[e]){P=g;break}return{activeDevices:P}}function O(e,t,i){let r=0;for(const n in e)e.hasOwnProperty(n)&&w(t,e[n],i)&&r++;return r}const b=({excludeAnonymFromCount:e,participants:t,me:i})=>{const n={membersCount:0,creatorPeerId:r.EMPTY_PEER_ID};for(const r in t)t.hasOwnProperty(r)&&(!n.creatorPeerId&&t[r].roles?.includes(s.UserRole.CREATOR)&&(n.creatorPeerId=r),e&&E(r)||w(i,t[r])&&n.membersCount++);return n};function N(){const{devices:e,participants:t,me:i}=c.GlobalStore.getCallsState();return(0,o.objectReduce)(e,((e,r)=>{if(r.externalId.id===i)return e;if(r.status!==s.ParticipantStatus.CONNECTED)return e;if(E(r.externalId))return e;return G(t[r.externalId.id])&&e.admins++,e.users++,e}),{users:0,admins:0})}function w(e,t,i=(e=>!!e.status)){return t.peerId===e||X(t,i)}function M(e){return G(e)}function k(e){return!!e?.roles&&e.roles.some((e=>e===s.UserRole.ADMIN))}function L(e){return!!e?.roles&&e.roles.some((e=>e===s.UserRole.CREATOR))}function U(e){return!!e.roles&&(L(e)||k(e))}const x=e=>Boolean(e?.statusData?.hand?.state),V=e=>Boolean(e?.statusData?.drat?.state);function B({devices:e,localDevice:t,handState:i,rooms:r}){const n=i?Object.keys(i).length:(0,o.objectReduce)(e,((e,t)=>(t.status&&x(t)&&t.roomId===r.roomId&&e++,e)),0);return x(t)?n+1:n}function F(e,t=!1){const i=A(e);return i?(0,s.removeParticipant)(i,t):Promise.resolve()}function j(e,t){if(!t)return!1;const i=(0,p.peerIdToVkId)(e.peerId);return!!i&&(i===t.ownerId||!!t.adminIds&&t.adminIds.includes(i))}function G(e){return k(e)||L(e)}function H(e){return(0,a.isAuthedByGroupId)(e)?e.groupId:e.me}function W(e,t){const{stream:i,screenSharingStream:r,animojiStream:n,movieStream:a,streamMode:o,mediaSettings:c,movieStreamInfo:l}=e,d=!!r&&c.isScreenSharingEnabled,u=!!n&&c.isAnimojiEnabled,h=!!i&&(c.isVideoEnabled||c.isAnimojiEnabled&&!!t?.animojiBackendRender),p=!!a&&l;if(t?.useCameraOrAnimoji){if(!h&&!u)return;return{data:h?i:n,type:s.MediaType.CAMERA}}switch(o){case s.MediaType.CAMERA:return h||u?{data:h?i:n,type:o}:void 0;case s.MediaType.SCREEN:return d?{data:r,type:o}:void 0;case s.MediaType.STREAM:case s.MediaType.MOVIE:return p?{data:a,type:o}:void 0;default:if(h||u)return{data:h?i:n,type:s.MediaType.CAMERA}}}function $(e){return!!e.mediaSettings?.isVideoEnabled||function(e){return!(!e.mediaSettings?.isAnimojiEnabled||!e.animojiStream&&!e.stream)}(e)||function(e){return!!z(e)&&!!e.screenSharingStream}(e)}function K(e){return!!e.movieStream&&!!e.movieStreamInfo}function z(e){return!!e?.mediaSettings?.isScreenSharingEnabled}function q(e){if(!e)throw new Error("externalId is null or undefined");let t=e.id;return"number"==typeof e.deviceIdx&&(t+=":d"+e.deviceIdx),t}const J=(e,t)=>Object.values(t).find((t=>t.externalId.id===e));function Y(e,t){return!(!e||!t)&&(e.deviceIdx===t.deviceIdx&&e.id===t.id)}function Q(...e){for(const t of e)if(null!=t)return t;return null}function X(e,t){if(!e)return!1;const{maps:{peerIdToDevices:i},devices:r}=c.GlobalStore.getCallsState(),n=i.get(e.peerId);if(!n)return!1;for(const e of n){const i=r[e];if(i&&t?.(i))return!0}return!1}function Z(e,t,i){if(i){const e=Math.max(0,i.countBefore),t=Math.max(0,i.countAfter);return 1+e+i.ids.length+t}let r=1;const n=t.roomParticipantIds[(0,l.roomIdToString)(t.roomId)]??[];for(const t of n){const i=e[t.idString];i&&i.status&&r++}return r}function ee(e,t){if(t===e.me)return new Set([q(e.externalId??te(t))]);const{maps:{peerIdToDevices:i}}=e;return i.get(t)??new Set}function te(e){return{deviceIdx:0,id:e??(0,p.vkIdToPeerId)(r.EMPTY_USER_ID),type:s.ExternalIdType.USER}}const ie=()=>{const{devices:e,externalId:t,me:i}=c.GlobalStore.getCallsState(),r=t?.id||i.toString();return(0,o.objectSome)(e,(e=>e.externalId.id!==r))};function re(e){const t={};return["hand","drat"].forEach((i=>{e[i]?t[i]={state:e[i].state===r.SdkParticipantState.ON,ts:e[i].ts}:t[i]={state:!1,ts:Date.now()}})),t}function ne(e,t){const i={};return["hand","drat"].forEach((n=>{(t[n]??e?.[n]?.state)&&(i[n]=r.SdkParticipantState.ON)})),i}function ae(e,t,i){const n=function(e){return(0,o.objectReduce)(e.mediaSharers,((e,t)=>t?e+1:e),0)}(e),a=!!i||1===n&&!(!e.adminPinnedParticipant&&!e.pinnedParticipant),s=e=>{t({type:r.E_ACTION.TOGGLE_ORATOR_MODE,isOratorMode:e})},c=e=>{t((0,f.setPinnedParticipant)(e))};a&&!e.isOratorMode&&s(!0),!a&&e.mediaSharingNeedDisableOratorModeAfterStop&&s(!1),t((0,f.setMediaSharingPinnedParticipant)((0,d.getWatchTogetherPinnedParticipant)(e)?null:i,!e.isOratorMode,e.pinnedParticipant)),i&&e.pinnedParticipant&&c(null),i||e.pinnedParticipant||!e.mediaSharingOldPinnedParticipant||c(e.mediaSharingOldPinnedParticipant)}function se(e,t,i,a,s){if(!(0,l.isInMyRoom)(a))return;if(!i&&(0,m.getSharingMiniAppParticipantId)(e))return;ae(e,t,i?a:null);const o=e.devices[q(a)]?.mediaSettings;!!o?.isScreenSharingEnabled!==i&&t({type:r.E_ACTION.SET_MEDIA_SHARER,participantId:a,isMediaSharingEnabled:i}),s&&t({type:r.E_ACTION.CALL_NOTIFICATION,notification:{type:i?n.NotificationType.SCREEN_SHARING_STARTED:n.NotificationType.SCREEN_SHARING_STOPPED,data:a.id,hidden:!i}})}function oe(e,t,i,n){ae(e,t,i?n:null);const a=e.devices[q(n)];(!!a?.sharedUrl||!!a?.sharedMiniAppId)!==i&&t({type:r.E_ACTION.SET_MEDIA_SHARER,participantId:n,isMediaSharingEnabled:i})}function ce(e,t,i){if(!t)return e;const{streamMode:r}=t;switch(e){case s.MediaType.STREAM:case s.MediaType.SHARED_URL:case s.MediaType.MOVIE:return ue(e,t,i);case s.MediaType.SCREEN:return r===s.MediaType.MOVIE||r===s.MediaType.STREAM||r===s.MediaType.SHARED_URL?r:ue(e,t,i);case s.MediaType.CAMERA:return r===s.MediaType.MOVIE||r===s.MediaType.STREAM||r===s.MediaType.SCREEN||r===s.MediaType.SHARED_URL?r:ue(e,t,i);default:return null}}function le(e){const t=[];return(0,_.isSharedMiniAppShownFromDevice)(e)&&t.push(s.MediaType.SHARED_URL),e.movieStreamInfo&&e.movieStream&&t.push(e.movieStreamInfo.source),e.mediaSettings.isScreenSharingEnabled&&e.screenSharingStream&&t.push(s.MediaType.SCREEN),(e.mediaSettings.isVideoEnabled&&e.stream||e.mediaSettings.isAnimojiEnabled&&(e.animojiStream||e.stream))&&t.push(s.MediaType.CAMERA),t}function de(e,t){return le(e).filter((e=>e!==t))[0]||null}function ue(e,t,i){return i?e:de(t,e)}function he(e,t,i=t.mediaSettings){switch(e){case s.MediaType.STREAM:case s.MediaType.MOVIE:return!(!t.movieStream||!t.movieStreamInfo);case s.MediaType.SCREEN:return!(!t.screenSharingStream||!i.isScreenSharingEnabled);case s.MediaType.CAMERA:return!!(t.stream&&i.isVideoEnabled||(t.animojiStream||t.stream)&&i.isAnimojiEnabled);default:return!1}}function pe(e,t){const i={mediaSettings:e};return t?(e.isVideoEnabled||e.isAnimojiEnabled||t.streamMode!==s.MediaType.CAMERA||(i.streamMode=ce(s.MediaType.CAMERA,t,!1)),e.isScreenSharingEnabled||t.streamMode!==s.MediaType.SCREEN||(i.streamMode=ce(s.MediaType.SCREEN,t,!1)),t.streamMode||(e.isScreenSharingEnabled&&t.screenSharingStream?i.streamMode=ce(s.MediaType.SCREEN,t,!0):(e.isVideoEnabled&&t.stream||e.isAnimojiEnabled&&(t.stream||t.animojiStream))&&(i.streamMode=ce(s.MediaType.CAMERA,t,!0))),i):i}const _e=({device:e,isMe:t,isOrator:i,isSausageStream:r,topology:n})=>{if(!e)return;if(t)return W(e);const a=n===s.TransportTopology.SERVER;return r?function(e,{isOrator:t,animojiBackendRender:i}){const{stream:r,screenSharingStream:n,animojiStream:a,movieStream:s,streamMode:o,mediaSettings:c,movieStreamInfo:l}=e,d=!(!n||!c.isScreenSharingEnabled),u=!(!a||!c.isAnimojiEnabled),h=!(!r||!(c.isVideoEnabled||c.isAnimojiEnabled&&i)),p=!(!s||!l);return t?W(e,{useCameraOrAnimoji:h||u,animojiBackendRender:i}):o?p?{data:s,type:o}:d?{data:n,type:o}:h||u?{data:h?r:a,type:o}:void 0:void 0}(e,{isOrator:i,animojiBackendRender:a}):W(e,{animojiBackendRender:a})},me=e=>!!e&&($(e)||K(e)),fe=e=>e.length?e[0]:""},926733:(e,t,i)=>{"use strict";i.d(t,{changeParticipantRoom:()=>h,equalsToMyRoom:()=>d,findRelatedRoom:()=>u,isInMyRoom:()=>l,roomIdToString:()=>c});var r=i(193053),n=i(920590),a=i(740239),s=i(663512),o=i(86562);const c=e=>String(e),l=e=>{const t=n.GlobalStore.getCallsStore().getState(),i=t.rooms.roomParticipantIds[c(t.rooms.roomId)];return i&&i.some((t=>(0,r.isSameExternalId)(t,e)))},d=(e,t)=>{const i=(0,a.getRoomId)(e);return!i&&!t||i===t},u=(e,t)=>Object.values(t).find((t=>t.participantIds?.some((t=>(0,r.isSameExternalId)(t,e))))),h=(e,t,i,r,n=!1)=>{if(n)e.switchRoom(i,r);else{const n=[],a=u(r,t);a&&n.push({id:a.id,removeParticipantIds:[r]}),i&&n.push({id:i,addParticipantIds:[r]}),e.updateRooms(n)}(0,s.sendStats)(o.ClickHouseEventType.SESSION_ROOMS_MANUAL_ALLOCATION)}},631227:(e,t,i)=>{"use strict";i.d(t,{getAgeDiff:()=>n,getCurrentTime:()=>a});const r=(e,t)=>(e%t+t)%t,n=(e,t=!1)=>{const i={years:0,months:0,days:0,hours:0,minutes:0,seconds:0},n=t?e:1e3*e,a=Date.now()-n;if(a<0)return i;i.hours=Math.floor(r(a/1e3,86400)/3600),i.minutes=Math.floor(r(a/1e3,3600)/60),i.seconds=Math.floor(r(a/1e3,60));let s=new Date(n);const o=new Date;return s.getHours()>o.getHours()&&(s=new Date(n+60*(24-s.getHours())*60*1e3)),i.years=o.getFullYear()-s.getFullYear(),i.months=o.getMonth()+1-(s.getMonth()+1),i.days=o.getDate()-s.getDate(),i.days<0&&i.months--,i.days=Math.floor(a/1e3/86400),i.months<0&&(i.years--,i.months+=12),(i.years||i.months)&&(i.days=0),i};function a(e=!0){const t=Date.now().toString(10);return e?t+"000":t}},342985:(e,t,i)=>{"use strict";i.d(t,{createFriendsCache:()=>g,getExternalIdByUserId:()=>v,getIdForColorCalculation:()=>h,getMemberForUserStack:()=>E,getUserName:()=>T,getUserShortName:()=>C,isEmptyPeerId:()=>d,isIPeerId:()=>c,mapExternalIdsToPeerIds:()=>y,mergeGroupToParticipant:()=>S,normalizeContact:()=>m,normalizeGroup:()=>f,normalizeUser:()=>_,peerIdToVkId:()=>l,vkIdToPeerId:()=>u});var r=i(619447),n=i(955349),a=i(8520),s=i(193053),o=i(330262);const c=e=>"string"==typeof e,l=e=>(0,s.isParticipantContact)(e)?r.EMPTY_USER_ID:Number(e),d=e=>e===r.EMPTY_PEER_ID,u=e=>e===r.EMPTY_USER_ID?r.EMPTY_PEER_ID:String(e),h=e=>(0,s.isParticipantContact)(e)?(e=>{const[,t]=e.split("_");return t?Number(t):0})(e):Math.abs(l(e)),p=(e,t)=>t in e?e[t]:void 0,_=e=>{const{id:t,photo_50:i,photo_100:r,photo_400:o,photo_200:c}=e,l=p(e,"custom_names_for_calls");let d=p(e,"first_name"),h=p(e,"last_name");const _=p(e,"name"),m=p(e,"screen_name");d=d??_??"",h=h??"",(0,s.isParticipantGroup)(t)&&(d=(0,a.escape)(d));const f=_||`${d}${d&&h?" ":""}${h}`;let g;m?g=`/${m}`:(0,s.isParticipantAnonymOrContact)(t)||(0,s.isParticipantGroup)(t)||(g=`/id${t}`);const S={canCall:p(e,"can_call"),firstName:d,id:t,is_nft:p(e,"is_nft"),lastName:h,link:g,name:f,photo:o||c||r||i,photo_100:r,peerId:u(t),sex:p(e,"sex"),shortName:(0,n.fetchUserShortName)(d,h,_)},v=p(e,"animated_avatar");v&&(S.animated_avatar=v);const E=p(e,"online_info");return E&&(S.onlineInfo=E),l?.[0]?.name&&(S.customName=l[0].name),S},m=e=>{const{user_id:t,calls_id:i,name:n,local_name:a}=e,s=a??n;return{animated_avatar:t?e.animated_avatar:void 0,id:t??r.EMPTY_USER_ID,firstName:s,name:s,peerId:t?u(t):i??r.EMPTY_PEER_ID,photo:t?e.photo_50:void 0,shortName:s}},f=({id:e,name:t,screen_name:i,photo_400:r,photo_200:n,photo_100:s})=>({id:-e,peerId:u(-e),name:(0,a.escape)(t??""),firstName:"",lastName:"",shortName:"",link:i&&`/${i}`,photo:r||n||s,photo_100:s});function g(e){return e.reduce(((e,t)=>(e[t.id]=!0,e)),{})}function S(e,t){let i={...t};return e.photo&&(i.photo=e.photo),e.name&&(i.name=e.name),e.link&&(i.link=e.link),i}function v(e){let t=o.ExternalIdType.USER;return(0,s.isParticipantGroup)(e)&&(t=o.ExternalIdType.GROUP),{id:e.toString(),type:t}}function E(e){const t=e.name||"";return e.photo?{src:e.photo,alt:t,key:e.peerId}:{id:h(e.peerId),text:(0,s.getSingleLetter)(t),key:e.peerId}}const T=e=>{const t=e?.customName||e?.name||e?.shortName||"";return(0,a.decodeHTMLEntities)(t)},C=e=>{const t=e?.customName||e?.shortName||e?.name||"";return(0,a.decodeHTMLEntities)(t)},y=e=>e.map((e=>e.id))},920590:(e,t,i)=>{"use strict";i.d(t,{GlobalStore:()=>r});class r{static setCallsStore(e){r.unsubscribeAllListeners(),r._callsStore=e,e&&this.listeners.forEach(((t,i)=>{this.listeners.set(i,e.subscribe(i)),i()}))}static getCallsStore(){if(!r._callsStore)throw new Error("store was not initiated!");return r._callsStore}static isSet(){return!!r._callsStore}static getCallsState(){return r.getCallsStore().getState()}static addStoreUpdateListener(e){return this.listeners.set(e,this.getCallsStore().subscribe(e)),()=>{this.listeners.get(e)?.(),this.listeners.delete(e)}}static unsubscribeAllListeners(){this.listeners.forEach((e=>{e()}))}}r._callsStore=null,r.listeners=new Map},516591:(e,t,i)=>{"use strict";i.d(t,{getCallConversation:()=>a,getCallData:()=>r,getCallDataShowChatHistory:()=>l,getCallDataShowChatHistoryRaw:()=>c,getCallDataTopology:()=>o,getCallId:()=>n,getStartCallModalOptions:()=>s});const r=e=>e.callData,n=e=>e.callData?.callId,a=e=>e.callData?.conversation,s=e=>e.callData?.startCallModalOptions,o=e=>e.callData?.topology,c=e=>e.callData?.showChatHistory,l=e=>e.callData&&void 0!==e.callData.showChatHistory?e.callData.showChatHistory:e.config.sferum},131512:(e,t,i)=>{"use strict";i.d(t,{getCommonClickHouseStatsData:()=>l});var r=i(862032),n=i(96450),a=i(933934),s=i(760962),o=i(4973),c=i(516591);const l=e=>{const t=(0,s.getMyId)(e),i=(0,s.getPeerId)(e),l=(0,o.getConfigDeviceId)(e),d=(0,c.getCallId)(e),u=(0,s.getIsVoiceRoom)(e),h=(0,s.getEntryPoint)(e);let p={session_id:d,peer_id:i||"",device_id:l||"",is_group_call:(0,n.isGroupCallByPeerAndMe)(i,t),is_room:u};return(0,a.isMiniAppSource)(h?.source)&&(p.source=r.CallStatSource.MINI_APP,p.mini_app_id=h?.miniAppId),p}},760962:(e,t,i)=>{"use strict";i.d(t,{createParticipantSelector:()=>p,getAdminPinnedParticipant:()=>P,getAnonymSecret:()=>v,getCallByName:()=>N,getCallTopology:()=>_,getConversation:()=>M,getConversationOptions:()=>k,getEffectVoiceChange:()=>J,getEntryPoint:()=>V,getGroupId:()=>B,getHasInCallChat:()=>z,getInCallChatOpened:()=>q,getIsChatAttachedToCall:()=>Y,getIsLoaderVisible:()=>K,getIsMeAdmin:()=>E,getIsMeAnonym:()=>T,getIsMeCommunity:()=>$,getIsModalOpened:()=>j,getIsRestrictedConversation:()=>C,getIsVoiceRoom:()=>b,getJoin:()=>g,getJoinLink:()=>S,getJoinProps:()=>G,getLastCallData:()=>x,getLocalVideoResolution:()=>I,getMeGroup:()=>l,getModal:()=>F,getMode:()=>U,getMyDevice:()=>c,getMyExternalId:()=>o,getMyId:()=>m,getMyMediaSettings:()=>d,getNoiseCancellation:()=>y,getNotification:()=>A,getOnlyAdminCanShareMovie:()=>Q,getOpponent:()=>L,getParticipants:()=>u,getPeerId:()=>f,getPeerIdToDevices:()=>R,getPermissions:()=>h,getPhotos:()=>X,getPinnedParticipant:()=>D,getPreselectedIds:()=>W,getShouldShowCloseTabWarning:()=>Z,getTooltips:()=>O,getUIMode:()=>w,getUiMode:()=>H});var r=i(654272),n=i(193053),a=i(96450),s=i(342985);const o=e=>e.externalId,c=e=>e.localDevice,l=e=>e.meGroup,d=e=>e.localDevice?.mediaSettings||{},u=e=>e.participants,h=e=>e.permissions,p=e=>t=>t.participants[e],_=e=>e.callData.topology,m=e=>e.me,f=e=>e.peer,g=e=>e.join,S=e=>e.join?.joinLink,v=e=>e.anonymSecret,E=e=>(0,n.participantIsAdmin)(e.localDevice),T=e=>(0,n.isParticipantAnonym)(e.me),C=e=>e.restrictedConversation,y=e=>e.noiseCancellation,I=e=>e.localVideoResolution,R=e=>e.maps.peerIdToDevices,A=e=>e.notification,P=e=>e.adminPinnedParticipant,D=e=>e.pinnedParticipant,O=e=>e.tooltips,b=e=>e.isVoiceRoom,N=e=>e.callByName,w=e=>e.uiMode,M=e=>e.callData.conversation,k=e=>e.conversationOptions,L=e=>{const t=f(e),i=m(e);return(0,a.isGroupCallByPeerAndMe)(t,i)?M(e):e.participants[t]},U=e=>e.mode,x=e=>e.lastCallData,V=e=>e.entryPoint,B=e=>e.groupId,F=e=>e.modal,j=e=>!!e.modal||e.errorShown||e.cautionShown,G=e=>e.join,H=e=>e.uiMode,W=e=>e.preselectedIds,$=e=>(0,n.isParticipantGroup)(e.groupId),K=e=>e.isLoaderVisible,z=e=>e.hasInCallChat,q=e=>e.inCallChatOpened,J=e=>e.effectVoiceChange,Y=e=>!(0,s.isEmptyPeerId)(e.peer)&&!e.groupId,Q=e=>e.onlyAdminCanShareMovie,X=e=>e.virtualBackgroundSettings?.photos||[],Z=e=>{const{mode:t,devices:i,waitingHall:n}=e,a=n?.members.size??0;return t===r.Mode.CALL&&(Object.values(i).length>0||a>0)}},4973:(e,t,i)=>{"use strict";i.d(t,{getBrowserWarnings:()=>s,getConfigDeviceId:()=>l,getIsEnabledRoomTimer:()=>d,getIsSferum:()=>a,getIsVideoSuspendAutoModeAvailable:()=>c,getIsVideoSuspendSupported:()=>o});var r=i(330262),n=i(981949);const a=e=>e.config.sferum,s=e=>e.config.browserWarnings,o=e=>!e.isVoiceRoom,c=e=>{const{callData:t}=e;return!n.currentBrowser.isFirefox&&t.topology===r.TransportTopology.SERVER},l=e=>e.config?.deviceId,d=e=>e.config?.enableRoomTimer},740239:(e,t,i)=>{"use strict";i.d(t,{getAnyRoomIsActive:()=>u,getIsInNotMainRoom:()=>h,getIsRoomMode:()=>c,getParticipantIdsByRoomIdMap:()=>o,getRoomCountdownSec:()=>l,getRoomId:()=>n,getRoomTimeoutMs:()=>d,getRooms:()=>a,getRoomsByIdMap:()=>s});var r=i(619447);const n=e=>e.rooms.roomId,a=e=>e.rooms,s=e=>e.rooms.rooms,o=e=>e.rooms.roomParticipantIds,c=e=>Boolean(e.rooms.roomId),l=e=>e.rooms.countdownSec,d=e=>e.rooms.timeoutMs,u=e=>{const t=s(e);return Object.values(t).filter((e=>null!==e.id)).some((e=>e.active))},h=e=>n(e)!==r.ROOM_MAIN_ID&&u(e)},796938:(e,t,i)=>{"use strict";i.d(t,{getWatchTogetherData:()=>n,getWatchTogetherDevice:()=>l,getWatchTogetherInfo:()=>o,getWatchTogetherMovieState:()=>c,getWatchTogetherOwner:()=>s,getWatchTogetherPinnedParticipant:()=>a});var r=i(193053);const n=e=>e.watchTogether,a=e=>e.watchTogether?.pinnedParticipant??null,s=e=>e.watchTogether?.owner??null,o=e=>e.watchTogether?.movieInfo??null,c=e=>e.watchTogether?.movieState??null,l=e=>{const t=e.watchTogether?.owner;return t?(0,r.isSameExternalId)(t,e.externalId)?e.localDevice:e.devices[(0,r.externalIdToString)(t)]:null}},89872:(e,t,i)=>{"use strict";i.d(t,{screenShareNotVisibleStat:()=>d,useScreenShareNotVisibleStat:()=>u});var r=i(296540),n=i(330262),a=i(8520),s=i(663512),o=i(86562),c=i(920590),l=i(193053);const d=new class{init(){const e=c.GlobalStore.getCallsState();this._isEnabled=!!e.config.enableScreenShareNotVisibleStat}destroy(){for(const e of this._timers.values())clearTimeout(e.timer);this._timers.clear()}checkLayoutDiff(e){if(this._isEnabled)for(const t of e){if((0,a.isString)(t.uid))continue;if(t.mediaType!==n.MediaType.SCREEN)continue;const e=(0,l.externalIdToString)(t.uid);"stopStream"in t?this._clearMark(e):this._mark(e)}}measure(e){this._isEnabled&&this._collectStat((0,l.externalIdToString)(e))}_mark(e){this._clearMark(e),this._timers.set(e,{timer:setTimeout(this._collectStat.bind(this,e),3e4),ts:Date.now()})}_clearMark(e){this._getTimerValue(e)}_getTimerValue(e){const t=this._timers.get(e);return t?(clearTimeout(t.timer),this._timers.delete(e),t.ts):null}_collectStat(e){const t=this._getTimerValue(e);if(null===t)return;const i=Date.now()-t;i<1e4||(0,s.sendStats)(o.ClickHouseEventType.SCREEN_SHARE_NOT_VISIBLE,{event_param:i})}constructor(){this._timers=new Map,this._isEnabled=!1}};function u(e){(0,r.useEffect)((()=>{if(e)return d.init(),()=>d.destroy()}),[e])}},60088:(e,t,i)=>{"use strict";i.d(t,{callStats:()=>o});var r=i(193053),n=i(342985),a=i(86562),s=i(631227);const o=new class{setActionStatCollector(e){this.actionStatCollector=e}setEventCommonData(e={}){this.eventCommonData=e}logEvent(e){const t=e.peer_id,i="string"==typeof t?(0,n.peerIdToVkId)(t):t,o="number"==typeof t?(0,n.vkIdToPeerId)(t):t,c=e.group_id||((0,r.isParticipantGroup)(i)?i:0),l={...e,peer_id:o,event_client_microsec:(0,s.getCurrentTime)(),session_id:e.session_id||"",lib_version:"calls_v2",group_id:c,device_id:e.device_id||"",...this.eventCommonData};this.actionStatCollector&&this.actionStatCollector.logEvent({type:a.actionProductionStatCallEventType,[a.actionProductionStatCallEventType]:l})}constructor(){this.actionStatCollector=void 0,this.eventCommonData={}}}},86562:(e,t,i)=>{"use strict";var r,n,a,s,o;i.d(t,{ClickHouseEventType:()=>s,EScreenSharingReason:()=>o,actionProductionStatCallEventType:()=>c}),function(e){e.AUDIO="ok_audio",e.AUDIO_TO_VIDEO="ok_video",e.VIDEO="ok_started_as_video",e.GROUP_AUDIO="group_audio",e.GROUP_AUDIO_TO_VIDEO="group_video",e.GROUP_VIDEO="group_started_as_video"}(r||(r={})),function(e){e.SUCCESS="success",e.FAIL="fail"}(n||(n={})),function(e){e.REMOTE_NO_CONNECT="push_not_delivered",e.REMOTE_FAILED_ACCEPT="cant_connect",e.REMOTE_DECLINE="declined_remote",e.LOCAL_DECLINE="declined_local",e.REMOTE_TIMEOUT="declined_timeout",e.REMOTE_BUSY="busy",e.CONNECTION_LOST="lost_connection"}(a||(a={})),function(e){e.OUTGOING_CALL_STARTED_VIDEO="OutgoingCallStartedVideo",e.OUTGOING_CALL_STARTED_AUDIO="OutgoingCallStartedAudio",e.OUTGOING_CALL_ADD_PARTICIPANTS_SENT="OutgoingCallAddParticipantsSent",e.OUTGOING_CALL_REMOTE_RINGING="OutgoingCallRemoteRinging",e.OUTGOING_CALL_ACCEPTED_REMOTELY="OutgoingCallAcceptedRemotely",e.OUTGOING_CALL_FAILED="OutgoingCallFailed",e.OUTGOING_CALL_COMPLETED="OutgoingCallCompleted",e.INCOMING_CALL_RECEIVED="IncomingCallReceived",e.INCOMING_CALL_ACCEPTED="IncomingCallAccepted",e.INCOMING_CALL_FAILED="IncomingCallFailed",e.CALL_DECLINED_OR_HANGED_LOCALLY="CallDeclinedOrHangedLocally",e.CALL_DECLINED_OR_HANGED_REMOTELY="CallDeclinedOrHangedRemotely",e.CALL_CONNECTED="CallConnected",e.CALL_DISCONNECTED="CallDisconnected",e.VIDEO_ENABLED="VideoEnabled",e.VIDEO_DISABLED="VideoDisabled",e.RELAY_CONNECTION_ESTABLISHED="RelayConnectionEstablished",e.USER_FEEDBACK_RECEIVED="UserFeedbackReceived",e.SYSTEM_STAT="SystemStat",e.GROUP_CALL_JOINED="GroupCallJoined",e.GROUP_CALL_JOIN_FAILED="GroupCallJoinFailed",e.HAND_RAISED="HandRaised",e.HAND_LOWERED="HandLowered",e.SCREEN_SHARING_STARTED="ScreenSharingStarted",e.SCREEN_SHARING_STOPPED="ScreenSharingStopped",e.AUDIO_SHARING_STARTED="AudioSharingStarted",e.ALL_MICS_DISABLED="AllMicsDisabled",e.USER_MICS_DISABLED="UserMicsDisabled",e.ALL_VIDEO_DISABLED="AllVideoDisabled",e.USER_VIDEO_DISABLED="UserVideoDisabled",e.ALL_SCREEN_SHARING_DISABLED="AllScreenSharingDisabled",e.USER_SCREEN_SHARING_DISABLED="UserScreenSharingDisabled",e.ALL_WATCH_TOGETHER_DISABLED="AllWatchTogetherDisabled",e.USER_WATCH_TOGETHER_DISABLED="UserWatchTogetherDisabled",e.MIC_OFF_WHILE_TALKING_ALERT="MicOffWhileTalkingAlert",e.MIC_OFF_WHILE_TALKING_ENABLE_CLICK="MicOffWhileTalkingEnableClick",e.VIDEO_DISABLED_DUE_TO_BAD_CONNECTION_ALERT="VideoDisabledDueToBadConnectionAlert",e.ALL_MICS_AND_VIDEO_DISABLED="AllMicsAndVideoDisabled",e.USER_MICS_AND_VIDEO_DISABLED="UserMicsAndVideoDisabled",e.ALL_HAND_LOWERED="AllHandsLowered",e.USER_HAND_LOWERED="UserHandLowered",e.ASK_ALL_TO_UNMUTE="AskAllToUnmute",e.ASK_USER_TO_UNMUTE="AskUserToUnmute",e.ASSIGN_ADMIN="AssignAdmin",e.RETRIEVE_ADMIN="RetrieveAdmin",e.ADMIN_PIN="AdminPin",e.ADMIN_UNPIN="AdminUnpin",e.VIRTUAL_BACKGROUND_SELECTED="VirtualBackgroundSelected",e.VIRTUAL_BACKGROUND_DISABLED="VirtualBackgroundDisabled",e.CUSTOM_VIRTUAL_BACKGROUND_SELECTED="CustomVirtualBackgroundSelected",e.CUSTOM_VIRTUAL_BACKGROUND_ADDED="CustomVirtualBackgroundAdded",e.CUSTOM_VIRTUAL_BACKGROUND_DELETED="CustomVirtualBackgroundDeleted",e.CUSTOM_VIRTUAL_BACKGROUND_DISABLED="CustomVirtualBackgroundDisabled",e.CALL_SCHEDULED="CallScheduled",e.SCHEDULED_CALL_EDITED="ScheduledCallEdited",e.SCHEDULED_CALL_LIVE_STARTED="ScheduledCallLiveStarted",e.REACTION_ENABLED="ReactionEnabled",e.REACTION_DISABLED="ReactionDisabled",e.REACTION_SENT="ReactionSent",e.CALL_WATCH_TOGETHER_CLICK="CallWatchTogetherClick",e.CALL_WATCH_TOGETHER_STARTED="CallWatchTogetherStarted",e.CALL_WATCH_TOGETHER_STOPPED="CallWatchTogetherStopped",e.SESSION_ROOMS_ASK_FOR_HELP="SessionRoomsAskForHelp",e.SESSION_ROOMS_USER_MOVED="SessionRoomsUserMoved",e.SESSION_ROOMS_USER_LEFT="SessionRoomsUserLeft",e.SESSION_ROOMS_AUTO_ALLOCATION="SessionRoomsAutoAllocation",e.SESSION_ROOMS_MANUAL_ALLOCATION="SessionRoomsManualAllocation",e.SESSION_ROOMS_OPENED="SessionRoomsOpened",e.SESSION_ROOMS_CLOSED="SessionRoomsClosed",e.SKIP_DESKTOP_JOIN_SCREEN="SkipDesktopJoinScreen",e.CALL_VMOJI_CLICK="CallVmojiClick",e.CALL_VMOJI_START_FAILED="CallVmojiStartFailed",e.CALL_VMOJI_STARTED="CallVmojiStarted",e.CALL_VMOJI_STOPPED="CallVmojiStopped",e.CALL_VMOJI_BENCHMARK="CallVmojiBenchmark",e.MIC_ENABLED="MicEnabled",e.MIC_DISABLED="MicDisabled",e.OPEN_CHAT="OpenChat",e.NAME_CHANGED_BY_USER="NameChangedByUser",e.NAME_CHANGED_BY_ANONYM="NameChangedByAnonym",e.NAME_CHANGED_BY_ADMIN="NameChangedByAdmin",e.NAME_CHANGED_BY_COMMUNITY="NameChangedByCommunity",e.TRANSCRIPTION_STARTED="TranscriptionStarted",e.TRANSCRIPTION_STOPPED="TranscriptionStopped",e.SCREEN_SHARE_NOT_VISIBLE="ScreenShareNotVisible",e.CALL_COLLAPSED="CallCollapsed",e.CALL_MISSED_NOTIFICATION="CallMissedNotification",e.SCREEN_ZOOMED="ScreenZoomed",e.WHITE_BOARD_STARTED="WhiteBoardStarted",e.WHITE_BOARD_VIEW_STARTED="WhiteBoardViewClick",e.WHITE_BOARD_VIEW_STOPPED="WhiteBoardViewStopped",e.WHITE_BOARD_STOPPED="WhiteBoardStopped",e.ONLINE_TRANSCRIPTION_STARTED="OnlineTranscriptionStarted",e.ONLINE_TRANSCRIPTION_STOPPED="OnlineTranscriptionStopped",e.WAITING_ROOM_DISABLED="WaitingRoomDisabled",e.WAITING_ROOM_ENABLED="WaitingRoomEnabled",e.CALL_STREAMING_CLICK="CallStreamingClick",e.CALL_STREAMING_START_FAILED="CallStreamingStartFailed",e.CALL_STREAMING_STARTED="CallStreamingStarted",e.CALL_STREAMING_STOPPED="CallStreamingStopped",e.CALL_RECORDING_CLICK="CallRecordingClick",e.CALL_RECORDING_START_FAILED="CallRecordingStartFailed",e.CALL_RECORDING_STARTED="CallRecordingStarted",e.CALL_RECORDING_STOPPED="CallRecordingStopped",e.CURRENT_USER_BAD_CONNECTION_ALERT="CurrentUserBadConnectionAlert",e.DOWNLOAD_PARTICIPANTS_LIST_CLICK="DownloadParticipantsListClick",e.CONTACT_JOINED="ContactJoined",e.CONTACT_DEANONIMIZED="ContactDeanonimized",e.VIDEO_SUSPEND_MODE="VideoSuspendMode",e.CALL_PREVIEW_CAMERA_ENABLED="CallPreviewCameraEnabled",e.CALL_PREVIEW_MIC_ENABLED="CallPreviewMicEnabled",e.CALL_PREVIEW_CAMERA_DISABLED="CallPreviewCameraDisabled",e.CALL_PREVIEW_MIC_DISABLED="CallPreviewMicDisabled",e.CALL_PREVIEW_DOWNLOAD_APP_CLICK="CallPreviewDownloadAppClick",e.CALL_PREVIEW_DESKTOP_APP_JOIN_CLICK="CallPreviewDesktopAppJoinClick",e.CALL_PREVIEW_DEVICE_CHANGE_CAM_CLICK="CallPreviewDeviceChangeCamClick",e.CALL_PREVIEW_DEVICE_CHANGE_MIC_CLICK="CallPreviewDeviceChangeMicClick",e.CALL_PREVIEW_MODAL_CLOSED="CallPreviewModalClosed",e.CALL_PREVIEW_SKIP_JOIN_SCREEN_CLICK="CallPreviewSkipDesktopJoinScreenClick",e.CALL_LINK_QR_CODE_CLICK="CallLinkQrCodeClick",e.CALL_LINK_QR_CODE_SHARED="CallLinkQrCodeShared",e.CALL_LINK_QR_CODE_DOWNLOAD="CallLinkQrCodeDownload",e.RECORD_HISTORY_OPENED="RecordHistoryOpened",e.RECORD_HISTORY_VIDEO_OPENED="RecordHistoryVideoOpened",e.SESSION_ROOMS_MESSAGE_SENT="SessionRoomsMessageSent",e.SESSION_ROOMS_TIMER_ENABLED="SessionRoomsTimerEnabled",e.SESSION_ROOMS_CLOSED_USING_TIMER="SessionRoomsClosedUsingTimer",e.CALL_HISTORY_DELETE_ALL="CallHistoryDeleteAll",e.CALL_HISTORY_DELETE_SINGLE="CallHistoryDeleteSingle",e.CALL_HISTORY_DELETE_SELECTED="CallHistoryDeleteSelected",e.CALL_ADD_PARTICIPANT_WITH_CHAT="AddParticipantWithChat",e.CALL_CHAT_HISTORY_TOGGLED="CallChatHistoryToggled"}(s||(s={})),function(e){e.HDScreenSharing="HDScreenSharing",e.AudioScreenSharing="AudioScreenSharing",e.FastScreenSharing="FastScreenSharing",e.FastAudioScreenSharing="FastAudioScreenSharing"}(o||(o={}));const c="type_voip_call_item"},663512:(e,t,i)=>{"use strict";i.d(t,{getSendStatService:()=>o,sendStats:()=>c});var r=i(920590),n=i(131512),a=i(60088),s=i(904346);const o=e=>(t,i={})=>{const r={...e||{},...i,call_event_type:t};a.callStats.logEvent(r)},c=(e,t={})=>{let i,a;try{i=r.GlobalStore.getCallsState(),a=(0,n.getCommonClickHouseStatsData)(i)}catch(e){(0,s.handlePromiseError)(e)}return o(a)(e,t)}},525697:(e,t,i)=>{"use strict";function r(e,t){return new Promise((function(i){setTimeout(i.bind(null,t),1e3*e)}))}i.d(t,{pause:()=>r})},900667:(e,t,i)=>{"use strict";function r(e){return e>0&&e<2e9}function n(e){return e>2e9}i.d(t,{isChatPeer:()=>n,isUserPeer:()=>r})},330262:(e,t,i)=>{"use strict";i.r(t),i.d(t,{Api:()=>zr,ApiExternal:()=>Qr,ArrayDequeue:()=>Yr,AuthData:()=>Ue,BaseLogger:()=>A,CallDirection:()=>Mi,CallType:()=>Li,ChatRoomEventType:()=>xi,ConversationFeature:()=>Bi,ConversationOption:()=>ji,DebugMessageType:()=>ci,ExternalIdType:()=>ir,FacingMode:()=>Nt,FatalError:()=>U,HangupReason:()=>N,HangupType:()=>b,MediaOption:()=>V,MediaTrackKind:()=>Je,MediaType:()=>pi,MuteState:()=>Hi,ParticipantState:()=>$i,ParticipantStatus:()=>Xe,RecordRole:()=>Jr,RoomsEventType:()=>zi,Signaling:()=>Ni,SignalingCommandType:()=>k,SignalingConnectionType:()=>Ci,SignalingNotification:()=>Ai,TransportTopology:()=>Or,UserRole:()=>Zi,UserType:()=>K,VolumeDetector:()=>hr,acceptCall:()=>hn,acceptPromotion:()=>Aa,activateRooms:()=>da,addMovie:()=>sa,addParticipant:()=>Sn,addParticipantInternal:()=>vn,authorize:()=>un,browser:()=>Zr,callInternal:()=>cn,callTo:()=>on,captureScreen:()=>yn,captureVmoji:()=>In,changeAudioEffect:()=>Sa,changeConversationOptions:()=>Gn,changeDevice:()=>Cn,changeParticipantState:()=>bn,changePriorities:()=>On,changeVideoEffect:()=>ga,chatHistory:()=>$n,chatMessage:()=>Hn,chatMessageInternal:()=>Wn,createJoinLink:()=>Yn,customData:()=>Kn,customDataInternal:()=>zn,debug:()=>_a,debugMessage:()=>ma,declineCall:()=>pn,enableFeatureForRoles:()=>wa,enableVideoSuspend:()=>Fn,enableVideoSuspendSuggest:()=>jn,feedback:()=>Oa,forceRelayPolicy:()=>ea,getAnonymTokenByLink:()=>Xn,getAudienceModeHands:()=>ya,getParticipantListChunk:()=>Pa,getParticipants:()=>Da,getStreamInfo:()=>aa,getWaitingHall:()=>Ca,grantRoles:()=>Mn,grantRolesInternal:()=>kn,hangup:()=>gn,init:()=>sn,joinCall:()=>_n,joinCallByLink:()=>fn,joinCallInternal:()=>mn,logClientEvent:()=>Na,muteParticipant:()=>Ln,muteParticipantInternal:()=>Un,pinParticipant:()=>xn,pinParticipantInternal:()=>Vn,processPush:()=>ln,processPushInternal:()=>dn,promoteParticipant:()=>Ia,publishStream:()=>ra,putHandsDown:()=>Nn,recordSetConf:()=>na,removeHistoryRecords:()=>ka,removeJoinLink:()=>Qn,removeMovie:()=>ca,removeParticipant:()=>En,removeParticipantInternal:()=>Tn,removeRooms:()=>ha,requestAsr:()=>xa,requestPromotion:()=>Ra,setAudioEffects:()=>nn,setAudioStream:()=>va,setLocalResolution:()=>Dn,setLogger:()=>tn,setMediaModifiers:()=>Bn,setStatisticsInterval:()=>pa,setVideoEffects:()=>rn,setVideoStream:()=>Rn,setVmoji:()=>an,setVmojiFill:()=>Ta,setVmojiSvg:()=>Ea,setVolume:()=>Zn,startAsr:()=>La,startAudienceConversation:()=>Jn,startConversation:()=>qn,startStream:()=>ta,startUrlSharing:()=>Va,stopAsr:()=>Ua,stopStream:()=>ia,stopUrlSharing:()=>Ba,switchRoom:()=>ua,toggleLocalAudio:()=>Pn,toggleLocalVideo:()=>An,updateDisplayLayout:()=>wn,updateMovie:()=>oa,updateRooms:()=>la,uploadDebugLogs:()=>fa,userFeedbackStats:()=>ba,utils:()=>en,version:()=>Fa});var r,n,a,s,o,c,l=i(966752),d=i(777688),u=i(857468),h=i.n(u),p=i(774721),_=i(28726),m=Object.defineProperty,f=Object.defineProperties,g=Object.getOwnPropertyDescriptors,S=Object.getOwnPropertySymbols,v=Object.prototype.hasOwnProperty,E=Object.prototype.propertyIsEnumerable,T=Math.pow,C=(e,t,i)=>t in e?m(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,y=(e,t)=>{for(var i in t||(t={}))v.call(t,i)&&C(e,i,t[i]);if(S)for(var i of S(t))E.call(t,i)&&C(e,i,t[i]);return e},I=(e,t)=>f(e,g(t)),R=(e,t,i)=>new Promise(((r,n)=>{var a=e=>{try{o(i.next(e))}catch(e){n(e)}},s=e=>{try{o(i.throw(e))}catch(e){n(e)}},o=e=>e.done?r(e.value):Promise.resolve(e.value).then(a,s);o((i=i.apply(e,t)).next())})),A=class{log(e,t,i=!1){}destroy(){}},P=class{constructor(){this._handlers={},this._listeners=[]}_triggerEvent(e,...t){if(this._handlers.hasOwnProperty(e))for(let i of this._handlers[e])i.apply(this,t)}addEventListener(e,t){if("function"!=typeof t)throw new Error("Listener should be a function");return this._handlers.hasOwnProperty(e)||(this._handlers[e]=[]),this._handlers[e].push(t),{dispose:this.removeEventListener.bind(this,e,t)}}removeEventListener(e,t){if(!this._handlers.hasOwnProperty(e))return;t||delete this._handlers[e];let i=this._handlers[e].indexOf(t);i>=0&&this._handlers[e].splice(i,1)}subscribe(e,t,i){let r=e.addEventListener(t,i);this._listeners.push(r)}unsubscribe(){this._listeners.forEach((e=>{e.dispose()}))}},D=class extends P{get ready(){return!0}setParticipantIdRegistry(e){}requestRealloc(){}setEndpoint(e){}setConversationId(e){}readyToSend(e=!0){}cleanup(){}requestTestMode(e,t){}getNextCommandSequenceNumber(){return 0}},O=((r=O||{}).CANCELED="CANCELED",r.REJECTED="REJECTED",r.REMOVED="REMOVED",r.HUNGUP="HUNGUP",r.MISSED="MISSED",r.BUSY="BUSY",r.FAILED="FAILED",r.NETWORK_ERROR="NETWORK_ERROR",r.KILLED="KILLED",r.BANNED="BANNED",r.HAS_ACTIVE_CALL="HAS_ACTIVE_CALL",r.CALLER_IS_BLOCKED="CALLER_IS_BLOCKED",r.NOT_FRIENDS="NOT_FRIENDS",r.CALLEE_IS_OFFLINE="CALLEE_IS_OFFLINE",r.CALLER_IS_REJECTED="CALLER_IS_REJECTED",r.UNKNOWN_ERROR="UNKNOWN_ERROR",r.UNSUPPORTED="UNSUPPORTED",r.OLD_VERSION="OLD_VERSION",r.SERVICE_DISABLED="SERVICE_DISABLED",r.EXTERNAL_API_ERROR="EXTERNAL_API_ERROR",r.SOCKET_CLOSED="SOCKET_CLOSED",r.ENDED="ENDED",r.KILLED_WITHOUT_DELETE="KILLED_WITHOUT_DELETE",r.ANOTHER_DEVICE="ANOTHER_DEVICE",r.NOT_FOUND="NOT_FOUND",r.VCHAT_DETAILED_ERROR="VCHAT_DETAILED_ERROR",r),b=O,N=class extends Error{constructor(e,t){var i;super(),this.name="HangupReason",this.code=t&&t.code||0,this.remote=t&&t.remote||!1,this.custom_error=null!=(i=null==t?void 0:t.custom_error)?i:null,Object.values(b).indexOf(e)>-1?this.hangup=e:this.error=e;let r=[];this.error&&r.push("error"),this.remote&&r.push("remote"),this.code&&r.push(`code: ${this.code}`),t&&t.message&&r.push(`message: '${t.message}'`),this.message=e+(r.length?` (${r.join(", ")})`:""),Error.captureStackTrace&&Error.captureStackTrace(this,N)}},w=class extends A{constructor(e,t){super(),this._batchInterval=3e3,this._batchedLogItems=[],this._batchedClientStats=[],this._batchedClientEvents=[],this._batchTimeout=null,this._serverTimeDelta=0,this._api=e,this._externalLogger=t,this._calculateServerTimeDelta()}_sendLogItems(e){this._api.log(e)}_sendClientStats(e){this._api.logClientStats(e)}_sendClientEvents(e){this._api.logClientEvents(e)}_sendBatch(){this._stopTimeout();let e=!1;this._batchedLogItems.length>0&&(this._sendLogItems(this._batchedLogItems),this._batchedLogItems=[],e=!0),this._batchedClientStats.length>0&&(this._sendClientStats(this._batchedClientStats),this._batchedClientStats=[],e=!0),this._batchedClientEvents.length>0&&(this._sendClientEvents(this._batchedClientEvents),this._batchedClientEvents=[],e=!0),e&&this._startTimeout()}_startTimeout(){this._batchTimeout=window.setTimeout((()=>this._sendBatch()),this._batchInterval)}_stopTimeout(){this._batchTimeout&&(clearTimeout(this._batchTimeout),this._batchTimeout=null)}_calculateServerTimeDelta(){return R(this,null,(function*(){try{let e=yield this._api.getServerTime();this._serverTimeDelta=Date.now()-e}catch(e){}}))}_now(){return Date.now()-this._serverTimeDelta}log(e,t,i=!1){let r={};void 0!==t&&(r.param=t),this._logInternal(e,r,i),this._externalLogger&&this._externalLogger.log(e,t,i)}logCustom(e,t,i=!1){this._logInternal(e,t,i)}logClientStats(e,t=!1){let i=Object.assign(e,{vcid:Ur.id(),timestamp:this._now()});Object.keys(i).forEach((e=>{void 0===i[e]&&delete i[e]})),this._batchedClientStats.push(i),(t||!this._batchTimeout)&&this._sendBatch()}logClientEvent(e,t=!1){let i=Object.assign(e,{vcid:Ur.id(),timestamp:this._now()});this._batchedClientEvents.push(i),(t||!this._batchTimeout)&&this._sendBatch()}_logInternal(e,t,i){let r={type:1,time:0,operation:e,timestamp:this._now(),custom:Object.assign(t,{vcid:Ur.id()}),uid:this._api.getUserId()};this._batchedLogItems.push(r),(i||!this._batchTimeout)&&this._sendBatch()}destroy(){this._sendBatch(),this._stopTimeout(),this._externalLogger&&this._externalLogger.destroy()}static create(e,t){w._instance||(w._instance=new w(e,t))}static log(e,t,i=!1){w._instance&&w._instance.log(e,t,i)}static logCustom(e,t,i=!1){w._instance&&w._instance.logCustom(e,t,i)}static logClientStats(e,t=!1){w._instance&&w._instance.logClientStats(e,t)}static logClientEvent(e,t=!1){w._instance&&w._instance.logClientEvent(e,t)}static destroy(){w._instance&&w._instance.destroy(),w._instance=null}},M=((n=M||{}).RECOVER="recover",n.ACCEPT_CALL="accept-call",n.ADD_PARTICIPANT="add-participant",n.REMOVE_PARTICIPANT="remove-participant",n.HANGUP="hangup",n.TRANSMIT_DATA="transmit-data",n.ACCEPT_PRODUCER="accept-producer",n.ALLOCATE_CONSUMER="allocate-consumer",n.CHANGE_MEDIA_SETTINGS="change-media-settings",n.CHANGE_PARTICIPANT_STATE="change-participant-state",n.CHANGE_STREAM_PRIORITIES="change-streams-priorities",n.UPDATE_DISPLAY_LAYOUT="update-display-layout",n.REPORT_PERF_STAT="report-perf-stat",n.REPORT_SHARING_STAT="report-sharing-stat",n.REPORT_NETWORK_STAT="report-network-stat",n.RECORD_START="record-start",n.RECORD_STOP="record-stop",n.RECORD_PUBLISH="record-publish",n.RECORD_SET_CONF="record-set-conf",n.RECORD_GET_STATUS="record-get-status",n.SWITCH_MICRO="switch-micro",n.SWITCH_TOPOLOGY="switch-topology",n.REQUEST_REALLOC="request-realloc",n.CHAT_MESSAGE="chat-message",n.CHAT_HISTORY="chat-history",n.CUSTOM_DATA="custom-data",n.GRANT_ROLES="grant-roles",n.MUTE_PARTICIPANT="mute-participant",n.ENABLE_FEATURE_FOR_ROLES="enable-feature-for-roles",n.PIN_PARTICIPANT="pin-participant",n.UPDATE_MEDIA_MODIFIERS="update-media-modifiers",n.CHANGE_OPTIONS="change-options",n.GET_WAITING_HALL="get-waiting-hall",n.GET_PARTICIPANT_LIST_CHUNK="get-participant-list-chunk",n.GET_PARTICIPANTS="get-participants",n.PROMOTE_PARTICIPANT="promote-participant",n.REQUEST_TEST_MODE="request-test-mode",n.ADD_MOVIE="add-movie",n.UPDATE_MOVIE="update-movie",n.REMOVE_MOVIE="remove-movie",n.START_URL_SHARING="start-url-sharing",n.STOP_URL_SHARING="stop-url-sharing",n.GET_ROOMS="get-rooms",n.UPDATE_ROOMS="update-rooms",n.ACTIVATE_ROOMS="activate-rooms",n.REMOVE_ROOMS="remove-rooms",n.SWITCH_ROOM="switch-room",n.FEEDBACK="feedback",n.ASR_START="asr-start",n.ASR_STOP="asr-stop",n.REQUEST_ASR="request-asr",n.REQUEST_PROMOTION="request-promotion",n.ACCEPT_PROMOTION="accept-promotion",n.GET_HAND_QUEUE="get-hand-queue",n.ENABLE_VIDEO_SUSPEND="enable-video-suspend",n.ENABLE_VIDEO_SUSPEND_SUGGEST="enable-video-suspend-suggest",n.PUT_HANDS_DOWN="put-hands-down",n),k=M,L=((a=L||{}).MIC_CAMERA_PERMISSION="mic_camera",a.CAMERA_PERMISSION="camera",a.MIC_PERMISSION="mic",a.CAMERA_ACCESS="cameralock",a.MIC_ACCESS="miclock",a.MIC_NOT_FOUND="nomic",a.SCREEN_PERMISSION="screenpermission",a.SCREEN_ACCESS="screenlock",a.CONNECTION="connection",a.NETWORK="network",a.UNKNOWN="unknown",a.UNSUPPORTED="unsupported",a.SIGNALING_FAILED="signalingfailed",a.API="api",a.AUTH="auth",a.OVERCONSTRAINED="overconstrained",a),U=L,x=((s=x||{}).AUDIO="AUDIO",s.VIDEO="VIDEO",s.SCREEN_SHARING="SCREEN_SHARING",s.MOVIE_SHARING="MOVIE_SHARING",s.AUDIO_SHARING="AUDIO_SHARING",s.ANIMOJI="ANIMOJI",s),V=x,B=((o=B||{}).ERROR="callError",o.DEVICES="callDevices",o.CALL_SPEC_ERROR="callSpecError",o.ICE_CONNECTION_STATE="callIceConnectionState",o.ICE_CONNECTION_TYPE="callIceConnectionType",o.ICE_RESTART="callIceRestart",o.PUSH="callPush",o.OUTGOING_CALL="callStart",o.OUTGOING_MULTIPARTY_CALL="callStartMultiparty",o.JOIN_CONVERSATION="callJoinConversation",o.ACCEPTED_OUTGOING="callAcceptedOutgoing",o.ACCEPT_INCOMING="callAcceptIncoming",o.DECLINE_INCOMING="callDeclineIncoming",o.ACCEPT_CONCURRENT="callAcceptConcurrent",o.HANGUP="callHangup",o.MEDIA_STATUS="callMediaStatus",o.DEVICE_CHANGED="callDeviceChanged",o.SOCKET_ACTION="callSocketAction",o.ADD_PARTICIPANT="callAddParticipant",o.REMOVE_PARTICIPANT="callRemoveParticipant",o.POOR_CONNECTION="callPoorConnection",o.TOPOLOGY_CHANGE_REQUESTED="callTopologyChangeRequested",o.RELAY_POLICY="callForceRelay",o.PAT_ALLOCATED="patAllocate",o.PAT_DEALLOCATED="patDeallocate",o.PAT_ERROR="patError",o.PAT_WAITING_TIME_ERROR="patWaitingTimeError",o.PAT_OUTDATED_RESPONSE="patOutdatedResponse",o.SIGNALING_CONNECTED="signaling_connected",o.RECONNECT="callReconnect",o.SCREENSHARE_FIRST_FRAME="screen_share_first_frame",o.SCREENSHARE_FREEZE_DURATION="callScreenshareFreezeDuration",o.FIRST_MEDIA_RECEIVED="first_media_received",o.CALL_EVENTUAL_STAT="callEventualStat",o.CALL_DECLINED_OR_HANGED_LOCALLY="CallDeclinedOrHangedLocally",o.USER_FEEDBACK_RECEIVED="UserFeedbackReceived",o),F=B,j=class{constructor(){this._worker=null}_createWorker(e,t){return R(this,arguments,(function*(e,t,i=[],r={},n=[]){return new Promise(((a,s)=>{let o=i.join(","),c=new Blob([e,`exports.default(${o});`],{type:"application/javascript; charset=utf-8"}),l=window.URL.createObjectURL(c);this._worker=new Worker(l),this._worker.onmessage=e=>{switch(e.data.type){case"ready":a();break;case"error":s(e.data.error);break;case"frame":t(e.data);break;case"debug":li.debug(e.data.message);break;case"log_error":w.log(F.ERROR,e.data.message)}},this._sendToWorker("init",r,n)}))}))}_removeWorker(){var e;null==(e=this._worker)||e.terminate(),this._worker=null}_sendToWorker(e,t={},i=[]){var r;null==(r=this._worker)||r.postMessage(Object.assign({type:e},t),i)}static isBrowserSupported(){throw new Error("Not implemented")}},G=class extends j{init(e,t){return R(this,null,(function*(){li.debug("LibVPxDecoder started"),yield this._createWorker('"use strict";var exports=(()=>{var d=Object.defineProperty;var y=Object.getOwnPropertyDescriptor;var x=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var R=(o,t)=>{for(var e in t)d(o,e,{get:t[e],enumerable:!0})},h=(o,t,e,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of x(t))!E.call(o,s)&&s!==e&&d(o,s,{get:()=>t[s],enumerable:!(a=y(t,s))||a.enumerable});return o};var V=o=>h(d({},"__esModule",{value:!0}),o);var D={};R(D,{default:()=>M});var M=(o,t)=>{let e=null,a=null,s=!0;function c(){return o({locateFile:t}).then(r=>a=r)}function f(r,u,n,m){if(!a){self.postMessage({type:"log_error",message:"decoder-init-fail-libvpx"}),self.postMessage({type:"frame",error:"Fatal initialization error"});return}if(s!==n&&(s=n,e&&(e=null,self.postMessage({type:"debug",message:`LibVPxDecoder codec changed to ${n?"VP9":"VP8"} - reinitialize`}))),!e&&(self.postMessage({type:"debug",message:`LibVPxDecoder codec ${n?"VP9":"VP8"}`}),e=new a.VpxDecoder,e.debug(m),!e.init(n?a.VpxType.VP9:a.VpxType.VP8))){e=null,self.postMessage({type:"frame",error:"Decoder failed to create"});return}try{e.allocateBuffer(u.byteLength).set(new Uint8Array(u))}catch(i){self.postMessage({type:"debug",message:i}),e=null,self.postMessage({type:"frame",error:String(i)});return}if(!(e.decode()&&e.nextImage())){self.postMessage({type:"frame",error:"Decode failed"});return}let l=e.getImageBuffer();if(!l){self.postMessage({type:"frame",error:"No decoded data"});return}let b=e.getImageWidth(),g=e.getImageHeight();e.nextImage()&&(self.postMessage({type:"debug",message:"LibVPxDecoder dropped frame"}),self.postMessage({type:"log_error",message:"LibVPxDecoder-drop"}));let p=new Uint8ClampedArray(l.byteLength);p.set(l),self.postMessage({type:"frame",data:p.buffer,width:b,height:g},[p.buffer])}c().then(()=>{self.onmessage=r=>{switch(r.data.type){case"frame":f(r.data.timestamp,r.data.data,r.data.isVP9,r.data.debug);break}},self.postMessage({type:"ready"})}).catch(r=>{self.postMessage({type:"error",error:String(r)})})};return V(D);})();\n',(i=>{if(i.error)li.warn("LibVPxDecoder",i.error),t(i.error);else{let t=new ImageData(new Uint8ClampedArray(i.data),i.width,i.height);e(t)}}),[h(),h().getUrl])}))}decodeFrame(e,t,i,r){this._sendToWorker("frame",{timestamp:e,data:t.buffer,isVP9:i,keyFrame:r,debug:li.enabled()},[t.buffer])}destroy(){this._removeWorker(),li.debug("LibVPxDecoder destroyed")}static isBrowserSupported(){return"WebAssembly"in window&&"Worker"in window}},H=class extends j{init(e,t){return R(this,null,(function*(){li.debug("WebCodecsDecoder started"),yield this._createWorker('"use strict";var exports=(()=>{var c=Object.defineProperty;var D=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var y=Object.prototype.hasOwnProperty;var C=(t,e)=>{for(var n in e)c(t,n,{get:e[n],enumerable:!0})},A=(t,e,n,a)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of R(e))!y.call(t,o)&&o!==n&&c(t,o,{get:()=>e[o],enumerable:!(a=D(e,o))||a.enumerable});return t};var V=t=>A(c({},"__esModule",{value:!0}),t);var F={};C(F,{default:()=>k});var k=t=>{let e=null,n=!0,a=null,o=!1,f=1e3/15*2;function p(){self.postMessage({type:"ready"})}function m(r,b,s,i=!1){if(!e||n!==s){if(!i){self.postMessage({type:"frame",error:"WebCodecsDecoder dropped frame - waiting for keyframe"});return}n=s,e?self.postMessage({type:"debug",message:`WebCodecsDecoder codec changed to ${s?"VP9":"VP8"}`}):(self.postMessage({type:"debug",message:`WebCodecsDecoder codec ${s?"VP9":"VP8"}`}),e=new VideoDecoder({output:d=>{l();let g=t?[d]:[];self.postMessage({type:"frame",data:d},g),d.close()},error:d=>{l(),e&&e.state!=="closed"&&e.close(),e=null,self.postMessage({type:"frame",error:"WebCodecsDecoder failed, reinitialize: "+String(d)})}})),e.configure(u(s))}if(o&&!i){self.postMessage({type:"frame",error:"WebCodecsDecoder dropped frame after reset - waiting for keyframe"});return}o=!1;let E=new EncodedVideoChunk({type:i?"key":"delta",timestamp:r,data:b});e.decode(E),a=setTimeout(()=>{o=!0,e==null||e.reset(),e==null||e.configure(u(s)),self.postMessage({type:"frame",error:"WebCodecsDecoder reset because of decode timeout"})},f)}self.onmessage=r=>{switch(r.data.type){case"init":p();break;case"frame":m(r.data.timestamp,r.data.data,r.data.isVP9,r.data.keyFrame);break}};function l(){a&&clearTimeout(a),a=null}function u(r){return{codec:r?"vp09.00.50.08":"vp8"}}};return V(F);})();\n',(i=>{i.error?(li.warn("WebCodecsDecoder",i.error),t(i.error)):(e(i.data),i.data.close())}),[jt.baseChromeVersion()>=92||"Safari"===jt.browserName()])}))}decodeFrame(e,t,i,r=!1){this._sendToWorker("frame",{timestamp:e,data:t.buffer,isVP9:i,keyFrame:r},[t.buffer])}destroy(){this._removeWorker(),li.debug("WebCodecsDecoder destroyed")}static isBrowserSupported(){return"VideoDecoder"in window&&"Worker"in window&&"VideoFrame"in window&&!jt.isBrokenVP9Decoder()&&"Firefox"!==jt.browserName()}},W=class{constructor(e=null,t=0){this._counter=0,this._interval=0,this._lastCalculationTime=Date.now(),this._onCalculated=null,this._onCalculated=e,t&&(this._interval=window.setInterval((()=>this.calculate()),t))}increment(e=1){this._counter+=e}calculate(){var e;let t=Date.now(),i=t-this._lastCalculationTime,r=Math.round(1e3*this._counter/i);return this._counter=0,this._lastCalculationTime=t,null==(e=this._onCalculated)||e.call(this,r),r}destroy(){window.clearInterval(this._interval),this._interval=0}},$=((c=$||{}).USER="USER",c.GROUP="GROUP",c),K=$,z="function"==typeof Object.fromEntries?Object.fromEntries:function(e){if(!e||!e[Symbol.iterator])throw new Error("Object.fromEntries() requires a single iterable argument");let t={};for(let[i,r]of e)t[i]=r;return t};var q,J=":",Y="a=fmtp:";(e=>{let t=/[\r\n]+/,i="\r\n";function r(e,t){let i,r=new RegExp("a=rtpmap:(\\d+) ([a-zA-Z0-9-]+)\\/\\d+"),n=[];for(i=0;i<e.length;++i){let a=e[i].match(r);a&&3===a.length&&a[2]===t&&n.push(a[1])}return n}function n(e,t,i){let r,n=e.split(" "),a=n.slice(0,3);for(r=3;r<n.length;r++)i.includes(n[r])&&a.push(n[r]);for(r=3;r<n.length;r++)!i.includes(n[r])&&!t.includes(n[r])&&a.push(n[r]);return a.join(" ")}function a(e,t,i,r){let a,s="m="+t;for(a=0;a<e.length;++a)e[a].startsWith(s)&&(e[a]=n(e[a],i,r))}function s(e,t){let i=r(e,t);if(!i.length)return;let n,s=i.slice(0),o=new RegExp(Y+"(\\d+) apt=(\\d+)");for(n=0;n<e.length;++n){let t=e[n].match(o);t&&3===t.length&&s.includes(t[2])&&s.push(t[1])}let c=new RegExp("a=(rtpmap|rtcp-fb|fmtp):(\\d+) .*");for(n=e.length;n--;){let t=e[n].match(c);t&&3===t.length&&s.includes(t[2])&&e.splice(n,1)}a(e,"video",s,[])}function o(e,t,i,r){let a=function(e,t,i,r){let n,a=new RegExp("a=rtpmap:(\\d+) ([a-zA-Z0-9-]+)\\/\\d+"),s=[];for(n=t;n<i;++n){let t=e[n].match(a);t&&3===t.length&&t[2]===r&&s.push(t[1])}if(!s.length)return s;let o=new RegExp(Y+"(\\d+) apt=(\\d+)");for(n=t;n<i;++n){let t=e[n].match(o);t&&3===t.length&&s.includes(t[2])&&s.push(t[1])}return s}(e,t,i,r);if(!a.length)return i+1;let s=new RegExp("a=(rtpmap|rtcp-fb|fmtp):(\\d+) .*"),o=0,c=i;for(;c>=t;){let t=e[c].match(s);t&&3===t.length&&a.includes(t[2])&&(e.splice(c,1),o++),c--}return e[t]=n(e[t],a,[]),i-o+1}function c(e,t,i,r){let n=-1,a=-1,s=!1;for(let c=0;c<e.length;++c)if(n>=0&&e[c].startsWith("m=")&&(a=c-1,s&&(c=o(e,n,a,t)),n=-1,a=-1,s=!1),e[c].startsWith("m=video")&&(n=c),n>=0){let t="remote"===i&&"encoder"===r||"local"===i&&"decoder"===r?"recvonly":"sendonly";(e[c].startsWith(`a=${t}`)||e[c].startsWith("a=sendrecv"))&&(s=!0)}a=e.length-1,n>=0&&s&&o(e,n,a,t)}function l(e,t,i){let n=r(e,"H264");t&&a(e,"video",[],n),i&&function(e,t){let i=new RegExp(Y+"(\\d+)");for(let r=0;r<e.length;++r){let n=e[r].match(i);if(n&&2===n.length&&t.includes(n[1])){let t=e[r].trim()===Y+n[1]?" ":";";e[r]+=t+"sps-pps-idr-in-keyframe=1"}}}(e,n)}function d(e){a(e,"video",[],r(e,"VP9"))}e.patchLocalSDP=function(e,n,s,o,u,h=!1,p=!1){if(!(n||s||o||p||h||u))return e;let _=e.split(t);return s?c(_,"H264","local","decoder"):(n||u)&&l(_,n,u),o&&d(_),p&&function(e){let t=r(e,"red");t.length>0&&a(e,"audio",[],t)}(_),h&&function(e){let t=e.findIndex((e=>e.startsWith("a=rtcp-fb:111")));~t&&(e[t]=e[t]+i+["a=rtcp-fb:111 nack","a=rtcp-fb:111 nack pli"].join(i))}(_),_.join(i)},e.patchRemoteSDP=function(e,r,n,a,o,u,h){r&&(e=e.replace("m=application 9 UDP/DTLS/SCTP webrtc-datachannel","m=application 9 DTLS/SCTP 5000").replace("a=sctp-port:5000","a=sctpmap:5000 webrtc-datachannel 256"));let p=e.split(t);return a?s(p,"H264"):n&&l(p,n,!1),u&&h?s(p,"VP9"):u?c(p,"VP9","remote","encoder"):h?c(p,"VP9","remote","decoder"):o&&d(p),p.join(i)},e.getPeerIdString=function(e){return e?`${e.type||"WEB_SOCKET"}_${e.id}`:"_"},e.comparePeerId=function(e,t){return e&&e.id===t.id&&(e.type||"WEB_SOCKET")===(t.type||"WEB_SOCKET")},e.getPeerConnectionHostInfo=function(e){return R(this,null,(function*(){let t={local:null,remote:null};if(!e||!e.getStats)return t;try{let i=yield e.getStats(null),r=null;if(i.forEach((e=>{"transport"===e.type&&e.selectedCandidatePairId?r=i.get(e.selectedCandidatePairId):"candidate-pair"===e.type&&"succeeded"===e.state&&!r&&(!e.hasOwnProperty("selected")||e.selected)&&(r=e)})),null!=r&&r.localCandidateId){let e=i.get(r.localCandidateId);e&&(t.local={type:e.candidateType,ip:e.ip||e.ipAddress,port:e.port||e.portNumber})}if(null!=r&&r.remoteCandidateId){let e=i.get(r.remoteCandidateId);e&&(t.remote={type:e.candidateType,ip:e.ip||e.ipAddress,port:e.port||e.portNumber})}return t}catch(e){return t}}))};let u=/^[0-9]+$/,h=/^([gu])([0-9]+)$/;function p(e,t=K.USER){let i=String(e);return h.test(i)?(li.warn(`Already composite id [${e}] type supplied [${t}]`),i):t===K.GROUP?"g"+i:t===K.USER?"u"+i:(li.warn(`Unknown type [${t}] for id [${e}]`),i.match(u)?"u"+i:i)}function _(e,t,i=0){return m(p(e,t),i)}function m(e,t){return t?e+J+"d"+t:e}function f(e){return _(e.id,e.idType||K.USER,e.deviceIdx)}function g(e){let t=String(e),i=t.match(h);return i?{id:Number(i[2]),type:"g"===i[1]?K.GROUP:K.USER}:(li.warn(`Unsupported compositeId [${e}]`),{id:Number(t),type:K.USER})}function S(e){let t=e.split(":d");return{compositeUserId:t[0],deviceIdx:t.length>1?parseInt(t[1],10):0}}function v(e,t,i,r,n){var a;if(!(RTCRtpSender.prototype.getParameters&&RTCRtpSender.prototype.setParameters&&e&&i&&"video"===i.kind))return;let s=i.getSettings();if(!s)return;let o=e.maxBitrateK?1024*e.maxBitrateK:null,c=s.width,l=s.height,d=c&&l&&e.maxDimension?Math.max(1,Math.max(c,l)/e.maxDimension):null,u=e.maxFramerate||null;if(c&&l&&e.maxDimension&&e.maxDimension>Math.max(c,l)){let e=Math.round(c*l/256),t=1e4*(Math.round(533*e/1e4)+1);o=null===o?t:Math.min(t,o)}let h=e.degradationPreference||"balanced",p=r[i.id];if(p&&p.bitrate===o&&p.scaleResolutionDownBy===d&&p.maxFramerate===u&&p.degradationPreference===h)return void(n[i.id]=p);n[i.id]={bitrate:o,scaleResolutionDownBy:d,maxFramerate:u,degradationPreference:h};let _=t.getParameters();_.encodings||(_.encodings=[{}]),_.encodings.forEach((t=>{e.scalabilityMode&&(t.scalabilityMode=e.scalabilityMode),o?t.maxBitrate=o:delete t.maxBitrate,d?t.scaleResolutionDownBy=d:delete t.scaleResolutionDownBy,u?t.maxFramerate=u:delete t.maxFramerate})),_.degradationPreference=h,null==(a=t.setParameters)||a.call(t,_).catch((e=>{li.error("Failed to set sender parameters",_,e)}))}e.composeUserId=p,e.composeParticipantId=_,e.compose=m,e.composeId=f,e.composeDecorativeId=function(e){if(e.decorativeUserId)return _(e.decorativeUserId,e.idType||K.USER,e.deviceIdx)},e.composeMessageId=function(e){return e.participant?f(e.participant):_(e.participantId,e.participantType||K.USER,e.deviceIdx)},e.extractOkId=function(e){return"string"==typeof e?g(S(e).compositeUserId).id:e},e.decomposeId=g,e.decomposeParticipantId=S,e.uuid=function(){var e,t;let i=null==(t=null==(e=window.crypto)?void 0:e.randomUUID)?void 0:t.call(e);if(i)return i;let r,n,a="0123456789abcdefghijklmnopqrstuvwxyz".split(""),s=new Array(36),o=0;for(n=0;n<36;n++)8===n||13===n||18===n||23===n?s[n]="-":14===n?s[n]="4":(o<=2&&(o=33554432+16777216*Math.random()|0),r=15&o,o>>=4,s[n]=a[19===n?3&r|8:r]);return s.join("")},e.debounce=function(e,t){let i;return function(...r){let n=this;i&&window.clearTimeout(i),i=window.setTimeout((()=>{e.apply(n,r)}),t)}},e.sdpFingerprint=function(e){if(!window.BigInt)return null;let t="",i=e.split("\n");for(let e of i)if(e.startsWith("a=fingerprint")){let i=e.split(" ");if(2===i.length){t=i[1];break}}if(!t)return BigInt(-1);let r=t.split(":"),n=BigInt(0);for(let e=Math.min(7,r.length-1);e>=0;e--){let t=BigInt(parseInt(r[e],16));n<<=BigInt(8),n|=t}return BigInt.asIntN(64,n)},e.delay=function(e){return R(this,null,(function*(){return new Promise((t=>window.setTimeout(t,e)))}))},e.applySettings=function(e,t,i){let r=[];return e.getSenders().forEach((e=>v(t,e,e.track,i,r))),r},e.applyVideoTrackSettings=v,e.includesOneOf=function(e,t){Array.isArray(t)||(t=[t]);for(let i of t)if(e.includes(i))return!0;return!1},e.mapParticipantState=function(e){var t;return Object.entries((null==(t=e.participantState)?void 0:t.state)||{}).reduce(((t,[i,r])=>(e.participantState&&(t[i]={ts:e.participantState.stateUpdateTs[i],state:r}),t)),{})},e.mapSharedParticipants=function(e){let t=e.map((e=>({uid:e.externalId,mediaSettings:e.mediaSettings,status:e.status,muteStates:e.muteStates,unmuteOptions:e.unmuteOptions,participantState:e.participantState,markers:e.markers,movieShareInfos:e.movieShareInfos})));return Ve.filterObservers?t.filter((e=>!e.uid.observer)):t},e.isEqualParticipantState=function(e,t){let i=Object.keys(e),r=Object.keys(t);if(i.length!==r.length)return!1;for(let n of i)if(!r.hasOwnProperty(n)||e[n].state!==t[n].state||e[n].ts!==t[n].ts)return!1;return!0},e.isObjectsEquals=function(e,t){let i=Object.keys(e),r=Object.keys(t);if(i.length!==r.length)return!1;for(let r of i)if(!t.hasOwnProperty(r)||e[r]!==t[r])return!1;return!0},e.isArraysEquals=function(e,t){if(e.length!==t.length)return!1;for(let i of e)if(t.indexOf(i)<0)return!1;return!0},e.isEmptyObject=function(e){return!Object.keys(e).length},e.participantMarkerCompare=function(e,t){return e||t?e&&t?i(t.rank,e.rank)||i(e.ts,t.ts)||function(e,t){let r={[K.USER]:0,[K.GROUP]:1},{compositeUserId:n,deviceIdx:a}=S(e.id),{compositeUserId:s,deviceIdx:o}=S(t.id),{id:c,type:l}=g(n),{id:d,type:u}=g(s);return i(r[l],r[u])||i(c,d)||i(a,o)}(e,t):e?-1:1:0;function i(e,t){return e<t?-1:e===t?0:1}},e.objectFilterOutValues=function(e,t){let i=Object.entries(e).filter((([,e])=>Array.isArray(t)?!t.includes(e):e!==t));return z(i)},e.objectReduce=function(e,t,i){let r=i;for(let i in e)e.hasOwnProperty(i)&&(r=t(r,e[i],i));return r},e.setImmediate=(()=>{let e=1,t={},i=null;return"undefined"!=typeof MessageChannel&&(i=new MessageChannel,i.port1.onmessage=e=>{let i=e.data;t[i]&&(t[i](),delete t[i])}),function(r){if(i&&"hidden"===document.visibilityState){let n=e;return e=e>=Number.MAX_SAFE_INTEGER?1:e+1,t[n]=r,i.port2.postMessage(n),()=>{t[n]&&delete t[n]}}let n=setTimeout(r,0);return()=>clearTimeout(n)}})(),e.isObject=function(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)}})(q||(q={}));var Q=q;function X(e,t,i=0){return t in e&&e[t]?e[t]:i}function Z(...e){return t=>{for(let i of e)if(i(t))return!0;return!1}}function ee(e,t){return i=>i[e]===t}function te(e,t){return t.reduce(((t,i)=>(t[i[e]]=i,t)),{})}function ie(e){let t={},i=[];for(let r of e)t[r.id]||(t[r.id]=!0,i.push(r));return i}function re(e){return Object.keys(e).filter((t=>void 0!==e[t])).map((t=>[t,e[t]])).reduce(((e,t)=>(e[t[0]]=Q.isObject(t[1])?re(t[1]):t[1],e)),{})}function ne(e){let t=[];for(let i of e)i.forEach((e=>t.push(e)));return t}function ae(e){let t=e.filter(ee("type","candidate-pair")).sort(function(e){return(t,i)=>i[e]-t[e]}("priority")).find(Z(ee("nominated",!0),ee("selected",!0)));if(!t)return{timestamp:0,availableOutgoingBitrate:0,totalRoundTripTime:0,currentRoundTripTime:0,bytesSent:0,bytesReceived:0};let i={timestamp:t.timestamp,availableOutgoingBitrate:t.availableOutgoingBitrate||0,totalRoundTripTime:t.totalRoundTripTime||0,currentRoundTripTime:t.currentRoundTripTime||0,bytesSent:t.bytesSent||0,bytesReceived:t.bytesReceived||0},r=e.find(ee("id",t.remoteCandidateId));r&&Object.assign(i,{remote:{type:r.candidateType,address:r.ip||r.address,port:r.port,protocol:r.protocol}});let n=e.find(ee("id",t.localCandidateId));return n&&Object.assign(i,{local:{type:n.candidateType,address:n.ip||n.address,port:n.port,protocol:n.protocol,relayProtocol:n.relayProtocol,networkType:n.networkType}}),re(i)}function se(e,t,i=!1){let r=te("id",e),n=i?e.filter(Z(ee("type","remote-inbound-rtp"))):e.filter(Z(ee("type","inbound-rtp"),ee("type","outbound-rtp")));return"Firefox"===jt.browserName()&&(n=Object.values(n.reduce(((e,t)=>{if(e[t.ssrc]){let i=Object.assign({},e[t.ssrc],t),r=e[t.ssrc].isRemote?t:e[t.ssrc];i.id=r.id,i.type=r.type,delete i.isRemote,delete i.remoteId,e[i.ssrc]=i}else e[t.ssrc]=t;return e}),{}))),n.map((e=>{let i=Number(e.ssrc),n=e.mediaType||e.kind,a=e.remoteId||e.trackId,s=e.type,o=e.codecId;if(!s||!i||!n)return null;let c={ssrc:i,type:s,kind:n,bytesReceived:X(e,"bytesReceived"),bytesSent:X(e,"bytesSent"),headerBytesReceived:X(e,"headerBytesReceived"),headerBytesSent:X(e,"headerBytesSent"),jitter:X(e,"jitter"),packetsLost:X(e,"packetsLost"),packetsReceived:X(e,"packetsReceived"),packetsSent:X(e,"packetsSent"),fractionLost:X(e,"fractionLost"),pliCount:X(e,"pliCount"),firCount:X(e,"firCount"),nackCount:X(e,"nackCount"),userId:t[i],freezeCount:X(e,"freezeCount",0),totalFreezesDuration:X(e,"totalFreezesDuration",0)};if("video"===n){let t=X(e,"framesDecoded"),i=X(e,"totalInterFrameDelay"),r=X(e,"totalSquaredInterFrameDelay");c.interframeDelayVariance=(r-i*i/t)/t}if("audio"===n&&(c.totalSamplesReceived=X(e,"totalSamplesReceived"),c.concealedSamples=X(e,"concealedSamples"),c.insertedSamplesForDeceleration=X(e,"insertedSamplesForDeceleration"),c.removedSamplesForAcceleration=X(e,"removedSamplesForAcceleration"),c.silentConcealedSamples=X(e,"silentConcealedSamples"),c.concealmentEvents=X(e,"concealmentEvents"),c.totalAudioEnergy=X(e,"totalAudioEnergy")),o&&r[o]){let e=r[o];c.clockRate=e.clockRate,c.mimeType=e.mimeType}if(a&&r[a]){let e=r[a];c.frameHeight=e.frameHeight,c.frameWidth=e.frameWidth,c.framesDecoded=e.framesDecoded,c.framesReceived=e.framesReceived,c.framesDropped=e.framesDropped}return re(c)})).filter((e=>!!e))}function oe(e,t){return R(this,arguments,(function*(e,t,i={},r=!1){let n=yield function(e){return R(this,null,(function*(){let t=[];return RTCRtpReceiver.prototype.getStats?(t.push(...e.getReceivers().map((e=>e.getStats()))),t.push(...e.getSenders().map((e=>e.getStats())))):t.push(e.getStats()),Promise.all(t).then(ne).then(ie)}))}(e),a={timestamp:Date.now(),transport:ae(n),rtps:se(n,i)};return r&&(a.remoteRtps=se(n,i,!0)),t?function(e,t,i=!1){if(!t||!t.rtps||!e.rtps)return e;let r,n;i&&(r=te("ssrc",(null==e?void 0:e.remoteRtps)||[]),n=te("ssrc",(null==t?void 0:t.remoteRtps)||[]));let a=te("ssrc",e.rtps),s=te("ssrc",t.rtps),o=(e.timestamp-t.timestamp)/1e3;return!a||!s||Object.keys(a).forEach((c=>{let l=a[c],d=s[c];if(l&&d){if(l.bytesReceived&&l.bytesReceived>d.bytesReceived&&(l.bandwidth=Math.round((l.bytesReceived-d.bytesReceived)/o),l.bandwidth+=Math.round((l.headerBytesReceived-d.headerBytesReceived)/o)),l.bytesSent&&l.bytesSent>d.bytesSent&&(l.bandwidth=Math.round((l.bytesSent-d.bytesSent)/o),l.bandwidth+=Math.round((l.headerBytesSent-d.headerBytesSent)/o)),l.packetsReceived)if(l.packetsReceived>d.packetsReceived||l.packetsLost>d.packetsLost){let e=l.packetsLost-d.packetsLost,t=l.packetsReceived-d.packetsReceived;l.packetLoss=parseFloat((100*e/(e+t)).toFixed(2))}else l.packetLoss=0;if(l.freezeCount>d.freezeCount&&(l.freezeCountDelta=l.freezeCount-d.freezeCount),l.totalFreezesDuration>d.totalFreezesDuration){let e=l.totalFreezesDuration-d.totalFreezesDuration;l.totalFreezesDurationDelta=e}if(l.framesDropped&&d.framesDropped&&l.framesDropped>d.framesDropped&&(l.framesDroppedDelta=parseFloat(((l.framesDropped-d.framesDropped)/o).toFixed(0))),i&&"outbound-rtp"===l.type&&"video"===l.kind){let i=null==r?void 0:r[c],a=null==n?void 0:n[c],s=e=>null!=e?e:0,o=Math.max(0,s(null==i?void 0:i.packetsLost)-s(null==a?void 0:a.packetsLost)),u=Math.max(1,l.packetsSent-d.packetsSent);e.transport.averageNetStat={currentRoundTripTime:(e.transport.currentRoundTripTime+t.transport.currentRoundTripTime)/2*1e3,lostPercent:Math.round(o/u*100)}}}})),e}(a,t,r):(yield Q.delay(1e3),oe(e,a,i,r))}))}function ce(e){performance.clearMarks(e),performance.mark(e)}function le(e){performance.clearMarks(e)}function de(e){let t=performance.getEntriesByName(e)[0];if(void 0===t)return null;let i=Math.round(performance.now()-t.startTime);return performance.clearMarks(e),i}function ue(e){return`${F.SCREENSHARE_FIRST_FRAME}_${function(e){return"string"==typeof e?e:JSON.stringify(e)}(e)}`}var he=class{constructor(){this._eventualLogs=new Set}static create(){he._instance=new he}static logCallStat(e){var t;if(null!=(t=he._instance)&&t._eventualLogs.size){for(let t of he._instance._eventualLogs)Object.assign(t,{call_topology:e.call_topology,local_address:e.local_address,local_connection_type:e.local_connection_type,network_type:e.network_type,remote_address:e.remote_address,remote_connection_type:e.remote_connection_type,transport:e.transport}),w.logClientStats(t);he._instance._eventualLogs.clear()}w.logClientStats(e)}static logEventualStat(e){var t;void 0===e.value&&(e.value=de(e.name)),null!==e.value&&(null==(t=he._instance)||t._eventualLogs.add(e))}static destroy(){var e;null==(e=he._instance)||e._destroy(),he._instance=null}_destroy(){this._eventualLogs.clear()}},pe=he;pe._instance=null;var _e=class{constructor(e){this._firstFrameReceived=!1,this._participantId=e}measure(e,t){if(this._firstFrameReceived)return;this._firstFrameReceived=!0;let i=de(ue(this._participantId));null!==i&&pe.logEventualStat({name:F.SCREENSHARE_FIRST_FRAME,value:i,width:e,height:t})}},me=class{constructor(e,t,i){this._chunks=[],this._participantId=e,this._onStream=t,this._onStat=i,this._statScreenShareFirstFrame=new _e(e)}appendChunk(e){let t=this._chunks.length;if(e.start)this._measureFreezeDuration(!1),this._measureFreezeDuration(!0),t&&(li.warn("[FrameBuilder] Cleanup buffer",Array.prototype.slice.call(this._chunks)),this._chunks=[]);else if(!t||(this._chunks[t-1].sequence+1)%65536!==e.sequence)return void li.warn("[FrameBuilder] Got incorrect chunk");if(this._chunks.push(e),e.end){let t=this._processFrameData(),{width:i,height:r}=me.getFrameSize(t);this._processFrame({timestamp:e.timestamp,frameData:t,isVP9:e.isVP9,keyframe:e.keyframe,width:i,height:r}),this._statScreenShareFirstFrame.measure(i,r)}}destroy(){le(F.SCREENSHARE_FREEZE_DURATION),le(ue(this._participantId)),this._chunks=[]}_processFrameData(){let e=this._chunks;this._chunks=[];let t=e.reduce(((e,t)=>e+t.data.byteLength),0),i=new Uint8Array(t),r=0;for(let t of e)i.set(new Uint8Array(t.data),r),r+=t.data.byteLength;return i}static getFrameSize(e){let t={width:0,height:0},i=new p.BitStream(e.buffer);i.bigEndian=!0,i.index+=2;let r=i.readBits(1),n=i.readBits(1)<<1|r;return 3===n&&i.index++,1===i.readBits(1)||0!==i.readBits(1)||(i.index++,i.index++,i.index+=24,n>=2&&i.index++,7!==i.readBits(3)?(i.index++,(1===n||3===n)&&(i.index+=3)):(1===n||3===n)&&i.index++,t.width=i.readBits(16)+1,t.height=i.readBits(16)+1),t}static isBrowserSupported(){throw new Error("Method `isBrowserSupported` is not implemented")}_measureFreezeDuration(e){if(e)return void ce(F.SCREENSHARE_FREEZE_DURATION);let t=de(F.SCREENSHARE_FREEZE_DURATION);null!==t&&t>1e3&&this._onStat({freeze_duration:t})}},fe=class{constructor(e){this._onStream=e}drawFrame(e){return R(this,null,(function*(){throw new Error("Method `drawFrame` is not supported by this implementation")}))}drawImage(e){return R(this,null,(function*(){throw new Error("Method `drawImage` is not supported by this implementation")}))}static isBrowserSupported(){throw new Error("Method `isBrowserSupported` is not implemented")}},ge=class extends fe{constructor(e){super(e),this._canvas=null,this._canvasContext=null,this._stream=null,this._track=null,li.debug("CanvasRenderer started"),this._useImageBitmap="ImageBitmap"in window}_createStream(e,t){this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.width=e,this._canvas.height=t,this._canvas.style.pointerEvents="none",this._canvas.style.visibility="hidden",this._canvas.style.position="absolute",this._canvas.style.width="160px",this._canvas.style.height="90px",this._canvas.style.bottom="0",this._canvas.style.right="0",this._canvas.style.zIndex="5000",document.body.appendChild(this._canvas),this._useImageBitmap?this._canvasContext=this._canvas.getContext("bitmaprenderer"):this._canvasContext=this._canvas.getContext("2d"),this._stream=this._canvas.captureStream(0),this._track=this._stream.getVideoTracks()[0],this._track.contentHint="text")}_removeStream(){this._stream&&(this._stream.getTracks().forEach((e=>e.stop())),this._stream=null,this._track=null),this._canvasContext=null;try{this._canvas&&document.body.removeChild(this._canvas)}catch(e){}this._canvas=null}_requestCanvasFrame(){this._track&&this._track.requestFrame?this._track.requestFrame():this._stream&&this._stream.requestFrame&&this._stream.requestFrame()}_drawImage(e){return R(this,null,(function*(){this._track||(this._createStream(e.width,e.height),this._onStream(this._stream));let t=this._canvas;if(t.width=e.width,t.height=e.height,this._useImageBitmap){let t;t=e instanceof ImageBitmap?e:yield createImageBitmap(e,0,0,e.width,e.height),this._canvasContext.transferFromImageBitmap(t),t.close()}else{let i=this._canvasContext;i.clearRect(0,0,t.width,t.height),i.putImageData(e,0,0)}this._requestCanvasFrame()}))}drawFrame(e){return R(this,null,(function*(){let t="createImageBitmap"in e?yield e.createImageBitmap():yield createImageBitmap(e);yield this._drawImage(t)}))}drawImage(e){return R(this,null,(function*(){yield this._drawImage(e)}))}destroy(){this._removeStream(),li.debug("CanvasRenderer destroyed")}static isBrowserSupported(){return!(!("CanvasCaptureMediaStream"in window)&&!("CanvasCaptureMediaStreamTrack"in window)||"Safari"===jt.browserName()&&15===Number(jt.browserVersion())||"Firefox"===jt.browserName()&&Number(jt.browserVersion())<60)}},Se=class extends fe{constructor(e){super(e),li.debug("TrackGeneratorRenderer started"),this._generator=new MediaStreamTrackGenerator({kind:"video"}),this._writer=this._generator.writable.getWriter(),this._stream=new MediaStream([this._generator]),this._onStream(this._stream)}drawFrame(e){return R(this,null,(function*(){yield this._writer.write(e)}))}destroy(){this._writer.releaseLock(),this._generator.writable.close().then((()=>this._generator.stop())),li.debug("TrackGeneratorRenderer destroyed")}static isBrowserSupported(){return"VideoFrame"in window&&"MediaStreamTrackGenerator"in window&&H.isBrowserSupported()}},ve=class extends me{constructor(e,t,i){super(e,t,i),this._decoderReady=!1,this._decoderBusy=!1,this._decoderQueue=[],li.debug(`StreamBuilder started for participant [${e}]`),Se.isBrowserSupported()?this._renderer=new Se(t):this._renderer=new ge(t),H.isBrowserSupported()?this._decoder=new H:this._decoder=new G;this._decoder.init((e=>R(this,null,(function*(){this._decoderBusy=!1,"VideoFrame"in window&&e instanceof VideoFrame?yield this._renderer.drawFrame(e):yield this._renderer.drawImage(e),this._fpsMeter.increment(),this._decodeQueue()}))),(e=>{this._decoderBusy=!1,this._decodeQueue()})).then((()=>{this._decoderReady=!0,this._decodeQueue()})),this._fpsMeter=new W((t=>li.log(`[StreamBuilder][${e}] fps: ${t}`)),2e4)}_processFrame(e){e.keyframe&&(this._decoderQueue=[]),this._decoderQueue.push(e),this._decodeQueue()}_decodeQueue(){if(!this._decoderReady||this._decoderBusy)return;let e=this._decoderQueue.shift();e&&(this._decoderBusy=!0,this._decoder.decodeFrame(e.timestamp,e.frameData,e.isVP9,e.keyframe))}destroy(){super.destroy(),this._fpsMeter.destroy(),this._decoder.destroy(),this._renderer.destroy(),li.debug(`StreamBuilder destroyed for participant ${this._participantId}`)}static isBrowserSupported(){return ge.isBrowserSupported()||Se.isBrowserSupported()}};var Ee,Te=T(2,15)-1,Ce=class{constructor(e){this._sourceBuffer=null,this._queue=[],this._clearBufferTill=0,this._mediaSource=new MediaSource,this._codec=e;let t=()=>{this._mediaSource.removeEventListener("sourceopen",t),this._initBuffer(),this._handleQueue()};this._mediaSource.addEventListener("sourceopen",t,!1)}_handleQueue(){if(!this._sourceBuffer||this._sourceBuffer.updating||!this._queue.length)return;if(this._clearBufferTill&&this._sourceBuffer.buffered.length){let e=this._sourceBuffer.buffered.start(0);return e<this._clearBufferTill&&(this._sourceBuffer.remove(e,this._clearBufferTill),li.debug(`[WebmBuilder] SourceBuffer cleanup from ${e} to ${this._clearBufferTill}`)),void(this._clearBufferTill=0)}let e=this._queue;this._queue=[];let t=Ce._buildQueue(e);this._sourceBuffer.appendBuffer(t)}static _buildQueue(e){if(!e.length)return new Uint8Array;if(1===e.length)return _.build(e[0]);let t=e.reduce(((e,t)=>e+t.countSize()),0),i=new Uint8Array(t),r=0;for(let t of e){let e=_.build(t);i.set(e,r),r+=e.byteLength}return i}_initBuffer(){this._sourceBuffer=this._mediaSource.addSourceBuffer(`video/webm; codecs="${this._codec}"`),this._sourceBuffer.mode="sequence",this._sourceBuffer.addEventListener("updateend",(()=>this._handleQueue()))}changeType(e){var t;return this._codec=e,null==(t=this._sourceBuffer)?void 0:t.changeType(e)}append(e,t=!1){this._queue.push(e),t&&this._handleQueue()}cleanup(){var e,t,i;"open"===(null==(e=this._mediaSource)?void 0:e.readyState)&&(null==(t=this._sourceBuffer)||t.abort());let r=null==(i=this._sourceBuffer)?void 0:i.buffered,n=null==r?void 0:r.length;if(!n)return;let a=r.start(0),s=Math.max(0,r.end(n-1)-5);s-a>5&&(this._clearBufferTill=s)}destroy(){var e;this._queue=[],"open"===this._mediaSource.readyState&&(null==(e=this._sourceBuffer)||e.abort(),this._mediaSource.endOfStream()),this._sourceBuffer=null,this._clearBufferTill=0}get codec(){return this._codec}get mediaSource(){return this._mediaSource}get buffered(){var e;return null==(e=this._sourceBuffer)?void 0:e.buffered}},ye=class extends me{constructor(e,t,i){super(e,t,i),this._mediaBuffer=null,this._video=null,this._stream=null,this._earliestTimestamp=0,this._clusterStartTime=0,this._lastFrameTimestamp=0,li.debug(`[WebmBuilder] started for participant [${e}]`)}static _intToU16BE(e){return new Uint8Array([e>>8,e])}static _genWebmHeader(){return _.element(_.ID.EBML,[_.element(_.ID.EBMLVersion,_.number(1)),_.element(_.ID.EBMLReadVersion,_.number(1)),_.element(_.ID.EBMLMaxIDLength,_.number(4)),_.element(_.ID.EBMLMaxSizeLength,_.number(8)),_.element(_.ID.DocType,_.string("webm")),_.element(_.ID.DocTypeVersion,_.number(2)),_.element(_.ID.DocTypeReadVersion,_.number(2))])}static _genSegmentHeader(e,t,i){let r=_.element(_.ID.Info,[_.element(_.ID.TimecodeScale,_.number(1e6)),_.element(_.ID.MuxingApp,_.string("vk-webm-builder")),_.element(_.ID.WritingApp,_.string("vk-webm-builder"))]),n=[_.element(_.ID.PixelWidth,_.number(e)),_.element(_.ID.PixelHeight,_.number(t))],a=_.element(_.ID.Tracks,_.element(_.ID.TrackEntry,[_.element(_.ID.TrackNumber,_.number(1)),_.element(_.ID.TrackUID,_.number(1)),_.element(_.ID.TrackType,_.number(1)),_.element(_.ID.FlagLacing,_.number(0)),_.element(_.ID.DefaultDuration,_.number(1e9)),_.element(_.ID.CodecID,_.string(`V_${i.toUpperCase()}`)),_.element(_.ID.Video,n)]));return _.unknownSizeElement(_.ID.Segment,[r,a])}static _genClusterHeader(e){return _.unknownSizeElement(_.ID.Cluster,[_.element(_.ID.Timecode,_.number(Math.round(e)))])}_createVideo(e){this._mediaBuffer=new Ce(e),this._video=document.createElement("video"),this._video.autoplay=!0,this._video.controls=!1,this._video.muted=!0,this._video.style.pointerEvents="none",this._video.style.visibility="hidden",this._video.style.position="absolute",this._video.style.width="160px",this._video.style.height="90px",this._video.style.bottom="0",this._video.style.right="0",this._video.style.zIndex="5000",this._video.src=URL.createObjectURL(this._mediaBuffer.mediaSource),document.body.appendChild(this._video);let t=()=>{var e;if(null!=(e=this._video)&&e.src){li.warn(`[WebmBuilder] Video paused for participant [${this._participantId}], try to play again`);let e=this._video.seekable;e.length&&(this._video.currentTime=e.end(e.length-1)-.1),this._video.play().catch((()=>{}))}};this._video.onpause=t,this._video.onwaiting=t,this._video.onstalled=t,this._video.onerror=()=>{var e;return li.warn(`[WebmBuilder] Video Error for participant [${this._participantId}]`,null==(e=this._video)?void 0:e.error)},this._stream=this._video.captureStream(),this._onStream(this._stream)}_processFrame(e){var t,i,r,n,a;let s=e.isVP9?"vp9":"vp8";this._mediaBuffer?this._mediaBuffer.codec!==s&&this._mediaBuffer.changeType(s):this._createVideo(s);let o=e.timestamp;if(o<=this._lastFrameTimestamp&&(o=this._lastFrameTimestamp+10,li.debug(`[WebmBuilder] Fixup timestamp for participant [${this._participantId}]`)),this._lastFrameTimestamp=o,this._earliestTimestamp)o-=this._earliestTimestamp;else{if(!e.keyframe)return;this._earliestTimestamp=o,o=0}if(e.keyframe){this._clusterStartTime=o,null==(t=this._mediaBuffer)||t.cleanup(),li.debug(`[WebmBuilder] Segment header for participant [${this._participantId}]`);let n=ye._genWebmHeader();null==(i=this._mediaBuffer)||i.append(n);let a=ye._genSegmentHeader(e.width,e.height,s);null==(r=this._mediaBuffer)||r.append(a)}let c=Math.round(o-this._clusterStartTime);if(c>Te&&(this._clusterStartTime=o,c=0),0===c){li.debug(`[WebmBuilder] Cluster header for participant [${this._participantId}]`);let e=ye._genClusterHeader(this._clusterStartTime);null==(n=this._mediaBuffer)||n.append(e)}let l=_.element(_.ID.SimpleBlock,[_.vintEncodedNumber(1),_.bytes(ye._intToU16BE(c)),_.number((e.keyframe?1:0)<<7),_.bytes(e.frameData)]);null==(a=this._mediaBuffer)||a.append(l,!0)}destroy(){super.destroy(),this._video&&(this._video.onpause=null,this._video.onwaiting=null,this._video.onstalled=null,this._video.onerror=null,this._video.pause(),this._video.src="",document.body.removeChild(this._video)),this._mediaBuffer&&(this._mediaBuffer.destroy(),this._mediaBuffer=null),this._stream&&(this._stream.getTracks().forEach((e=>e.stop())),this._stream=null),li.debug(`[WebmBuilder] destroyed for participant [${this._participantId}]`)}static isBrowserSupported(){var e,t,i;return"captureStream"in(null==(e=window.HTMLVideoElement)?void 0:e.prototype)&&(null==(t=window.MediaSource)?void 0:t.isTypeSupported('video/webm; codecs="vp8"'))&&(null==(i=window.MediaSource)?void 0:i.isTypeSupported('video/webm; codecs="vp9"'))}},Ie=class{constructor(e,t,i,r,n){this._participantIdRegistry=null,this._streamBuilders={},this._onStream=()=>{},this._onEos=()=>{},li.debug("ScreenCaptureReceiver started"),this._datachannel=e,this._participantIdRegistry=t,this._onStream=i,this._onEos=r,this._onStat=n,this._datachannel.onmessage=e=>this._onDataChannelMessage(e.data)}_onDataChannelMessage(e){var t,i;let r=function(e){let t=new DataView(e),i=t.getUint8(0),r=t.getUint16(1),n=t.getUint32(3),a=1===t.getUint8(7),s=t.getUint16(8),o=t.getUint8(10),c=!!(1&o),l=!!(2&o),d=!!(4&o),u=!!(8&o);if(1!==i)throw new Error(`Unexpected protocol version. Got ${i}, expected 1`);return{timestamp:n,start:c,end:l,keyframe:d,sequence:r,isVP9:a,ssrc:s,eos:u,data:e.slice(11)}}(e),n=null==(i=null==(t=this._participantIdRegistry)?void 0:t.getStreamDescription(r.ssrc))?void 0:i.participantId;if(!n)return void li.warn(`Participant id for ssrc ${r.ssrc} not found in registry`);if(r.eos)return this.close(n),void this._onEos(n);let a=this._streamBuilders[n];if(!a){let e=e=>this._onStream(n,e);a=Ve.screenShareWebmBuilder&&ye.isBrowserSupported()?new ye(n,e,this._onStat):new ve(n,e,this._onStat),this._streamBuilders[n]=a}a.appendChunk(r)}close(e){let t=this._streamBuilders[e];t&&(t.destroy(),delete this._streamBuilders[e])}destroy(){this._datachannel.onbufferedamountlow=null,this._datachannel.onmessage=null,this._onStream=()=>{},Object.values(this._streamBuilders).forEach((e=>e.destroy())),this._streamBuilders={},this._participantIdRegistry=null,li.debug("ScreenCaptureReceiver destroyed")}static isBrowserSupported(){return(H.isBrowserSupported()||G.isBrowserSupported())&&(ve.isBrowserSupported()||ye.isBrowserSupported())}},Re=class{constructor(e,t,i){this._next=i,i&&(i.prev=this),this._prev=t,t&&(t.next=this),this._data=e}get prev(){return this._prev}set prev(e){this._prev=e}get next(){return this._next}set next(e){this._next=e}get data(){return this._data}},Ae=class{constructor(){this._head=null,this._tail=null,this._length=0}get length(){return this._length}push(...e){for(let t of e)this._tail=new Re(t,this._tail,null),this._head||(this._head=this._tail),this._length++}merge(e){this._tail&&(this._tail.next=e._head),this._head||(this._head=e._head),this._tail=e._tail,this._length+=e._length,e.clear()}shift(){if(!this._length||!this._head)return null;let e=this._head;return this._head=e.next,this._head&&(e.next=null,this._head.prev=null),this._length--,1===this.length?this._tail=this._head:this.length||(this._head=this._tail=null),e.data}bisect(){if(this.length){let e=this.length>1?Math.floor(this.length/2):1;for(let t=0;t<e;t++)this.shift()}}head(){var e;return(null==(e=this._head)?void 0:e.data)||null}tail(){var e;return(null==(e=this._tail)?void 0:e.data)||null}clear(){this._head=null,this._tail=null,this._length=0}toString(){let e=[],t=this._head;for(;null!==t;)e.push(t.data),t=t.next;return e.length?JSON.stringify(e,((e,t)=>t instanceof Error?String(t):t)):""}},Pe=class extends j{constructor(e,t,i,r){super(),this._video=null,this._imageCapture=null,this._canvas=null,this._canvasCtx=null,this._frameReadTimeout=0,this._lastFrame=null,this._sourceTrack=e,this._onFrame=t,this._useCongestionControl=i,this._maxBitrate=r,this._useImageCapture="ImageCapture"in window&&"ImageBitmap"in window,("live"!==e.readyState||!e.enabled||e.muted)&&(this._useImageCapture=!1)}_createDom(){this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.style.pointerEvents="none",this._canvas.style.visibility="hidden",this._canvas.style.position="absolute",this._canvas.style.width="160px",this._canvas.style.height="90px",this._canvas.style.bottom="0",this._canvas.style.right="160px",this._canvas.style.zIndex="5000",this._canvasCtx=this._canvas.getContext("2d"),document.body.appendChild(this._canvas)),!this._video&&!this._useImageCapture&&(this._video=document.createElement("video"),this._video.controls=!1,this._video.autoplay=!1,this._video.preload="auto",this._video.muted=!0,this._video.style.pointerEvents="none",this._video.style.visibility="hidden",this._video.style.position="absolute",this._video.style.width="160px",this._video.style.height="90px",this._video.style.bottom="0",this._video.style.right="0",this._video.style.zIndex="5000",document.body.appendChild(this._video))}_removeDom(){try{this._canvas&&document.body.removeChild(this._canvas),this._video&&document.body.removeChild(this._video)}catch(e){}this._canvasCtx=null,this._canvas=null,this._video=null}_createStream(e){return R(this,null,(function*(){if(!this._canvas)throw new Error("Canvas not found");if(!this._video&&!this._useImageCapture)throw new Error("Video element not found");return new Promise(((t,i)=>{if(this._useImageCapture)this._imageCapture=new ImageCapture(e),t();else{let r=this._video;r.srcObject=new MediaStream([e]),r.onloadeddata=e=>t(),r.onerror=()=>i(new Error("Video element error"));let n=r.play(),a=()=>i(new Error("Autoplay is disabled"));n?n.catch(a):a()}}))}))}_removeStream(){var e;window.clearTimeout(this._frameReadTimeout),null==(e=this._lastFrame)||e.close(),this._video&&(this._video.pause(),this._video.srcObject=null),this._imageCapture&&(this._imageCapture=null)}_drawFrameVideo(){if(!this._canvas||!this._canvasCtx||!this._video)throw new Error("Fatal error");this._video.paused&&this._video.play();let e=this._video.videoWidth,t=this._video.videoHeight;return this._canvas.width=this._video.width=e,this._canvas.height=this._video.height=t,this._canvasCtx.clearRect(0,0,e,t),this._canvasCtx.drawImage(this._video,0,0,e,t),this._canvasCtx.getImageData(0,0,e,t)}_getFrameBitmap(){return R(this,null,(function*(){if(!this._imageCapture)throw new Error("Destroyed");return this._imageCapture.grabFrame()}))}_drawFrameData(e){var t;if(!this._canvas||!this._canvasCtx)throw new Error("Destroyed");let i=e.width,r=e.height;return this._canvas.width=i,this._canvas.height=r,this._canvasCtx.clearRect(0,0,i,r),this._canvasCtx.drawImage(e,0,0,i,r),null==(t=this._canvasCtx)?void 0:t.getImageData(0,0,i,r)}init(){return R(this,null,(function*(){this._createDom();let e=this._sourceTrack.getSettings().width,t=this._sourceTrack.getSettings().height;li.debug(`LibVPxEncoder started ${e}x${t}, codec ${this.isVP9()?"VP9":"VP8"}`),yield this._createStream(this._sourceTrack),yield this._createWorker('"use strict";var exports=(()=>{var u=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var y=Object.getOwnPropertyNames;var x=Object.prototype.hasOwnProperty;var V=(a,r)=>{for(var s in r)u(a,s,{get:r[s],enumerable:!0})},h=(a,r,s,i)=>{if(r&&typeof r=="object"||typeof r=="function")for(let e of y(r))!x.call(a,e)&&e!==s&&u(a,e,{get:()=>r[e],enumerable:!(i=R(r,e))||i.enumerable});return a};var A=a=>h(u({},"__esModule",{value:!0}),a);var M={};V(M,{default:()=>F});var F=(a,r,s,i)=>{let e;function m(t,o){return a({locateFile:r}).then(n=>{if(e=new n.VpxEncoder,e.debug(o),!e.init(t?n.VpxType.VP9:n.VpxType.VP8))throw self.postMessage({type:"log_error",message:"encoder-init-fail-libvpx"}),new Error("LibVPxEncoder failed to create");if(s){let d=Math.round(i/1e3);e.setTargetBitrate(d)}else e.setMaxQuantizer(10),e.setTargetBitrate(1024)})}function E(t,o,n,p){let d=e.allocateImage(t,o);if(!d){self.postMessage({type:"frame",error:"No buffer data"});return}d.set(new Uint8Array(n));let l=Math.round(performance.now()),f=150;if(!e.encode(l,f,p)){self.postMessage({type:"frame",error:"Encode failed"});return}let b=e.readFrame();if(!b){self.postMessage({type:"frame",error:"No encoded data"});return}e.readFrame()&&(self.postMessage({type:"debug",message:"LibVPxEncoder dropped frame"}),self.postMessage({type:"log_error",message:"LibVPxEncoder-drop"}));let c=new Uint8Array(b.byteLength);c.set(b),self.postMessage({type:"frame",frameType:p?"key":"delta",timestamp:l,duration:f,width:t,height:o,data:c.buffer},[c.buffer])}function g(t,o){let n=Math.round(t/1e3);e.setTargetBitrate(n)}self.onmessage=t=>{switch(t.data.type){case"init":m(t.data.isVP9,t.data.debug).then(()=>self.postMessage({type:"ready"})).catch(o=>self.postMessage({type:"error",error:String(o)}));break;case"frame":E(t.data.width,t.data.height,t.data.imageData,t.data.keyFrame);break;case"set_bitrate":g(t.data.bitrate,t.data.useCbr);break}}};return A(M);})();\n',(e=>{var t;e.error?this._onFrame(null,e.error):this._onFrame({type:e.frameType,timestamp:e.timestamp,duration:e.duration,data:e.data,byteLength:null==(t=e.data)?void 0:t.byteLength,width:e.width,height:e.height})}),[h(),h().getUrl,this._useCongestionControl,this._maxBitrate],{isVP9:this.isVP9(),debug:li.enabled()})}))}_encode(e,t){let i=e.data.buffer;this._sendToWorker("frame",{width:e.width,height:e.height,imageData:i,keyFrame:t},[i])}_requestFrameVideo(e){let t=this._drawFrameVideo();this._encode(t,e)}_requestFrameBitmap(e){window.clearTimeout(this._frameReadTimeout),this._frameReadTimeout=window.setTimeout((()=>{if(this._lastFrame){let t=this._drawFrameData(this._lastFrame);this._encode(t,e)}else this._onFrame(null)}),1e3),this._getFrameBitmap().then((t=>{var i;window.clearTimeout(this._frameReadTimeout),null==(i=this._lastFrame)||i.close(),this._lastFrame=t;let r=this._drawFrameData(t);this._encode(r,e)})).catch((()=>{}))}requestFrame(e=!1){this._useImageCapture?this._requestFrameBitmap(e):this._requestFrameVideo(e)}setBitrate(e,t,i){this._sendToWorker("set_bitrate",{bitrate:e,useCbr:t})}isVP9(){return!1}destroy(){this._removeWorker(),this._removeStream(),this._removeDom(),li.debug("LibVPxEncoder destroyed")}static isBrowserSupported(){return"WebAssembly"in window&&"Worker"in window&&("CanvasCaptureMediaStream"in window||"CanvasCaptureMediaStreamTrack"in window)}},De=class extends j{constructor(e,t,i,r,n,a){super(),this._sourceTrack=e,this._onFrame=t,this._useCongestionControl=i,this._maxBitrate=r,this._useCbr=n,this._frameRate=a,this._trackProcessor=new MediaStreamTrackProcessor(e)}init(){return R(this,null,(function*(){let e=this._sourceTrack.getSettings().width,t=this._sourceTrack.getSettings().height,i=this._trackProcessor.readable;li.debug(`WebCodecsEncoder started ${e}x${t}, codec ${this.isVP9()?"VP9":"VP8"}`),yield this._createWorker('"use strict";var exports=(()=>{var p=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var x=Object.prototype.hasOwnProperty;var _=(a,t)=>{for(var n in t)p(a,n,{get:t[n],enumerable:!0})},I=(a,t,n,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of B(t))!x.call(a,o)&&o!==n&&p(a,o,{get:()=>t[o],enumerable:!(i=T(t,o))||i.enumerable});return a};var M=a=>I(p({},"__esModule",{value:!0}),a);var O={};_(O,{default:()=>S});var S=()=>{let t,n,i,o,g,m,d=null,f=0,b=!1,u=0,V,y,c=!1,l=!1;function A(e){t=e.readable,n=t.getReader(),i=e.width,o=e.height,g=e.isVP9,m=e.framerate,V=e.useCongestionControl,y=e.maxBitrate,V&&(u=y,c=e.useCbr),E(),self.postMessage({type:"ready"})}function F(e){e&&!l&&(l=!0),self.clearTimeout(f),f=self.setTimeout(()=>{d&&h(d,l)},1e3),!b&&(b=!0,n.read().finally(()=>{b=!1,self.clearTimeout(f)}).then(({done:r,value:s})=>{if(d==null||d.close(),d=null,!(r||!s)){if(!R){n.releaseLock(),t.cancel();return}d=s,h(s,l)}}))}function h(e,r){(e.codedWidth!==i||e.codedHeight!==o)&&(i=e.codedWidth,o=e.codedHeight,E(),l=!0),R.encode(e,{keyFrame:r}),r&&(l=!1)}function E(){let e={framerate:m,codec:g?"vp09.00.50.08":"vp8",width:i,height:o,latencyMode:"realtime",bitrateMode:c?"constant":"variable"};u>0&&(e.bitrate=u),R.configure(e)}function C(e,r,s){u=e,c=r,m=s,E()}let R=new VideoEncoder({output:e=>{let r;e.data?r=e.data:(r=new ArrayBuffer(e.byteLength),e.copyTo(r)),self.postMessage({type:"frame",frameType:e.type,timestamp:e.timestamp,duration:e.duration,width:i,height:o,data:r},[r])},error:e=>{self.postMessage({type:"frame",error:String(e)})}});self.onmessage=e=>{switch(e.data.type){case"init":A(e.data);break;case"frame":F(e.data.keyFrame);break;case"set_bitrate":C(e.data.bitrate,e.data.useCbr,e.data.fps);break}}};return M(O);})();\n',(e=>{var t;e.error?this._onFrame(null,e.error):this._onFrame({type:e.frameType,timestamp:e.timestamp,duration:e.duration,data:e.data,byteLength:null==(t=e.data)?void 0:t.byteLength,width:e.width,height:e.height})}),[],{readable:i,width:e,height:t,isVP9:this.isVP9(),framerate:this._frameRate,useCongestionControl:this._useCongestionControl,maxBitrate:this._maxBitrate,useCbr:this._useCbr},[i])}))}requestFrame(e=!1){this._sendToWorker("frame",{keyFrame:e})}setBitrate(e,t,i){this._sendToWorker("set_bitrate",{bitrate:e,useCbr:t,fps:i})}isVP9(){return!0}destroy(){this._removeWorker(),li.debug("WebCodecsEncoder destroyed")}static isBrowserSupported(){return"VideoEncoder"in window&&"Worker"in window&&"EncodedVideoChunk"in window&&"MediaStreamTrackProcessor"in window}},Oe=8e3,be=((Ee=be||{})[Ee.NONE=0]="NONE",Ee[Ee.UP=1]="UP",Ee[Ee.DOWN=2]="DOWN",Ee),Ne=class{constructor(e,t,i,r,n,a,s){this._upPenalty=0,this._delayAvgShort=-1,this._delayAvgLong=-1,this._minDelay=Number.MAX_VALUE,this._maxDelay=0,this._largeDelayDuration=0,this._frames=0,this._fps=0,this._onCongestion=e,this._ccEnabled=r,this._minBitrate=t,this._maxBitrate=i,this._fastSharing=n,this._targetFps=s,this._highDelayThreshold=a>0?a:2100,n&&(this._highDelayThreshold=600),this._trendDelayThreshold=Math.round(this._highDelayThreshold/3),this._targetBitrate=this._maxBitrate,this._probing=!1;let o=Date.now();this._lastDown=0,this._lastUp=o,this._lastProbing=o,this._lastCheckDelay=0,this._lastFpsCalcMs=0}checkDelay(e,t,i){let r=Date.now();if(this._calcFps(r),this._calcDelay(t,r),this._delayAvgShort<=0||this._delayAvgLong<=0||!this._ccEnabled)return;let n=0,a=this._delayAvgShort-this._delayAvgLong,s=Math.round(100*Math.abs(a)/this._delayAvgLong),o=a>40&&s>30&&this._delayAvgShort>this._trendDelayThreshold,c=this._delayAvgShort>this._highDelayThreshold;o||c?n=2:Math.abs(a)<40&&s<10&&!c&&(n=1);let l=Math.round(this._targetBitrate/1e3),d=i;e%20==0&&li.debug(`#${e}: cc: delay=${t} short=${this._delayAvgShort} long=${this._delayAvgLong} delta=${a} percent=${s} -> ${be[n]} tr=${l} br=${i}`);let u=r-this._lastDown;if(2===n&&u>2e3){this._probing&&(this._upPenalty=Math.min(++this._upPenalty,4),this._probing=!1);let i=.8*d*1e3;if(i>=this._targetBitrate&&(i=.8*this._targetBitrate),i=Math.max(i,this._minBitrate),i<this._targetBitrate){let r=Math.round(i/1e3),o=Math.round(this._upPenalty*Oe/1e3);li.log(`#${e}: cc: delay=${t} short=${this._delayAvgShort} long=${this._delayAvgLong} delta=${a} percent=${s} -> ${be[n]}`),li.log(`#${e}: cc: DOWN delay=${t} bitrate=${d} target=${l} -> newBitrate=${r} penalty=${o}s`),this._setBitrate(i,!0),this._targetBitrate=i}this._lastDown=r}let h=r-this._lastUp,p=8e3+this._upPenalty*Oe;if(1===n&&h>p&&u>p){let i=Math.min(1.2*this._targetBitrate,this._maxBitrate);if(i>this._targetBitrate){let o=Math.round(i/1e3),c=Math.round(this._targetBitrate/1e3),l=Math.round(this._upPenalty*Oe/1e3);li.log(`#${e}: cc: delay=${t} short=${this._delayAvgShort} long=${this._delayAvgLong} delta=${a} percent=${s} -> ${be[n]}`),li.log(`#${e}: cc: UP bitrate=${d} target=${c} -> newBitrate=${o} penalty=${l}s`),this._setBitrate(i,!1),this._targetBitrate=i,this._probing=!0,this._lastProbing=r,this._lastUp=r}}let _=r-this._lastProbing;this._probing&&_>16e3&&(this._probing=!1);let m=r-this._lastDown;this._upPenalty>0&&m>3*p&&(li.log(`#${e}: cc: UP reset penalty: oldPenalty=${this._upPenalty}`),this._upPenalty=0)}_setBitrate(e,t){this._fastSharing&&(t=!0);let i=this._targetFps;this._fps>0&&(i=this._fps),this._onCongestion(e,t,i)}_calcDelay(e,t){if(!(e<=0)){if(-1===this._delayAvgShort&&(this._delayAvgShort=e,this._delayAvgLong=e),this._delayAvgShort=Math.round((3*this._delayAvgShort+e)/4),this._delayAvgLong=Math.round((23*this._delayAvgLong+e)/24),e>0&&e<this._minDelay?this._minDelay=e:e>this._maxDelay&&(this._maxDelay=e),0===this._lastCheckDelay&&(this._lastCheckDelay=t),e>2e3){let e=t-this._lastCheckDelay;this._largeDelayDuration+=e}this._lastCheckDelay=t}}reconfigure(e,t){this._minBitrate=e,this._maxBitrate=t}getStat(){if(this._minDelay===Number.MAX_VALUE||0===this._maxDelay||this._delayAvgLong<=0)return null;let e={minDelay:this._minDelay,maxDelay:this._maxDelay,avgDelay:this._delayAvgLong,largeDelayDuration:this._largeDelayDuration};return this._minDelay=Number.MAX_VALUE,this._maxDelay=0,this._largeDelayDuration=0,e}_calcFps(e){this._frames++;let t=e-this._lastFpsCalcMs;if(t>5e3){this._lastFpsCalcMs=e;let i=this._fps,r=1e3*this._frames/t;0===this._fps?this._fps=Math.round(r):this._fps=Math.round((3*this._fps+r)/4),this._frames=0,this._fps!==i&&li.log(`cc: fps=${this._fps}`)}}},we=class{constructor(e){this._size=0,this._head=0,this._tail=0,this._maxSize=e,this._buffer=new Array(e)}add(e,t,i,r,n){this._tail===this._head&&this._size>0&&(this._head=++this._head%this._maxSize);let a=this._tail;return this._buffer[this._tail]={seq:e,ts:t,size:i,sent:Date.now(),start:r,end:n,ts2:-1,recv:-1},this._tail=++this._tail%this._maxSize,this._size++,a}update(e,t){let i=this.get(e);return null===i?null:(i.ts2=t,i.recv=Date.now(),i)}get(e){let t=this._head;for(let i=0;i<this._maxSize;i++){let i=this._buffer[t];if(e===(null==i?void 0:i.seq))return i;if(t=++t%this._maxSize,t===this._tail)break}return null}getServerBitrateK(e){let t=0,i=0,r=-1,n=-1,a=this._tail;for(let t=0;t<this._maxSize;t++){a>0?--a:a=this._maxSize-1;let t=this._buffer[a];if(!t||(-1===n&&(n=t.ts2,i=0),n>=0&&(i+=t.size),r=t.ts2,n-r>=e)||a===this._head)break}if(r>=0&&n>=0){let e=n-r;t=Math.round(e>0?8*i/e:0)}return t}getCurrentDelay(){let e=this._tail;for(let t=0;t<this._maxSize;t++){e>0?--e:e=this._maxSize-1;let t=this._buffer[e];if(!t)break;if(t.recv>=0&&t.sent>=0)return t.recv-t.sent;if(e===this._head)break}return 0}getMaxBandwidth(){let e=0,t=0,i=-1,r=-1,n=this._tail;for(let a=0;a<this._maxSize;a++){n>0?--n:n=this._maxSize-1;let a=this._buffer[n];if(a){if(-1===r&&a.end&&!a.start&&(r=a.ts2,t=0),-1===i&&r>=0&&a.start&&!a.end&&(i=a.ts2),i>=0&&r>=0){let n=r-i;e=n>0?8*t/n:0;break}if(r>=0&&(t+=a.size),n===this._head)break}}return Math.round(e)}clear(){this._buffer.fill(void 0),this._size=0,this._head=0,this._tail=0}},Me=65536,ke=0,Le=class{constructor(e,t,i,r){this._destroyed=!1,this._needKeyframe=!0,this._frameNum=0,this._feedback=new we(1024),this._lastSentFrameSeq=0,this._lastDeliveredFrameSeq=0,this._lastFrameDelay=0,this._lastFramerateReduced=Date.now(),this._lastSharingStat=Date.now(),this._queue=new Ae,li.debug("ScreenCaptureSender started"),this.DATA_SIZE=Ve.consumerScreenDataChannelPacketSize-11,this._datachannel=t,this._signaling=i,this._fastSharing=r,this._congestionControlEnabled=Ve.screenShareCongestionControl||this._fastSharing,this._width=e.getSettings().width,this._height=e.getSettings().height,this._maxFrameDelay=this._fastSharing?Ve.screenShareCongestionControlThreshold:2*Ve.screenShareCongestionControlThreshold;let n=Ve.getScreenFrameRate(this._fastSharing),{minBitrate:a,maxBitrate:s}=this._calcMinMaxBitrate(this._width,this._height),o=this._onCongestionCallback.bind(this);li.log(`ScreenCaptureSender: CongestionControl: enabled=${this._congestionControlEnabled} minBitrate=${Math.round(a/1e3)}k maxBitrate=${Math.round(s/1e3)}k delayThreshold=${Ve.screenShareCongestionControlThreshold}`),this._congestionControl=new Ne(o,a,s,this._congestionControlEnabled,this._fastSharing,Ve.screenShareCongestionControlThreshold,n);let c=(e,t)=>{if(this._destroyed)return;if(!e)return li.warn("requestFrame failed, keyFrame: "+this._needKeyframe,t),this._needKeyframe=!0,void this._handleQueue();(e.width!==this._width||e.height!==this._height)&&(this._width=e.width,this._height=e.height,this._onResize(this._width,this._height));let i=this._sliceFrame(e);this._queue.merge(i),this._handleQueue(),this._sendSharingStat()};if(De.isBrowserSupported()){let t=this._fastSharing;this._encoder=new De(e,c,this._congestionControlEnabled,s,t,n)}else this._encoder=new Pe(e,c,this._congestionControlEnabled,s);this._datachannel.onmessage=e=>{(function(e){if(!e||!e.byteLength||4!==e.byteLength)return!1;let t=new DataView(e);return!(1!==t.getUint8(0)||1!==t.getUint8(1)||0!==t.getUint16(2))})(e.data)&&(li.debug(`[${this._datachannel.label}] Requested keyframe`),this._needKeyframe=!0);let t=function(e){if(!e||!e.byteLength||10!==e.byteLength)return null;let t=new DataView(e);return 1!==t.getUint8(0)||2!==t.getUint8(1)||0!==t.getUint16(2)?null:{seq:t.getUint16(4),ts2:t.getUint32(6)}}(e.data);null!==t&&this._checkCcFeedback(t)},this._encoder.init().then((()=>this._handleQueue())).catch((e=>li.warn("ScreenCaptureSender init failed",e))),this._fpsMeter=new W((e=>li.log(`[ScreenCaptureSender] fps: ${e}`)),5e3)}_handleQueue(){if(this._destroyed)return;let e=this._queue.shift();if(e){if(!this._sendFrameChunk(e))return this._needKeyframe=this._needKeyframe||!this._cleanupQueue(),void Q.setImmediate((()=>this._handleQueue()));if(e.isLast){this._frameNum++,this._fpsMeter.increment(),e.isKey&&li.debug(`#${this._frameNum}: sharing: send keyframe size=${Math.round(e.frameSize/1e3)}k`);let t=this._feedback.getCurrentDelay(),i=this._feedback.getServerBitrateK(2e3);t>0&&this._congestionControl.checkDelay(this._frameNum,t,i)}else Q.setImmediate((()=>this._handleQueue()))}else if((this._lastSentFrameSeq-this._lastDeliveredFrameSeq+Me)%Me>5&&this._lastFrameDelay>this._maxFrameDelay){let e=Date.now();e-this._lastFramerateReduced>2e3&&(this._lastFramerateReduced=e,li.debug(`[ScreenCaptureSender] reduce framerate: delay=${this._lastFrameDelay} maxDelay=${this._maxFrameDelay}`))}else this._requestFrame()}_cleanupQueue(){let e=this._queue.head();for(;e;){if(e.isFirst&&e.isKey)return!0;this._queue.shift(),e=this._queue.head()}return!1}_requestFrame(){this._destroyed||(this._encoder.requestFrame(this._needKeyframe),this._needKeyframe=!1)}_sliceFrame(e){let t="key"===e.type,i=e.data.byteLength,r=new Ae;for(let n=0;n<i;n+=this.DATA_SIZE){let a=e.data.slice(n,n+this.DATA_SIZE),s=0===n,o=i<=n+a.byteLength,c=this._wrapHeader(e.timestamp,s,o,t,a);r.push({data:c.data,sequence:c.sequence,frameSize:i,isFirst:s,isLast:o,isKey:t,timestamp:e.timestamp})}return r}_wrapHeader(e,t,i,r,n){let a=function(e,t,i,r,n,a,s){let o=0;t&&(o|=1),i&&(o|=2),r&&(o|=4),s||(o|=8);let c=new ArrayBuffer(11),l=new DataView(c);if(l.setUint8(0,1),l.setUint16(1,n),l.setUint32(3,e),l.setUint8(7,a?1:0),l.setUint16(8,0),l.setUint8(10,o),!s)return c;let d=new Uint8Array(c.byteLength+s.byteLength);return d.set(new Uint8Array(c),0),d.set(new Uint8Array(s),c.byteLength),d.buffer}(e,t,i,r,ke,this._encoder.isVP9(),n),s={sequence:ke,data:a};return ke=(ke+1)%Me,s}_stopPacket(){return this._wrapHeader(Date.now(),!1,!1,!1,null).data}_sendFrameChunk(e){if(!this._datachannel||"open"!==this._datachannel.readyState)return!1;try{return this._datachannel.send(e.data),this._feedback.add(e.sequence,e.timestamp,e.data.byteLength,e.isFirst,e.isLast),e.isLast&&(this._lastSentFrameSeq=e.sequence),!0}catch(e){return li.warn("Error sending chunk to DataChannel",e),!1}}destroy(){this._queue.clear(),this._fpsMeter.destroy(),this._datachannel.onmessage=null,this._feedback.clear(),"open"===this._datachannel.readyState&&this._datachannel.send(this._stopPacket()),this._destroyed=!0,this._encoder.destroy(),li.debug("ScreenCaptureSender destroyed")}static isBrowserSupported(){return De.isBrowserSupported()||Pe.isBrowserSupported()}_onCongestionCallback(e,t,i){this._encoder.setBitrate(e,t,i)}_onResize(e,t){let{minBitrate:i,maxBitrate:r}=this._calcMinMaxBitrate(e,t),n=Math.round(i/1e3),a=Math.round(r/1e3);li.log(`cc: resize to ${e}x${t}, minBitrate=${n} maxBitrate=${a}`),this._congestionControl.reconfigure(i,r)}_calcMinMaxBitrate(e,t){(void 0===e||e<640)&&(e=640),(void 0===t||t<360)&&(t=360);let i=e*t/256;return{minBitrate:Math.max(3e5,Math.min(1e6,Math.round(50*i))),maxBitrate:Math.round(400*i)}}_checkCcFeedback(e){let t=this._feedback.update(e.seq,e.ts2);if(null===t)li.debug(`cc: update failed, seq=${e.seq}`);else if(t.end){this._lastDeliveredFrameSeq=t.seq;let e=t.recv-t.sent;e>0&&(this._lastFrameDelay=e),this._handleQueue()}}_sendSharingStat(){let e=Date.now();if(e-this._lastSharingStat>3e4){let t=this._congestionControl.getStat();null!==t&&(li.debug(`cc: send stats: ${JSON.stringify(t)}`),this._signaling.reportSharingStat(t)),this._lastSharingStat=e}}},Ue=class{static get sessionKey(){return Ue._sessionKey}static set sessionKey(e){Ue._sessionKey=e}static get sessionSecretKey(){return Ue._sessionSecretKey}static set sessionSecretKey(e){Ue._sessionSecretKey=e}static get accessToken(){return Ue._accessToken}static set accessToken(e){Ue._accessToken=e}static isEmpty(){return!Ue._sessionKey}},xe=class{static set(e){e.hasOwnProperty("voiceParams")&&(Object.assign(xe._params.voiceParams,e.voiceParams),delete e.voiceParams),e.hasOwnProperty("specListenerParams")&&(Object.assign(xe._params.specListenerParams,e.specListenerParams),delete e.specListenerParams),e.hasOwnProperty("apiAuth")&&(Ue.accessToken=e.apiAuth.accessToken,Ue.sessionKey=e.apiAuth.sessionKey,Ue.sessionSecretKey=e.apiAuth.sessionSecretKey),Object.assign(xe._params,Q.objectFilterOutValues(e,void 0))}static get(e){return xe._params[e]}static get appName(){return"ok.calls.sdk.js"}static get appVersion(){return 1.1}static get sdkVersion(){return"2.8.5-beta.36"}static get debug(){return xe._params.debug}static get protocolVersion(){return xe._params.joinFromMultipleDevices?6:5}static get platform(){return xe._params.platform}static set platform(e){xe._params.platform=e}static get clientStatsPlatform(){return xe._params.clientStatsPlatform}static set clientStatsPlatform(e){xe._params.clientStatsPlatform=e}static get clientType(){return xe._params.clientType}static set clientType(e){xe._params.clientType=e}static get externalUserType(){return xe._params.externalUserType}static set externalUserType(e){xe._params.externalUserType=e}static get device(){return xe._params.device}static get apiKey(){return xe._params.apiKey}static get apiEnv(){return xe._params.apiEnv}static apiEndpoint(e){switch(null!=e?e:xe.apiEnv){case"AUTO":case"PROD":return"https://api.mycdn.me";case"CALLS":return"https://calls.okcdn.ru";case"PROD_OK":return"https://api.ok.ru";case"TEST":return"https://apitest.ok.ru/api";case"VIDEOTEST":return"https://videotestapi.ok.ru/api";case"CALLSTEST":return"https://calls-test.okcdn.ru/api";default:return xe._params.apiEnv}}static get authToken(){return xe._params.authToken}static set authToken(e){xe._params.authToken=e}static get anonymToken(){return xe._params.anonymToken}static set anonymToken(e){xe._params.anonymToken=e}static get domain(){return xe._params.domain}static get externalDomain(){return xe._params.externalDomain}static get iceServers(){return xe._params.iceServers}static set iceServers(e){xe._params.iceServers=e}static get wssBase(){return xe._params.wssBase}static set wssBase(e){xe._params.wssBase=e}static get wssToken(){return xe._params.wssToken}static set wssToken(e){xe._params.wssToken=e}static get signalingReconnectDelay(){return xe._params.signalingReconnectDelay}static get signalingReconnectMaxDelay(){return xe._params.signalingReconnectMaxDelay}static get signalingReconnectMaxCount(){return xe._params.signalingReconnectMaxCount}static get waitConnectionDelay(){return xe._params.waitConnectionDelay}static get waitResponseDelay(){return xe._params.waitResponseDelay}static get waitMessageDelay(){return xe._params.waitMessageDelay}static get waitAnotherTabDelay(){return xe._params.waitAnotherTabDelay}static get debugLog(){return xe._params.debugLog}static get forceRelayPolicy(){return xe._params.forceRelayPolicy}static set forceRelayPolicy(e){xe._params.forceRelayPolicy=e}static get videoMinWidth(){return xe._params.videoMinWidth}static get videoMaxWidth(){return xe._params.videoMaxWidth}static set videoMaxWidth(e){xe._params.videoMaxWidth=e}static get videoMinHeight(){return xe._params.videoMinHeight}static get videoMaxHeight(){return xe._params.videoMaxHeight}static set videoMaxHeight(e){xe._params.videoMaxHeight=e}static get videoAspectRatio(){return xe._params.videoAspectRatio}static get videoFrameRate(){return xe._params.videoFrameRate}static get videoFacingMode(){return xe._params.videoFacingMode||(jt.isMobile()?"user":null)}static set videoFacingMode(e){xe._params.videoFacingMode=e}static get displaySurface(){return xe._params.displaySurface}static get audioEffects(){return xe._params.audioEffects}static set audioEffects(e){var t;xe._params.audioEffects=e,null==(t=xe._params.audioEffects)||t.setLogger(((e,...t)=>li.send(e,...t)))}static get videoEffects(){return xe._params.videoEffects}static set videoEffects(e){var t;xe._params.videoEffects=e,null==(t=xe._params.videoEffects)||t.setLogger(((e,...t)=>li.send(e,...t)))}static get videoEffectMaxWidth(){return xe._params.videoEffectMaxWidth}static set videoEffectMaxWidth(e){xe._params.videoEffectMaxWidth=e}static get videoEffectMaxHeight(){return xe._params.videoEffectMaxHeight}static set videoEffectMaxHeight(e){xe._params.videoEffectMaxHeight=e}static get vmoji(){var e;return null!=(e=xe._params.vmoji)&&e.isBrowserSupported()?xe._params.vmoji:null}static set vmoji(e){xe._params.vmoji=e}static get vmojiOptions(){return xe._params.vmojiOptions||{protocolVersion:1,renderingOptions:{}}}static set vmojiOptions(e){xe._params.vmojiOptions=e}static get voiceParams(){return xe._params.voiceParams}static get specListenerParams(){return xe._params.specListenerParams}static get iceRestartWaitTime(){return xe._params.iceRestartWaitTime}static get transportConnectionWaitTime(){return xe._params.transportConnectionWaitTime}static get statisticsInterval(){return xe._params.statisticsInterval}static set statisticsInterval(e){xe._params.statisticsInterval=e}static get networkStatisticsInterval(){return xe._params.networkStatisticsInterval}static get perfStatReportEnabled(){return xe._params.perfStatReportEnabled}static get callStatReportEnabled(){return xe._params.callStatReportEnabled}static get clientEventsLoggingEnabled(){return xe._params.clientEventsLoggingEnabled}static get enableLogPerfStatReport(){return xe._params.enableLogPerfStatReport}static get producerNotificationDataChannel(){return xe._params.producerNotificationDataChannel}static get producerCommandDataChannel(){return xe._params.producerCommandDataChannel}static get consumerScreenDataChannel(){return xe._params.consumerScreenDataChannel&&Le.isBrowserSupported()}static get producerScreenDataChannel(){return xe._params.producerScreenDataChannel&&xe.producerNotificationDataChannel&&Ie.isBrowserSupported()}static get asrDataChannel(){return xe._params.asrDataChannel&&xe.producerNotificationDataChannel}static get consumerScreenDataChannelPacketSize(){return xe._params.consumerScreenDataChannelPacketSize}static get screenShareWebmBuilder(){return xe._params.screenShareWebmBuilder}static get noiseSuppression(){return xe._params.noiseSuppression}static set noiseSuppression(e){xe._params.noiseSuppression=e}static get preferH264(){return xe._params.preferH264}static get preferVP9(){return xe._params.preferVP9}static get audioNack(){return xe._params.audioNack}static get consumerScreenTrack(){return xe._params.consumerScreenTrack&&xe.consumerScreenDataChannel}static get producerScreenTrack(){return xe._params.producerScreenTrack}static get movieShare(){return xe._params.movieShare&&xe.videoTracksCount>0}static get videoTracksCount(){return xe.producerNotificationDataChannel?Number(xe._params.videoTracksCount):0}static get breakVideoPayloadTypes(){return xe._params.breakVideoPayloadTypes}static get useCallsToContacts(){return xe._params.useCallsToContacts}static get useParticipantListChunk(){return xe._params.useParticipantListChunk&&xe.videoTracksCount>0}static get useRooms(){return xe._params.useRooms}static get useChatRooms(){return xe._params.useChatRooms}static get participantListChunkInitIndex(){var e;return null!=(e=xe._params.participantListChunkInitIndex)?e:0}static get participantListChunkInitCount(){var e;return null!=(e=xe._params.participantListChunkInitCount)?e:null}static get serverAudioRed(){return xe._params.serverAudioRed}static get p2pAudioRed(){return xe._params.p2pAudioRed}static get h264spsPpsIdrInKeyframe(){return xe._params.h264spsPpsIdrInKeyframe}static get filterObservers(){return xe._params.filterObservers}static get muteMode(){return xe._params.muteMode}static get preserveAudioTracks(){return xe._params.preserveAudioTracks}static get audioShare(){return jt.isAudioShareSupported()&&xe._params.audioShare}static get fastScreenShare(){return xe._params.fastScreenShare}static get screenShareCongestionControl(){return xe._params.screenShareCongestionControl}static get screenShareCongestionControlThreshold(){return xe._params.screenShareCongestionControlThreshold}static get fastScreenShareWidth(){return xe._params.fastScreenShareWidth}static get fastScreenShareHeight(){return xe._params.fastScreenShareHeight}static get newMuteRules(){return xe._params.newMuteRules}static get videoSuspend(){return xe._params.videoSuspend}static get enumerateDevicesDelay(){return xe._params.enumerateDevicesDelay}static getScreenFrameRate(e){return e?xe._params.fastScreenShareFrameRate:xe._params.screenFrameRate}static get switchVideoAtBadNetwork(){return xe._params.switchVideoAtBadNetwork}static get enableVideoEffectsFpsDegradation(){return xe._params.enableVideoEffectsFpsDegradation}static toJSON(){return{apiKey:xe._params.apiKey,apiEnv:xe._params.apiEnv,audioShare:xe._params.audioShare,useCallsToContacts:xe._params.useCallsToContacts,useParticipantListChunk:xe._params.useParticipantListChunk,useRooms:xe._params.useRooms,useChatRooms:xe._params.useChatRooms,fastScreenShare:xe._params.fastScreenShare,participantListChunkInitCount:xe._params.participantListChunkInitCount,screenShareCongestionControl:xe._params.screenShareCongestionControl,screenShareCongestionControlThreshold:xe._params.screenShareCongestionControlThreshold,videoTracksCount:xe._params.videoTracksCount,asrDataChannel:xe._params.asrDataChannel,videoMaxHeight:xe._params.videoMaxHeight,videoMaxWidth:xe._params.videoMaxWidth,videoEffectMaxHeight:xe._params.videoEffectMaxHeight,videoEffectMaxWidth:xe._params.videoEffectMaxWidth,videoSuspend:xe._params.videoSuspend,debugLog:xe._params.debugLog,callStatReportEnabled:xe._params.callStatReportEnabled,joinFromMultipleDevices:xe._params.joinFromMultipleDevices,movieShare:xe._params.movieShare,newMuteRules:xe._params.newMuteRules,clientType:xe._params.clientType,clientStatsPlatform:xe._params.clientStatsPlatform,consumerScreenDataChannelPacketSize:xe._params.consumerScreenDataChannelPacketSize,switchVideoAtBadNetwork:xe._params.switchVideoAtBadNetwork}}},Ve=xe;function Be(e,t){return!(e.isAudioEnabled!==t.isAudioEnabled||e.isVideoEnabled!==t.isVideoEnabled||e.isScreenSharingEnabled!==t.isScreenSharingEnabled||e.isFastScreenSharingEnabled!==t.isFastScreenSharingEnabled||e.isAudioSharingEnabled!==t.isAudioSharingEnabled||e.isAnimojiEnabled!==t.isAnimojiEnabled)}function Fe(e){return Object.assign({isAudioEnabled:!1,isVideoEnabled:!1,isScreenSharingEnabled:!1,isFastScreenSharingEnabled:!1,isAudioSharingEnabled:!1,isAnimojiEnabled:!1},e||{})}Ve._params={platform:"WEB",clientStatsPlatform:"",clientType:"PORTAL",externalUserType:"",device:"browser",apiKey:"",authToken:"",anonymToken:"",apiEnv:"AUTO",domain:"",externalDomain:"",iceServers:[],wssBase:"",wssToken:"",signalingReconnectDelay:1e3,signalingReconnectMaxDelay:5e3,signalingReconnectMaxCount:10,waitConnectionDelay:1e4,waitResponseDelay:1e4,waitMessageDelay:15e3,waitAnotherTabDelay:200,debugLog:!1,debug:!1,forceRelayPolicy:!1,videoMinWidth:428,videoMinHeight:240,videoMaxWidth:1280,videoMaxHeight:720,videoAspectRatio:16/9,videoFrameRate:25,screenFrameRate:15,videoFacingMode:null,displaySurface:"monitor",audioEffects:null,videoEffects:null,videoEffectMaxWidth:640,videoEffectMaxHeight:360,vmoji:null,vmojiOptions:null,iceRestartWaitTime:2e4,transportConnectionWaitTime:5e3,statisticsInterval:5e3,networkStatisticsInterval:2e4,perfStatReportEnabled:!0,callStatReportEnabled:!1,clientEventsLoggingEnabled:!1,enableLogPerfStatReport:!1,voiceParams:{smoothing:.8,minFreq:200,maxFreq:5e3,interval:500,threshold:.35,speakerLevelMultiplier:1.8},specListenerParams:{connectionTimeout:1e4,volumeTimeout:1e4},producerNotificationDataChannel:!0,producerCommandDataChannel:!0,consumerScreenDataChannel:!0,producerScreenDataChannel:!0,asrDataChannel:!1,consumerScreenDataChannelPacketSize:65536,screenShareWebmBuilder:!1,noiseSuppression:!0,preferH264:!1,preferVP9:!1,audioNack:!0,consumerScreenTrack:!0,producerScreenTrack:!0,videoTracksCount:30,movieShare:!1,useCallsToContacts:!1,useParticipantListChunk:!1,useRooms:!1,useChatRooms:!1,participantListChunkInitIndex:0,participantListChunkInitCount:null,serverAudioRed:!0,p2pAudioRed:!0,h264spsPpsIdrInKeyframe:!0,breakVideoPayloadTypes:!1,joinFromMultipleDevices:!1,filterObservers:!1,muteMode:!1,preserveAudioTracks:!1,audioShare:!1,fastScreenShare:!1,screenShareCongestionControl:!1,screenShareCongestionControlThreshold:2100,fastScreenShareFrameRate:24,fastScreenShareWidth:1280,fastScreenShareHeight:720,newMuteRules:!1,videoSuspend:!1,enumerateDevicesDelay:2e3,switchVideoAtBadNetwork:!1,enableVideoEffectsFpsDegradation:!1};var je=e=>e.stop(),Ge=e=>e.getTracks().forEach(je);function He(e,t){return R(this,null,(function*(){try{let i="number"==typeof t.width?t.width:void 0,r="number"==typeof t.height?t.height:void 0;yield e.applyConstraints(y(y(y({},t),i&&{width:{max:i,ideal:i}}),r&&{height:{max:r,ideal:r}}))}catch(e){li.warn("setVideoConstraints failed",e)}}))}var We,$e,Ke,ze,qe=class extends P{constructor(){super(...arguments),this.FPS_LIMITS=[13,20,Math.max(Ve.videoFrameRate,25)],this.THRESHOLD=.8,this.HISTORY_LENGTH=10,this._fpsMeterUnsubscribe=null,this._fpsHistory={cursor:0,arr:[]},this._fpsLimitCursor=this.FPS_LIMITS.length-1}get fpsLimit(){return this.FPS_LIMITS[this._fpsLimitCursor]}watch(e){this._cleanup();try{e&&(this._assertsVideoEffect(e),this._fpsMeterUnsubscribe=e.addFpsMeterListener(this._handleFpsMeter.bind(this)))}catch(e){li.warn("VideoEffectsFpsLimiter error",e)}}_handleFpsMeter(e){if(this._fpsHistory.arr[this._fpsHistory.cursor]=e,this._fpsHistory.cursor=(this._fpsHistory.cursor+1)%this.HISTORY_LENGTH,this._fpsHistory.arr.length===this.HISTORY_LENGTH&&this._fpsLimitCursor){let e=this._fpsHistory.arr.reduce(((e,t)=>e+t),0)/this.HISTORY_LENGTH,t=this.FPS_LIMITS[this._fpsLimitCursor];e<t*this.THRESHOLD&&(this._fpsLimitCursor=Math.max(0,this._fpsLimitCursor-1)),t!==this.fpsLimit&&this._triggerEvent("fps-limit",this.fpsLimit)}}_assertsVideoEffect(e){if(!("addFpsMeterListener"in e))throw new Error("Outdated VideoEffect version")}addEventListener(e,t){return super.addEventListener(e,t)}_cleanup(){var e;null==(e=this._fpsMeterUnsubscribe)||e.call(this),this._fpsMeterUnsubscribe=null}destroy(){this._cleanup(),super.unsubscribe()}},Je=((We=Je||{}).audio="audio",We.video="video",We.screen="screen",We.audioshare="audioshare",We),Ye=class extends P{constructor(){super(),this._stream=null,this._screenTrack=null,this._audioShareTrack=null,this._sendVideoTrack=null,this._cameraVideoTrack=null,this._micAudioTrack=null,this._audioEffectsTrack=null,this._mediaSettings=Fe(),this._videoStatusOnScreenCapturingEnabled=!1,this._effect=null,this._audioEffectParams=null,this._animojiEnabled=!1,this._initDeviceChangeListener(),Ve.audioShare&&(this._audioShareTrack=this.getSilentAudioShareTrack()),Ve.enableVideoEffectsFpsDegradation&&(this._videoEffectsFpsLimiter=new qe,this._videoEffectsFpsLimiter.addEventListener("fps-limit",this.handleVideoEffectsLowFps.bind(this)))}request(){return R(this,arguments,(function*(e=[V.AUDIO],t=!0){var i,r,n;if(this._stream)return;let a=e.includes(V.VIDEO),s=e.includes(V.AUDIO),o=e.includes(V.ANIMOJI);if(!jt.isBrowserSupported())throw new N(U.UNSUPPORTED);try{this._stream=yield jt.getUserMedia(a,s,t),null==(i=this._cameraVideoTrack)||i.stop(),this._cameraVideoTrack=this._stream.getVideoTracks()[0],null==(r=this._micAudioTrack)||r.stop(),this._micAudioTrack=this._stream.getAudioTracks()[0],null==(n=this._audioEffectsTrack)||n.stop(),this._mediaSettings.isVideoEnabled=a&&this._stream.getVideoTracks().filter((e=>e.enabled)).length>0||!1,this._mediaSettings.isAudioEnabled=s&&this._stream.getAudioTracks().filter((e=>e.enabled)).length>0||!1,this._mediaSettings.isAnimojiEnabled=o&&!this._mediaSettings.isVideoEnabled||!1,this._animojiEnabled=o}catch(e){throw new N(e)}}))}getStream(){return this._stream}getScreenTrack(){return this._screenTrack}getSendVideoTrack(e=!1){return this._sendVideoTrack&&!e?this._sendVideoTrack:this._stream?this._stream.getVideoTracks()[0]:null}getSendAudioTrack(){var e;return(null==(e=this._stream)?void 0:e.getAudioTracks().find((e=>!e.contentHint)))||null}get isAnimojiRequested(){return this._animojiEnabled&&!this._mediaSettings.isVideoEnabled}addTrackToPeerConnection(e,t,i){let r=this.getStream(),n=this.getSendAudioTrack(),a=this.getSendVideoTrack(i);if(!r||!n&&!a&&!t)throw new Error("No local stream found");n&&!t&&e.addTrack(n,r),a&&!t&&e.addTrack(a,r)}getMediaSettings(){return this._mediaSettings}changeDevice(e){return R(this,null,(function*(){switch(e){case"videoinput":if(this._mediaSettings.isVideoEnabled)return this._changeVideoInput();break;case"audioinput":if(this._mediaSettings.isAudioEnabled)return this._changeAudioInput();break;default:return Promise.reject(U.UNKNOWN)}}))}stopVideoTrack(){var e;this._mediaSettings.isVideoEnabled&&(this._stopEffect(),this._stream&&this._stream.getVideoTracks().forEach(je),null==(e=this._cameraVideoTrack)||e.stop())}setVideoStream(e,t){return R(this,null,(function*(){return t?this._changeScreen(!1,!1,e):this._changeVideoInput(e)}))}_initDeviceChangeListener(){!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices||!navigator.mediaDevices.addEventListener||(this._onDeviceChange=e=>R(this,null,(function*(){var t,i;if(!this._stream)return;let r=jt.getSavedMicrophone(),n=jt.getSavedCamera(),a=this._mediaSettings.isAudioEnabled&&(null==r?void 0:r.groupId)!==(null==(t=e.microphone)?void 0:t.groupId),s=this._mediaSettings.isVideoEnabled&&(null==n?void 0:n.groupId)!==(null==(i=e.camera)?void 0:i.groupId);try{a&&(yield this._changeAudioInput()),s&&(yield this._changeVideoInput())}catch(e){}})),jt.addEventListener("devicechange",this._onDeviceChange))}_destroyDeviceChangeListener(){this._onDeviceChange&&jt.removeEventListener("devicechange",this._onDeviceChange)}_changeVideoInput(e){return R(this,null,(function*(){var t;try{let i=e?"stream":"video",r=e||(yield jt._getUserVideo(!!this._effect,this._frameRate));if(null==(t=this._cameraVideoTrack)||t.stop(),this._cameraVideoTrack=r.getVideoTracks()[0],this._stream){Ve.consumerScreenTrack||(yield this._disableScreenCapture());let e=yield this._setEffect(this._effect,this._cameraVideoTrack);w.log(F.DEVICE_CHANGED,i),li.log("Video stream changed"),yield this._replaceLocalTrack(e),this._mediaSettings.isVideoEnabled=!0,this._triggerEvent("SOURCE_CHANGED",{kind:"video"})}else Ge(r)}catch(e){throw w.log(F.ERROR,"change_video"),li.warn("Camera change failed",e),e}}))}setAudioStream(e){return R(this,null,(function*(){return this._changeAudioInput(e)}))}_changeAudioInput(e=null){return R(this,null,(function*(){var t;try{let i=e||(yield jt.getUserAudio());if(null==(t=this._micAudioTrack)||t.stop(),this._micAudioTrack=i.getAudioTracks()[0],this._stream){let e=yield this._applyAudioEffect();w.log(F.DEVICE_CHANGED,"audio"),li.log("Audio stream changed",e),yield this._replaceLocalTrack(e),this._mediaSettings.isAudioEnabled=!0,this._triggerEvent("SOURCE_CHANGED",{kind:"audio"})}else Ge(i)}catch(e){throw w.log(F.ERROR,"change_audio"),li.error("Microphone change failed",e),e}}))}_changeScreen(e,t,i){return R(this,null,(function*(){try{if(i=i||(yield jt.getScreenMedia(e,t)),this._stream){let r=i.getVideoTracks()[0];if(r.addEventListener("ended",(()=>{this._mediaSettings.isScreenSharingEnabled&&this.disableScreenCapturing()}),!1),Ve.consumerScreenTrack||this._stopEffect(),w.log(F.DEVICE_CHANGED,"screen"),li.log("Screen capturing started"),this._screenTrack=r,this._mediaSettings.isScreenSharingEnabled=!0,this._mediaSettings.isFastScreenSharingEnabled=e,Ve.consumerScreenTrack||(this._videoStatusOnScreenCapturingEnabled=this._mediaSettings.isVideoEnabled,this._mediaSettings.isVideoEnabled=!0,this._sendVideoTrack=Ve.consumerScreenDataChannel?jt.getBlackMediaTrack(Ve.videoMinWidth,Ve.videoMinHeight):r,yield this._replaceLocalTrack(r,this._sendVideoTrack)),i.getAudioTracks().length>0){let e=i.getAudioTracks()[0];e.contentHint="music",this._audioShareTrack=e,yield this._replaceLocalTrack(e),this._mediaSettings.isAudioSharingEnabled=!0}t&&!this._mediaSettings.isAudioSharingEnabled&&li.debug("Audio share requested but not captured"),this._triggerEvent("SCREEN_STATUS",{track:r}),this._triggerEvent("SOURCE_CHANGED",{kind:"screen"})}else Ge(i)}catch(e){throw w.log(F.ERROR,"screen"),li.warn("Screen capturing failed",e),e}}))}_disableScreenCapture(){return R(this,null,(function*(){this._sendVideoTrack&&(this._sendVideoTrack.stop(),this._sendVideoTrack=null),this._screenTrack&&(this._screenTrack.stop(),this._screenTrack=null),yield this.stopAudioShareTrack(),this._mediaSettings.isScreenSharingEnabled&&(this._mediaSettings.isScreenSharingEnabled=!1,this._mediaSettings.isFastScreenSharingEnabled=!1,this._triggerEvent("SCREEN_STATUS",{track:null}),this._triggerEvent("SOURCE_CHANGED",{kind:"screen"}))}))}disableAudioShare(){return R(this,null,(function*(){yield this.stopAudioShareTrack(),this._triggerEvent("SCREEN_STATUS",{track:null}),this._triggerEvent("SOURCE_CHANGED",{kind:"audioshare"})}))}stopAudioShareTrack(){return R(this,null,(function*(){if(this._audioShareTrack){this._audioShareTrack.stop();let e=this.getSilentAudioShareTrack();yield this._replaceLocalTrack(e),this._mediaSettings.isAudioSharingEnabled=!1}}))}_applyAudioEffect(){return R(this,null,(function*(){var e;if(!Ve.audioEffects||!this._audioEffectParams)return null==(e=Ve.audioEffects)||e.pause(),this._micAudioTrack;Ve.audioEffects.isInitialized||(yield Ve.audioEffects.init()),Ve.audioEffects.resume(),Ve.audioEffects.setEffects(this._audioEffectParams.effects,this._audioEffectParams.isPreset),Ve.audioEffects.setSource(this._micAudioTrack);let t=Ve.audioEffects.outputStream.getAudioTracks()[0];return(!this._audioEffectsTrack||this._audioEffectsTrack.id!==t.id)&&(this._audioEffectsTrack=t),this._audioEffectsTrack}))}getSilentAudioShareTrack(){let e=jt.getSilentMediaTrack();return e.contentHint="music",e.stop(),e}_replaceLocalTrack(e,t){return R(this,null,(function*(){var i,r;if(!this._stream)return;let n=this._stream.getTracks().find((t=>t.kind===e.kind&&t.contentHint===e.contentHint));(null==n?void 0:n.id)!==e.id&&(n?(n!==this._audioEffectsTrack&&n.stop(),null==(i=this._stream)||i.removeTrack(n),null==(r=this._stream)||r.addTrack(e),this._triggerEvent("TRACK_REPLACED",e,t)):(this._stream.addTrack(e),this._triggerEvent("TRACK_REPLACED",e,t)))}))}_setEffect(e,t){return R(this,null,(function*(){var i;if(null==(i=this._videoEffectsFpsLimiter)||i.watch(Ve.videoEffects),!Ve.videoEffects)return t;try{return Ve.videoEffects.setEffect(e,t)}catch(e){return li.warn("Video effect failed",e),t}}))}_stopEffect(){if(Ve.videoEffects)try{Ve.videoEffects.stopEffect()}catch(e){li.warn("Video effect failed",e)}}destroy(){var e,t,i,r;this._destroyDeviceChangeListener(),Ve.videoEffects&&(this._effect=null,Ve.videoEffects.destroy()),Ve.audioEffects&&Ve.audioEffects.destroy(),this._stream&&(Ge(this._stream),this._stream=null),null==(e=this._cameraVideoTrack)||e.stop(),null==(t=this._micAudioTrack)||t.stop(),null==(i=this._audioEffectsTrack)||i.stop(),this._disableScreenCapture();let n=jt.getAudioContext();null==n||n.suspend().catch((e=>li.error(e))),null==(r=this._videoEffectsFpsLimiter)||r.destroy()}toggleScreenCapturing(e){return R(this,null,(function*(){if(!e.captureScreen)return Ve.consumerScreenTrack?this._disableScreenCapture():(e.captureAudio||(yield this.disableAudioShare()),this._videoStatusOnScreenCapturingEnabled?this._changeVideoInput():this.toggleVideo(!1));yield this._changeScreen(e.fastScreenSharing,e.captureAudio)}))}disableScreenCapturing(){return R(this,null,(function*(){return this.toggleScreenCapturing({captureScreen:!1,fastScreenSharing:!1,captureAudio:!1})}))}toggleVideo(e){return R(this,null,(function*(){var t;if(!this._stream)return;let i;if(Ve.consumerScreenTrack||(yield this._disableScreenCapture()),null==(t=this._cameraVideoTrack)||t.stop(),e){let e=yield jt._getUserVideo(!!this._effect,this._frameRate);this._cameraVideoTrack=e.getVideoTracks()[0],i=yield this._setEffect(this._effect,this._cameraVideoTrack)}else i=jt.getBlackMediaTrack(Ve.videoMinWidth,Ve.videoMinHeight),this._stopEffect();yield this._replaceLocalTrack(i),this._mediaSettings.isVideoEnabled=e,this._animojiEnabled?this._triggerEvent("ANIMOJI_STATUS",!e):this._triggerEvent("SOURCE_CHANGED",{kind:"video"})}))}toggleAudio(e){return R(this,null,(function*(){var t,i;if(!this._stream)return;let r;if(null==(t=this._micAudioTrack)||t.stop(),e){let e=yield jt.getUserAudio();this._micAudioTrack=e.getAudioTracks()[0],r=yield this._applyAudioEffect()}else null==(i=Ve.audioEffects)||i.pause(),r=jt.getSilentMediaTrack();yield this._replaceLocalTrack(r),this._mediaSettings.isAudioEnabled=e,this._triggerEvent("SOURCE_CHANGED",{kind:"audio"})}))}toggleAnimojiCapturing(e){this._animojiEnabled=e,this._mediaSettings.isVideoEnabled||this._triggerEvent("ANIMOJI_STATUS",e)}onAnimojiSender(e){this._mediaSettings.isAnimojiEnabled=e,this._triggerEvent("SOURCE_CHANGED",{kind:"video"})}setResolution(e){return R(this,arguments,(function*({video:e,effect:t}){if(!Ve.consumerScreenTrack&&this._mediaSettings.isScreenSharingEnabled||!this._mediaSettings.isVideoEnabled)return;if(!this._stream)throw new Error("Local stream not found");if(!this._cameraVideoTrack)throw new Error("Local video track not found");let i=this._effect&&t||e;yield this._applyVideoConstraints(this._cameraVideoTrack,i)}))}updateNoiseSuppression(){return R(this,null,(function*(){if(!this._stream||!this._mediaSettings.isAudioEnabled)return;let e=this._stream.getAudioTracks().find((e=>!e.contentHint));if(!e)throw new Error("Local audio track not found");return e.enabled?e.applyConstraints({noiseSuppression:Ve.noiseSuppression}):void 0}))}videoEffect(e){return R(this,null,(function*(){if(!Ve.videoEffects)throw new Error("Video Effects library is not set");if(!Ve.consumerScreenTrack&&this._mediaSettings.isScreenSharingEnabled)throw new Error("Can't apply effect to screensharing");if(w.log(F.DEVICE_CHANGED,`effect_${(null==e?void 0:e.effect)||"none"}`),this._mediaSettings.isVideoEnabled){if(this._stream&&e!==this._effect&&this._cameraVideoTrack){let t=this._effect;this._effect=e;try{let e=this._cameraVideoTrack.clone(),t=new MediaStream([e]);yield this._applyVideoConstraints(e),yield this._changeVideoInput(t)}catch(e){this._effect=t;let i=this._cameraVideoTrack.clone(),r=new MediaStream([i]);throw yield this._changeVideoInput(r),e}}}else this._effect=e}))}audioEffect(e){return R(this,null,(function*(){var t;if(!Ve.audioEffects)throw new Error("Audio Effects library is not set");if(this._mediaSettings.isAudioEnabled){if(this._stream&&(!e&&this._audioEffectParams||e&&!this._audioEffectParams||!Q.isArraysEquals((null==e?void 0:e.effects)||[],(null==(t=this._audioEffectParams)?void 0:t.effects)||[]))&&this._micAudioTrack){let t=this._audioEffectParams;this._audioEffectParams=e;try{let e=this._micAudioTrack.clone(),t=new MediaStream([e]);yield this._changeAudioInput(t)}catch(e){this._audioEffectParams=t;let i=this._micAudioTrack.clone(),r=new MediaStream([i]);throw yield this._changeAudioInput(r),e}}}else this._audioEffectParams=e}))}getAudioShareTrack(){return this._audioShareTrack}handleVideoEffectsLowFps(e){this._mediaSettings.isVideoEnabled&&this._cameraVideoTrack&&e<Ve.videoFrameRate&&this._applyVideoConstraints(this._cameraVideoTrack).catch((e=>{li.warn("MediaSource handleVideoEffectsLowFps error",e)}))}get _frameRate(){var e,t;let i=null!=(t=null==(e=this._videoEffectsFpsLimiter)?void 0:e.fpsLimit)?t:Ve.videoFrameRate;return this._effect?Math.min(i,Ve.videoFrameRate):void 0}_applyVideoConstraints(e,t){return R(this,null,(function*(){yield He(e,y(y({width:this._effect?Ve.videoEffectMaxWidth:Ve.videoMaxWidth,height:this._effect?Ve.videoEffectMaxHeight:Ve.videoMaxHeight},this._frameRate&&{frameRate:{ideal:this._frameRate}}),t))}))}},Qe=class{static isSupported(){return"Firefox"!==jt.browserName()&&"permissions"in navigator&&"PermissionStatus"in window}init(e){return R(this,null,(function*(){try{let[t,i]=yield Promise.all([navigator.permissions.query({name:"camera"}),navigator.permissions.query({name:"microphone"})]);this._cameraPermissionStatus=t,this._microphonePermissionStatus=i,this._listener=e,this._cameraPermissionStatus.onchange=e=>this.handlePermissionChange(e),this._microphonePermissionStatus.onchange=e=>this.handlePermissionChange(e)}catch(e){li.warn("NavigatorPermissions init error",e)}}))}handlePermissionChange(e){let t=e.target;if(t instanceof PermissionStatus){let{name:e,state:i}=t;switch(e){case"audio_capture":this._listener("microphone",i);break;case"video_capture":this._listener("camera",i)}}}getPermissionState(e){let t=null;switch(e){case"camera":t=this._cameraPermissionStatus.state;break;case"microphone":t=this._microphonePermissionStatus.state}return t}},Xe=(($e=Xe||{}).WAITING_HALL="WAITING_HALL",$e.WAITING="WAITING",$e.CONNECTING="CONNECTING",$e.CONNECTED="CONNECTED",$e.RECONNECT="RECONNECT",$e.ERROR="ERROR",$e.HANGUP="HANGUP",$e.PERMISSIONS="PERMISSIONS",$e);function Ze(e,...t){let i=Ve.get(e);"function"==typeof i&&setTimeout(i,0,...t)}function et(e,t,...i){if(Ve.filterObservers)if(Array.isArray(t)){if(t=t.filter((e=>!e.observer)),!t.length)return}else if(t.observer)return;Ze(e,t,...i)}function tt(e){return Object.assign({},e)}function it(e){return e.slice()}(ze=Ke||(Ke={})).onLocalStream=function(e,t){Ze("onLocalStream",e,tt(t))},ze.onScreenStream=function(e,t){Ze("onScreenStream",e,tt(t))},ze.onVmojiStream=function(e,t){Ze("onVmojiStream",e,tt(t))},ze.onVmojiError=function(e){Ze("onVmojiError",e)},ze.onLocalStreamUpdate=function(e,t){Ze("onLocalStreamUpdate",tt(e),t)},ze.onLocalStatus=function(e){li.debug("Local status:",e),Ze("onLocalStatus",e)},ze.onRemoteStream=function(e,t){et("onRemoteStream",e,t)},ze.onRemoteLive=function(e,t){et("onRemoteLive",e,t)},ze.onLocalLive=function(e,t){et("onLocalLive",e,t)},ze.onRemoteLiveUpdate=function(e,t){et("onRemoteLiveUpdate",e,t)},ze.onLocalLiveUpdate=function(e,t){et("onLocalLiveUpdate",e,t)},ze.onRemoteScreenStream=function(e,t){et("onRemoteScreenStream",e,t)},ze.onRemoteVmojiStream=function(e,t){et("onRemoteVmojiStream",e,t)},ze.onRemoteStreamSuspended=function(e,t,i){et("onRemoteStreamSuspended",e,t,i)},ze.onConversation=function(e,t,i,r,n){et("onConversation",e,tt(t),tt(i),r,n)},ze.onConversationParticipantListChunk=function(e){e&&Ze("onConversationParticipantListChunk",e)},ze.onRemoteMediaSettings=function(e,t,i){et("onRemoteMediaSettings",e,tt(t),i)},ze.onLocalMediaSettings=function(e,t){et("onLocalMediaSettings",e,tt(t))},ze.onRemoteSharedMovieInfo=function(e,t,i){et("onRemoteSharedMovieInfo",e,tt(t),i)},ze.onRemoteSharedMovieStoppedInfo=function(e,t,i){et("onRemoteSharedMovieStoppedInfo",e,tt(t),i)},ze.onLocalSharedMovieInfo=function(e,t,i){et("onLocalSharedMovieInfo",e,tt(t),i)},ze.onLocalSharedMovieStoppedInfo=function(e,t,i){et("onLocalSharedMovieStoppedInfo",e,tt(t),i)},ze.onRemoteSharedUrl=function(e,t,i){et("onRemoteSharedUrl",e,t,i)},ze.onParticipantAdded=function(e,t){et("onParticipantAdded",e,t)},ze.onParticipantJoined=function(e,t){et("onParticipantJoined",e,t)},ze.onLocalParticipantState=function(e){Ze("onLocalParticipantState",tt(e))},ze.onRemoteParticipantState=function(e,t,i){et("onRemoteParticipantState",e,tt(t),i)},ze.onRemoteParticipantsState=function(e,t){Ze("onRemoteParticipantsState",e,t)},ze.onRemoteStatus=function(e,t,i=null){li.debug("Remote status:",t,e),et("onRemoteStatus",e,t,i)},ze.onPermissionsRequested=function(){Ze("onPermissionsRequested")},ze.onPermissionsError=function(e,t){Ze("onPermissionsError",e,t)},ze.onRemoteRemoved=function(e,t){et("onRemoteRemoved",e,t)},ze.onCallState=function(e,t,i){Ze("onCallState",e,t,tt(i))},ze.onDeviceSwitched=function(e,t){Ze("onDeviceSwitched",e,t)},ze.onMuteStates=function(e,t,i,r=!1,n=!1,a=null,s=null,o,c,l=null){let d=c?it(c):void 0;Ze("onMuteStates",tt(e),it(t),it(i),r,n,a,s,o,d,l)},ze.onRolesChanged=function(e,t,i=!1){et("onRolesChanged",e,it(t),i)},ze.onLocalRolesChanged=function(e,t=!1){Ze("onLocalRolesChanged",it(e),t)},ze.onPinnedParticipant=function(e,t,i,r){et("onPinnedParticipant",e,t,i,r)},ze.onLocalPin=function(e,t){Ze("onLocalPin",e,t)},ze.onOptionsChanged=function(e){Ze("onOptionsChanged",it(e))},ze.onCallAccepted=function(){Ze("onCallAccepted")},ze.onAcceptedCall=function(e){et("onAcceptedCall",e)},ze.onRateNeeded=function(){Ze("onRateNeeded")},ze.onSpeakerChanged=function(e){et("onSpeakerChanged",e)},ze.onVolumesDetected=function(e){Ze("onVolumesDetected",it(e))},ze.onLocalVolume=function(e,t){Ze("onLocalVolume",e,t)},ze.onJoinStatus=function(e,t){Ze("onJoinStatus",e,t)},ze.onHangup=function(e,t){Ze("onHangup",e,t)},ze.onMultipartyChatCreated=function(e){Ze("onMultipartyChatCreated",tt(e))},ze.onDeviceChange=function(){Ze("onDeviceChange")},ze.onFingerprintChange=function(e){Ze("onFingerprintChange",e)},ze.onTokenExpired=function(){Ze("onTokenExpired")},ze.onChatMessage=function(e,t,i=!1){Ze("onChatMessage",e,t,i)},ze.onCustomData=function(e,t,i=!1){Ze("onCustomData",e,t,i)},ze.onRecordStarted=function(e,t,i,r,n,a,s=null){Ze("onRecordStarted",e,t,i,r,n,a,s)},ze.onRecordStopped=function(e=null){Ze("onRecordStopped",e)},ze.onLocalNetworkStatusChanged=function(e){Ze("onLocalNetworkStatusChanged",e)},ze.onNetworkStatusChanged=function(e){Ze("onNetworkStatusChanged",e)},ze.onDebugMessage=function(e,...t){Ze("onDebugMessage",e,...t)},ze.onStatistics=function(e,t){Ze("onStatistics",Object.assign({},e,{memory:t}))},ze.onAutoplayError=function(){Ze("onAutoplayError")},ze.onChatRoomUpdated=function(e,t,i,r,n){Ze("onChatRoomUpdated",e,t,i,r,n)},ze.onPromoted=function(e){Ze("onPromoted",e)},ze.onRemoteMixedAudioStream=function(e){Ze("onRemoteMixedAudioStream",e)},ze.onJoinLinkChanged=function(e){Ze("onJoinLinkChanged",e)},ze.onRoomsUpdated=function(e){Ze("onRoomsUpdated",e)},ze.onRoomUpdated=function(e,t,i,r){Ze("onRoomUpdated",e,t,i,r)},ze.onRoomParticipantsUpdated=function(e){Ze("onRoomParticipantsUpdated",e)},ze.onRoomSwitched=function(e){Ze("onRoomSwitched",e)},ze.onRoomStart=function(e){Ze("onRoomStart",e)},ze.onFeedback=function(e,t=null){Ze("onFeedback",e,t)},ze.onFeaturesPerRoleChanged=function(e){Ze("onFeaturesPerRoleChanged",e)},ze.onParticipantVmojiUpdate=function(e){Ze("onParticipantVmojiUpdate",e)},ze.onAsrSet=function(e,t){Ze("onAsrSet",e,t)},ze.onAsrStarted=function(e,t,i){Ze("onAsrStarted",e,t,i)},ze.onAsrStopped=function(e){Ze("onAsrStopped",e)},ze.onAsrTranscription=function(e,t,i,r){Ze("onAsrTranscription",e,t,i,r)},ze.onParticipantIdChanged=function(e,t){Ze("onParticipantIdChanged",e,t)},ze.onVideoSuspendSuggest=function(e){Ze("onVideoSuspendSuggest",e)},ze.onSignalingMessage=function(e){Ze("onSignalingMessage","string"==typeof e?e:tt(e))},ze.onPromotionApproved=function(e){Ze("onPromotionApproved",e)},ze.onPeerRegistered=function(){Ze("onPeerRegistered")};var rt,nt=Ke,at="_okcls_",st=(()=>{try{let e=Date.now().toString(),t=window.localStorage,i=!1;return t.setItem(e,e),i=t.getItem(e)===e,t.removeItem(e),i?t:null}catch(e){return null}})();(e=>{e.get=function(e){return function(e){let t=st?st.getItem(at+e):null;if(null===t)return null;try{return JSON.parse(t)}catch(e){return null}}(e)||null},e.set=function(e,t){!function(e,t){try{st&&st.setItem(at+e,JSON.stringify(t))}catch(e){}}(e,t)},e.remove=function(e){!function(e){st&&st.removeItem(at+e)}(e)}})(rt||(rt={}));var ot,ct,lt,dt,ut=rt,ht=null,pt=null,_t=null,mt=[],ft=[],gt=[],St=null,vt=null,Et=null,Tt=!1,Ct=!1,yt=null,It="",Rt=[],At=null,Pt=navigator.appVersion,Dt=navigator.appName,Ot=navigator.userAgent,bt={},Nt=(e=>(e.USER="user",e.ENVIRONMENT="environment",e))(Nt||{});(dt=Nt||(Nt={})).contains=function(e){return Object.values(dt).includes(e)};var wt,Mt=class{constructor(e,t=!1,i=Ve.videoMaxWidth,r=Ve.videoMaxHeight,n=Ve.videoFrameRate){this.isVideoRequested=()=>this.needVideo,this.supportedConstraints=navigator.mediaDevices.getSupportedConstraints();let a=!1;if(e){a={noiseSuppression:Ve.noiseSuppression,echoCancellation:!0,autoGainControl:!0};let t,i,r=wt.getMicrophones();if(vt&&(i=vt.groupId,t=vt.deviceId),"string"==typeof e){let n=r.find((t=>t.deviceId===e));i=null==n?void 0:n.groupId,t=e}else if(!vt&&"MacOS"===wt.os()&&r.find((e=>e.label.includes("iPhone")))){let e=r.find((e=>!e.label.includes("Virtual")&&!e.label.includes("iPhone")));e&&(i=e.groupId,t=e.deviceId)}i&&this.supportedConstraints.groupId?a.groupId={exact:i}:t&&(a.deviceId={exact:t})}let s=!1;if(t){s={width:{min:Ve.videoMinWidth,max:i,ideal:i},height:{min:Ve.videoMinHeight,max:r,ideal:r},aspectRatio:{ideal:Ve.videoAspectRatio},frameRate:{ideal:n}};let e,a,o=wt.getCameras();if(St&&(a=St.groupId,e=St.deviceId),"string"==typeof t){let i=o.find((e=>e.deviceId===t));a=null==i?void 0:i.groupId,e=t}else if(!St&&"MacOS"===wt.os()&&o.find((e=>e.label.includes("iPhone")))){let t=o.find((e=>!e.label.includes("Virtual")&&!e.label.includes("iPhone")));t&&(a=t.groupId,e=t.deviceId)}a&&this.supportedConstraints.groupId?s.groupId={exact:a}:e&&(s.deviceId={exact:e}),Ve.videoFacingMode&&(s.facingMode={ideal:Ve.videoFacingMode},delete s.deviceId,delete s.groupId)}this.audio=a,this.video=s,this.needVideo=!!s,this.lastSimplifyWasReached=!1}getNative(){return Object.assign({},{audio:this.audio,video:this.video})}simplify(){return"object"==typeof this.video&&(this.video.width||this.video.height?(delete this.video.width,delete this.video.height):this.video.aspectRatio?delete this.video.aspectRatio:this.video.frameRate?delete this.video.frameRate:(this.video.deviceId||this.video.groupId||this.video.facingMode)&&(delete this.video.deviceId,delete this.video.groupId,delete this.video.facingMode)),"object"==typeof this.audio&&(this.audio.echoCancellation||this.audio.autoGainControl||this.audio.noiseSuppression?(delete this.audio.echoCancellation,delete this.audio.autoGainControl,delete this.audio.noiseSuppression):(this.audio.deviceId||this.audio.groupId)&&(delete this.audio.deviceId,delete this.audio.groupId)),!0===this.video&&!0===this.audio?this.video=!1:!1===this.video&&!0===this.audio?(this.audio=!1,this.video=this.needVideo):!0===this.video&&!1===this.audio&&(this.video=!1),this.video&&!Object.keys(this.video).length&&(this.video=!0),this.audio&&!Object.keys(this.audio).length&&(this.audio=!0),!this.audio&&!this.video&&(this.lastSimplifyWasReached=!0,this.audio=!this.isVideoRequested(),this.video=this.isVideoRequested()),this}canSimplify(){let e="object"==typeof this.video&&(this.video.width||this.video.height||this.video.aspectRatio||this.video.frameRate||this.video.facingMode||this.video.deviceId||this.video.groupId)||this.video;return!!("object"==typeof this.audio&&(this.audio.deviceId||this.audio.groupId||this.audio.noiseSuppression||this.audio.echoCancellation||this.audio.autoGainControl)||this.audio||e)&&!this.lastSimplifyWasReached}isVideo(){return!!this.video}isAudio(){return!!this.audio}},kt=class extends Mt{constructor(e,t,i,r){if(super(!1,!0),this.captureController="CaptureController"in window?new CaptureController:null,"object"==typeof this.video?(delete this.video.deviceId,delete this.video.groupId,delete this.video.aspectRatio,delete this.video.frameRate,delete this.video.facingMode):this.video={},this.video.cursor="motion",this.video.width=e,this.video.height=t,this.video.frameRate=i,this.video.displaySurface=Ve.displaySurface,"Safari"===wt.browserName()){let i=Number(wt.browserVersion());16===i?(this.video.width={max:e},this.video.height={max:t}):17===i&&(delete this.video.width,delete this.video.height)}r&&(this.audio={noiseSuppression:!1,echoCancellation:!1,autoGainControl:!1})}getNative(){return Object.assign(super.getNative(),{systemAudio:"exclude",controller:this.captureController})}},Lt=class{constructor(){this._lockId=Math.round(99998*Math.random())+1}busy(){if(Lt._lockId)throw w.log(F.ERROR,"change_device"),li.warn("Device change failed: MediaSource is busy"),new Error("MediaSource is busy");Lt._lockId=this._lockId}free(){Lt._lockId===this._lockId&&(Lt._lockId=0)}},Ut=Lt;function xt(){return R(this,null,(function*(){Ct=!1,Tt=!1,ht=null;let e={camera:wt.getSavedCamera(),microphone:wt.getSavedMicrophone(),output:wt.getSavedOutput()};yield Vt(),function(e,...t){if(bt[e])for(let i of bt[e])i(...t)}("devicechange",e),nt.onDeviceChange()}))}function Vt(){return R(this,null,(function*(){return ht||(navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices?(!pt&&navigator.mediaDevices.addEventListener&&(pt=Q.debounce(xt,Ve.enumerateDevicesDelay),navigator.mediaDevices.addEventListener("devicechange",pt)),!_t&&Qe.isSupported()&&(_t=new Qe,yield _t.init(((e,t)=>{switch(t){case"denied":case"prompt":null==pt||pt()}}))),ht=navigator.mediaDevices.enumerateDevices().then((e=>{var t,i,r;mt=e.filter((e=>"videoinput"===e.kind&&(e.label&&(Tt=!0),!0))),ft=e.filter((e=>"audioinput"===e.kind&&(e.label?Ct=!0:wt.isMobile()&&"Firefox"===wt.browserName()&&(Ct=Tt),!0))),gt=e.filter((e=>"audiooutput"===e.kind));let n=null!=(t=null==St?void 0:St.deviceId)?t:ut.get("videoinput"),a=null!=(i=null==vt?void 0:vt.deviceId)?i:ut.get("audioinput"),s=null!=(r=null==Et?void 0:Et.deviceId)?r:ut.get("audiooutput");return St=mt.find((e=>e.deviceId===n))||null,vt=ft.find((e=>e.deviceId===a))||null,Et=gt.find((e=>e.deviceId===s))||gt[0]||null,ht=Promise.resolve(e),e})).catch((()=>(ht=null,[])))):[])}))}function Bt(e,t){return R(this,null,(function*(){li.debug("Try to get media",JSON.parse(JSON.stringify(e.getNative())));let i=(!e.isVideo()||wt.hasCameraPermission())&&(!e.isAudio()||wt.hasMicrophonePermission());!i&&!t&&nt.onPermissionsRequested();let r=new Ut;try{r.busy();let t=yield navigator.mediaDevices.getUserMedia(e.getNative());return r.free(),i||(yield xt()),function(e){if(St&&vt)return;let t=(e,t)=>{var i;let r=null==(i=t.getSettings())?void 0:i.deviceId;return e.find((e=>e.deviceId===r||e.label===t.label))||null};null==e||e.getTracks().forEach((e=>{vt||"audio"!==e.kind?!St&&"video"===e.kind&&(St=t(wt.getCameras(),e)):vt=t(wt.getMicrophones(),e)}))}(t),t}catch(i){switch(r.free(),li.error("getUserMedia error",i),i.name){case"PermissionDeniedError":case"PermissionDismissedError":case"NotAllowedError":case"SecurityError":case"DOMException":case"NotFoundError":t=e.isVideoRequested()?U.CAMERA_PERMISSION:U.MIC_PERMISSION;break;case"OverconstrainedError":t=U.OVERCONSTRAINED;break;case"TypeError":t=U.UNKNOWN;break;case"AbortError":case"NotReadableError":t=e.isVideoRequested()?U.CAMERA_ACCESS:U.MIC_ACCESS}if(e.canSimplify())return Bt(e.simplify(),t);let n=t||U.UNKNOWN;throw nt.onPermissionsError(n,i),n}}))}function Ft(){return Rt.length||(Rt=(()=>{let e,t=!1,i=0,r="0",n=Ot.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(/trident/i.test(n[1]))return e=/\brv[ :]+(\d+)/g.exec(Ot),["IE",e&&e[1]||"Unknown",t,i,r];if("Safari"===n[1]){if(e=Ot.match(/\bEdge\/(\d+)/),e)return["Edge",e[1]||"Unknown",t,i,r];if(e=Ot.match(/\bCriOS\/(\d+)/),e)return["Chrome",e[1],!0,Number(e[1]),r];if(e=Ot.match(/\bFxiOS\/(\d+)/),e)return["Firefox",e[1],!1,i,r];if(e=Ot.match(/\bYaBrowser\/(\d+)/),e)return["Yandex",e[1],!1,i,r];if(e=Ot.match(/\bOPT\/(\d+)/),e)return["Opera",e[1],!1,i,r]}if("Chrome"===n[1]){if(t=!0,i=Number(n[2]),e=Ot.match(/\bOPR\/(\d+)/),e)return["Opera",e[1]||"Unknown",t,i,r];if(e=Ot.match(/\bYaBrowser\/(\d+)/),e)return["Yandex",e[1]||"Unknown",t,i,r];if(e=Ot.match(/\bSferum\/((\d+)(?:\.\d+)*)/),e)return["Sferum",e[1]||"Unknown",t,i,r];if(e=Ot.match(/\bEdge?\/(\d+)/),e)return["Edge",e[1]||"Unknown",t,i,r];if(void 0!==window.opr&&/^(.+\.)?ok.ru$/.test(window.location.host))return["Opera","Hidden",t,i,r]}return e=Ot.match(/version\/(\d+)(?:(?:\.)(\d+))?/i),e&&void 0!==e[2]&&(r=e[2]),[n[2]?n[1]:Dt,e&&e[1]||n[2]||Pt,t,i,r]})()),Rt}Ut._lockId=0,(e=>{function t(){return mt.length>0}function i(){return ft.length>0}function r(){return Tt}function n(){return Ct}function a(){return Ft()[0]}function s(){return Ft()[1]}e.init=function(){return R(this,null,(function*(){if(ht)return;let t=()=>{e.getSilentMediaTrack(),document.removeEventListener("click",t),document.removeEventListener("touchstart",t)};document.addEventListener("click",t),document.addEventListener("touchstart",t),yield Vt()}))},e.getCameras=function(){return mt},e.getMicrophones=function(){return ft},e.getOutput=function(){return gt},e.hasCamera=t,e.hasMicrophone=i,e.getSavedCamera=function(){return St},e.getSavedMicrophone=function(){return vt},e.getSavedOutput=function(){return Et},e.getVideoFacingMode=function(){return Ve.videoFacingMode},e.hasCameraPermission=r,e.hasMicrophonePermission=n,e.getMicrophonePermissionState=function(){var e;return null!=(e=null==_t?void 0:_t.getPermissionState("microphone"))?e:null},e.hasPermissions=function(e=!1){return!!n()&&(!t()||!e||r())},e.getUserMedia=function(r=!1,n=!0,a=!0){return R(this,null,(function*(){let s,o=i()&&n,c=t()&&r;if(o||c)try{s=yield Bt(new Mt(o,c))}catch(e){s=new MediaStream}else s=new MediaStream;return!s.getVideoTracks().length&&a&&s.addTrack(e.getBlackMediaTrack()),!s.getAudioTracks().length&&a&&s.addTrack(e.getSilentMediaTrack()),s}))},e.getScreenMedia=function(e,t){return R(this,null,(function*(){let i=e?Ve.fastScreenShareWidth:window.screen.width,r=e?Ve.fastScreenShareHeight:window.screen.height,n=Ve.getScreenFrameRate(e);return function(e){return R(this,null,(function*(){var t;li.debug("Try to get screen",JSON.parse(JSON.stringify(e.getNative())));let i=new Ut;try{i.busy();let r=yield navigator.mediaDevices.getDisplayMedia(e.getNative()),n=null==r?void 0:r.getVideoTracks()[0];if(n){let i=null==(t=n.getSettings())?void 0:t.displaySurface;if(li.debug(`Got display media track: ${n.id} (${i})`),n.contentHint="text",e.captureController&&("browser"===i||"window"===i))try{e.captureController.setFocusBehavior("no-focus-change")}catch(e){li.warn("Failed to set focus behavior",e)}}return r}catch(e){switch(e.name){case"PermissionDeniedError":case"NotAllowedError":case"SecurityError":throw U.SCREEN_PERMISSION;default:throw U.SCREEN_ACCESS}}finally{i.free()}}))}(new kt(i,r,n,t))}))},e._getUserVideo=function(e=!1,t){return R(this,null,(function*(){let i=e?Ve.videoEffectMaxWidth:Ve.videoMaxWidth,r=e?Ve.videoEffectMaxHeight:Ve.videoMaxHeight;return Bt(new Mt(!1,!0,i,r,t))}))},e.getUserVideo=function(e,t){return R(this,null,(function*(){let i=(null==t?void 0:t.width)||Ve.videoMaxWidth,r=(null==t?void 0:t.height)||Ve.videoMaxHeight;return Bt(new Mt(!1,e||!0,i,r))}))},e.getUserAudio=function(e){return R(this,null,(function*(){return Bt(new Mt(e||!0,!1))}))},e.setResolution=function(e,t){return R(this,null,(function*(){let[i]=e.getVideoTracks();if(!i)throw new Error("Video track not found in stream");return He(i,t)}))},e._saveDeviceId=function(e,t){return R(this,null,(function*(){let i=(yield Vt()).find((i=>i.kind===e&&i.deviceId===t));return i?("videoinput"===e?St=i:"audioinput"===e?vt=i:"audiooutput"===e&&(Et=i),ut.set(e,t),i):null}))},e.getSilentMediaTrack=function(){if(!lt||"ended"===lt.readyState){let t=e.getAudioContext(),i=t.createMediaStreamDestination(),r=t.createGain();r.gain.value=1e-5,r.connect(i),r.connect(t.destination);let n=t.createOscillator();n.type="sine",n.frequency.value=0,n.connect(r),n.start(),lt=i.stream.getAudioTracks()[0]}return Object.assign(lt.clone(),{enabled:!1})},e.getBlackMediaTrack=function(e=Ve.videoMinWidth,t=Ve.videoMinHeight){ct||(ct=document.createElement("canvas")),ct.width=e,ct.height=t;let i=ct.getContext("2d");return i.rect(0,0,e,t),i.fillStyle="black",i.fill(),(!ot||"ended"===ot.readyState)&&(ot=ct.captureStream(Ve.videoFrameRate).getVideoTracks()[0]),Object.assign(ot.clone(),{enabled:!1})},e.isBrowserSupported=function(){if("Edge"===a()&&Number(s())<70)return!1;try{let e=window;return!!("mediaDevices"in e.navigator&&"getUserMedia"in e.navigator.mediaDevices&&e.RTCPeerConnection&&e.RTCIceCandidate&&e.RTCSessionDescription&&e.HTMLCanvasElement&&e.HTMLCanvasElement.prototype.captureStream&&e.RTCRtpSender&&e.RTCRtpSender.prototype.replaceTrack&&e.RTCRtpSender.prototype.getParameters&&"sendBeacon"in navigator)}catch(e){return!1}},e.isScreenCapturingSupported=function(){return!!navigator.mediaDevices.getDisplayMedia},e.isBrokenH264Decoder=function(){let t="Safari"===e.browserName()&&"15"===e.browserVersion()&&"1"===e.browserSubVersion(),i="Opera"===e.browserName(),r="Yandex"===e.browserName();return t||i||r},e.isBrokenVP9Encoder=function(){return"Yandex"===e.browserName()&&"Windows"===e.os()},e.isBrokenVP9Decoder=function(){return"Safari"===e.browserName()&&17===Number(e.browserVersion())&&[4,5,6].includes(Number(e.browserSubVersion()))},e.isOldDataChannelDescription=function(){return"Firefox"===e.browserName()&&Number(e.browserVersion())<60},e.canPreferH264=function(){return!(e.baseChromeVersion()&&e.isMobile())},e.os=function(){return It||(It=(()=>{let e={Windows:/Win/,Android:/Android/,OpenBSD:/OpenBSD/,SunOS:/SunOS/,Linux:/(Linux|X11)/,iPad:/(iPad)/,iPhone:/(iPhone)/,iPod:/(iPod)/,MacOS:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh|Mac OS X)/,QNX:/QNX/,UNIX:/UNIX/,BeOS:/BeOS/,OS2:/OS\/2/,Bot:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/};for(let t in e)if(e.hasOwnProperty(t)&&e[t].test(Ot))return t;return"Unknown"})()),It},e.isMobile=function(){return null===yt&&(yt=/Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(Pt)),yt},e.browserName=a,e.browserVersion=s,e.baseChromeVersion=function(){return Ft()[3]},e.getAudioContext=function(){return At||(At=new(window.AudioContext||window.webkitAudioContext)),At.resume().catch((()=>{li.warn("Failed to resume AudioContext")})),At},e.browserSubVersion=function(){return Ft()[4]},e.isAudioShareSupported=function(){return e.baseChromeVersion()>=105&&!e.isMobile()},e.addEventListener=function(e,t){bt[e]||(bt[e]=[]),bt[e].push(t)},e.removeEventListener=function(e,t){if(bt[e])if(t){let i=bt[e].indexOf(t);i>-1&&bt[e].splice(i,1)}else delete bt[e]}})(wt||(wt={}));var jt=wt,Gt=class{static get startTime(){var e;return(null==(e=Gt._list[0])?void 0:e.t)||0}static get endTime(){var e;let t=Gt._list;return(null==(e=t[t.length-1])?void 0:e.t)||0}static startSession(){Gt._list=[]}static get conversationId(){return Gt._conversationId}static set conversationId(e){Gt._conversationId=e}static add(e){Gt._list.push(e)}static _createContextLogs(){let e=[[`Calls SDK ${Ve.sdkVersion}`,Ve.toJSON()],["UserAgent:",navigator.userAgent],["Screen resolution:",`${window.screen.width}x${window.screen.height}`],["Permissions:",`Camera: ${jt.hasCameraPermission()}, Mic: ${jt.hasMicrophonePermission()}`]],t=new Date,i=t.getTime(),r=t.toLocaleString("ru-RU",{dateStyle:"short",timeStyle:"long"});return e.map((e=>({h:r,t:i,l:"LOG",d:e})))}static collectLogs(){let e=Gt._list;return 0===e.length?[]:[...Gt._createContextLogs(),...e]}},Ht=Gt;Ht._list=[],Ht._conversationId=null;var Wt=class{constructor(){this._items=[]}get length(){return this._items.length}push(...e){this._items.push(...e)}merge(e){this._items.push(...e._items)}shift(){return this._items.shift()||null}bisect(){let e=this.length>1?Math.floor(this.length/2):1;this._items=this._items.slice(e)}head(){return this._items[0]||null}tail(){let e=this._items.length;return e?this._items[e-1]:null}clear(){this._items=[]}toString(){return this._items.length?JSON.stringify(this._items,((e,t)=>t instanceof Error?String(t):t)):""}},$t=2097152,Kt=524288,zt=102400,qt="_okcls_logs_session_",Jt=class{constructor(){this._items=[],this._itemsSize=0,this._storageSize=$t;try{let e=window.localStorage;for(let t of Object.keys(e)){if(0!==t.indexOf(qt))continue;let i=e.getItem(t);if(!i){Xt(t);continue}let r=Qt(i);this.add(t,r)}}catch(e){console.error("Storage is blocked",e),this._storageSize=0}this._items.sort(((e,t)=>e.date-t.date)),this.cleanup(zt)}get size(){return this._itemsSize}get length(){return this._items.length}get available(){return Math.max(this._storageSize-this._itemsSize,0)}get items(){return this._items}set storageSize(e){this._storageSize=Math.min(e,this._storageSize,$t)}add(e,t){let i=parseInt(e.replace(qt,""),10);this._itemsSize+=t,this._items.push({key:e,size:t,date:i})}deleteOldestItem(){let e=this._items.shift();e&&(Xt(e.key),this._itemsSize-=e.size)}cleanup(e){for(;this.length&&(this.size>$t||this.length>4||this.size+e>this.available);)this.deleteOldestItem()}};function Yt(){return`${qt}${Date.now()}`}function Qt(e){return new Blob([e]).size}function Xt(e){try{window.localStorage.removeItem(e)}catch(e){console.error("Failed to remove log from storage",e)}}function Zt(){let e=ni.toString();if(!ri.available||!e)return;let t=Qt(e);if(t>Kt)return ni.bisect(),void Zt();ri.cleanup(zt+t);try{window.localStorage.setItem(ai,e)}catch(e){return console.warn("Failed to write log to storage",e),ri.storageSize=ri.size+t,ri.cleanup(zt+t),ri.available>=zt+t?void Zt():t>zt?(ni.bisect(),void Zt()):void(ri.storageSize=0)}t>Kt&&(ri.add(ai,t),ai=Yt(),ni.clear(),ri.cleanup(zt))}function ei(){!ri.available||!ni.length||Zt()}function ti(e=!1){let t=[];try{let e=window.localStorage;for(let i of ri.items){let r=e.getItem(i.key);t.push(r)}let i=ni.toString();i&&t.push(i)}catch(e){console.error("Storage is blocked",e)}let i=`[${t.join(",")}]`;if(e)return i;let r=`logs_${Date.now()}.json`;return function(e,t){let i=document.createElement("a"),r=new Blob([e],{type:"text/json"});i.href=URL.createObjectURL(r),i.download=t,i.click()}(i,r),r}function ii(){ri||(ri=new Jt,ni=new Wt,ai=Yt(),window.addEventListener("beforeunload",ei))}var ri,ni,ai,si=null;window.__VKCallsSDKLogs__=(e=!1)=>(ri||ii(),ei(),ti(e));var oi,ci=(e=>(e.DEBUG="DEBUG",e.LOG="LOG",e.WARN="WARN",e.ERROR="ERROR",e))(ci||{});(e=>{let t="📞",i=(e,...t)=>{nt.onDebugMessage(e,...t)},r=!1,n=(e,t)=>(...i)=>{e(...i),function(e,t){if(!ri.available)return;let i=new Date,r={t:i.getTime(),l:e,d:t,h:i.toLocaleString("ru-RU",{dateStyle:"short",timeStyle:"long"})};ni.push(r),Ht.add(r),si||(si=window.setTimeout((()=>{si=null,ei()}),3e4))}(t,i)},a=console.debug.bind(console,t),s=console.log.bind(console,t),o=console.warn.bind(console,t),c=console.error.bind(console,t),l=i.bind(null,"DEBUG"),d=i.bind(null,"LOG"),u=i.bind(null,"WARN"),h=i.bind(null,"ERROR");e.debug=l,e.log=d,e.warn=u,e.error=h,e.enabled=function(){return r},e.toggle=function(t){r=t,Ve.debugLog&&ii(),t?(e.debug=Ve.debugLog?n(a,"DEBUG"):a,e.log=Ve.debugLog?n(s,"LOG"):s,e.warn=Ve.debugLog?n(o,"WARN"):o,e.error=Ve.debugLog?n(c,"ERROR"):c):(e.debug=Ve.debugLog?n(l,"DEBUG"):l,e.log=Ve.debugLog?n(d,"LOG"):d,e.warn=Ve.debugLog?n(u,"WARN"):u,e.error=Ve.debugLog?n(h,"ERROR"):h)},e.send=function(t,...i){switch(t){case"DEBUG":(0,e.debug)(...i);break;case"LOG":(0,e.log)(...i);break;case"WARN":(0,e.warn)(...i);break;case"ERROR":(0,e.error)(...i)}},e.test=function(e,...t){}})(oi||(oi={}));var li=oi;function di(e){return e.stopStream}function ui(e){return e.keyFrameRequested}function hi(e){if(di(e))return"ss";if(ui(e))return"kf";let t="";return void 0!==e.priority&&(t+="p="+e.priority),void 0!==e.width&&void 0!==e.height&&(""!==t&&(t+=":"),t+="sz="+Math.round(e.width)+"x"+Math.round(e.height)),void 0!==e.fit&&(""!==t&&(t+=":"),t+="fit="+e.fit),t}var pi=(e=>(e.CAMERA="CAMERA",e.SCREEN="SCREEN",e.STREAM="STREAM",e.MOVIE="MOVIE",e.ANIMOJI="ANIMOJI",e.SHARED_URL="SHARED_URL",e))(pi||{});function _i(e){return e.participantId+(e.mediaType?":s"+e.mediaType:"")+(e.streamName?":m"+e.streamName:"")}function mi(e){let t=e.split(J),i=t.shift();if(!i)throw new Error("Illegal stream description: "+e);let r,n=null,a=0;for(let i of t)switch(i.charAt(0)){case"s":n=fi(i.slice(1));break;case"m":r=i.slice(1);break;case"d":a=Number.parseInt(i.slice(1),10);break;default:throw new Error("Unexpected parameter type "+i.charAt(0)+" in stream description "+e)}return{participantId:Q.compose(i,a),mediaType:n,streamName:r}}function fi(e){for(let t of Object.keys(pi))if(t===e)return pi[t];return null}function gi(){let e=new DataView(new ArrayBuffer(64)),t=0;function i(i){if(t+i>e.byteLength){let r=new Uint8Array(Math.max(t+i,e.byteLength+64));r.set(new Uint8Array(e.buffer.slice(0,t))),e=new DataView(r.buffer)}}return{put(r){if(i(r.byteLength),function(e){return void 0!==e.buffer}(r)){let i=r.buffer;new Uint8Array(e.buffer).set(new Uint8Array(i),t)}else new Uint8Array(e.buffer).set(new Uint8Array(r),t);t+=r.byteLength},putI8(r){i(1),e.setInt8(t,r),++t},putI16(r){i(2),e.setInt16(t,r),t+=2},putI32(r){i(4),e.setInt32(t,r),t+=4},putI64(r){i(8);let n=r<0;n&&(r=-r);let a=r/4294967296|0,s=r%4294967296|0;n&&(s=1+~s|0,a=0===s?1+~a|0:~a),e.setUint32(t,a),e.setUint32(t+4,s),t+=8},putUi8(r){i(1),e.setUint8(t,r),++t},putUi16(r){i(2),e.setUint16(t,r),t+=2},putUi32(r){i(4),e.setUint32(t,r),t+=4},putUi64(r){i(8),e.setUint32(t,r/4294967296|0),e.setUint32(t+4,r%4294967296),t+=8},putF(r){i(8),e.setFloat64(t,r),t+=8},ui8array:()=>new Uint8Array(e.buffer.slice(0,t))}}function Si(e){let t=ArrayBuffer.isView(e)?new DataView(e.buffer,e.byteOffset,e.byteLength):new DataView(e),i=0;return{peek:()=>t.getUint8(i),get(e){i+=e;let r=t.byteOffset;return t.buffer.slice(r+i-e,r+i)},getI8:()=>t.getInt8(i++),getI16:()=>(i+=2,t.getInt16(i-2)),getI32:()=>(i+=4,t.getInt32(i-4)),getI64:()=>(i+=8,4294967296*t.getInt32(i-8)+t.getUint32(i-4)),getUi8:()=>t.getUint8(i++),getUi16:()=>(i+=2,t.getUint16(i-2)),getUi32:()=>(i+=4,t.getUint32(i-4)),getUi64:()=>(i+=8,4294967296*t.getUint32(i-8)+t.getUint32(i-4)),getF32:()=>(i+=4,t.getFloat32(i-4)),getF64:()=>(i+=8,t.getFloat64(i-8))}}var vi,Ei=class{constructor(){this.participantIdRegistry=null}setParticipantIdRegistry(e){this.participantIdRegistry=e}serializeUpdateDisplayLayout(e,t){let i=gi();d.Int.enc(i,0),d.Int.enc(i,0),d.Int.enc(i,e),d.Nil.enc(i,null);let r=[];for(let e in t)t.hasOwnProperty(e)&&this.writeLayout(t,e,r);return d.Arr.enc(i,r),d.Nil.enc(i,null),i.ui8array()}writeLayout(e,t,i){let r=e[t],n=gi();if(this.writeStreamDesc(t,n),di(r))d.Int.enc(n,1);else if(ui(r))d.Int.enc(n,2);else if(d.Int.enc(n,0),void 0!==r.priority?d.Int.enc(n,r.priority):d.Nil.enc(n,null),void 0!==r.width&&void 0!==r.height?(d.Int.enc(n,Math.round(r.width)),d.Int.enc(n,Math.round(r.height))):(d.Nil.enc(n,null),d.Nil.enc(n,null)),void 0!==r.fit)switch(r.fit){case"cv":d.Int.enc(n,0);break;case"cn":d.Int.enc(n,1);break;default:d.Nil.enc(n,null)}else d.Nil.enc(n,null);i.push(n.ui8array())}writeStreamDesc(e,t){if(this.participantIdRegistry){let i=this.participantIdRegistry.getCompactId(e);if(void 0!==i)return void d.Int.enc(t,i)}d.Str.enc(t,e)}serializePerfStatReport(e,t){let i=gi();return d.Int.enc(i,1),d.Int.enc(i,0),d.Int.enc(i,e),d.Int.enc(i,t.framesDecoded),d.Int.enc(i,t.framesReceived),i.ui8array()}serializeSharingStatReport(e,t){let i=gi();return d.Int.enc(i,2),d.Int.enc(i,0),d.Int.enc(i,e),d.Int.enc(i,t.minDelay),d.Int.enc(i,t.maxDelay),d.Int.enc(i,t.avgDelay),d.Int.enc(i,t.largeDelayDuration),i.ui8array()}serializeRequestAsr(e,t){let i=gi();return d.Int.enc(i,3),d.Int.enc(i,0),d.Int.enc(i,e),d.Bool.enc(i,t.request),i.ui8array()}serializeNetworkStatReport(e,t){let i=gi();return d.Int.enc(i,4),d.Int.enc(i,0),d.Int.enc(i,e),d.Int.enc(i,t.timestamp),d.Int.enc(i,t.sendBitrate),i.ui8array()}serializeEnableVideoSuspend(e,t){let i=gi();return d.Int.enc(i,5),d.Int.enc(i,0),d.Int.enc(i,e),d.Bool.enc(i,t.enabled),i.ui8array()}serializeEnableVideoSuspendSuggest(e,t){let i=gi();return d.Int.enc(i,6),d.Int.enc(i,0),d.Int.enc(i,e),d.Bool.enc(i,t.enabled),i.ui8array()}deserializeCommandResponse(e){return R(this,null,(function*(){let t;if(e instanceof Blob){let i="arrayBuffer"in Blob.prototype?yield e.arrayBuffer():yield function(e){return R(this,null,(function*(){return new Promise(((t,i)=>{let r=new FileReader;r.onload=e=>{var i;t(null==(i=e.target)?void 0:i.result)},r.onerror=i,r.readAsArrayBuffer(e)}))}))}(e);t=Si(i)}else t=Si(e);let i=d.Int.dec(t),r=d.Int.dec(t);if(0===r)if(0===d.Int.dec(t))switch(i){case 0:return this.deserializeUpdateDisplayLayoutResponse(t);case 1:return this.deserializeReportPerfStatResponse(t);default:return void li.warn("unsupported command response commandType: "+i)}else li.warn("Error code: "+i+"received for command type: "+i+", version "+r);else li.warn("Unsupported version for command type: "+i+", version "+r)}))}deserializeUpdateDisplayLayoutResponse(e){let t=d.Int.dec(e),i=d.Arr.dec(e),r={};return i.forEach((e=>{var t;let i=Si(e),n=d.Any.dec(i);if("string"==typeof n)r[n]=d.Int.dec(i);else{let e=n,a=_i(null==(t=this.participantIdRegistry)?void 0:t.getStreamDescription(e));r[a]=d.Int.dec(i)}})),{type:"response",sequence:t,response:k.UPDATE_DISPLAY_LAYOUT.toString(),errorCodeByParticipantId:r}}deserializeReportPerfStatResponse(e){let t=d.Int.dec(e),i=d.Int.dec(e);return{type:"response",sequence:t,response:k.REPORT_PERF_STAT.toString(),estimatedPerformanceIndex:i}}},Ti=(e=>(e.START="start",e.ACCEPT="accept",e.JOIN="join",e.RETRY="retry",e))(Ti||{}),Ci=Ti,yi=(e=>(e.NOTIFICATION="NOTIFICATION",e.FAILED="FAILED",e.RECONNECT="RECONNECT",e))(yi||{}),Ii=yi,Ri=((vi=Ri||{}).TRANSMITTED_DATA="transmitted-data",vi.ACCEPTED_CALL="accepted-call",vi.HUNGUP="hungup",vi.PARTICIPANT_ADDED="participant-added",vi.PARTICIPANT_JOINED="participant-joined",vi.CLOSED_CONVERSATION="closed-conversation",vi.MEDIA_SETTINGS_CHANGED="media-settings-changed",vi.PARTICIPANT_STATE_CHANGED="participant-state-changed",vi.PARTICIPANTS_STATE_CHANGED="participants-state-changed",vi.RATE_CALL_DATA="rate-call-data",vi.FEATURE_SET_CHANGED="feature-set-changed",vi.TOPOLOGY_CHANGED="topology-changed",vi.PRODUCER_UPDATED="producer-updated",vi.CONSUMER_ANSWERED="consumer-answered",vi.MULTIPARTY_CHAT_CREATED="multiparty-chat-created",vi.FORCE_MEDIA_SETTINGS_CHANGE="force-media-settings-change",vi.SETTINGS_UPDATE="settings-update",vi.VIDEO_QUALITY_UPDATE="video-quality-update",vi.REGISTERED_PEER="registered-peer",vi.SWITCH_MICRO="switch-micro",vi.RECORD_STARTED="record-started",vi.RECORD_STOPPED="record-stopped",vi.REALLOC_CON="realloc-con",vi.AUDIO_ACTIVITY="audio-activity",vi.SPEAKER_CHANGED="speaker-changed",vi.STALLED_ACTIVITY="stalled-activity",vi.CHAT_MESSAGE="chat-message",vi.CUSTOM_DATA="custom-data",vi.ROLES_CHANGED="roles-changed",vi.MUTE_PARTICIPANT="mute-participant",vi.PIN_PARTICIPANT="pin-participant",vi.OPTIONS_CHANGED="options-changed",vi.NETWORK_STATUS="network-status",vi.PARTICIPANT_SOURCES_UPDATE="participant-sources-update",vi.PROMOTE_PARTICIPANT="promote-participant",vi.CHAT_ROOM_UPDATED="chat-room-updated",vi.PROMOTION_APPROVED="promotion-approved",vi.JOIN_LINK_CHANGED="join-link-changed",vi.FEEDBACK="feedback",vi.MOVIE_UPDATE_NOTIFICATION="movie-update-notification",vi.MOVIE_SHARE_STARTED="movie-share-started",vi.MOVIE_SHARE_STOPPED="movie-share-stopped",vi.URL_SHARING_INFO_UPDATED="url-sharing-info-updated",vi.ROOM_UPDATED="room-updated",vi.ROOMS_UPDATED="rooms-updated",vi.ROOM_PARTICIPANTS_UPDATED="room-participants-updated",vi.FEATURES_PER_ROLE_CHANGED="features-per-role-changed",vi.PARTICIPANT_ANIMOJI_CHANGED="participant-animoji-changed",vi.ASR_STARTED="asr-started",vi.ASR_STOPPED="asr-stopped",vi.DECORATIVE_PARTICIPANT_ID_CHANGED="decorative-participant-id-changed",vi.VIDEO_SUSPEND_SUGGEST="video-suspend-suggest",vi),Ai=Ri,Pi="open",Di=[()=>Ve.producerScreenTrack,()=>Ve.videoTracksCount>0,()=>!0,()=>!0,()=>Ve.consumerScreenTrack,()=>!0,()=>Ve.movieShare,()=>Ve.useParticipantListChunk,()=>Ve.useRooms,()=>!!Ve.vmoji,()=>Ve.useCallsToContacts,()=>Ve.useChatRooms],Oi=["service-unavailable","conversation-ended","invalid-token"],bi=class extends D{constructor(){super(...arguments),this.socket=null,this.sequence=1,this.lastStamp=0,this.websocketCommandsQueue=[],this.datachannelCommandsQueue=[],this.incomingCache=[],this.responseHandlers={},this.reconnectCount=0,this.conversationResolve=null,this.conversationReject=null,this.connected=!1,this.listenersReady=!1,this.postfix="&platform="+Ve.platform+"&appVersion="+Ve.appVersion+"&version="+Ve.protocolVersion+"&device="+Ve.device+"&capabilities="+bi._getCapabilityFlags(),this.peerId=null,this.conversationId=null,this.reconnectTimer=0,this.connectionMessageWaitTimer=0,this.doctorTimer=0,this.participantIdRegistry=null,this.producerNotificationDataChannel=null,this.producerCommandDataChannel=null,this.producerCommandDataChannelEnabled=!1,this.producerCommandSerializationService=new Ei}static _getCapabilityFlags(){let e=0;for(let t=0;t<Di.length;t++)Di[t]()&&(e|=1<<t);return e.toString(16).toUpperCase()}get ready(){return null!==this.socket}setEndpoint(e){this.endpoint=e}setConversationId(e){this.conversationId=e}setParticipantIdRegistry(e){this.participantIdRegistry=e,this.producerCommandSerializationService.setParticipantIdRegistry(e)}setProducerNotificationDataChannel(e){this.producerNotificationDataChannel=e,this.producerNotificationDataChannel.onmessage=e=>{var t;let i=null==(t=this.participantIdRegistry)?void 0:t.handleMessage(e.data);i&&this._handleMessage(i)}}setProducerCommandDataChannel(e){this.producerCommandDataChannel=e,this.producerCommandDataChannel.onmessage=e=>{this.producerCommandSerializationService.deserializeCommandResponse(e.data).then((e=>{e&&this._handleMessage(e)})).catch((e=>{li.warn("[signaling] cannot parse message at producerCommandDataChannel",e)}))},this._handleCommandsQueue(this.datachannelCommandsQueue)}useCommandDataChannel(e){this.producerCommandDataChannelEnabled=e}cleanup(){this.datachannelCommandsQueue=[],this.incomingCache=[]}connect(e){return R(this,null,(function*(){return this.postfix+=`&clientType=${Ve.clientType}`,new Promise(((t,i)=>{if(this.socket&&this.socket.readyState<WebSocket.CLOSING)return w.log(F.SOCKET_ACTION,"already_opened"),void i(Error("Socket already opened"));this.conversationResolve=e=>{t(e),this.conversationResolve=null,this.conversationReject=null},this.conversationReject=e=>{i(e),this.conversationResolve=null,this.conversationReject=null},this._connect(e)}))}))}_send(e){return R(this,arguments,(function*(e,t={},i=!0,r=0){if(t.participantId){let e=Q.decomposeParticipantId(t.participantId),i=Q.decomposeId(e.compositeUserId);t=Object.assign({},t,{participantId:i.id,participantType:i.type}),e.deviceIdx&&(t.deviceIdx=e.deviceIdx)}return this._sendRaw(e,t,i,r)}))}_sendRaw(e){return R(this,arguments,(function*(e,t={},i=!0,r=0){let n=t=>{var i;if(this._isDataChannelCommand(e))this.datachannelCommandsQueue.push(t),(null==(i=this.producerCommandDataChannel)?void 0:i.readyState)===Pi&&this._handleCommandsQueue(this.datachannelCommandsQueue);else{if(!this.socket)return w.log(F.SOCKET_ACTION,"not_opened"),li.warn("[signaling] socket is not opened"),void t.reject(new Error(`Socket not opened [${e}]`),!0);this.socket.readyState>WebSocket.OPEN&&(w.log(F.SOCKET_ACTION,"invalid_state"),li.warn(`[signaling] socket is not opened, state ${this.socket.readyState}`)),this.websocketCommandsQueue.push(t),this.socket&&this.socket.readyState===WebSocket.OPEN&&this._handleCommandsQueue(this.websocketCommandsQueue)}};return new Promise(((a,s)=>{let o={sequence:this.sequence++,name:e,params:t,responseTimer:0,needResponse:i,resolve:a,reject:(t,i=!1)=>{!r||i?s(t):(li.debug("[signaling] resending a signaling message",e,o.sequence),r--,n(o))}};n(o)}))}))}_isDataChannelCommand(e){return!!this.producerCommandDataChannelEnabled&&(e===k.UPDATE_DISPLAY_LAYOUT||e===k.REPORT_PERF_STAT||e===k.REPORT_SHARING_STAT||e===k.REQUEST_ASR||e===k.ENABLE_VIDEO_SUSPEND||e===k.ENABLE_VIDEO_SUSPEND_SUGGEST||e===k.REPORT_NETWORK_STAT)}getNextCommandSequenceNumber(){return this.sequence}hangup(e){return R(this,null,(function*(){return this._send(k.HANGUP,{reason:e}).catch((()=>{}))}))}sendCandidate(e,t){return R(this,null,(function*(){return this._send(k.TRANSMIT_DATA,{participantId:e,data:{candidate:t}},!1)}))}requestTestMode(e,t){return R(this,null,(function*(){return this._send(k.REQUEST_TEST_MODE,{consumer:e,producer:t})}))}sendSdp(e,t,i){return R(this,null,(function*(){let r=Object.assign({sdp:t},i);return this._send(k.TRANSMIT_DATA,{participantId:e,data:r})}))}acceptCall(e){return R(this,null,(function*(){return this._send(k.ACCEPT_CALL,{mediaSettings:e})}))}changeMediaSettings(e){return R(this,null,(function*(){return this._send(k.CHANGE_MEDIA_SETTINGS,{mediaSettings:e},!0,10)}))}changeParticipantState(e,t){return R(this,null,(function*(){let i={participantState:{state:e}};return t&&(i.participantId=t),this._sendRaw(k.CHANGE_PARTICIPANT_STATE,i)}))}putHandsDown(){return R(this,null,(function*(){return this._send(k.PUT_HANDS_DOWN)}))}addParticipant(e,t){return R(this,null,(function*(){return this._send(k.ADD_PARTICIPANT,y({participantId:e},t))}))}removeParticipant(e,t=!1){return R(this,null,(function*(){return this._send(k.REMOVE_PARTICIPANT,{participantId:e,ban:t})}))}allocateConsumer(e,t){return R(this,null,(function*(){let i={capabilities:t};return e&&(i.description=e.sdp),this._send(k.ALLOCATE_CONSUMER,i)}))}acceptProducer(e,t){return R(this,null,(function*(){let i={description:e.sdp};return t&&(i.ssrcs=t),this._send(k.ACCEPT_PRODUCER,i)}))}changePriorities(e){return R(this,null,(function*(){return this._send(k.CHANGE_STREAM_PRIORITIES,{typedPriorities:e}).catch((()=>{}))}))}updateDisplayLayout(e){return R(this,null,(function*(){return this._send(k.UPDATE_DISPLAY_LAYOUT,e)}))}addMovie(e){return R(this,null,(function*(){return this._send(k.ADD_MOVIE,e)}))}updateMovie(e){return R(this,null,(function*(){return this._send(k.UPDATE_MOVIE,e)}))}removeMovie(e){return R(this,null,(function*(){return this._send(k.REMOVE_MOVIE,e)}))}startUrlSharing(e){return this._send(k.START_URL_SHARING,{sharedUrl:e})}stopUrlSharing(){return this._send(k.STOP_URL_SHARING)}updateRooms(e,t){return R(this,null,(function*(){return this._send(k.UPDATE_ROOMS,{rooms:e,assignRandomly:t})}))}activateRooms(e,t){return R(this,null,(function*(){return this._send(k.ACTIVATE_ROOMS,{roomIds:e,deactivate:t})}))}switchRoom(e,t){return R(this,null,(function*(){return this._sendRaw(k.SWITCH_ROOM,{toRoomId:e,participantId:t})}))}getRooms(e){return R(this,null,(function*(){return this._sendRaw(k.GET_ROOMS,{withParticipants:e})}))}removeRooms(e){return R(this,null,(function*(){return this._send(k.REMOVE_ROOMS,{roomIds:e})}))}startStream(e){return R(this,null,(function*(){return this._send(k.RECORD_START,e)}))}stopStream(){return R(this,arguments,(function*(e={roomId:null}){return this._send(k.RECORD_STOP,e)}))}publishStream(){return R(this,arguments,(function*(e={roomId:null}){return this._send(k.RECORD_PUBLISH,e)}))}recordSetConf(){return R(this,arguments,(function*(e={hideParticipantCount:!1,roomId:null}){var t;let i={options:{hideParticipantCount:e.hideParticipantCount},roomId:e.roomId};return e.king&&(i.king=e.king),null!=(t=e.pawns)&&t.length&&(i.pawns=e.pawns.join(",")),this._send(k.RECORD_SET_CONF,i)}))}getRecordStatus(){return R(this,null,(function*(){return this._send(k.RECORD_GET_STATUS)}))}switchTopology(e,t=!1){return R(this,null,(function*(){return this._send(k.SWITCH_TOPOLOGY,{topology:e,force:t})}))}requestRealloc(){return R(this,null,(function*(){return this._send(k.REQUEST_REALLOC)}))}reportPerfStat(e){return R(this,null,(function*(){return this._send(k.REPORT_PERF_STAT,e)}))}reportSharingStat(e){return R(this,null,(function*(){return this._send(k.REPORT_SHARING_STAT,e,!1)}))}reportNetworkStat(e){return R(this,null,(function*(){return this._send(k.REPORT_NETWORK_STAT,e,!1)}))}chatMessage(e,t=null){return R(this,null,(function*(){return this._send(k.CHAT_MESSAGE,{message:e,participantId:t})}))}chatHistory(e){return R(this,null,(function*(){return this._send(k.CHAT_HISTORY,{count:e})}))}customData(e,t){return R(this,null,(function*(){return this._send(k.CUSTOM_DATA,{data:e,participantId:t})}))}grantRoles(e,t,i){return R(this,null,(function*(){let r={participantId:e,roles:t};return i&&(r.revoke=!0),this._sendRaw(k.GRANT_ROLES,r)}))}muteParticipant(e,t,i,r=null){return R(this,null,(function*(){return this._sendRaw(k.MUTE_PARTICIPANT,{participantId:e,muteStates:t,requestedMedia:i,roomId:r})}))}enableFeatureForRoles(e,t){return R(this,null,(function*(){return this._sendRaw(k.ENABLE_FEATURE_FOR_ROLES,{feature:e,roles:t})}))}pinParticipant(e,t,i){return R(this,null,(function*(){let r={participantId:e,roomId:i};return t&&(r.unpin=!0),this._sendRaw(k.PIN_PARTICIPANT,r)}))}updateMediaModifiers(e){return R(this,null,(function*(){return this._send(k.UPDATE_MEDIA_MODIFIERS,{mediaModifiers:e})}))}enableVideoSuspend(e){return R(this,null,(function*(){return this._send(k.ENABLE_VIDEO_SUSPEND,{enabled:e},!1)}))}enableVideoSuspendSuggest(e){return R(this,null,(function*(){return this._send(k.ENABLE_VIDEO_SUSPEND_SUGGEST,{enabled:e},!1)}))}changeOptions(e){return R(this,null,(function*(){return this._send(k.CHANGE_OPTIONS,{options:e})}))}getWaitingHall(e=null,t,i=!1){return R(this,null,(function*(){let r={};return e&&(r.fromId=e),t&&(r.count=t),i&&(r.backward=i),this._send(k.GET_WAITING_HALL,r)}))}promoteParticipant(e,t=!1){return R(this,null,(function*(){let i={};return e&&(i.participantId=e),t&&(i.demote=t),this._sendRaw(k.PROMOTE_PARTICIPANT,i)}))}requestPromotion(e=!1){return R(this,null,(function*(){let t={};return e&&(t.unrequest=e),this._send(k.REQUEST_PROMOTION,t)}))}acceptPromotion(e=!1){return R(this,null,(function*(){let t={};return e&&(t.reject=e),this._send(k.ACCEPT_PROMOTION,t)}))}feedback(e){return R(this,null,(function*(){return this._sendRaw(k.FEEDBACK,{key:e})}))}getHandQueue(){return R(this,null,(function*(){return this._send(k.GET_HAND_QUEUE)}))}close(){this.socket&&this.socket.readyState<WebSocket.CLOSING&&this._closeSocket(),this._stopWaitConnectionMessage(),this._stopDoctor(),clearTimeout(this.reconnectTimer)}readyToSend(e=!0){this.listenersReady=e,this._handleCachedMessages()}getParticipantListChunk(e){return R(this,null,(function*(){return this._send(k.GET_PARTICIPANT_LIST_CHUNK,e)}))}getParticipants(e){return R(this,null,(function*(){return this._send(k.GET_PARTICIPANTS,{externalIds:e})}))}getPeerId(){return this.peerId}startAsr(e){return R(this,null,(function*(){return this._send(k.ASR_START,e)}))}stopAsr(e){return R(this,null,(function*(){return this._send(k.ASR_STOP,e)}))}requestAsr(e){return R(this,null,(function*(){return this._send(k.REQUEST_ASR,{request:e},!1)}))}_connect(e){if(this.socket&&this.socket.readyState<WebSocket.CLOSING)return;let t="";e&&(t+=`&tgt=${e}`),e===Ci.RETRY&&this.lastStamp&&(t+=`&recoverTs=${this.lastStamp}`),t=function(e){if(!Ve.useParticipantListChunk)return e;let t=Ve.participantListChunkInitIndex;e+=`&partIdx=${t}`;let i=Ve.participantListChunkInitCount;return null!==i&&(e+=`&partCount=${i}`),e}(t),li.debug("[signaling] connecting to "+this.endpoint+this.postfix+t),this.socket=new WebSocket(this.endpoint+this.postfix+t),this.socket.onopen=this._onOpen.bind(this),this.socket.onmessage=this._onMessage.bind(this),this.socket.onerror=this._onError.bind(this),this.socket.onclose=this._onClose.bind(this),this._startDoctor()}_disconnect(e){this.socket&&this.socket.readyState<WebSocket.CLOSING&&(this.socket.onopen=null,this.socket.onmessage=null,this.socket.onerror=null,this.socket.onclose=null,this.socket.close(e),this.socket=null),this._stopWaitConnectionMessage(),this._stopDoctor(),clearTimeout(this.reconnectTimer)}_onOpen(){li.debug("[signaling] socket opened"),w.log(F.SOCKET_ACTION,"opened"),this._waitConnectionMessage(),this._startDoctor()}_onMessage(e){if(this._startDoctor(),"ping"===e.data)return nt.onSignalingMessage(e.data),void(this.socket&&this.socket.readyState===WebSocket.OPEN&&this.socket.send("pong"));try{let t=JSON.parse(e.data);nt.onSignalingMessage(t),this._handleMessage(t)}catch(t){w.log(F.SOCKET_ACTION,"parse_error"),li.error("[signaling] unable to parse message",t,e.data)}}_handleMessage(e){var t;switch(e.type){case"notification":"connection"===e.notification?(li.debug("[signaling] signaling connected",e),this.connected=!0,this.reconnectCount=0,this.endpoint=e.endpoint,e.peerId&&this.peerId!==e.peerId.id&&(this.postfix+=`&peerId=${e.peerId.id}`,this.peerId=e.peerId.id),this._stopWaitConnectionMessage(),this.conversationResolve?this.conversationResolve(e):(this._triggerEvent(Ii.RECONNECT,e),e.conversation.topology&&this._triggerEvent(Ii.NOTIFICATION,{type:"notification",notification:Ai.TOPOLOGY_CHANGED,topology:e.conversation.topology})),this.lastStamp&&this._handleCachedMessages(),null==(t=e.recoverMessages)||t.forEach((e=>this._handleMessage(e))),this._handleCommandsQueue(this.websocketCommandsQueue)):this.connected&&this.listenersReady?this._triggerEvent(Ii.NOTIFICATION,e):this.incomingCache.push(e);break;case"response":this._handleCommandResponse(!0,e);break;case"error":this._handleErrorMessage(e);break;default:w.log(F.SOCKET_ACTION,"unknown_message"),li.warn("[signaling] unhandled message",e)}this.lastStamp=e.stamp||this.lastStamp}_handleErrorMessage(e){var t;w.log(F.SOCKET_ACTION,`error-${e.error}`);let i=!!e.error&&Oi.includes(e.error);switch(li.debug(`[signaling] error message [${e.sequence}]`,e),e.sequence&&this.responseHandlers[e.sequence]&&this._handleCommandResponse(!1,e),e.error){case"service-unavailable":this._reconnect();break;case"conversation-ended":this.conversationReject?this.conversationReject(new N(e.reason||U.SIGNALING_FAILED,{message:`Conversation ended: ${e.error}`,remote:!0})):this._triggerEvent(Ii.NOTIFICATION,{notification:Ai.CLOSED_CONVERSATION,reason:e.reason});break;case"participant-not-found":case"invalid-token":this._throwError(new Error(`Signaling error: ${e.error}`));break;default:if(!i)break;this.connected?this._throwError(new Error(`Signaling error: ${e.error}`)):e.sequence||(null==(t=this.conversationReject)||t.call(this,new N(e.reason||U.SIGNALING_FAILED,{message:`Unable to connect to the signaling: ${e.error}`,remote:!0})),this._closeSocket())}}_handleCachedMessages(){let e=[...this.incomingCache];for(this.incomingCache=[];e.length>0;){let t=e.shift();this._handleMessage(t)}}_throwError(e){this._triggerEvent(Ii.FAILED,e)}_onError(e){w.log(F.SOCKET_ACTION,"error"),li.error("[signaling] signaling error",e)}_onClose(e){w.log(F.SOCKET_ACTION,"closed"),li.debug("[signaling] connection closed",{code:e.code,reason:e.reason}),this.connected=!1,this._stopDoctor(),this.socket&&this.reconnectCount++<bi.RECONNECT_MAX_COUNT?this._reconnect():this.socket&&this._closeSocket(new Error("Connection closed"))}_closeSocket(e=null){this.socket&&(this._disconnect(),Object.values(this.responseHandlers).forEach((t=>{window.clearTimeout(t.responseTimer),e&&t.reject(new Error("Connection closed"),!0)})),this.websocketCommandsQueue=[],this.responseHandlers={},this.lastStamp=0,e&&this._throwError(new Error("Connection closed")))}_reconnect(){let e=Math.min(bi.RECONNECT_MAX_DELAY,bi.RECONNECT_DELAY*Math.pow(2,this.reconnectCount-1));li.log(`[signaling] reconnect websocket after ${e}ms (${this.reconnectCount})`),w.log(F.SOCKET_ACTION,"reconnect"),this.reconnectTimer=window.setTimeout(this._connect.bind(this,Ci.RETRY),e)}_handleCommandResponse(e,t){var i;if(!this.responseHandlers.hasOwnProperty(t.sequence))return;let r=this.responseHandlers[t.sequence];window.clearTimeout(r.responseTimer),li.debug(`[signaling] command response [${t.sequence}]`,t),e?(delete this.responseHandlers[t.sequence],r.resolve(t)):"error"===t.type?(delete this.responseHandlers[t.sequence],w.log(F.SOCKET_ACTION,"response-error"),r.reject(new Error(t.error||`Response error [${r.name}]`),!0)):(null==(i=this.socket)?void 0:i.readyState)===WebSocket.OPEN?(delete this.responseHandlers[t.sequence],w.log(F.SOCKET_ACTION,"response-timeout"),r.reject(new Error(t.error||`Response timeout [${r.name}]`))):r.responseTimer=window.setTimeout((()=>this._handleCommandResponse(e,t)),bi.WAIT_RESPONSE_DELAY)}_handleCommandsQueue(e){for(var t,i;e.length>0;){let r=e.shift();if(li.debug(`[signaling] command send [${r.sequence}]`,`'${r.name}'`,r.params),this._isDataChannelCommand(r.name)){if((null==(t=this.producerCommandDataChannel)?void 0:t.readyState)!==Pi)return void r.reject(new Error(`Invalid data channel state: ${null==(i=this.producerCommandDataChannel)?void 0:i.readyState}`));this._startResponseTimer(r);let e=this._serializeBinary(r);null!==e&&this.producerCommandDataChannel.send(e)}else{if(!this.socket||this.socket.readyState!==WebSocket.OPEN){r.reject(new Error("Invalid state or socket already closed"));continue}this._startResponseTimer(r),this.socket.send(this._serializeJson(r))}}}_startResponseTimer(e){e.needResponse?(e.responseTimer=window.setTimeout((()=>this._handleCommandResponse(!1,{response:e.name,sequence:e.sequence,type:"timeout"})),bi.WAIT_RESPONSE_DELAY),this.responseHandlers[e.sequence]=e):e.resolve({type:"response",sequence:e.sequence,response:e.name})}_serializeBinary(e){switch(e.name){case k.UPDATE_DISPLAY_LAYOUT:return this.producerCommandSerializationService.serializeUpdateDisplayLayout(e.sequence,e.params);case k.REPORT_PERF_STAT:return this.producerCommandSerializationService.serializePerfStatReport(e.sequence,e.params);case k.REPORT_SHARING_STAT:return this.producerCommandSerializationService.serializeSharingStatReport(e.sequence,e.params);case k.REQUEST_ASR:return this.producerCommandSerializationService.serializeRequestAsr(e.sequence,e.params);case k.REPORT_NETWORK_STAT:return this.producerCommandSerializationService.serializeNetworkStatReport(e.sequence,e.params);case k.ENABLE_VIDEO_SUSPEND:return this.producerCommandSerializationService.serializeEnableVideoSuspend(e.sequence,e.params);case k.ENABLE_VIDEO_SUSPEND_SUGGEST:return this.producerCommandSerializationService.serializeEnableVideoSuspendSuggest(e.sequence,e.params)}return li.warn("[signaling] cannot get binary data for data channel command: "+e.name),null}_serializeJson(e){let t;t=e.name===k.UPDATE_DISPLAY_LAYOUT?this._convertDisplayLayout(e.params):e.params;let i=Object.assign({command:e.name,sequence:e.sequence},t);return JSON.stringify(i)}_convertDisplayLayout(e){let t=e,i={};for(let e in t)t.hasOwnProperty(e)&&(i[e]=hi(t[e]));return{layouts:i}}_waitConnectionMessage(){this.connectionMessageWaitTimer=window.setTimeout((()=>{this.conversationReject&&this.conversationReject(new N(U.SIGNALING_FAILED,{message:"Unable to connect to the signaling: connection timeout",remote:!0}))}),bi.WAIT_CONNECTION_DELAY)}_stopWaitConnectionMessage(){window.clearTimeout(this.connectionMessageWaitTimer),this.connectionMessageWaitTimer=0}_startDoctor(){this._stopDoctor(),this.doctorTimer=window.setTimeout((()=>{li.warn("[signaling] socket is dead, trying to reconnect"),this._disconnect(4e3),this._connect(Ci.RETRY)}),bi.WAIT_MESSAGE_DELAY)}_stopDoctor(){window.clearTimeout(this.doctorTimer),this.doctorTimer=0}},Ni=bi;Ni.RECONNECT_DELAY=Ve.signalingReconnectDelay,Ni.RECONNECT_MAX_DELAY=Ve.signalingReconnectMaxDelay,Ni.RECONNECT_MAX_COUNT=Ve.signalingReconnectMaxCount,Ni.WAIT_CONNECTION_DELAY=Ve.waitConnectionDelay,Ni.WAIT_RESPONSE_DELAY=Ve.waitResponseDelay,Ni.WAIT_MESSAGE_DELAY=Ve.waitMessageDelay;var wi=(e=>(e.INCOMING="INCOMING",e.OUTGOING="OUTGOING",e.JOINING="JOINING",e))(wi||{}),Mi=wi,ki=(e=>(e.USER="USER",e.GROUP="GROUP",e.CHAT="CHAT",e))(ki||{}),Li=ki,Ui=(e=>(e.ATTENDEE="ATTENDEE",e.HAND_UP="HAND_UP",e))(Ui||{}),xi=Ui,Vi=(e=>(e.ADD_PARTICIPANT="ADD_PARTICIPANT",e.RECORD="RECORD",e.MOVIE_SHARE="MOVIE_SHARE",e))(Vi||{}),Bi=Vi,Fi=(e=>(e.REQUIRE_AUTH_TO_JOIN="REQUIRE_AUTH_TO_JOIN",e.AUDIENCE_MODE="AUDIENCE_MODE",e.WAITING_HALL="WAITING_HALL",e.ASR="ASR",e.FEEDBACK="FEEDBACK",e.RECURRING="RECURRING",e))(Fi||{}),ji=Fi;var Gi=(e=>(e.UNMUTE="UNMUTE",e.MUTE="MUTE",e.MUTE_PERMANENT="MUTE_PERMANENT",e))(Gi||{}),Hi=Gi,Wi=(e=>(e.CALLED="CALLED",e.ACCEPTED="ACCEPTED",e.REJECTED="REJECTED",e.HUNGUP="HUNGUP",e))(Wi||{}),$i=Wi,Ki=(e=>(e.UPDATE="UPDATE",e.REMOVE="REMOVE",e.ACTIVATE="ACTIVATE",e.TIMEOUT="TIMEOUT",e))(Ki||{}),zi=Ki,qi=(e=>(e.AUDIO_MIX="audio-mix",e.PARTICIPANT_AGNOSTIC_TRACK_PREFIX="pat",e))(qi||{}),Ji=qi,Yi=(e=>(e.NO_AVAILABLE_TRACKS="no-available-tracks",e.UNKNOWN_ERROR="unknown-error",e))(Yi||{}),Qi=Yi;var Xi=(e=>(e.CREATOR="CREATOR",e.ADMIN="ADMIN",e))(Xi||{}),Zi=Xi;function er(e,t){if(e.length!==t.length)return!1;for(let i of e)if(!t.includes(i))return!1;return!0}var tr,ir=(e=>(e.USER="USER",e.ANONYM="ANONYM",e.GROUP="GROUP",e))(ir||{});function rr(e,t){return null===e||null===t?null===e&&null===t:!(e.maxDimension!==t.maxDimension||e.maxBitrateK!==t.maxBitrateK||e.maxFramerate!==t.maxFramerate||e.degradationPreference!==t.degradationPreference||e.scalabilityMode!==t.scalabilityMode)}function nr(e,t){return!(!rr(e.camera,t.camera)||!rr(e.screenSharing,t.screenSharing))}function ar(e,t){return{camera:Object.assign({},e.camera,t.camera),screenSharing:Object.assign({},e.screenSharing,t.screenSharing)}}(e=>{function t(e,t="USER",i=0){return{id:e,type:t,deviceIdx:i}}function i(e,t=0){return{id:e.id,type:"ANONYM"===e.type?"ANONYM":"USER",deviceIdx:t}}function r(e){let t=e.deviceIdx||0;return`{"id":"${e.id}","type":"${e.type}","deviceIdx":${t}}`}e.fromIds=function(e){return e.length?"object"==typeof e[0]?e:e.map((e=>t(e))):[]},e.fromId=t,e.fromSignalingParticipant=function(e,t=!0){var r;let n=t?e.decorativeExternalUserId:e.externalId,a=null!=(r=e.deviceIdx)?r:0;if(n)return i(n,a)},e.fromSignaling=i,e.toString=r,e.fromIdToString=function(e,i="USER",n=0){return r(t(e,i,n))},e.fromString=function(e){try{return JSON.parse(e)}catch(t){throw new Error(`Failed to parse ExternalId from string '${e}'`)}},e.compare=function(e,t){return e.id===t.id&&e.type===t.type&&e.deviceIdx===t.deviceIdx},e.getDeviceIdx=function(e){return(null==e?void 0:e.deviceIdx)||0}})(tr||(tr={}));var sr=(e,t)=>Q.objectReduce(e,((e,i,r)=>(i===t&&e.push(r),e)),[]);function or(e,t){return Q.objectReduce(e,((e,i,r)=>{switch(i){case Hi.MUTE:case Hi.MUTE_PERMANENT:(function(e,t){switch(e){case V.AUDIO:return!!t.isAudioEnabled;case V.AUDIO_SHARING:return!!t.isAudioSharingEnabled;case V.VIDEO:return!!t.isVideoEnabled;case V.SCREEN_SHARING:return!!t.isFastScreenSharingEnabled||!!t.isScreenSharingEnabled;default:return!1}})(r,t)||(e[r]=i);break;default:e[r]=i}return e}),{})}function cr(e){let{muteStates:t={},mediaSettings:i}=e;return or(t,i)}var lr=class{constructor(e){this._fixNoPacketsApplied=!1,this._fixNoPacketsChecked=!1,this._fixTooManyPacketsApplied=!1,this._fixTooManyPacketsSucceeded=!1,this._fixTooManyPacketsFailed=!1,this._toggleAudioPromise=null,this._fixNoPacketsAppliedVideo=!1,this._mediaSource=e}_fixAudioDeviceNoPackets(e){if(!this._fixNoPacketsApplied||!this._fixNoPacketsChecked){if(this._fixNoPacketsApplied&&!this._fixNoPacketsChecked)return this._fixNoPacketsChecked=!0,void w.log(F.ERROR,"audio_device_recover_"+(e.bandwidth?"success":"fail"));!this._fixNoPacketsApplied&&!e.bandwidth&&(this._fixNoPacketsApplied=!0,w.log(F.ERROR,"audio_device_recover"),li.log("[AudioFix] Trying to fix RV (no packets)"),this._toggleAudioPromise=this._mediaSource.toggleAudio("denied"!==jt.getMicrophonePermissionState()))}}_fixAudioDeviceTooManyPackets(e){if(this._fixTooManyPacketsSucceeded||this._fixTooManyPacketsFailed)return;let t=Date.now();if(this._lastPacketsSentTime){if(t-this._lastPacketsSentTime>500){let i=1e3*(e.packetsSent-this._lastPacketsSent)/(t-this._lastPacketsSentTime);this._lastPacketsSentTime=t,this._lastPacketsSent=e.packetsSent,this._fixTooManyPacketsApplied?i>75?(li.log("[AudioFix] Failed to fix RV"),w.log(F.ERROR,"audio_device_recover_rv_fail"),this._fixTooManyPacketsFailed=!0):t-this._fixTooManyPacketsTime>6e4&&(li.log("[AudioFix] Fixed RV"),w.log(F.ERROR,"audio_device_recover_rv_success"),this._fixTooManyPacketsSucceeded=!0):i>75&&(this._fixTooManyPacketsApplied=!0,w.log(F.ERROR,"audio_device_recover"),li.log("[AudioFix] Trying to fix RV (too many packets)"),this._mediaSource.toggleAudio(!0),this._fixTooManyPacketsTime=t)}}else e.packetsSent>0&&(this._lastPacketsSentTime=t,this._lastPacketsSent=e.packetsSent)}fix(e){if(!this._mediaSource)return;let t=e.find((e=>"audio"===e.kind));t&&(this._fixAudioDeviceNoPackets(t),this._fixAudioDeviceTooManyPackets(t))}fixVideo(e){if(!this._mediaSource||this._fixNoPacketsAppliedVideo||!this._toggleAudioPromise)return;let t=e.find((e=>"video"===e.kind));t&&!t.bandwidth&&(this._fixNoPacketsAppliedVideo=!0,this._toggleAudioPromise.then((()=>{this._mediaSource.getMediaSettings().isVideoEnabled&&this._mediaSource.toggleVideo(!0)})))}},dr=class{constructor(e){this._output=null,this._volume=1,this._features={setSinkId:!!Audio.prototype.setSinkId},this._statFirstMediaReceived=e}add(e){this.destroy(),this._output={},this._output.audioTrack=e,this._initAudioElement()}remove(e){!this._output||this._output.audioTrack!==e||this.destroy()}get volume(){return this._volume}set volume(e){this._volume=Math.max(0,Math.min(1,e)),this._output&&this._output.audioElement&&(this._output.audioElement.volume=this._volume)}_initAudioElement(){var e;if(Ve.muteMode||null==(e=this._output)||!e.audioTrack)return;let t="Safari"!==jt.browserName()||jt.isMobile(),i=document.createElement(t?"audio":"video");i.muted=!1,i.volume=this._volume,i.preload="auto";let r=()=>{li.warn("[audio] Error on play audio"),nt.onAutoplayError()},n=e=>{i.srcObject=new MediaStream([e]),i.load();let t=i.play();t&&t.catch(r)},a=()=>{var e;li.debug("[audio] Recover audio playback");let t=null==(e=this._output)?void 0:e.audioTrack;t?n(t):li.warn("[audio] Broken audio track")};i.onpause=a,i.onstalled=a,i.onerror=a,i.onloadeddata=()=>{this._statFirstMediaReceived.measure()},n(this._output.audioTrack),this._output.audioElement=i}_stopAudioElement(){var e,t,i;null!=(e=this._output)&&e.audioElement&&(this._output.audioElement.pause(),this._output.audioElement.srcObject=null),null==(i=null==(t=this._output)?void 0:t.audioTrack)||i.stop()}destroy(){this._output&&(this._stopAudioElement(),this._output=null)}changeOutput(){return R(this,null,(function*(){var e,t,i;try{if(!this._features.setSinkId)throw new Error('Feature "setSinkId" is not supported');if(null==(e=this._output)||!e.audioElement)return;let r=jt.getSavedOutput();r&&(yield null==(i=(t=this._output.audioElement).setSinkId)?void 0:i.call(t,r.deviceId))}catch(e){throw w.log(F.ERROR,"change_output"),li.error("[audio] Output change failed",e),e}}))}},ur=class extends P{constructor(){super(...arguments),this._lastMemoryStat={percent:0,bytes:0}}onRemoteDataStats(e,t){this._calcMemory(),e.inbound.rtps.map((e=>{let i="string"==typeof e.userId&&t[e.userId]||null;e.userId=null==i?void 0:i.externalId})),nt.onStatistics(e,this._lastMemoryStat)}_calcMemory(){var e;let t=null==(e=null==window?void 0:window.performance)?void 0:e.memory;if(!t||!t.usedJSHeapSize||!t.jsHeapSizeLimit)return;let i=Number((100*t.usedJSHeapSize/t.jsHeapSizeLimit).toFixed(2)),r=Number((t.usedJSHeapSize/1024/1024).toFixed(1));i>90?li.warn(`High memory usage: ${i}% (${r} MiB)`):(!this._lastMemoryStat.percent||Math.abs(i-this._lastMemoryStat.percent)>=3)&&(li.debug(`Memory usage: ${i}% (${r} MiB)`),this._lastMemoryStat.percent=i,this._lastMemoryStat.bytes=t.usedJSHeapSize)}},hr=class{constructor(e,t){this._analyser=null,this._gainNode=null,this._fftBins=null,this._mediaStreamSource=null,this._lastSmoothedLevel=0,this._trackId=e,this._track=t,this._stream=new MediaStream([t]);try{let e=jt.getAudioContext();this._gainNode=e.createGain(),this._gainNode.gain.value=1e-5,this._gainNode.connect(e.destination),this._analyser=e.createAnalyser(),this._analyser.fftSize=1024,this._analyser.smoothingTimeConstant=0,this._analyser.connect(this._gainNode),this._fftBins=new Uint8Array(this._analyser.frequencyBinCount),this._mediaStreamSource=e.createMediaStreamSource(this._stream),this._mediaStreamSource.connect(this._analyser)}catch(e){}}get track(){return this._track}get trackId(){return this._trackId}_getBins(){if(!this._fftBins||!this._analyser)return new Uint8Array;this._analyser.getByteFrequencyData(this._fftBins);let e=44100/this._fftBins.length,t=Math.ceil(Ve.voiceParams.minFreq/e),i=Math.floor(Ve.voiceParams.maxFreq/e);return this._fftBins.subarray(t,i)}getLevel(){let e=this._getBins(),t=e.reduce(((e,t)=>e+t),0)/e.length/255,i=this._lastSmoothedLevel*Ve.voiceParams.smoothing+t*(1-Ve.voiceParams.smoothing);return this._lastSmoothedLevel=i,{real:t,smoothed:i}}destroy(){this._mediaStreamSource&&(this._mediaStreamSource.disconnect(),this._mediaStreamSource=null),this._gainNode&&(this._gainNode.disconnect(),this._gainNode=null),this._analyser&&(this._analyser.disconnect(),this._analyser=null,this._fftBins=null,this._lastSmoothedLevel=0),this._stream.removeTrack(this._track)}},pr=class extends P{constructor(e){super(),this._detector=null,this._interval=null;let t=()=>{this._detector&&nt.onLocalVolume(this._detector.getLevel().real,e.getMediaSettings().isAudioEnabled),this._interval=window.setTimeout(t,Ve.voiceParams.interval)};this._interval=window.setTimeout(t,Ve.voiceParams.interval);let i=()=>{let t=e.getSendAudioTrack();t&&this.init(t)};this.subscribe(e,"SOURCE_CHANGED",(t=>{"audio"===t.kind&&e.getMediaSettings().isAudioEnabled&&i()})),i()}init(e){this._stopDetector(),this._detector=new hr("local",e.clone())}_stopDetector(){this._detector&&(this._detector.track.stop(),this._detector.destroy(),this._detector=null)}destroy(){this.unsubscribe(),this._interval&&(window.clearTimeout(this._interval),this._interval=null),this._stopDetector()}},_r=(e=>(e.producerNotification="producerNotification",e.producerCommand="producerCommand",e.consumerScreenShare="consumerScreenShare",e.producerScreenShare="producerScreenShare",e.asr="asr",e.animoji="animoji",e))(_r||{}),mr=_r,fr=class extends P{constructor(e,t){super(),this._state="IDLE",this._pc=null,this._signaling=e,this._mediaSource=t}getState(){return this._state||"IDLE"}},gr="videochat-epi",Sr=class extends P{constructor(e,t,i=!1){super(),this._previousPerfStatReportTimestamp=0,this._previousNetworkStatReportTimestamp=Date.now(),this._previousCallStatReportTimestamp=Date.now(),this._previousCallStatReport=null,this._screenShareStats=[],this._handleScreenSharingStat=e=>{this._screenShareStats.push(e)},this._handleTransportStateChanged=e=>{(this._directTopology&&"CONNECTED"===e||!this._directTopology&&"OPENED"===e)&&(this._previousNetworkStatReportTimestamp=Date.now(),this._previousCallStatReportTimestamp=Date.now())},this._signaling=t,this._directTopology=i,this.subscribe(e,"REMOTE_DATA_STATS",this._handleStats.bind(this)),this.subscribe(e,"SCREEN_SHARING_STAT",this._handleScreenSharingStat.bind(this)),this.subscribe(e,"STATE_CHANGED",this._handleTransportStateChanged.bind(this))}destroy(){this.unsubscribe()}static getEstimatedPerformanceIndex(){try{let e=parseInt(localStorage.getItem(gr)||"",10);return isNaN(e)?0:e}catch(e){return 0}}_handleStats(e){return R(this,null,(function*(){var t;if(!e.inbound||!e.inbound.rtps)return;let i=Date.now();!this._directTopology&&Ve.perfStatReportEnabled&&this._previousPerfStatReportTimestamp+5e3<=i&&(yield this.reportPerfStats(e),this._previousPerfStatReportTimestamp=i);let r="tcp"===(null==(t=e.outbound.transport.local)?void 0:t.protocol);!this._directTopology&&r&&this._previousNetworkStatReportTimestamp+500<=i&&(yield this.reportNetworkStats(e),this._previousNetworkStatReportTimestamp=i),Ve.callStatReportEnabled&&this._previousCallStatReportTimestamp+Ve.statisticsInterval<=i&&(this._reportCallStats(e),this._previousCallStatReportTimestamp=i)}))}reportPerfStats(e){return R(this,null,(function*(){let t=e.inbound.rtps.reduce(((e,t)=>("video"===t.kind&&(e.framesDecoded+=t.framesDecoded||0,e.framesReceived+=t.framesReceived||0),e)),{framesDecoded:0,framesReceived:0});if(t.framesDecoded)try{let e=yield this._signaling.reportPerfStat(t);localStorage.setItem(gr,e.estimatedPerformanceIndex)}catch(e){}}))}reportNetworkStats(e){return R(this,null,(function*(){let t={timestamp:e.outbound.transport.timestamp,sendBitrate:e.outbound.rtps.reduce(((e,t)=>{var i;return e+8*(null!=(i=t.bandwidth)?i:0)}),0)};if(t.timestamp)try{yield this._signaling.reportNetworkStat(t)}catch(e){}}))}_reportCallStats(e){var t,i,r,n;let a={call_topology:this._directTopology?"D":"S",stat_time_delta:0,nack_received:0,pli_received:0,fir_received:0,frames_dropped:0,jitter_video:0,jitter_audio:0,interframe_delay_variance:0,nack_sent:0,pli_sent:0,fir_sent:0,total_audio_samples_received:0,concealed_audio_samples:0,silent_concealed_audio_samples:0,inserted_audio_samples_for_deceleration:0,removed_audio_samples_for_acceleration:0,audio_concealment_events:0,total_audio_energy:0,inbound_video_count:0,inbound_audio_count:0,packets_lost_video:0,packets_sent_video:0,packets_lost_audio:0,packets_sent_audio:0,freeze_count:0,total_freezes_duration:0,rtt:Math.round(1e3*e.inbound.transport.currentRoundTripTime),ss_freeze_count:0,ss_total_freezes_duration:0,local_address:Er(e.inbound.transport.local),local_connection_type:null==(t=e.inbound.transport.local)?void 0:t.type,network_type:null==(i=e.inbound.transport.local)?void 0:i.networkType,transport:null==(r=e.inbound.transport.local)?void 0:r.protocol,remote_address:Er(e.inbound.transport.remote),remote_connection_type:null==(n=e.inbound.transport.remote)?void 0:n.type};this._previousCallStatReport||(this._previousCallStatReport=Object.assign({},a));let s=!1,o=!1;for(e.inbound.rtps.reduce(((e,t)=>("video"===t.kind?(s=!0,t.framesReceived&&(e.jitter_video=e.jitter_video*e.inbound_video_count/(e.inbound_video_count+1)+1e3*t.jitter/(e.inbound_video_count+1),e.interframe_delay_variance=e.interframe_delay_variance*e.inbound_video_count/(e.inbound_video_count+1)+1e6*(t.interframeDelayVariance||0)/(e.inbound_video_count+1),e.inbound_video_count++),e.frames_dropped+=t.framesDropped||0,e.nack_sent+=t.nackCount,e.pli_sent+=t.pliCount,e.fir_sent+=t.firCount,e.freeze_count+=t.freezeCountDelta||0,e.total_freezes_duration+=t.totalFreezesDurationDelta||0):(o=!0,t.totalSamplesReceived&&(e.jitter_audio=e.jitter_audio*e.inbound_audio_count/(e.inbound_audio_count+1)+1e3*t.jitter/(e.inbound_audio_count+1),e.total_audio_energy=e.total_audio_energy*e.inbound_audio_count/(e.inbound_audio_count+1)+(t.totalAudioEnergy||0)/(e.inbound_audio_count+1),e.inbound_audio_count++),e.total_audio_samples_received+=t.totalSamplesReceived||0,e.inserted_audio_samples_for_deceleration+=t.insertedSamplesForDeceleration||0,e.removed_audio_samples_for_acceleration+=t.removedSamplesForAcceleration||0,e.concealed_audio_samples+=t.concealedSamples||0,e.silent_concealed_audio_samples+=t.silentConcealedSamples||0,e.audio_concealment_events+=t.concealmentEvents||0),e)),a),e.outbound.rtps.reduce(((e,t)=>("video"===t.kind?(e.nack_received+=t.nackCount,e.pli_received+=t.pliCount,e.fir_received+=t.firCount,e.packets_sent_video+=t.packetsSent):e.packets_sent_audio+=t.packetsSent,e)),a),e.remoteInbound.rtps.reduce(((e,t)=>("video"===t.kind?e.packets_lost_video+=t.packetsLost:e.packets_lost_audio+=t.packetsLost,e)),a);this._screenShareStats.length;){let e=this._screenShareStats.pop();null!=e&&e.freeze_duration&&(a.ss_freeze_count+=1,a.ss_total_freezes_duration+=e.freeze_duration)}let c={call_topology:a.call_topology,stat_time_delta:Math.max(0,Date.now()-this._previousCallStatReportTimestamp),nack_sent:Math.max(0,a.nack_sent-this._previousCallStatReport.nack_sent),nack_received:Math.max(0,a.nack_received-this._previousCallStatReport.nack_received),pli_sent:Math.max(0,a.pli_sent-this._previousCallStatReport.pli_sent),pli_received:Math.max(0,a.pli_received-this._previousCallStatReport.pli_received),fir_sent:Math.max(0,a.fir_sent-this._previousCallStatReport.fir_sent),fir_received:Math.max(0,a.fir_received-this._previousCallStatReport.fir_received),frames_dropped:Math.max(0,a.frames_dropped-this._previousCallStatReport.frames_dropped),rtt:Math.max(0,a.rtt)};if(s&&!Tr(a.jitter_video)&&(c.jitter_video=Math.round(a.jitter_video)),o&&!Tr(a.jitter_audio)&&(c.jitter_audio=Math.round(a.jitter_audio)),s&&!Tr(a.interframe_delay_variance)&&(c.interframe_delay_variance=a.interframe_delay_variance),a.freeze_count&&a.total_freezes_duration&&(c.freeze_count=a.freeze_count,c.total_freezes_duration=Math.round(1e3*a.total_freezes_duration)),a.ss_freeze_count&&a.ss_total_freezes_duration&&(c.ss_freeze_count=a.ss_freeze_count,c.ss_total_freezes_duration=a.ss_total_freezes_duration),o&&!Tr(a.total_audio_samples_received)){let e=Math.max(0,a.total_audio_samples_received-this._previousCallStatReport.total_audio_samples_received),t=Math.max(0,a.inserted_audio_samples_for_deceleration-this._previousCallStatReport.inserted_audio_samples_for_deceleration),i=Math.max(0,a.removed_audio_samples_for_acceleration-this._previousCallStatReport.removed_audio_samples_for_acceleration),r=Math.max(0,a.concealed_audio_samples-this._previousCallStatReport.concealed_audio_samples),n=Math.max(0,a.silent_concealed_audio_samples-this._previousCallStatReport.silent_concealed_audio_samples),s=Math.max(0,a.audio_concealment_events-this._previousCallStatReport.audio_concealment_events);c.inserted_audio_samples_for_deceleration=Cr(t/e*1e3),c.removed_audio_samples_for_acceleration=Cr(i/e*1e3),c.concealed_audio_samples=Cr(r/e*1e3),c.concealed_silent_audio_samples=Cr(n/e*1e3),c.concealment_audio_avg_size=Cr(r/s),c.total_audio_energy=a.total_audio_energy}vr(a,"local_address","local_connection_type","network_type","transport")&&(c.local_address=a.local_address,c.local_connection_type=a.local_connection_type,c.network_type=a.network_type,c.transport=a.transport),vr(a,"remote_address","remote_connection_type")&&(c.remote_address=a.remote_address,c.remote_connection_type=a.remote_connection_type);let l=Math.max(0,a.packets_sent_video-this._previousCallStatReport.packets_sent_video),d=Math.max(0,a.packets_sent_audio-this._previousCallStatReport.packets_sent_audio);if(l>0){let e=Math.max(0,a.packets_lost_video-this._previousCallStatReport.packets_lost_video);c.video_loss=Cr(e/l*100)}if(d>0){let e=Math.max(0,a.packets_lost_audio-this._previousCallStatReport.packets_lost_audio);c.audio_loss=Cr(e/d*100)}pe.logCallStat(c),Ve.enableLogPerfStatReport&&li.log("Sent call stats",c),this._previousCallStatReport=a}};function vr(e,...t){for(let i of t)if(!e.hasOwnProperty(i)||void 0===e[i])return!1;return!0}function Er(e,t=!1){if(null!=e&&e.address)return e.address+(t?`:${e.port}`:"")}function Tr(e){return void 0===e}function Cr(e){return Number.isNaN(e)?0:e}var yr=class{constructor(e,t=null){this.value=NaN,this.weightUp=e,this.weightDown=null!=t?t:e}set(e){this.value=e}update(e){return this.value=this.getNext(e),this.value}getNext(e){if(isNaN(this.value))return e;let t=e<this.value?this.weightDown:this.weightUp;return this.value*(1-t)+e*t}getValue(){return this.value}},Ir=class extends P{constructor(e){super(),this._networkLimits={badNet:{loss:3,rtt:1e3},goodNet:{loss:.5,rtt:600}},this._lastStatSentTimestamp=0,this._currentState="good",this._signaling=e,this._localNetworkStat={rtt:new yr(.25,.25),loss:new yr(.35,.35),bitrate:0},this._remoteNetworkStat={rtt:0,loss:0,bitrate:0},this._lastNetworkStat={rtt:0,loss:0,date:0}}_calcRttRating(e){let t="number"==typeof e?e:e.getValue(),i=1;if(isNaN(t))return i;let r=Math.round((t-this._networkLimits.goodNet.rtt)/85);for(let e=0;e<r;e++)i*=.9;return i}_calcLossRating(e){let t="number"==typeof e?e:e.getValue(),i=1;if(isNaN(t))return i;let r=Math.round((t-this._networkLimits.goodNet.loss)/1.5);for(let e=0;e<r;e++)i*=.9;return i}_calcBitrateRating(e,t){if(!e||!t)return 1;let i=1-1*(1-Math.min(e,t)/Math.max(e,t));return Math.min(i,1)}_calcUDPRating({rtt:e,loss:t}){return this._calcRttRating(e)*this._calcLossRating(t)}_calcRating(e,t,i){return i?this._calcBitrateRating(e.bitrate,t.bitrate):this._calcUDPRating(e)*this._calcUDPRating(t)}_getNetworkState(e){return isNaN(e)||e>=.6?"good":e>=.3?"medium":"bad"}updateSettings(e){Object.assign(this._networkLimits.badNet,(null==e?void 0:e.badNet)||{}),Object.assign(this._networkLimits.goodNet,(null==e?void 0:e.goodNet)||{})}reportLocal(e){var t;if(!this._signaling.ready)return;let i="tcp"===(null==(t=e.outbound.transport.local)?void 0:t.protocol),r=Math.max(0,Math.round(1e3*e.outbound.transport.currentRoundTripTime)||0),n=e.inbound.rtps.reduce(((e,t)=>Math.max(e,t.packetLoss||0)),0),a={rtt:this._localNetworkStat.rtt.update(r),loss:this._localNetworkStat.loss.update(n)};if(i){let t=e.outbound.rtps.reduce(((e,t)=>{var i;return e+8*(null!=(i=t.bandwidth)?i:0)}),0);a.bitrate=t,this._localNetworkStat.bitrate=t}let s=Date.now(),o=this._calcRating(this._localNetworkStat,this._remoteNetworkStat,i),c=Math.max(Math.round(10*o)/10,.1),l=this._getNetworkState(c);(i||l!==this._currentState||s-this._lastStatSentTimestamp>Ve.networkStatisticsInterval)&&(this._lastStatSentTimestamp=s,this._signaling.customData({sdk:Object.assign({type:"bad-net"},a)},null).catch((e=>{li.warn("Unable to send [bad-net]",e)}))),this._currentState=l,this._triggerEvent("NETWORK_STATUS",c)}reportRemote(e){let{rtt:t,loss:i,bitrate:r}=e||{};this._remoteNetworkStat.rtt=t||0,this._remoteNetworkStat.loss=i||0,this._remoteNetworkStat.bitrate=r||0}},Rr=class extends fr{constructor(e,t,i,r,n){if(super(i,r),this._remoteSDP={},this._remoteCandidates={},this._lastRemoteSDP=null,this._animojiDataChannel=null,this._animojiReceiver=null,this._animojiSender=null,this._remoteAnimojiVersion=1,this._isOpen=!1,this._remotePeerId=null,this._statInterval=null,this._settingsInterval=null,this._failedOnCreate=null,this._remoteStream=null,this._iceRestartTimeout=null,this._reconnectionTimeout=null,this._reconnectionPrevented=!1,this._fingerprint=null,this._neverConnected=!0,this._prevConsumerSettings={},this._networkLimitsForVideo={bad:{loss:4,rtt:1e3},good:{loss:2,rtt:700}},this._videoMaxDimensionsForNet={worst:320,bad:640,good:1280},this._lastVideoMaxDimension=this._videoMaxDimensionsForNet.good,this._lastBadConnection=0,this._participantId=e,this._isMaster=t,this._serverSettings=n,this._perfStatReporter=new Sr(this,i,!0),this._directStatReporter=new Ir(i),this.subscribe(this._signaling,Ii.NOTIFICATION,this._onSignalingNotification.bind(this)),this.subscribe(this._mediaSource,"TRACK_REPLACED",this._onReplacedTrack.bind(this)),this.subscribe(this._mediaSource,"SOURCE_CHANGED",this._applySettings.bind(this)),this.subscribe(this._directStatReporter,"NETWORK_STATUS",this._onNetworkStatus.bind(this)),this._pc=new RTCPeerConnection({iceServers:Ve.iceServers,iceTransportPolicy:Ve.forceRelayPolicy?"relay":"all"},{optional:[{googSuspendBelowMinBitrate:!1}]}),this._pc.onicecandidate=this._handleIceCandidate.bind(this),this._pc.ontrack=this._onAddTrack.bind(this),this._pc.oniceconnectionstatechange=this._onIceConnectionStateChange.bind(this),this._pc.onconnectionstatechange=this._onConnectionStateChange.bind(this),this._pc.onsignalingstatechange=this._onSignalingStateChange.bind(this),this._prevConsumerSettings={},Ve.vmoji&&this._createDataChannel(this._pc,mr.animoji,(e=>{var t,i;this._animojiDataChannel=e,this._animojiDataChannel.binaryType="arraybuffer",null==(t=this._animojiReceiver)||t.setDataChannel(this._animojiDataChannel),null==(i=this._animojiSender)||i.setDataChannel(this._animojiDataChannel)})),this._isMaster){try{this._mediaSource.addTrackToPeerConnection(this._pc,!1,!0),this._applySettings()}catch(e){return w.log(F.ERROR,"addTrack-direct"),li.error("Unable to add media source tracks",e,{participantId:this._participantId}),void(this._failedOnCreate=e)}this._createOffer(!1).catch((e=>{"IDLE"===this._state?this._failedOnCreate=e:this.close(e)}))}this._startSettingsInterval()}get participantId(){return this._participantId}updateStatisticsInterval(){this._stopStatInterval(),this._isDeadConnection()||this._startStatInterval()}_isDeadConnection(){return["IDLE","CLOSED","FAILED"].includes(this.getState())}open(e=null){return R(this,null,(function*(){if(this._isOpen)return void li.warn("DirectTransport: Already opened",{participantId:this._participantId});if(this._failedOnCreate)return void this.close(this._failedOnCreate);if(li.debug("DirectTransport: Open transport",{participantId:this._participantId}),this._isOpen=!0,this._remotePeerId=e,!this._isMaster)try{this._mediaSource.addTrackToPeerConnection(this._pc,!1,!0),this._applySettings()}catch(e){return w.log(F.ERROR,"addTrack-direct"),li.error("DirectTransport: Unable to add media source tracks",e,{participantId:this._participantId}),void this.close(e)}this._setState("OPENED");let t=e;if(!e){let e=Object.keys(this._remoteSDP);t=e[e.length-1]}if(t&&this._remoteSDP[t])try{yield this._setRemoteDescription(t,this._remoteSDP[t])}catch(e){return void this.close()}this._remoteSDP={},this._remoteCandidates={}}))}updateSettings(e){nr(e,this._serverSettings)||(this._serverSettings=e,this._applySettings())}preventRestart(){this._reconnectionPrevented=!0}allowRestart(){this._reconnectionPrevented=!1}setAnimojiTransport(e,t){if(Ve.vmoji&&(this._animojiReceiver=e,this._animojiSender=t,e.setParticipantId(this._participantId),this._animojiDataChannel))return e.setDataChannel(this._animojiDataChannel),void t.setDataChannel(this._animojiDataChannel)}close(e){this._isOpen&&(this._isOpen=!1,this._stopReconnection(),this._remoteStream&&(this._remoteStream.getTracks().forEach((e=>{e.stop(),this._triggerEvent("REMOTE_TRACK_REMOVED",this._remoteStream,e)})),this._remoteStream=null),this._stopStatInterval(),this._stopSettingsInterval(),this._pc&&(this._animojiDataChannel&&(this._animojiDataChannel.onopen=null,this._animojiDataChannel.onmessage=null,this._animojiDataChannel.onerror=null,this._animojiDataChannel.close()),this._pc.onicecandidate=null,this._pc.ontrack=null,this._pc.oniceconnectionstatechange=null,this._pc.onconnectionstatechange=null,this._pc.onsignalingstatechange=null,this._pc.close(),this._pc=null),this._onNetworkStatus(1),this.unsubscribe(),e?(li.error("DirectTransport: Closed",e,{participantId:this._participantId}),this._setState("FAILED")):(li.debug("DirectTransport: Closed",{participantId:this._participantId}),this._setState("CLOSED")),this._triggerEvent("PEER_CONNECTION_CLOSED"))}_setState(e){this._state!==e&&(li.debug(`DirectTransport: State changed to ${e}`,{participantId:this._participantId}),this._state=e,this._triggerEvent("STATE_CHANGED",e))}_onSignalingNotification(e){var t;switch(e.notification){case Ai.TRANSMITTED_DATA:this._handleTransmittedData(e);break;case Ai.SETTINGS_UPDATE:this._directStatReporter.updateSettings(e.settings);break;case Ai.CUSTOM_DATA:e.data.hasOwnProperty("sdk")&&this._directStatReporter.reportRemote(null==(t=e.data)?void 0:t.sdk)}}_handleTransmittedData(e){let t=e.data,i=Q.getPeerIdString(e.peerId);Q.composeMessageId(e)===this._participantId&&(t.candidate&&t.candidate.candidate?this._addIceCandidate(i,t.candidate).catch(this.close.bind(this)):t.sdp&&(this._remoteAnimojiVersion=t.animojiVersion||1,this._setRemoteDescription(i,t.sdp).catch(this.close.bind(this))))}_addIceCandidate(e,t){return R(this,null,(function*(){if(this._isOpen&&(!this._remotePeerId||this._remotePeerId===e)&&this._pc&&this._pc.remoteDescription){li.debug("Add remote ice candidate",{participantId:this._participantId,candidate:t});try{yield this._pc.addIceCandidate(new RTCIceCandidate(t))}catch(e){throw w.log(F.ERROR,"addIceCandidate-direct"),li.error("Unable to add remote ice candidate",e,{participantId:this._participantId,candidate:t}),e}}else li.debug("Cache remote ice candidate",{participantId:this._participantId,candidate:t}),this._remoteCandidates[e]=this._remoteCandidates[e]||[],this._remoteCandidates[e].push(t)}))}_setRemoteCandidates(e){return R(this,null,(function*(){if(!this._remoteCandidates[e])return void li.log(`No cached candidates found for peer ${e}`);let t=this._remoteCandidates[e];this._remoteCandidates[e]=[];for(let i of t)try{yield this._addIceCandidate(e,i)}catch(e){}}))}_setRemoteDescription(e,t){return R(this,null,(function*(){var i;if(!this._isOpen||this._remotePeerId&&this._remotePeerId!==e||!this._pc)this._remoteSDP[e]=t;else{if((null==(i=this._lastRemoteSDP)?void 0:i.sdp)===t.sdp)return;this._lastRemoteSDP=t,t=Rr._patchRemoteDescription(t),li.debug("Add remote description",{participantId:this._participantId,sdp:t}),this._calcFingerprint(t.sdp);try{yield this._pc.setRemoteDescription(t),yield this._setRemoteCandidates(e),this._processAnimojiProtocolVersion(this._remoteAnimojiVersion)}catch(e){throw w.log(F.ERROR,"setRemoteDescription-direct"),li.error("Unable to set remote description",e,{participantId:this._participantId,sdp:t}),e}}}))}_processAnimojiProtocolVersion(e){var t,i;let r=Math.min(e,(null==(t=Ve.vmojiOptions)?void 0:t.protocolVersion)||1);null==(i=this._animojiSender)||i.setProtocolVersion(r)}_onAddTrack(e){li.debug("Added remote track",{participantId:this._participantId,kind:e.track.kind}),this._remoteStream?this._remoteStream.addTrack(e.track):(this._remoteStream=new MediaStream([e.track]),this._remoteStream.onremovetrack=e=>{this._triggerEvent("REMOTE_TRACK_REMOVED",this._remoteStream,e.track)}),this._triggerEvent("REMOTE_TRACK_ADDED",this._remoteStream,e.track)}_handleIceCandidate(e){return R(this,null,(function*(){e.candidate&&this._signaling.ready&&(li.debug("Local ice candidate",{participantId:this._participantId,candidate:e.candidate}),yield this._signaling.sendCandidate(this._participantId,e.candidate))}))}_onSignalingStateChange(){var e,t;li.debug(`DirectTransport: Signaling state changed to ${null==(e=this._pc)?void 0:e.signalingState}`,{participantId:this._participantId});let i={animojiVersion:Ve.vmojiOptions.protocolVersion||1};switch(null==(t=this._pc)?void 0:t.signalingState){case"have-local-offer":let e=this._pc.localDescription;e?this._signaling.sendSdp(this._participantId,e,i).catch(this.close.bind(this)):this.close(new Error);break;case"have-remote-offer":this._createAnswer().then((e=>this._signaling.sendSdp(this._participantId,e,i))).catch(this.close.bind(this))}}_onIceConnectionStateChange(){var e,t;if("checking"===(li.debug(`DirectTransport: Ice Connection state changed to ${null==(e=this._pc)?void 0:e.iceConnectionState}`,{participantId:this._participantId}),null==(t=this._pc)?void 0:t.iceConnectionState)){let e=this.getState();"IDLE"===e||"OPENED"===e?this._setState("CONNECTING"):this._setState("RECONNECTING")}}_onConnectionStateChange(){var e,t,i;switch(li.debug(`DirectTransport: Connection state changed to ${null==(e=this._pc)?void 0:e.connectionState}`,{participantId:this._participantId}),w.log(F.ICE_CONNECTION_STATE,null==(t=this._pc)?void 0:t.connectionState),null==(i=this._pc)?void 0:i.connectionState){case"connected":this._neverConnected=!1,this._setState("CONNECTED"),this._stopReconnection(),Q.getPeerConnectionHostInfo(this._pc).then((e=>{null!=e&&e.local&&(w.log(F.ICE_CONNECTION_TYPE,e.local.type),li.debug("Selected ICE candidates",e))})),this._startStatInterval();break;case"failed":case"disconnected":this._reconnectionPrevented?this.close(new Error(`Ice connection ${this._pc.connectionState}`)):(this._setState("RECONNECTING"),this._startReconnection());break;case"closed":this.close(new Error("Ice connection closed"))}}_startReconnection(){this._reconnectionTimeout||this._iceRestartTimeout||(li.log("Waiting for reconnection...",{participantId:this._participantId}),this._reconnectionTimeout=window.setTimeout((()=>{this._reconnectionTimeout=null,this._neverConnected?this._requestTopologySwitch():this._startIceRestart()}),Ve.transportConnectionWaitTime))}_requestTopologySwitch(){this._isMaster&&this._signaling.ready&&(li.log("Switch topology DIRECT to SERVER",{participantId:this._participantId}),this._signaling.switchTopology("SERVER"))}_stopReconnection(){this._reconnectionTimeout&&(clearTimeout(this._reconnectionTimeout),this._reconnectionTimeout=null),this._iceRestartTimeout&&(clearTimeout(this._iceRestartTimeout),this._iceRestartTimeout=null)}_startIceRestart(){this._isMaster?(w.log(F.ICE_RESTART),li.log("Ice restart",{participantId:this._participantId}),this._createOffer(!0).catch(this.close.bind(this))):li.debug("Waiting for ice restart...",{participantId:this._participantId}),this._iceRestartTimeout=window.setTimeout((()=>{this._iceRestartTimeout=null,li.error("Ice restart failed",{participantId:this._participantId}),w.log(F.ERROR,"iceRestart-direct"),this._requestTopologySwitch()}),Ve.iceRestartWaitTime)}_createOffer(e){return R(this,null,(function*(){var t,i;let r,n={iceRestart:e,offerToReceiveAudio:!0,offerToReceiveVideo:!0};li.debug("Create offer",{participantId:this._participantId,options:n});try{r=yield null==(t=this._pc)?void 0:t.createOffer(n),li.debug("Created offer",{participantId:this._participantId,offer:r}),r=Rr._patchLocalDescription(r)}catch(e){throw li.error("Unable to create offer",e,{participantId:this._participantId}),w.log(F.ERROR,"createOffer-direct"),e}try{return li.debug("Set local description",{participantId:this._participantId,offer:r}),this._calcFingerprint(r.sdp),yield null==(i=this._pc)?void 0:i.setLocalDescription(r),r}catch(e){throw li.error("Unable to set local description",e,{participantId:this._participantId}),w.log(F.ERROR,"setLocalDescription-direct"),e}}))}_createAnswer(){return R(this,null,(function*(){var e,t;let i;li.debug("Create answer",{participantId:this._participantId});try{i=yield null==(e=this._pc)?void 0:e.createAnswer(),li.debug("Created answer",{participantId:this._participantId,answer:i}),i=Rr._patchLocalDescription(i)}catch(e){throw li.error("Unable to create answer",e,{participantId:this._participantId}),w.log(F.ERROR,"createAnswer-direct"),e}try{return li.debug("Set local description",{participantId:this._participantId,answer:i}),this._calcFingerprint(i.sdp),yield null==(t=this._pc)?void 0:t.setLocalDescription(i),i}catch(e){throw li.error("Unable to set local description",e,{participantId:this._participantId}),w.log(F.ERROR,"setLocalDescription-direct"),e}}))}static _patchLocalDescription(e){let t=!!jt.baseChromeVersion();return e.sdp=Q.patchLocalSDP(e.sdp,Ve.preferH264&&jt.canPreferH264(),jt.isBrokenH264Decoder(),Ve.preferVP9,Ve.h264spsPpsIdrInKeyframe,t&&Ve.audioNack,Ve.p2pAudioRed),e}static _patchRemoteDescription(e){return e.sdp=Q.patchRemoteSDP(e.sdp,!1,!1,!1,Ve.preferVP9,jt.isBrokenVP9Encoder(),jt.isBrokenVP9Decoder()),e}_onReplacedTrack(e){this._pc&&(this._pc.getSenders().forEach((t=>{t.track&&t.track.kind===e.kind&&t.track.contentHint===e.contentHint&&t.replaceTrack(e).catch((e=>{li.error("DirectTransport: Unable to replace track",e,{participantId:this._participantId}),w.log(F.ERROR,"replaceTrack-direct")}))})),this._applySettings())}_startStatInterval(){if(this._statInterval)return;let e=()=>{this._isDeadConnection()?this._stopStatInterval():oe(this._pc,this._lastStat,void 0,!0).then((t=>{var i;this._lastStat=t;let r={inbound:{topology:"DIRECT",transport:t.transport,rtps:t.rtps.filter((e=>"inbound-rtp"===e.type&&(e.userId=this._participantId,!0)))},outbound:{topology:"DIRECT",transport:t.transport,rtps:t.rtps.filter((e=>"outbound-rtp"===e.type))},remoteInbound:{topology:"DIRECT",transport:t.transport,rtps:null!=(i=t.remoteRtps)?i:[]}};this._checkPPTNetwork(r),this._directStatReporter.reportLocal(r),this._triggerEvent("REMOTE_DATA_STATS",r),this._statInterval=window.setTimeout(e,Ve.statisticsInterval)}))};this._statInterval=window.setTimeout(e,Ve.statisticsInterval)}_isSVCSupported(e,t){return R(this,null,(function*(){let i=this._mediaSource.getSendVideoTrack(),r=e.outbound.rtps.find((e=>"video"===e.kind));if(null==r||!r.mimeType||null==r||!r.bandwidth||!i)return!1;let n=i.getSettings();if(!n.width||!n.height||!n.frameRate)return!1;let a={type:"Firefox"===jt.browserName()?"transmission":"webrtc",video:{contentType:r.mimeType,width:n.width,height:n.height,bitrate:r.bandwidth,framerate:n.frameRate,scalabilityMode:t}};try{return(yield navigator.mediaCapabilities.encodingInfo(a)).supported||!1}catch(e){return li.warn("Failed to get encodingInfo",a,e),!1}}))}_checkPPTNetwork(e){return R(this,null,(function*(){if(!Ve.switchVideoAtBadNetwork||!e.inbound.transport.averageNetStat)return;let{averageNetStat:t}=e.inbound.transport,i=t.currentRoundTripTime<=this._networkLimitsForVideo.good.rtt&&t.lostPercent<=this._networkLimitsForVideo.good.loss,r=t.currentRoundTripTime>=this._networkLimitsForVideo.bad.rtt||t.lostPercent>=this._networkLimitsForVideo.bad.loss,n=t.currentRoundTripTime<this._networkLimitsForVideo.bad.rtt,a=this._videoMaxDimensionsForNet.good,s="L1T1";if(r?(this._lastBadConnection=Date.now(),n?(a=this._videoMaxDimensionsForNet.bad,s="L1T2"):(a=this._videoMaxDimensionsForNet.worst,s="L1T3")):i&&(a=this._videoMaxDimensionsForNet.good,s="L1T1"),!(a<this._lastVideoMaxDimension||Date.now()-this._lastBadConnection>3e4)||this._lastVideoMaxDimension===a)return;let o=this._serverSettings.camera;if(!o||!(yield this._isSVCSupported(e,s)))return;li.debug("Switch outbound video frame size and scalabilityMode",{scalabilityMode:s,averageNetStat:t,nextVideoMaxDimension:a}),this._lastVideoMaxDimension=a;let c=I(y({},this._serverSettings),{camera:I(y({},o),{scalabilityMode:s,maxDimension:this._lastVideoMaxDimension})});this.updateSettings(c)}))}_stopStatInterval(){this._statInterval&&(window.clearTimeout(this._statInterval),this._statInterval=null)}_onNetworkStatus(e){let t={};t[this._participantId]=t[""]=e,this._triggerEvent("NETWORK_STATUS",t)}_startSettingsInterval(){if(this._settingsInterval)return;let e=()=>{this._pc?(this._applySettings(),this._settingsInterval=window.setTimeout(e,2e3)):this._stopSettingsInterval()};this._settingsInterval=window.setTimeout(e,2e3)}_stopSettingsInterval(){this._settingsInterval&&(window.clearTimeout(this._settingsInterval),this._settingsInterval=null)}_calcFingerprint(e){let t=Q.sdpFingerprint(e);null!==t?null===this._fingerprint?this._fingerprint=t:(nt.onFingerprintChange((this._fingerprint^t).toString()),this._fingerprint=null):li.warn("Fingerprint calculation is unsupported")}_applySettings(){var e;let t=this._mediaSource.getMediaSettings().isScreenSharingEnabled?this._serverSettings.screenSharing:this._serverSettings.camera;t&&"connected"===(null==(e=this._pc)?void 0:e.connectionState)&&(this._prevConsumerSettings=Q.applySettings(this._pc,t,this._prevConsumerSettings))}_createDataChannel(e,t,i){li.debug(`[${t}] data channel opening`);let r=e.createDataChannel(t,{negotiated:!0,id:1});r.onopen=()=>{let e=r.readyState;"open"===e?(li.debug(`[${t}] data channel opened`),r.onerror=e=>{li.error(`[${t}] data channel error`,e)},i(r)):li.error(`[${t}] data channel open failed, state [${e}]`)}}},Ar=class{constructor(e,t,i){li.debug("AsrReceiver started"),this._datachannel=e,this._participantIdRegistry=t,this._asrCallback=i,this._textDecoder=new TextDecoder,this._datachannel.onmessage=e=>this._onDataChannelMessage(e.data)}static parse(e){let t=new DataView(e),i=t.getUint8(0),r=t.getUint8(1);if(0!==r)throw new Error(`Unsupported message type. Message type: ${r}`);let n=t.getUint16(2),a=t.getUint32(4),s=t.getUint32(8),o=t.getUint32(12);if(1!==i)throw new Error(`Unexpected protocol version. Got ${i}, expected 1`);return{sequence:n,ssrc:a,timestamp:s,duration:o,data:e.slice(16)}}_onDataChannelMessage(e){var t,i;let r=Ar.parse(e),n=null==(i=null==(t=this._participantIdRegistry)?void 0:t.getStreamDescription(r.ssrc))?void 0:i.participantId;if(!n)return void li.warn(`Participant id for ssrc ${r.ssrc} not found in registry`);let a={participantId:n,text:this._textDecoder.decode(r.data),timestamp:r.timestamp,duration:r.duration};this._asrCallback(a)}destroy(){this._datachannel.onmessage=null}},Pr=class{constructor(){this.streamDescriptionByCompactId=new Map,this.compactIdByStreamDescription=new Map}getStreamDescription(e){return this.streamDescriptionByCompactId.get(e)}getCompactId(e){return this.compactIdByStreamDescription.get(e)}handleMessage(e){var t,i;let r=new Uint8Array(e),n=r[0],a=r.subarray(1);switch(n){case 1:let e=(0,d.decode)(a);return Object.entries(e).forEach((([e,t])=>{let i=mi(e);this.streamDescriptionByCompactId.set(t,i),this.compactIdByStreamDescription.set(e,t)})),null;case 2:case 4:let r=(0,d.decode)(a),s=[];for(let e of r){let t=this.getStreamDescription(e);t&&s.push(t.participantId)}return 2===n?{type:"notification",notification:Ai.AUDIO_ACTIVITY,activeParticipants:s}:{type:"notification",notification:Ai.STALLED_ACTIVITY,stalledParticipants:s};case 3:let o=(0,d.decode)(a);return{type:"notification",notification:Ai.SPEAKER_CHANGED,speaker:null==(t=this.getStreamDescription(o))?void 0:t.participantId};case 5:let c=(0,d.decode)(a);return{type:"notification",notification:Ai.VIDEO_QUALITY_UPDATE,quality:{maxBitrate:c[0],maxDimension:c[1]}};case 6:let l=(0,d.decode)(a),u={};for(let[e,t]of Object.entries(l)){let r=null==(i=this.getStreamDescription(Number(e)))?void 0:i.participantId;r&&(u[r]=t/100)}return{type:"notification",notification:Ai.NETWORK_STATUS,statuses:u};case 7:return this._createParticipantSourcesUpdateNotification(a);case 8:{let e=(0,d.decode)(a).map((e=>{var t;let[i,r,n,a,s,o,c]=e;return{participantId:null==(t=this.getStreamDescription(i))?void 0:t.participantId,gain:r,pause:n,offset:a,mute:s,liveStatus:o,startTimeMs:c}}));return{type:"notification",notification:Ai.MOVIE_UPDATE_NOTIFICATION,data:e}}case 9:let h=(0,d.decode)(a);return{type:"notification",notification:Ai.VIDEO_SUSPEND_SUGGEST,bandwidth:h};default:return li.debug("unsupported message type: "+n),null}}_createParticipantSourcesUpdateNotification(e){let t=(0,d.decode)(e),i=[];for(let[e,r]of Object.entries(t)){let t,n=r[0],a=r[1],s=r[2],o=!!r[3],c=null!==r[4]?!!r[4]:void 0;if(null!==n){if(t=this.getStreamDescription(n),!t){li.error(`could not uncompress participant ID ${n}`);continue}}else t=null;if(null===s){li.error("unexpected null sequenceNumber",e,r);continue}let l=Ji.PARTICIPANT_AGNOSTIC_TRACK_PREFIX+"-"+e,d=a?a>>>0:null;i.push({participantStreamDescription:t,streamId:l,rtpTimestamp:d,sequenceNumber:s,fastScreenShare:o,suspend:c})}return{type:"notification",notification:Ai.PARTICIPANT_SOURCES_UPDATE,participantUpdateInfos:i}}},Dr=class extends fr{constructor(e,t,i){super(e,t),this._producerNotification=null,this._producerCommand=null,this._producerScreen=null,this._consumerScreen=null,this._asr=null,this._animojiDataChannel=null,this._animojiReceiver=null,this._animojiSender=null,this._isOpen=!1,this._observer=!1,this._reconnectionPrevented=!1,this._statInterval=null,this._settingsInterval=null,this._statBytes={},this._ssrcMap={},this._ssrcMapUpdated=!1,this._producerOfferIsProcessing=!1,this._producerNextOffer=null,this._lastStat=null,this._prevConsumerSettings={},this._asrTrack=null,this._captureSender=null,this._captureReceiver=null,this._participantIdRegistry=null,this._disabledSenders=new Set,this._rtpReceiversByStreamId={},this._producerSessionId="",this._newAudioShareTrack=null,this.subscribe(this._signaling,Ii.NOTIFICATION,this._onSignalingNotification.bind(this)),this.subscribe(this._mediaSource,"TRACK_REPLACED",this._onReplacedTrack.bind(this)),this.subscribe(this._mediaSource,"SOURCE_CHANGED",this._applyConsumerSettings.bind(this)),this.subscribe(this._mediaSource,"SCREEN_STATUS",this._onScreenSharingStatus.bind(this)),this._createPerfStatsReporter(),this._serverSettings=i,li.debug("ServerTransport: Created")}updateStatisticsInterval(){this._stopStatInterval();let e=this.getState();"IDLE"!==e&&"CLOSED"!==e&&"FAILED"!==e&&this._startStatInterval()}open(e=!1){this._isOpen?li.log("ServerTransport: Already opened connections"):(this._isOpen=!0,this._observer=e,this._openConnection())}close(e){this._isOpen&&(this._isOpen=!1,this._closeConnection(),this.unsubscribe(),e?(li.error("ServerTransport: Closed",e),this._setState("FAILED")):(li.debug("ServerTransport: Closed"),this._setState("CLOSED")))}removeParticipant(e){var t;null==(t=this._captureReceiver)||t.close(e)}preventRestart(){this._reconnectionPrevented=!0}allowRestart(){this._reconnectionPrevented=!1}updateSettings(e){nr(e,this._serverSettings)||(this._serverSettings=e,this._applyConsumerSettings())}setAnimojiTransport(e,t){if(Ve.vmoji&&(this._animojiReceiver=e,this._animojiSender=t,this._participantIdRegistry&&e.setParticipantIdRegistry(this._participantIdRegistry),this._animojiDataChannel))return e.setDataChannel(this._animojiDataChannel),void t.setDataChannel(this._animojiDataChannel)}_createPerfStatsReporter(){var e;null==(e=this._perfStatReporter)||e.destroy(),this._perfStatReporter=new Sr(this,this._signaling)}_closeConnection(){this._stopStatInterval(),this._stopSettingsInterval(),this._removeAsrTrack(),this._removeCaptureSender(),this._removeCaptureReceiver(),this._pc&&(this._rtpReceiversByStreamId={},this._disabledSenders.forEach((e=>{var t;return null==(t=e.track)?void 0:t.stop()})),this._disabledSenders.clear(),this._pc.ontrack=null,this._pc.onconnectionstatechange=null,this._pc.onsignalingstatechange=null,this._participantIdRegistry=null,Dr._closeDataChannel(this._producerNotification),Dr._closeDataChannel(this._producerCommand),Dr._closeDataChannel(this._producerScreen),Dr._closeDataChannel(this._consumerScreen),Dr._closeDataChannel(this._asr),Dr._closeDataChannel(this._animojiDataChannel),this._pc.close(),this._pc=null,this._producerOfferIsProcessing=!1,this._producerNextOffer=null),this._triggerEvent("PEER_CONNECTION_CLOSED")}static _closeDataChannel(e){e&&(e.onopen=null,e.onmessage=null,e.onerror=null,e.close())}_createDataChannel(e,t,i){li.debug(`[${t}] data channel opening`);let r=e.createDataChannel(t,{ordered:!0});r.onopen=()=>{let e=r.readyState;"open"===e?(li.debug(`[${t}] data channel opened`),i(r)):li.error(`[${t}] data channel open failed, state [${e}]`)},r.onerror=e=>{let i=e.error;li.error(`[${t}] data channel error`,null==i?void 0:i.errorDetail,null==i?void 0:i.message)}}_openConnection(e=!1){li.debug("ServerTransport: Open single connection"),this._pc=new RTCPeerConnection({},{optional:[{googSuspendBelowMinBitrate:!1}]}),this._pc.ontrack=this._onAddTrack.bind(this,this._pc),this._pc.onconnectionstatechange=Q.debounce((e=>{this._pc&&this._onConnectionStateChange(this._pc,e)}),500),this._pc.onsignalingstatechange=Dr._onSignalingStateChange.bind(this,this._pc),this._participantIdRegistry=new Pr,this._signaling.setParticipantIdRegistry(this._participantIdRegistry),Ve.producerNotificationDataChannel&&this._createDataChannel(this._pc,mr.producerNotification,(e=>{this._producerNotification=e,this._producerNotification.binaryType="arraybuffer",this._signaling.setProducerNotificationDataChannel(e)})),Ve.producerCommandDataChannel&&(this._signaling.useCommandDataChannel(!0),this._createDataChannel(this._pc,mr.producerCommand,(e=>{this._producerCommand=e,this._signaling.setProducerCommandDataChannel(e)}))),Ve.producerScreenDataChannel&&this._createDataChannel(this._pc,mr.producerScreenShare,(e=>{this._producerScreen=e,this._producerScreen.binaryType="arraybuffer",this._createCaptureReceiver()})),Ve.asrDataChannel&&this._createDataChannel(this._pc,mr.asr,(e=>{this._asr=e,this._asr.binaryType="arraybuffer",this._removeAsrTrack(),this._asrTrack=new Ar(e,this._participantIdRegistry,(e=>{this._onAsrTranscription(e)}))})),Ve.vmoji&&this._createDataChannel(this._pc,mr.animoji,(e=>{var t,i,r,n;this._animojiDataChannel=e,this._animojiDataChannel.binaryType="arraybuffer",null==(t=this._animojiReceiver)||t.setDataChannel(e),null==(i=this._animojiReceiver)||i.setParticipantIdRegistry(this._participantIdRegistry),null==(r=this._animojiSender)||r.setDataChannel(e),null==(n=this._animojiSender)||n.setProtocolVersion(Ve.vmojiOptions.protocolVersion||1)})),this._newAudioShareTrack=this._mediaSource.getAudioShareTrack();try{this._mediaSource.addTrackToPeerConnection(this._pc,this._observer,!1),this._prevConsumerSettings={},this._applyConsumerSettings()}catch(e){return li.error("ServerTransport: Unable to add media source tracks",e),w.log(F.ERROR,"addTrack-single"),void this.close(e)}Ve.consumerScreenDataChannel&&this._createDataChannel(this._pc,mr.consumerScreenShare,(e=>{this._consumerScreen=e,this._consumerScreen.binaryType="arraybuffer";let t=this._mediaSource.getScreenTrack();t&&this._createCaptureSender(t)})),e||this._allocateConsumer(),this._setState("OPENED"),this._startStatInterval(),this._startSettingsInterval()}_removeAsrTrack(){var e;null==(e=this._asrTrack)||e.destroy(),this._asrTrack=null}_reconnect(){"OPENED"!==this.getState()&&(this._setState("RECONNECTING"),this._closeConnection(),this._openConnection(!0))}_signalActiveParticipants(e){this._triggerEvent("SIGNALLED_ACTIVE_PARTICIPANTS",e)}_signalStalledParticipants(e){this._triggerEvent("SIGNALLED_STALLED_PARTICIPANTS",e)}_signalSpeakerChanged(e){this._triggerEvent("SIGNALLED_SPEAKER_CHANGED",e)}_signalNetworkStatus(e){this._triggerEvent("NETWORK_STATUS",e)}_updateSSRCMap(e){e&&e.sdp.split("\n").forEach((e=>{let t=`a=ssrc:([0-9]+) label:(audio|video)-((?:[ug]?[\\d]+)|(?:mix)|(?:${Ji.PARTICIPANT_AGNOSTIC_TRACK_PREFIX}-[0-9]+))`,i=new RegExp(t).exec(e);i&&(this._ssrcMap[i[1]]=i[3],this._ssrcMapUpdated=!0)}))}_createCaptureSender(e){let t=this._mediaSource.getMediaSettings();!e||!Ve.consumerScreenDataChannel||!this._consumerScreen||!t.isScreenSharingEnabled||(this._captureSender&&this._removeCaptureSender(),this._captureSender=new Le(e,this._consumerScreen,this._signaling,t.isFastScreenSharingEnabled))}_removeCaptureSender(){var e;null==(e=this._captureSender)||e.destroy(),this._captureSender=null}_createCaptureReceiver(){!Ve.producerScreenDataChannel||!this._producerScreen||(this._captureReceiver&&this._removeCaptureReceiver(),this._captureReceiver=new Ie(this._producerScreen,this._participantIdRegistry,((e,t)=>{this._triggerEvent("REMOTE_STREAM_SECOND",e,t)}),(e=>{this._triggerEvent("REMOTE_STREAM_SECOND",e,null)}),(e=>{this._triggerEvent("SCREEN_SHARING_STAT",e)})))}_removeCaptureReceiver(){var e;null==(e=this._captureReceiver)||e.destroy(),this._captureReceiver=null}_applyConsumerSettings(){let e=this._mediaSource.getMediaSettings().isScreenSharingEnabled&&!Ve.consumerScreenDataChannel?this._serverSettings.screenSharing:this._serverSettings.camera;if(e&&this._pc){let t=[];this._pc.getSenders().forEach((i=>{if(!i.track||"video"!==i.track.kind)return;let r=!this._disabledSenders.has(i),n=0!==e.maxDimension;if(r&&!n)return li.log("Disabling video upload"),this._disabledSenders.add(i),void i.replaceTrack(jt.getBlackMediaTrack()).catch((e=>{li.error("Could not disable video upload",e)}));let a=this._mediaSource.getSendVideoTrack();if(!r&&n&&a){li.log("Enabling video upload"),this._disabledSenders.delete(i);let e=i.track;e.enabled=a.enabled,i.replaceTrack(a).then((()=>e.stop())).catch((e=>{li.error("Could not enable video upload",e)}))}Q.applyVideoTrackSettings(e,i,null!=a?a:i.track,this._prevConsumerSettings,t)})),this._prevConsumerSettings=t}}_onScreenSharingStatus(e){e.track?this._createCaptureSender(e.track):this._removeCaptureSender()}_setState(e){this._state!==e&&(this._state=e,this._triggerEvent("STATE_CHANGED",e))}_startStatInterval(){if(this._statInterval)return;let e=()=>{this._pc?(this._collectStat().then((e=>{this._reportStats(e),this._detectStaleTracks(e)})).catch((()=>{})),this._statInterval=window.setTimeout(e,Ve.statisticsInterval)):this._stopStatInterval()};this._statInterval=window.setTimeout(e,Ve.statisticsInterval)}_stopStatInterval(){this._statInterval&&(window.clearTimeout(this._statInterval),this._statInterval=null),this._statBytes={}}_startSettingsInterval(){if(this._settingsInterval)return;let e=()=>{this._pc?(this._applyConsumerSettings(),this._settingsInterval=window.setTimeout(e,2e3)):this._stopSettingsInterval()};this._settingsInterval=window.setTimeout(e,2e3)}_stopSettingsInterval(){this._settingsInterval&&(window.clearTimeout(this._settingsInterval),this._settingsInterval=null)}_collectStat(){return R(this,null,(function*(){if(!this._pc)return Promise.reject();this._ssrcMapUpdated&&(this._lastStat=null,this._ssrcMapUpdated=!1,this._createPerfStatsReporter());let e=yield oe(this._pc,this._lastStat,this._ssrcMap,!0);return this._lastStat=e,e}))}_reportStats(e){var t;this._triggerEvent("REMOTE_DATA_STATS",{inbound:{topology:"SERVER",transport:e.transport,rtps:e.rtps.filter((e=>"inbound-rtp"===e.type))},outbound:{topology:"SERVER",transport:e.transport,rtps:e.rtps.filter((e=>"outbound-rtp"===e.type))},remoteInbound:{topology:"SERVER",transport:e.transport,rtps:null!=(t=e.remoteRtps)?t:[]}})}_detectStaleTracks(e){let t=e.rtps.find((e=>"inbound-rtp"===e.type&&"audio"===e.kind&&"mix"===this._ssrcMap[e.ssrc]));if(!t)return;let i=Ji.AUDIO_MIX,r=this._statBytes[i],n=!1;if(r){let e=t.bytesReceived-r.bytesReceived;e>=0&&e<=5&&(n=!0),r.stalled!==n&&this._triggerEvent("AUDIO_MIX_STALL",n)}this._statBytes[i]={bytesReceived:t.bytesReceived,stalled:n}}_allocateConsumer(){if(!this._signaling.ready)return;let e={estimatedPerformanceIndex:Sr.getEstimatedPerformanceIndex(),audioMix:!0,consumerUpdate:!0,producerNotificationDataChannelVersion:Ve.producerNotificationDataChannel?8:0,producerCommandDataChannelVersion:Ve.producerCommandDataChannel?3:0,consumerScreenDataChannelVersion:Ve.consumerScreenDataChannel?1:0,producerScreenDataChannelVersion:Ve.producerScreenDataChannel?1:0,asrDataChannelVersion:Ve.asrDataChannel?1:0,animojiDataChannelVersion:Ve.vmoji?Ve.vmojiOptions.protocolVersion:1,animojiBackendRender:!Ve.vmojiOptions.renderingOptions.useFullClientRendering,onDemandTracks:!0,unifiedPlan:!0,singleSession:!0,videoTracksCount:Ve.videoTracksCount,red:Ve.serverAudioRed,audioShare:Ve.audioShare,fastScreenShare:Ve.fastScreenShare,videoSuspend:Ve.videoSuspend};!Ve.videoTracksCount&&!this._observer&&li.warn("Setting videoTracksCount to 0 is deprecated"),this._signaling.allocateConsumer(null,e)}_processOffer(e){return R(this,null,(function*(){if(!this._pc)throw new Error("Interrupt allocation");try{yield this._pc.setRemoteDescription(e)}catch(e){throw li.error("[single] unable to set remote offer",e),w.log(F.ERROR,"setRemoteDescription-single"),e}let t;try{if(yield this._handleTracks(),li.debug("[single] create local answer"),!this._pc)throw new Error("Interrupt allocation");t=yield this._pc.createAnswer()}catch(e){throw li.error("[single] unable to create answer",e),w.log(F.ERROR,"createAnswer-single"),e}try{if(!this._pc)throw new Error("Interrupt allocation");t.sdp=Q.patchLocalSDP(t.sdp,!1,jt.isBrokenH264Decoder(),!1,Ve.h264spsPpsIdrInKeyframe),li.debug("[single] set local answer",{answer:t}),yield this._pc.setLocalDescription(t)}catch(e){throw li.error("[single] unable to set local answer",e),w.log(F.ERROR,"setLocalDescription-single"),e}try{li.debug("[single] transmit local answer",{answer:t}),this._updateSSRCMap(e),yield this._signaling.acceptProducer(t,Object.keys(this._ssrcMap)),li.debug("[single] remote offer has been processed")}catch(e){li.warn("[single] unable to send local answer",e),w.log(F.ERROR,"acceptProducer")}}))}_acceptProducer(e){return R(this,null,(function*(){if(this._producerOfferIsProcessing)return this._producerNextOffer=e,void li.debug("[single] wait until other remote offer is processed");this._producerOfferIsProcessing=!0;let t={type:"offer",sdp:Q.patchRemoteSDP(e,jt.isOldDataChannelDescription(),!1,!1,!1,jt.isBrokenVP9Encoder(),jt.isBrokenVP9Decoder())};if(li.debug("[single] set remote offer",{offer:t}),!this._pc)throw new Error("Interrupt allocation");try{if(yield this._processOffer(t),this._producerOfferIsProcessing=!1,this._producerNextOffer){li.debug("[single] there is other unprocessed remote offer, process it");let e=this._producerNextOffer;this._producerNextOffer=null,yield this._acceptProducer(e)}}catch(e){this.close(e)}}))}_handleTracks(){return R(this,null,(function*(){var e;if(!this._newAudioShareTrack||this._observer)return;let t=null==(e=this._pc)?void 0:e.getTransceivers().find((e=>{var t;return null==(t=e.mid)?void 0:t.endsWith("s")}));if(t&&t.sender){null!==t.sender.track&&li.warn("Unexpected track assigned to audioshare");try{t.direction="sendonly",yield t.sender.replaceTrack(this._newAudioShareTrack),this._newAudioShareTrack=null}catch(e){li.error("ServerTransport: Unable to replace track",e),w.log(F.ERROR,"replaceTrack-single")}}else li.warn("Cannot find audioshare transceiver")}))}_onSignalingNotification(e){return R(this,null,(function*(){if(this._isOpen)switch(e.notification){case Ai.PRODUCER_UPDATED:yield this._onProducerUpdated(e);break;case Ai.REALLOC_CON:this._reconnect();break;case Ai.AUDIO_ACTIVITY:this._signalActiveParticipants(e.activeParticipants);break;case Ai.SPEAKER_CHANGED:this._signalSpeakerChanged(e.speaker);break;case Ai.STALLED_ACTIVITY:this._signalStalledParticipants(e.stalledParticipants);break;case Ai.NETWORK_STATUS:this._signalNetworkStatus(e.statuses)}}))}_onAsrTranscription(e){this._triggerEvent("ASR_TRANSCRIPTION",e)}_onProducerUpdated(e){return R(this,null,(function*(){this._producerSessionId&&this._producerSessionId!==e.sessionId&&this._reconnect(),Ve.breakVideoPayloadTypes&&(li.log("test mode enabled, video switched off"),this._signaling.requestTestMode("breakVideoPayloadTypes",null)),this._producerSessionId=e.sessionId,yield this._acceptProducer(e.description)}))}_onAddTrack(e,t){li.debug("[single] remote track (added)",{track:t.track});let i=t.streams[0];i?(i.onremovetrack||(i.onremovetrack=e=>{this._triggerEvent("REMOTE_TRACK_REMOVED",i.id,i,e.track)}),i.getTracks().find((e=>e.id===t.track.id))||i.addTrack(t.track),this._rtpReceiversByStreamId[i.id]=t.receiver,this._triggerEvent("REMOTE_TRACK_ADDED",i.id,i,t.track)):li.error("[single] unable to get media stream from track event")}static _onSignalingStateChange(e,t){li.debug("[single] signaling state changed",{state:e.signalingState},t)}_onConnectionStateChange(e,t){switch(li.debug("[single] connection state changed",{state:e.connectionState},t),w.log(F.ICE_CONNECTION_STATE,e.connectionState),e.connectionState){case"failed":this._reconnectionPrevented?this.close(new Error("Ice connection failed")):(w.logCustom(F.RECONNECT,{param:1}),this._reconnect());break;case"connecting":let t=this.getState();"IDLE"===t||"OPENED"===t?this._setState("CONNECTING"):"checking"===e.iceConnectionState&&this._setState("RECONNECTING");break;case"disconnected":this._reconnectionPrevented?this.close(new Error("Ice connection disconnected")):this._setState("RECONNECTING");break;case"connected":this._setState("CONNECTED"),Q.getPeerConnectionHostInfo(e).then((e=>{null!=e&&e.local&&(w.log(F.ICE_CONNECTION_TYPE,e.local.type),li.debug("Selected ICE candidates",e))})),w.logCustom(F.RECONNECT,{param:0})}}_onReplacedTrack(e,t){var i;if(this._pc){Ve.consumerScreenDataChannel&&t&&(e=t);let r=null==(i=this._pc)?void 0:i.getSenders().find((t=>t.track&&t.track.kind===e.kind&&!this._disabledSenders.has(t)&&t.track.contentHint===e.contentHint));null!=r&&r.track?r.replaceTrack(e).catch((e=>{li.error("ServerTransport: Unable to replace track",e),w.log(F.ERROR,"replaceTrack-single")})):"audio"===e.kind&&"music"===e.contentHint&&(this._newAudioShareTrack=e)}this._applyConsumerSettings()}getStreamWaitingTimeMs(e,t){if(!this._pc)return w.log(F.PAT_WAITING_TIME_ERROR,"noConnection"),li.error("Cannot get stream waiting time, peer connection is not initialized"),0;if(!RTCRtpReceiver.prototype.getSynchronizationSources)return w.log(F.PAT_WAITING_TIME_ERROR,"oldBrowser"),li.error("Cannot get stream waiting time, RTCRtpReceiver.getSynchronizationSources is not supported"),0;let i=this._rtpReceiversByStreamId[e];if(!i)return w.log(F.PAT_WAITING_TIME_ERROR,"noReceiver"),li.error(`Cannot get stream waiting time, cannot find RTP receiver by stream ID: ${e}`),0;let r=i.getSynchronizationSources();if(!r||!r.length)return li.log(`Cannot get stream waiting time, ${e} receiver has no synchronization sources`),0;let n=r[0].rtpTimestamp;if(!Number.isInteger(n))return w.log(F.PAT_WAITING_TIME_ERROR,"timestampNotInteger"),li.error(`Cannot get stream waiting time, ${e} receiver's RTP timestamp is not an integer: ${n}`),0;let a=t-n&4294967295,s=Math.ceil(a/90);return Math.min(100,Math.max(0,s))}},Or=(e=>(e.DIRECT="DIRECT",e.SERVER="SERVER",e))(Or||{}),br=class extends P{constructor(e,t,i,r){super(),this._allocated=[],this._opened=[],this._directTransport=null,this._serverTransport=null,this._dtListeners=[],this._stListeners=[],this._states={},this._localState="IDLE",this._animojiReceiver=null,this._animojiSender=null,this._signaling=t,this._mediaSource=i,this._topology=e,this._serverSettings=r,this.subscribe(this._signaling,Ii.NOTIFICATION,this._onSignalingNotification.bind(this)),this.subscribe(this._mediaSource,"ANIMOJI_STATUS",this._onAnimojiStatus.bind(this)),this.subscribe(this._mediaSource,"SOURCE_CHANGED",this._onSourceChanged.bind(this)),this._createAnimojiTransport(),"SERVER"===e&&(this._serverTransport=this._createServerTransport())}updateSettings(e){li.log("Update transport settings",e),this._serverSettings=e,this._directTransport&&this._directTransport.updateSettings(e),this._serverTransport&&this._serverTransport.updateSettings(e)}updateStatisticsInterval(){this._directTransport&&this._directTransport.updateStatisticsInterval(),this._serverTransport&&this._serverTransport.updateStatisticsInterval()}allocate(e,t=!1){li.log(`Trying allocate participant [${e}]`),-1===this._allocated.indexOf(e)?(this._allocated.push(e),"DIRECT"===this._topology&&!this._directTransport&&(this._directTransport=this._createDirectTransport(e,t)),"SERVER"===this._topology&&!this._serverTransport&&(this._serverTransport=this._createServerTransport())):li.warn(`The participant [${e}] has already had allocated transport`)}open(e,t=null,i=!1,r=!1){li.log("Trying open participant",{participantIds:e});let n=r;for(let t of e)-1===this._opened.indexOf(t)?-1!==this._allocated.indexOf(t)?(this._opened.push(t),n=!0):li.warn(`The participant [${t}] has no allocated transport`):li.warn(`The participant [${t}] has already had opened transport`);n&&("DIRECT"===this._topology&&this._directTransport&&this._directTransport.open(t),"SERVER"===this._topology&&this._serverTransport&&(this._serverTransport.open(i),this._setStates(e,this._serverTransport.getState()),this._setLocalState(this._serverTransport.getState())),li.debug("The transport has been opened",e))}close(e){var t;let i=this._allocated.indexOf(e),r=this._opened.indexOf(e);i<0&&li.warn(`The participant [${e}] transport has already deallocated`),"DIRECT"===this._topology&&this._directTransport&&r>=0&&this._releaseDirectTransport(),"SERVER"===this._topology&&(null==(t=this._serverTransport)||t.removeParticipant(e),this._setStates([e],"CLOSED")),r>=0&&this._opened.splice(r,1),i>=0&&this._allocated.splice(i,1),delete this._states[e]}destroy(){var e,t,i;this.unsubscribe();for(let e of this._dtListeners)e.dispose();for(let e of this._stListeners)e.dispose();this._removeAnimojiTransport(),null==(e=Ve.audioEffects)||e.destroy(),null==(t=this._directTransport)||t.close(),this._directTransport=null,null==(i=this._serverTransport)||i.close(),this._serverTransport=null,this._allocated=[],this._opened=[]}getTopology(){return this._topology}isAllocated(e){return this._allocated.indexOf(e)>=0}allocated(){return this._allocated.slice()}opened(){return this._opened.slice()}getState(){var e,t;return"SERVER"===this._topology?null==(e=this._serverTransport)?void 0:e.getState():null==(t=this._directTransport)?void 0:t.getState()}getStates(){return this._states}setAnimojiSvg(e,t){var i,r;Ve.vmoji&&t.isMe&&(null==(i=Ve.vmoji.AnimojiPreviewGenerator)||i.setSvgData(t)),(!(t.svg instanceof ArrayBuffer)||0!==t.svg.byteLength)&&(null==(r=this._animojiReceiver)||r.setParticipantSvg(e,t))}setAnimojiFill(e){var t;null==(t=this._animojiSender)||t.setFill(e)}_setStates(e,t){let i=e.filter((e=>this._states[e]!==t&&(this._states[e]=t,!0)));i.length&&this._triggerEvent("STATE_CHANGED",i,t)}_setLocalState(e){this._localState!==e&&(this._localState=e,this._triggerEvent("LOCAL_STATE_CHANGED",e))}_onSignalingNotification(e){if(e.notification===Ai.TOPOLOGY_CHANGED)return this._onTopologyChanged(e)}_onTopologyChanged(e){var t;if(e.topology!==this._topology){if(li.log(`Topology changed ${this._topology} -> ${e.topology}`),w.log(F.TOPOLOGY_CHANGE_REQUESTED,e.topology),this._topology=e.topology,"SERVER"===this._topology&&(this._serverTransport?this._serverTransport.allowRestart():(this._serverTransport=this._createServerTransport(),this._opened.length>0&&(null==(t=this._directTransport)||t.preventRestart(),this._serverTransport.open()))),"DIRECT"===this._topology){let t=e.offerTo||[],i=e.offerToTypes||[],r=e.offerToDeviceIdxs||[],n=t.length&&i.length?Q.composeParticipantId(t[0],i[0],r[0]):null;if(this._serverTransport&&this._serverTransport.preventRestart(),!this._allocated||0===this._allocated.length)return void li.error("Topology changed to DIRECT, but the list of allocated participants is empty");this._allocated.length>1&&li.warn("Topology changed to DIRECT, but the allocated participants count more then one");let a=this._allocated[0];if(this._directTransport)this._directTransport.allowRestart();else{let e=n===a;this._directTransport=this._createDirectTransport(a,e)}this._opened.indexOf(a)>=0&&this._directTransport.open()}this._triggerEvent("TOPOLOGY_CHANGED",this._topology)}}_createDirectTransport(e,t=!1){let i=new Rr(e,t,this._signaling,this._mediaSource,this._serverSettings);return this._dtListeners.length>0&&li.warn(`The list of direct listeners for the participant [${e}] is not empty`),this._dtListeners=[],this._dtListeners.push(i.addEventListener("REMOTE_TRACK_ADDED",this._onRemoteTrackAdded.bind(this,e)),i.addEventListener("REMOTE_TRACK_REMOVED",this._onRemoteTrackRemoved.bind(this,e)),i.addEventListener("REMOTE_DATA_STATS",this._onRemoteDataStats.bind(this)),i.addEventListener("STATE_CHANGED",this._onDirectTransportChanged.bind(this)),i.addEventListener("NETWORK_STATUS",this._onTransportNetworkStatus.bind(this)),i.addEventListener("PEER_CONNECTION_CLOSED",this._onPeerConnectionClosed.bind(this,"DIRECT"))),this._animojiReceiver&&this._animojiSender&&i.setAnimojiTransport(this._animojiReceiver,this._animojiSender),i}_createServerTransport(){let e=new Dr(this._signaling,this._mediaSource,this._serverSettings);return this._stListeners.length>0&&li.warn("The list of server transport listeners is not empty"),this._stListeners=[],this._stListeners.push(e.addEventListener("REMOTE_TRACK_ADDED",this._onRemoteTrackAdded.bind(this)),e.addEventListener("REMOTE_TRACK_REMOVED",this._onRemoteTrackRemoved.bind(this)),e.addEventListener("AUDIO_MIX_STALL",this._onServerAudioMixStall.bind(this)),e.addEventListener("REMOTE_DATA_STATS",this._onRemoteDataStats.bind(this)),e.addEventListener("STATE_CHANGED",this._onServerTransportChanged.bind(this)),e.addEventListener("SIGNALLED_ACTIVE_PARTICIPANTS",this._onTransportActiveParticipants.bind(this)),e.addEventListener("SIGNALLED_SPEAKER_CHANGED",this._onTransportSpeakerChanged.bind(this)),e.addEventListener("SIGNALLED_STALLED_PARTICIPANTS",this._onTransportStalledParticipants.bind(this)),e.addEventListener("NETWORK_STATUS",this._onTransportNetworkStatus.bind(this)),e.addEventListener("REMOTE_STREAM_SECOND",this._onRemoteStreamSecond.bind(this)),e.addEventListener("PEER_CONNECTION_CLOSED",this._onPeerConnectionClosed.bind(this,"SERVER")),e.addEventListener("ASR_TRANSCRIPTION",this._onAsrTranscription.bind(this))),this._animojiReceiver&&this._animojiSender&&e.setAnimojiTransport(this._animojiReceiver,this._animojiSender),e}_releaseDirectTransport(){var e;null==(e=this._directTransport)||e.close(),this._directTransport=null;for(let e of this._dtListeners)e.dispose();this._dtListeners=[]}_releaseServerTransport(){var e;null==(e=this._serverTransport)||e.close(),this._serverTransport=null;for(let e of this._stListeners)e.dispose();this._stListeners=[]}_setLocalNoiseSuppression(e){var t;Ve.noiseSuppression!==e&&(Ve.noiseSuppression=e,null==(t=this._mediaSource)||t.updateNoiseSuppression())}_onDirectTransportChanged(e){var t;let i=null==(t=this._directTransport)?void 0:t.participantId;if("CONNECTED"===e&&"DIRECT"===this._topology&&this._releaseServerTransport(),("CLOSED"===e||"FAILED"===e)&&(this._releaseDirectTransport(),"DIRECT"===this._topology)){let e=this._opened.indexOf(i);e>=0&&this._opened.splice(e,1);let t=this._allocated.indexOf(i);t>=0&&this._allocated.splice(t,1)}"DIRECT"===this._topology&&i&&(this._setStates([i],e),this._setLocalState(e))}_onServerTransportChanged(e){let t=this._opened.slice();"CONNECTED"===e&&"SERVER"===this._topology&&this._releaseDirectTransport(),("CLOSED"===e||"FAILED"===e)&&(this._releaseServerTransport(),"SERVER"===this._topology&&(this._allocated=[],this._opened=[])),"SERVER"===this._topology&&(this._setStates(t,e),this._setLocalState(e))}_onTransportActiveParticipants(e){"SERVER"===this._topology&&this._triggerEvent("SIGNALLED_ACTIVE_PARTICIPANTS",e)}_onTransportStalledParticipants(e){"SERVER"===this._topology&&this._triggerEvent("SIGNALLED_STALLED_PARTICIPANTS",e)}_onTransportSpeakerChanged(e){"SERVER"===this._topology&&this._triggerEvent("SIGNALLED_SPEAKER_CHANGED",e)}_onTransportNetworkStatus(e){this._triggerEvent("NETWORK_STATUS",e)}_onRemoteStreamSecond(e,t){this._triggerEvent("REMOTE_STREAM_SECOND",e,t)}_onPeerConnectionClosed(e){this._triggerEvent("PEER_CONNECTION_CLOSED",e)}_onServerAudioMixStall(e){"SERVER"===this._topology&&this._triggerEvent("AUDIO_MIX_STALL",e)}_onRemoteDataStats(e){this._triggerEvent("REMOTE_DATA_STATS",e)}_onRemoteTrackAdded(e,t,i){this._triggerEvent("REMOTE_TRACK_ADDED",e,t,i)}_onRemoteTrackRemoved(e,t,i){this._triggerEvent("REMOTE_TRACK_REMOVED",e,t,i)}_onAsrTranscription(e){this._triggerEvent("ASR_TRANSCRIPTION",e)}_onSourceChanged(){var e;let t=this._mediaSource.getStream();t&&(null==(e=this._animojiSender)||e.setStream(t))}_onAnimojiStream(e,t){this._triggerEvent("ANIMOJI_STREAM",e,t)}_onAnimojiStatus(e){var t,i;e?null==(t=this._animojiSender)||t.resume():null==(i=this._animojiSender)||i.pause(),this._mediaSource.onAnimojiSender(e)}_createAnimojiTransport(){if(!Ve.vmoji)return;this._animojiReceiver=new Ve.vmoji.AnimojiReceiver(((e,t)=>this._onAnimojiStream(e,t)),(e=>this._onAnimojiStream(e,null)),(e=>{this._triggerEvent("ANIMOJI_ERROR",e)}),Ve.vmojiOptions.renderingOptions);let e=this._mediaSource.getStream();this._animojiSender=new Ve.vmoji.AnimojiSender(e,this._signaling.getPeerId(),Ve.vmojiOptions.protocolVersion,{requested:this._mediaSource.isAnimojiRequested,useAI:Ve.vmojiOptions.renderingOptions.useAI}),this._animojiSender.onLocalData=e=>{var t;return null==(t=this._animojiReceiver)?void 0:t.receive(e)}}_removeAnimojiTransport(){var e,t;null==(e=this._animojiSender)||e.destroy(),this._animojiSender=null,null==(t=this._animojiReceiver)||t.destroy(),this._animojiReceiver=null}getStreamWaitingTimeMs(e,t){return"SERVER"!==this._topology?(w.log(F.PAT_WAITING_TIME_ERROR,"wrongTopology"),li.error(`Cannot get stream waiting time, incorrect topology: ${this._topology}`),0):this._serverTransport?this._serverTransport.getStreamWaitingTimeMs(e,t):(w.log(F.PAT_WAITING_TIME_ERROR,"noTransport"),li.error("Cannot get stream waiting time, server transport is not initialized"),0)}},Nr=class extends P{constructor(e){super(),this._detector=null,this._interval=null,this.subscribe(e,"REMOTE_TRACK_ADDED",this._onRemoteTrackAdded.bind(this)),this.subscribe(e,"REMOTE_TRACK_REMOVED",this._onRemoteTrackRemoved.bind(this)),this.subscribe(e,"SIGNALLED_ACTIVE_PARTICIPANTS",this._onSignalledActiveParticipants.bind(this)),this.subscribe(e,"TOPOLOGY_CHANGED",this._onTopologyChanged.bind(this))}destroy(){var e;this._interval&&(window.clearTimeout(this._interval),this._interval=null),this.unsubscribe(),null==(e=this._detector)||e.destroy(),this._detector=null}_onRemoteTrackAdded(e,t,i){var r;if("audio"===i.kind&&(null==(r=this._detector)||r.destroy(),this._detector=new hr(e,i),!this._interval)){let e=()=>{this._collectVolumes(),this._interval=window.setTimeout(e,Ve.voiceParams.interval)};this._interval=window.setTimeout(e,Ve.voiceParams.interval)}}_onRemoteTrackRemoved(e,t,i){"audio"===i.kind&&(!this._detector||this._detector.track!==i||(this._detector.destroy(),this._detector=null))}_collectVolumes(){if(!this._detector)return;let e={},t=this._detector.trackId,i=this._detector.getLevel();if(t===Ji.AUDIO_MIX){if(this._activeParticipants)for(let t of this._activeParticipants)e[t]=i}else e[t]=i;this._triggerEvent("VOLUMES_DETECTED",e)}_onSignalledActiveParticipants(e){this._activeParticipants=e}_onTopologyChanged(e){"DIRECT"===e&&(this._activeParticipants=null)}},wr=class extends P{constructor(e,t,i){super(),this._speakerId=null,this._serverSideSpeakerDetection=!1,this._serverSideSpeakerDetection="SERVER"===i,this.subscribe(e,"VOLUMES_DETECTED",this._onVolumesDetected.bind(this)),this.subscribe(t,"SIGNALLED_SPEAKER_CHANGED",this._onServerSpeakerChanged.bind(this)),this.subscribe(t,"TOPOLOGY_CHANGED",this._onTopologyChanged.bind(this))}destroy(){this.unsubscribe()}_onVolumesDetected(e){if(this._serverSideSpeakerDetection)return;let t=0,i=null;if(Object.keys(e).forEach((r=>{let n=e[r].smoothed;n>t&&n>Ve.voiceParams.threshold&&(t=n,i=r)})),i&&i!==this._speakerId){let r=this._speakerId&&e.hasOwnProperty(this._speakerId)?e[this._speakerId].smoothed:0;t>r*Ve.voiceParams.speakerLevelMultiplier&&(this._speakerId=i,this._triggerEvent("SPEAKER_CHANGED",i))}}_onServerSpeakerChanged(e){this._serverSideSpeakerDetection&&this._triggerEvent("SPEAKER_CHANGED",e)}_onTopologyChanged(e){this._serverSideSpeakerDetection="SERVER"===e}},Mr=class extends P{constructor(e,t,i){super(),this._volumes={},this._participants={},this._connectionTimeout=0,this._volumeTimeout=0,this._transport=e,this._participants=i,this.subscribe(e,"STATE_CHANGED",this._onTransportStateChanged.bind(this)),this.subscribe(t,"VOLUMES_DETECTED",this._onVolumesDetected.bind(this))}destroy(){this.unsubscribe(),this._connectionTimeout&&window.clearTimeout(this._connectionTimeout),this._volumeTimeout&&window.clearTimeout(this._volumeTimeout)}onChangeRemoteMediaSettings(e,t){t.isAudioEnabled||(this._volumes[e]=1),t.isAudioEnabled&&(this._volumes[e]=0)}_onTransportStateChanged(e,t){"OPENED"===t&&(this._connectionTimeout||(this._connectionTimeout=window.setTimeout(this._onConnectionTimeout.bind(this),Ve.specListenerParams.connectionTimeout)),this._volumeTimeout||(this._volumeTimeout=window.setTimeout(this._onVolumeTimeout.bind(this),Ve.specListenerParams.volumeTimeout))),"FAILED"===t&&this._connectionTimeout&&(li.warn("Transport failed, send callSpecError"),w.log(F.CALL_SPEC_ERROR,`${this._transport.getTopology()}_CONNECTION_TIMEOUT`))}_onVolumesDetected(e){Object.keys(e).forEach((t=>{this._volumes[t]=Math.max(e[t].real,this._volumes[t]||0)}))}_onConnectionTimeout(){let e=e=>"CONNECTED"!==e;(()=>Object.values(this._transport.getStates()).filter(e).length>0)()&&(li.warn("There is not connected transport, send callSpecError"),w.log(F.CALL_SPEC_ERROR,`${this._transport.getTopology()}_CONNECTION_TIMEOUT`)),this._connectionTimeout=0}_onVolumeTimeout(){let e=[];Object.keys(this._volumes).forEach((t=>{if(this._volumes[t]>0)return;let i="UNKNOWN",r=this._participants[t];r&&r.platform&&(i=r.platform),e.indexOf(i)<0&&(e.push(i),w.log(F.CALL_SPEC_ERROR,`${this._transport.getTopology()}_VOLUME_TIMEOUT_${i}`))})),e.length&&li.warn("There is silent participant, send callSpecError"),this._volumeTimeout=0}},kr=class{constructor(){this._isCallMarked=!1,this._isFinished=!1,this._callType=null}markAcceptCall(e){this.mark("DIRECT"===e?"direct_incoming":"server_incoming")}markAcceptedCall(e){"DIRECT"===e&&this.mark("direct_outgoing")}markParticipantJoined(e){"DIRECT"===e&&this.mark("server_change_topology")}markOnJoin(e){"SERVER"===e&&this.mark("server_join_server")}mark(e){this._isCallMarked||(this._isCallMarked=!0,this._callType=e,ce(F.FIRST_MEDIA_RECEIVED))}measure(){this._isFinished||(this._isFinished=!0,this._callType&&pe.logEventualStat({name:F.FIRST_MEDIA_RECEIVED,call_type:this._callType}))}},Lr=class extends P{constructor(e,t){super(),this._mediaSource=null,this._conversation=null,this._myLastRequestedLayouts={},this._state="IDLE",this._participantState=$i.CALLED,this._participants={},this._transport=null,this._debugInfo=null,this._volumesDetector=null,this._speakerDetector=null,this._localVolumeDetector=null,this._specListener=null,this._activeSpeakerId=null,this._lastSignalledActiveSpeakerId=null,this._isRealTimeAsrRequested=!1,this._serverSettings={camera:null,screenSharing:null},this._lastStalled={},this._audioMixStalled=!1,this._audioFix=null,this._streamByStreamId=new Map,this._streamIdByStreamDescription=new Map,this._streamWaitTimerByStreamDescription=new Map,this._sequenceNumberByStreamDescription=new Map,this._cooldownTimestampByStreamDescription=new Map,this._cooldownQueueCleanupTimer=null,this._changeMediaSettings=Q.debounce((e=>R(this,null,(function*(){if(this._signaling.ready)try{yield this._signaling.changeMediaSettings(e)}catch(e){if(li.warn("changeMediaSettings failed with error",e),"chatRoom.maxShareCountExceeded"===e.message)return this.toggleScreenCapturing({captureScreen:!1,fastScreenSharing:!1,captureAudio:!1})}}))),100),w.create(e,t),pe.create(),this._api=e,this._signaling=new Ni,this._onUnload=()=>{this._conversation&&this._api&&(this._api.hangupConversation(this._conversation.id),Ve.clientEventsLoggingEnabled&&w.logClientEvent({event_type:F.CALL_DECLINED_OR_HANGED_LOCALLY,reason:"none"},!0)),w.destroy(),pe.destroy()},window.addEventListener("unload",this._onUnload),this._statFirstMediaReceived=new kr,this._audioOutput=new dr(this._statFirstMediaReceived),Ve.videoTracksCount>0&&(this._cooldownQueueCleanupTimer=window.setInterval(this._cleanupCooldownQueue.bind(this),1e3))}static current(){return Lr._current}static hangupAfterInit(){Lr._activationMutex&&!Lr._current&&(Lr._delayedHangup=!0)}static id(){var e,t;return(null==(t=null==(e=Lr._current)?void 0:e._conversation)?void 0:t.id)||null}onStart(e,t,i,r="",n=!1,a=!1,s){return R(this,null,(function*(){if(Lr._activationMutex)throw w.log(F.ERROR,"startCall"),li.warn("Conversation: there is already running activation"),new N(b.FAILED);Lr._activationMutex=!0,Ht.startSession();try{this._mediaSource=this._createMediaSource(),yield this._mediaSource.request(i);let o=this._mediaSource.getMediaSettings();t===Li.CHAT||e.length>1?this._logWithMediaSettings(F.OUTGOING_MULTIPARTY_CALL,o):this._logWithMediaSettings(F.OUTGOING_CALL,o);let c=yield this._startConversation(e,t,Mi.OUTGOING,i,r,n,a,s);if(!this._conversation)throw new N(b.UNKNOWN_ERROR);if(this._participantState=$i.ACCEPTED,this._changeMediaSettings(o),yield this._processConnection(c),this._allocateTransport(),this._createSpeakerDetector(),this._createSpecListener(),this._signaling.readyToSend(),Lr._delayedHangup)throw new N(b.CANCELED);return li.debug("Outgoing call",{opponentIds:e,opponentType:t,mediaOptions:i}),yield this._processConnectionSharedMovieInfo(c),yield this._processConversationUrlSharingInfo(c),nt.onLocalStream(this._mediaSource.getStream(),this._mediaSource.getMediaSettings()),nt.onConversation(this._conversation.externalId,this._conversation.mediaModifiers,this._getMuteStatesForCurrentRoom(),this._getMainRoomParticipants()),this._onConversationParticipantListChunk(c),this._processPinnedParticipants(c),nt.onLocalStatus("WAITING"),this._toggleJoinAvailability(),this._changeFeatureSet(),this._changeNeedRate(),Lr._current=this,this._conversation.concurrent&&(yield this._acceptConcurrent()),this._conversation}catch(e){throw this._close(e,"Unable to start conversation"),e}finally{Lr._activationMutex=!1}}))}onJoin(e){return R(this,null,(function*(){var t;if(Lr._activationMutex)throw w.log(F.ERROR,"joinCall"),li.warn("Conversation: there is already running activation"),new N(b.FAILED);Lr._activationMutex=!0,this._state="PROCESSING",Ht.startSession();try{let i=!(null==(t=e.observedIds)||!t.length);if(i&&Ve.videoTracksCount>0)throw li.error("Observer mode: please set videoTracksCount=0"),new N(b.UNSUPPORTED);this._mediaSource=this._createMediaSource(),yield this._mediaSource.request(e.mediaOptions,!i);let r=this._mediaSource.getMediaSettings();this._logWithMediaSettings(F.JOIN_CONVERSATION,r);let n=yield this._joinConversation(e);if(!this._conversation)throw new N(b.UNKNOWN_ERROR);return this._conversation.observer=i,nt.onLocalStream(this._mediaSource.getStream(),r),this._conversation.waitingHall?(li.log("In waiting hall"),Lr._current=this,Lr._activationMutex=!1,this._signaling.readyToSend(),nt.onLocalStatus("WAITING_HALL"),this._conversation):this._onJoinPart2(n)}catch(e){throw Lr._activationMutex=!1,this._close(e,"Unable to join conversation"),e}}))}_onJoinPart2(e){return R(this,null,(function*(){var t,i,r,n;li.debug("Join conversation part 2"),Lr._activationMutex=!0;try{if(this._participantState=$i.ACCEPTED,!this._conversation||!this._mediaSource)throw new N(b.UNKNOWN_ERROR);if(this._statFirstMediaReceived.markOnJoin(this._conversation.topology),!this._conversation.observer&&!this._isAudienceModeListener()&&this._changeMediaSettings(this._mediaSource.getMediaSettings()),yield this._processConnection(e),this._allocateTransport(),this._createSpeakerDetector(),this._createSpecListener(),this._signaling.readyToSend(),"CLOSE"===this._state)return this._conversation;if(Lr._delayedHangup)throw new N(b.CANCELED);yield this._processConnectionSharedMovieInfo(e),yield this._processConversationUrlSharingInfo(e),yield this._processConnectionAsrInfo(e);let a=yield this._extractExternalRoomsData(null==(t=e.rooms)?void 0:t.rooms,null==(i=e.rooms)?void 0:i.roomId);return nt.onConversation(this._conversation.externalId,this._conversation.mediaModifiers,this._getMuteStatesForCurrentRoom(),this._getMainRoomParticipants(),a),this._onConversationParticipantListChunk(e),this._processPinnedParticipants(e),nt.onLocalStatus("WAITING"),this._toggleJoinAvailability(),this._changeNeedRate(),this._state="ACTIVE",this._changeFeatureSet(),Lr._current=this,this._openTransport(Object.values(this._participants),!1),this._conversation.audienceMode&&!this._conversation.restricted&&this._forceOpenTransportForAloneInCall(),this._conversation.recordsInfoByRoom.get(null!=(n=null==(r=null==e?void 0:e.rooms)?void 0:r.roomId)?n:null)&&this._forceOpenTransportForAloneInCall(),this._conversation}catch(e){throw this._close(e,"Unable to join conversation"),e}finally{Lr._activationMutex=!1}}))}_extractExternalRooms(e){return R(this,null,(function*(){let t=e.map(this._convertRoomToExternal.bind(this));return(yield Promise.all(t)).filter((e=>!!e))}))}_extractExternalRoomsData(e,t){return R(this,null,(function*(){if(!e||!e.length)return;let i={rooms:yield this._extractExternalRooms(e)};return t&&(i.roomId=t),i}))}onPush(e){return R(this,arguments,(function*(e,t=K.USER,i){if(Lr._activationMutex)throw li.warn("Conversation: there is already running activation"),new N(b.REJECTED);Lr._activationMutex=!0;try{let r=yield this._prepareConversation(e,t,i);if(this._mediaSource=this._createMediaSource(),!this._conversation)throw new N(b.UNKNOWN_ERROR);if(!r.conversation.participants.find((e=>{var t;return e.state===$i.CALLED&&e.id===(null==(t=this._conversation)?void 0:t.userId)})))throw li.log("Push rejected (there is an active call)"),w.log(F.PUSH,"rejected"),new N(b.REJECTED);if(Ht.startSession(),yield this._processConnection(r),this._extractConnectionUrlSharingInfo(r),this._allocateTransport(),this._createSpeakerDetector(),this._createSpecListener(),this._processPinnedParticipants(r),this._signaling.readyToSend(),w.log(F.PUSH,"accepted"),Lr._current=this,Lr._delayedHangup)throw new N(b.CANCELED);Lr._activationMutex=!1}catch(e){throw Lr._activationMutex=!1,this._close(e,"Unable to handle inbound call push"),e}}))}_isInWaitingHall(e){return!(!e.conversation||(e.conversation.options||[]).indexOf(ji.WAITING_HALL)<0)&&this._isRestricted(e)}_isRestricted(e){let t=(e.conversation.participants||[]).find((t=>Q.comparePeerId(t.peerId,e.peerId)));return t&&t.restricted||!1}_isAudienceMode(e){var t,i;return(null==(i=null==(t=e.conversation)?void 0:t.options)?void 0:i.includes(ji.AUDIENCE_MODE))||!1}_isAudienceModeListener(){var e,t;return(null==(e=this._conversation)?void 0:e.audienceMode)&&(null==(t=this._conversation)?void 0:t.restricted)}_acceptConcurrent(){return R(this,null,(function*(){if(!this._mediaSource||!this._conversation||!this._transport)throw new N(b.UNKNOWN_ERROR);this._state="PROCESSING";let e=this._mediaSource.getMediaSettings();this._logWithMediaSettings(F.ACCEPT_CONCURRENT,e),li.debug("Concurrent call",{conversationId:this._conversation.id});try{this._statFirstMediaReceived.markAcceptCall(this._transport.getTopology()),yield this._signaling.acceptCall(this._mediaSource.getMediaSettings()),nt.onCallAccepted(),this._state="ACTIVE",this._participantState=$i.ACCEPTED,this._changeFeatureSet(),this._openTransport(Object.values(this._participants),!0)}catch(e){this._close(e,"Unable to accept concurrent call")}}))}_getMainRoomParticipants(){return Q.mapSharedParticipants(Object.values(this._participants).filter((e=>!e.isInRoom)))}accept(e){return R(this,null,(function*(){var t,i,r,n,a;if("IDLE"!==this._state)throw w.log(F.ERROR,"acceptIncoming"),li.error("Unable to accept a call - invalid state"),new Error("Unable to accept a call - invalid state");if(!this._mediaSource||!this._conversation||!this._transport)throw new N(b.UNKNOWN_ERROR);this._state="PROCESSING",li.debug("Accept incoming call",e);try{yield this._mediaSource.request(e);let s=this._mediaSource.getMediaSettings();this._logWithMediaSettings(F.ACCEPT_INCOMING,s),this._changeMediaSettings(s),this._statFirstMediaReceived.markAcceptCall(this._transport.getTopology()),yield this._signaling.acceptCall(s),this._participantState=$i.ACCEPTED;let o=this._getMuteStatesForCurrentRoom(),c=Object.keys(o);c.length&&this._onMuteParticipant({muteStates:o,mediaOptions:c,muteAll:!0,stateUpdated:!0}),this._registerParticipantLocalMuteState({muteStates:this._conversation.muteStatesPersonal});let l=yield this._signaling.getRooms(this._isCallAdmin());null!=(t=l.rooms)&&t.rooms&&l.rooms.rooms.forEach((e=>{var t;null==(t=e.participantIds)||t.forEach((e=>{this._participants[e]&&(this._participants[e].isInRoom=!0)}))})),this._conversation.roomId=(null==(i=l.rooms)?void 0:i.roomId)||null;let d=yield this._extractExternalRoomsData(null==(r=l.rooms)?void 0:r.rooms,null==(n=l.rooms)?void 0:n.roomId);if(nt.onCallAccepted(),nt.onLocalStream(this._mediaSource.getStream(),s),nt.onConversation(this._conversation.externalId,this._conversation.mediaModifiers,this._getMuteStatesForCurrentRoom(),this._getMainRoomParticipants(),d),Ve.useParticipantListChunk){let e=yield this._getInitialParticiapntListChunk();null==(a=null==e?void 0:e.participants)||a.forEach((e=>{let t=Q.composeId(e),i=this._participants[t];i&&(i.movieShareInfos=e.movieShareInfos)})),this._onConversationParticipantListChunk({participants:e})}return nt.onLocalStatus("WAITING"),this._toggleJoinAvailability(),this._changeNeedRate(),this._state="ACTIVE",this._changeFeatureSet(),this._openTransport(Object.values(this._participants),!0),yield this._processConversationUrlSharingInfo(),yield this._processConnectionAsrInfo(),this._conversation}catch(e){throw this._close(e,"Unable to accept call"),e}}))}decline(){return R(this,null,(function*(){var e;if("IDLE"!==this._state)throw w.log(F.ERROR,"declineIncoming"),li.error("Unable to decline a call - invalid state"),new Error("Unable to decline a call - invalid state");this._state="PROCESSING",li.debug("Decline incoming call"),this._logWithMediaSettings(F.DECLINE_INCOMING,null==(e=this._mediaSource)?void 0:e.getMediaSettings()),this._participantState=$i.HUNGUP,this._signaling.ready&&(yield this._signaling.hangup(b.REJECTED)),this._close(new N(b.REJECTED))}))}hangup(){return R(this,null,(function*(){li.debug("Hangup");let e="ACTIVE"===this._state?b.HUNGUP:b.CANCELED;w.log(F.HANGUP,e),this._signaling.ready?(yield this._signaling.hangup(e),this._close(new N(e))):nt.onHangup(new N(b.HUNGUP),this._conversation&&this._conversation.id)}))}addParticipant(e,t){return R(this,null,(function*(){if(!this._signaling.ready)return void this._close(new N(b.UNKNOWN_ERROR),"Unable to add participant");let i=yield this._signaling.addParticipant(e,t),r=null;"error"===i.type&&(r="call-unfeasible"===i.error?i.status:b.UNKNOWN_ERROR);let n=i.participant;yield this._onAddParticipant(Q.composeId(n),n,r)}))}removeParticipant(e,t=!1){return R(this,null,(function*(){this._signaling.ready&&(yield this._signaling.removeParticipant(e,t),this._onRemoveParticipant(e))}))}setVolume(e){this._audioOutput.volume=e}updateStatisticsInterval(){this._transport&&this._transport.updateStatisticsInterval()}_openTransport(e,t){var i;if(!this._transport)return;let r=[];for(let i of e)(i.state===$i.CALLED||i.state===$i.ACCEPTED)&&(this._transport.isAllocated(i.id)||this._transport.allocate(i.id,t)),i.state===$i.ACCEPTED&&r.push(i.id);r.length&&this._transport.open(r,null,!(null==(i=this._conversation)||!i.observer))}_close(e,t){t&&li.error(t,e),li.debug("Close conversation",e),this._signaling.readyToSend(!1),e.error?this._signaling.ready&&this._signaling.hangup(b.FAILED):w.log(F.ERROR,e.hangup),Lr._activationMutex=!1;let i=this._conversation&&this._conversation.id;return-1!==[b.CANCELED,b.NOT_FRIENDS,b.CALLEE_IS_OFFLINE,b.CALLER_IS_BLOCKED,b.CALLER_IS_REJECTED].indexOf(e.hangup)||e.hangup===b.REJECTED&&!e.remote?(nt.onHangup(e,i),void this.destroy()):(e.hangup!==b.HUNGUP||e.remote&&!this._isCalledState())&&(e.hangup!==b.MISSED||e.remote)?(null!==this._cooldownQueueCleanupTimer&&(window.clearInterval(this._cooldownQueueCleanupTimer),this._cooldownQueueCleanupTimer=null),(e.hangup!==b.SOCKET_CLOSED&&e.hangup!==b.NOT_FOUND||!Lr._current||this._conversation)&&(e.hangup!==b.BUSY||e.remote)?(this._state="CLOSE",this._participantState=$i.HUNGUP,this._changeFeatureSet(),this._cleanupMediaSource(),this._cleanupParticipants(),this._cleanupParticipantAgnosticStreams(),this._cleanupTransport(),this._cleanupSpeakerDetector(),this._cleanupSpecListener(),this._cleanupSignaling(),this._api.cleanup(),w.destroy(),pe.destroy(),this._conversation=null,this._myLastRequestedLayouts={},Lr._current=null,Lr._delayedHangup=!1,void nt.onHangup(e||new N(b.UNKNOWN_ERROR),i)):(this._cleanupSignaling(),void this._cleanupMediaSource())):(nt.onHangup(e,i),void this.destroy())}destroy(){let e=this._conversation&&this._conversation.id;li.debug("Destroy conversation",{conversationId:e}),null!==this._cooldownQueueCleanupTimer&&(window.clearInterval(this._cooldownQueueCleanupTimer),this._cooldownQueueCleanupTimer=null),this._state="CLOSE",this._participantState=$i.HUNGUP,this._cleanupMediaSource(),this._cleanupParticipants(),this._cleanupParticipantAgnosticStreams(),this._cleanupTransport(),this._cleanupSpeakerDetector(),this._cleanupSpecListener(),this._cleanupSignaling(),this._api.cleanup(),this._cleanupListeners(),w.destroy(),pe.destroy(),this._conversation=null,this._myLastRequestedLayouts={},Lr._current=null,Lr._delayedHangup=!1}_getConversationParams(e){return R(this,null,(function*(){let t=yield this._api.getConversationParams(e);li.debug("Api.getConversationParams",t);let i=[],{turn_server:r,stun_server:n}=t;if(n&&i.push(n),r){let e=r.urls.filter(((e,t,i)=>i.indexOf(e)===t));e.push(`${e[e.length-1]}?transport=tcp`),i.push({urls:e,username:r.username,credential:r.credential})}return Ve.iceServers=i,Ve.wssBase=t.endpoint,Ve.wssToken=t.token,t.client_type&&(Ve.clientType=t.client_type),Ve.externalUserType=t.external_user_type,t}))}_addGeoParamsToEndpoint(e,t){return t.isp_as_no&&(e+=`&ispAsNo=${t.isp_as_no}`),t.isp_as_org&&(e+=`&ispAsOrg=${t.isp_as_org}`),t.loc_cc&&(e+=`&locCc=${t.loc_cc}`),t.loc_reg&&(e+=`&locReg=${t.loc_reg}`),e}_startConversation(e,t,i,r,n="",a=!1,s=!1,o){return R(this,null,(function*(){ce(F.SIGNALING_CONNECTED);let c=Q.uuid();li.debug("Conversation: start",{conversationId:c,opponentIds:e,opponentType:t,direction:i});let l=r.includes(V.VIDEO),d=yield this._api.startConversation(c,e,t,l,n,a,s,{onlyAdminCanShareMovie:o});li.debug("Api.startConversation",d);let u=yield this._getConversationParams(d.id);d.endpoint=this._addGeoParamsToEndpoint(d.endpoint,u);let h=yield this._connectSignaling(Ci.START,d);return yield this._setConversation(d,h,i),h}))}_joinConversation(e){return R(this,null,(function*(){ce(F.SIGNALING_CONNECTED);let{conversationId:t,mediaOptions:i,chatId:r,joinLink:n,observedIds:a,payload:s}=e;li.debug("Conversation: join",{conversationId:t,joinLink:n,observedIds:a});let o,c=i.includes(V.VIDEO);if(t)o=yield this._api.joinConversation(t,c,r);else{if(!n)throw new N(b.UNKNOWN_ERROR);o=yield this._api.joinConversationByLink(n,c,a,s)}li.debug("Api.joinConversation",o),yield this._getConversationParams(o.id);let l=yield this._connectSignaling(Ci.JOIN,o);return yield this._setConversation(o,l,Mi.JOINING),l}))}_prepareConversation(e){return R(this,arguments,(function*(e,t=K.USER,i){ce(F.SIGNALING_CONNECTED),li.debug("Conversation: push",{conversationId:e,type:t,peerId:i});let r=this._api.getUserId();if(!r)throw new N(b.UNKNOWN_ERROR);let n=yield this._getConversationParams(e),a=n.device_idx||0,s=`${Ve.wssBase}?userId=${r}&entityType=${t}&deviceIdx=${a}&conversationId=${e}&token=${Ve.wssToken}`;s=this._addGeoParamsToEndpoint(s,n);let o={id:e,peerId:i,endpoint:s,is_concurrent:!1,p2p_forbidden:!1,device_idx:a},c=yield this._connectSignaling(Ci.ACCEPT,o);return!Lr._current||Lr._current._participantState!==$i.ACCEPTED&&Lr._current._participantState!==$i.CALLED?(Lr._current&&(Lr._current.destroy(),Lr._current=null),yield this._setConversation(o,c,Mi.INCOMING,t),c):(li.log("Push rejected (busy)"),w.log(F.PUSH,"busy"),this._signaling.ready&&this._signaling.hangup(b.BUSY),Promise.reject({hangup:b.BUSY}))}))}_createParticipant(e,t){return R(this,null,(function*(){var i;let r=Object.assign({id:null,externalId:null,mediaSettings:Fe(),participantState:{},state:$i.CALLED,status:null,remoteStream:null,mediaSource:null,platform:null,clientType:null,roles:[],networkRating:1,lastRequestedLayouts:{},muteStates:{},unmuteOptions:[],observedIds:[],isInRoom:!1,markers:null},e);return r.externalId||(r.externalId=yield this._getParticipantId(null!=t?t:r.id)),this._api.cacheExternalId(null!=t?t:r.id,r.externalId),t&&this._api.mapDecorativeId(t,r.id),null!=(i=r.observedIds)&&i.length&&(r.externalId.observer=!0),e.markers&&(r.markers=this._denormalizeMarkers(r.id,e.markers)),r}))}_getParticipantId(e){return R(this,null,(function*(){try{return yield this._api.userId(e)}catch(e){throw this._close(new N(b.NETWORK_ERROR),e),e}}))}_setConversation(e,t,i){return R(this,arguments,(function*(e,t,i,r=K.USER){var n;let{participants:a}=t.conversation;a.forEach((e=>{let t=Q.composeId(e),i=tr.fromSignalingParticipant(e,!1);if(i){this._api.cacheExternalId(t,i);let r=Q.composeDecorativeId(e),n=tr.fromSignalingParticipant(e);r&&n&&(this._api.cacheExternalId(r,n),this._api.mapDecorativeId(e.decorativeUserId,e.id))}}));let s=this._api.getUserId(),o=e.device_idx||0;if(!s){let e=(t.conversation.participants||[]).find((e=>Q.comparePeerId(e.peerId,t.peerId)));if(!e)throw new N(b.UNKNOWN_ERROR);s=Number(e.id),e.idType&&(r=e.idType),e.deviceIdx&&(o=e.deviceIdx),this._api.setUserId(s)}let c=Q.composeParticipantId(s,r,o);this._conversation={userId:s,compositeUserId:c,externalId:yield this._getExternalIdByParticipantId(c),acceptTime:t.conversation.acceptTime,features:t.conversation.features||[],featuresPerRole:t.conversation.featuresPerRole,id:t.conversation.id||e.id,participantsLimit:t.conversation.participantsLimit||30,topology:t.conversation.topology||"DIRECT",direction:i,concurrent:t.isConcurrent||e.is_concurrent||!1,needRate:!1,chatId:t.conversation.multichatId,roles:[],recordsInfoByRoom:new Map,asrInfoByRoom:new Map,muteStates:new Map,muteStatesPersonal:{},joinLink:e.join_link,pinnedParticipantIdByRoom:new Map,mediaModifiers:t.mediaModifiers,options:[],networkRating:1,waitingHall:this._isInWaitingHall(t),observer:!1,asrInfo:t.conversation.asrInfo||null,roomId:(null==(n=t.rooms)?void 0:n.roomId)||null,audienceMode:this._isAudienceMode(t),restricted:this._isRestricted(t),urlSharingInfoByRoom:new Map},Ht.conversationId=t.conversation.id||e.id,this._signaling.setConversationId(this._conversation.id),e.p2p_forbidden&&(Ve.forceRelayPolicy=e.p2p_forbidden),w.log(F.RELAY_POLICY,Ve.forceRelayPolicy?"1":"0"),this._changeFeatureSet(),this._logDevices()}))}_updateConversation(e){if(!this._conversation)throw new N(b.UNKNOWN_ERROR);this._conversation.acceptTime=e.conversation.acceptTime,this._conversation.features=e.conversation.features||[],this._conversation.featuresPerRole=e.conversation.featuresPerRole,this._conversation.participantsLimit=e.conversation.participantsLimit||30,this._conversation.topology=e.conversation.topology||"DIRECT",this._conversation.concurrent=e.isConcurrent||!1,this._conversation.chatId=e.conversation.multichatId,this._conversation.mediaModifiers=e.mediaModifiers,this._conversation.waitingHall=!1}_createMediaSource(){let e=new Ye;return this.subscribe(e,"SOURCE_CHANGED",this._onLocalMediaStreamChanged.bind(this)),this.subscribe(e,"SCREEN_STATUS",this._onScreenSharingStatus.bind(this)),this._audioFix=new lr(e),e}_connectSignaling(e,t){return R(this,null,(function*(){this._signaling.setEndpoint(t.endpoint),this.subscribe(this._signaling,Ii.NOTIFICATION,this._onSignalingNotification.bind(this)),this.subscribe(this._signaling,Ii.FAILED,this._onSignalingFailed.bind(this)),this.subscribe(this._signaling,Ii.RECONNECT,this._onSignalingReconnect.bind(this));let i=yield this._signaling.connect(e,t);return pe.logEventualStat({name:F.SIGNALING_CONNECTED}),i}))}_processConnection(e){return R(this,null,(function*(){yield this._registerConnectionParticipants(e),this._processRooms(e),this._processMuteStates(e),this._processRecordInfos(e),this._onOptionsChanged(e.conversation.options),e.chatRoom&&e.chatRoom.totalCount&&this._onChatRoomUpdated(xi.ATTENDEE,e.chatRoom.totalCount,e.chatRoom.firstParticipants,null,null)}))}_onConversationParticipantListChunk(e){let t=e.participants;t&&nt.onConversationParticipantListChunk(this._participantListChunkToExternalChunk(this._createParticipantListChunk(t)))}_createParticipantListChunk(e){return y(y({},{participants:[],countBefore:0,countAfter:0,markerFound:!1}),e)}_participantListChunkToExternalChunk(e){let t=Q.mapSharedParticipants(e.participants.reduce(((e,t)=>{let i=Q.composeId(t);return this._participants[i]&&e.push(this._participants[i]),e}),[]));return I(y({},e),{participants:t})}_registerConnectionParticipants(e){return R(this,null,(function*(){var t,i,r,n,a,s;yield this._registerParticipants(e.conversation.participants),null!=(t=e.participants)&&t.participants&&(yield this._registerParticipants(null==(i=e.participants)?void 0:i.participants));let o=null!=(n=null==(r=null==e?void 0:e.rooms)?void 0:r.rooms)?n:[];for(let e of o)yield this._registerParticipants(null!=(s=null==(a=null==e?void 0:e.participants)?void 0:a.participants)?s:[],!0)}))}_registerParticipants(e,t=!1){return R(this,null,(function*(){if(this._conversation)for(let i of e){let e=Q.composeId(i);if(li.test("Conversation:RegisterParticipant",e),this._isMe(e)){this._conversation.roles=i.roles||[],this._conversation.roles.length&&(li.debug(`Local roles changed: ${i.roles}`),nt.onLocalRolesChanged(this._conversation.roles,!0)),this._registerParticipantLocalMuteState(i);continue}if(i.state===$i.HUNGUP||i.state===$i.REJECTED){this._participants[i.id]&&this._removeParticipant(this._participants[i.id],b.HUNGUP);continue}let r=Q.composeDecorativeId(i),n=yield this._createParticipant({id:e,externalId:tr.fromSignalingParticipant(i),mediaSettings:Fe(i.mediaSettings),participantState:Q.mapParticipantState(i),state:i.state,roles:i.roles||[],status:"WAITING",muteStates:i.muteStates||{},unmuteOptions:i.unmuteOptions||[],observedIds:i.observedIds||[],markers:this._denormalizeMarkers(e,i.markers),movieShareInfos:i.movieShareInfos,isInRoom:t},r);this._registerParticipantInCache(n),i.roles&&i.roles.length&&(li.debug(`Roles for participant [${e}] changed: ${i.roles}`),nt.onRolesChanged(this._participants[e].externalId,i.roles,!0))}}))}_registerParticipantLocalMuteState({muteStates:e,unmuteOptions:t}){if(!e)return;let i=()=>R(this,null,(function*(){let i=sr(e,Hi.MUTE),r=sr(e,Hi.MUTE_PERMANENT);for(let n of[i,r])n.length&&(yield this._onMuteParticipant({muteStates:e,unmuteOptions:t,mediaOptions:n,stateUpdated:!0}))}));Q.setImmediate((()=>i().catch((e=>li.error(e)))))}_getStatusByTransportState(e){let t=null;return"CONNECTED"===e?t="CONNECTED":"CONNECTING"===e||"OPENED"===e?t="CONNECTING":"RECONNECTING"===e&&(t="RECONNECT"),t}_registerParticipantInCache(e){return this._participants[e.id]=e,e}_getExistedParticipantByIdOrCreate(e){return R(this,null,(function*(){let t=this._participants[e];if(t)return t;let i=this._api.getDecorativeIdByInitialId(Q.decomposeId(e).id),r=i?Q.composeUserId(i):void 0;return this._createParticipant({id:e},r)}))}_getExternalIdByParticipantId(e){return R(this,null,(function*(){var t,i;if(this._isMe(e))return null==(t=this._conversation)?void 0:t.externalId;if(Ve.useParticipantListChunk)return(yield this._getExistedParticipantByIdOrCreate(e)).externalId;if(null!=(i=this._participants[e])&&i.externalId)return this._participants[e].externalId;{let t=yield this._getParticipantId(e);return this._api.cacheExternalId(e,t),t}}))}_registerParticipantAndSetMarkersIfChunkEnabled(e,t){return R(this,null,(function*(){if(Ve.useParticipantListChunk){let i=this._registerParticipantInCache(yield this._getExistedParticipantByIdOrCreate(e));return i.markers=this._denormalizeMarkers(i.id,t),i}return this._participants[e]}))}_warnParticipantNotInConversation(e){li.warn(`Participant [${e}] isn't in conversation`)}_denormalizeMarkers(e,t){if(!t)return null;let i=Object.values(t).find((e=>"ts"in e&&"rank"in e));return Object.entries(t).reduce(((t,[r,n])=>(t[r]=I(y(y({},i),n),{id:e}),t)),{})}_processRooms(e){var t,i;let r=null!=(i=null==(t=e.rooms)?void 0:t.roomId)?i:null;this._onRoomSwitched(r,!0)}_processMuteStates(e,t=!1){var i,r,n;let a=function(e){var t;return null!=(t=e.conversation)&&t.muteStates?e.conversation.muteStates:e.muteState&&e.muteOptions?e.muteOptions.reduce(((t,i)=>(t[i]=e.muteState,t)),{}):void 0}(e);this._setMuteStatesForRoomId(a,null);for(let t of null!=(r=null==(i=e.rooms)?void 0:i.rooms)?r:[])this._setMuteStatesForRoomId(t.muteStates,t.id);let s=this._getMuteStatesForCurrentRoom();t&&(s=function(e,t){let i=e.conversation.participants.find((t=>Q.comparePeerId(t.peerId,e.peerId)));if(!i)return t;let{mediaSettings:r}=i;return or(t,r)}(e,s));let o=Object.keys(s),c=null==(n=this._conversation)?void 0:n.roomId;o.length&&this._onMuteParticipant({muteStates:s,mediaOptions:o,muteAll:!0,stateUpdated:!0,roomId:c},t)}_processRecordInfos(e){var t,i,r,n,a;this._onRecordInfo(null!=(i=null==(t=e.conversation)?void 0:t.recordInfo)?i:null);for(let t of null!=(n=null==(r=e.rooms)?void 0:r.rooms)?n:[])this._onRecordInfo(null!=(a=t.recordInfo)?a:null,t.id)}_processPinnedParticipants(e){var t,i,r,n;e.conversation.pinnedParticipantId?this._onPinParticipant(e.conversation.pinnedParticipantId):null==(t=this._conversation)||t.pinnedParticipantIdByRoom.delete(null);for(let t of null!=(r=null==(i=e.rooms)?void 0:i.rooms)?r:[])t.pinnedParticipantId?this._onPinParticipant(t.pinnedParticipantId,!1,void 0,t.id):null==(n=this._conversation)||n.pinnedParticipantIdByRoom.delete(t.id)}_allocateTransport(){if(!this._conversation||!this._mediaSource)return;this._transport=new br(this._conversation.topology,this._signaling,this._mediaSource,this._serverSettings),this._debugInfo=new ur,this.subscribe(this._transport,"STATE_CHANGED",this._onTransportStateChanged.bind(this)),this.subscribe(this._transport,"LOCAL_STATE_CHANGED",this._onTransportLocalStateChanged.bind(this)),this.subscribe(this._transport,"REMOTE_TRACK_ADDED",this._onRemoteTrackAdded.bind(this)),this.subscribe(this._transport,"REMOTE_TRACK_REMOVED",this._onRemoteTrackRemoved.bind(this)),this.subscribe(this._transport,"AUDIO_MIX_STALL",this._onAudioMixStall.bind(this)),this.subscribe(this._transport,"REMOTE_DATA_STATS",this._onRemoteDataStats.bind(this)),this.subscribe(this._transport,"SIGNALLED_STALLED_PARTICIPANTS",this._onRemoteSignalledStall.bind(this)),this.subscribe(this._transport,"TOPOLOGY_CHANGED",this._onTopologyChanged.bind(this)),this.subscribe(this._transport,"NETWORK_STATUS",this._onNetworkStatus.bind(this)),this.subscribe(this._transport,"REMOTE_STREAM_SECOND",this._onRemoteStreamSecond.bind(this)),this.subscribe(this._transport,"PEER_CONNECTION_CLOSED",this._onPeerConnectionClosed.bind(this)),this.subscribe(this._transport,"ASR_TRANSCRIPTION",this._onAsrTranscription.bind(this)),this.subscribe(this._transport,"ANIMOJI_STREAM",this._onAnimojiStream.bind(this)),this.subscribe(this._transport,"ANIMOJI_ERROR",this._onAnimojiError.bind(this));let e=this._conversation.direction===Mi.OUTGOING&&!this._conversation.concurrent;for(let t of Object.values(this._participants))(t.state===$i.ACCEPTED||t.state===$i.CALLED)&&this._transport.allocate(t.id,e)}_createSpeakerDetector(){this._transport&&this._conversation&&(this._volumesDetector=new Nr(this._transport),this.subscribe(this._volumesDetector,"VOLUMES_DETECTED",this._onVolumesDetected.bind(this)),this._speakerDetector=new wr(this._volumesDetector,this._transport,this._conversation.topology),this.subscribe(this._speakerDetector,"SPEAKER_CHANGED",this._onSpeakerChanged.bind(this)),this._localVolumeDetector=new pr(this._mediaSource))}_createSpecListener(){this._transport&&this._volumesDetector&&(this._specListener=new Mr(this._transport,this._volumesDetector,this._participants))}_logDevices(){let e=jt.getCameras().length,t=jt.getMicrophones().length;li.debug("Cameras: "+e+(jt.hasCameraPermission()?"✔":"✖")+", Microphones: "+t+(jt.hasMicrophonePermission()?"✔":"✖")),w.log(F.DEVICES,`${e}_${t}`)}_logWithMediaSettings(e,t){w.log(e,[(null==t?void 0:t.isAudioEnabled)&&"audio",(null==t?void 0:t.isVideoEnabled)&&"video"].filter(Boolean).join("_"))}_removeParticipant(e,t){var i;if(e.state!==$i.CALLED&&e.state!==$i.ACCEPTED&&"CLOSE"!==this._state&&(e.id===this._lastSignalledActiveSpeakerId&&(this._lastSignalledActiveSpeakerId=null),this._participants[e.id])){t===b.HUNGUP?this._setParticipantsStatus([e],"HANGUP"):this._setParticipantsStatus([e],"ERROR",t),null==(i=e.mediaSource)||i.disconnect(),this._conversation&&this._conversation.pinnedParticipantIdByRoom.get(null)===e.id&&this._conversation.pinnedParticipantIdByRoom.delete(null),this._conversation&&this._conversation.roomId&&this._conversation.pinnedParticipantIdByRoom.get(this._conversation.roomId)===e.id&&this._conversation.pinnedParticipantIdByRoom.delete(this._conversation.roomId);for(let[t,i]of Object.entries(e.lastRequestedLayouts))this._streamIdByStreamDescription.delete(t),this._sequenceNumberByStreamDescription.delete(t),this._cooldownTimestampByStreamDescription.delete(t),this._streamWaitTimerByStreamDescription.has(t)&&(window.clearTimeout(this._streamWaitTimerByStreamDescription.get(t)),this._streamWaitTimerByStreamDescription.delete(t)),this._sendUpdateDisplayLayout({[t]:{stopStream:!0}});this._api.unmapDecorativeId(e.id),delete this._participants[e.id],nt.onRemoteRemoved(e.externalId,e.markers)}}_cleanupListeners(){this.unsubscribe(),window.removeEventListener("unload",this._onUnload)}_cleanupMediaSource(){this._mediaSource&&(this._mediaSource.destroy(),this._mediaSource=null)}_cleanupParticipants(){Object.values(this._participants).forEach((e=>{var t,i,r,n;null==(t=e.remoteStream)||t.getTracks().forEach((e=>e.stop())),null==(i=e.remoteAudioTrack)||i.stop(),null==(r=e.secondStream)||r.getTracks().forEach((e=>e.stop())),null==(n=e.mediaSource)||n.disconnect()})),this._participants={},this._audioOutput&&this._audioOutput.destroy()}_cleanupParticipantAgnosticStreams(){li.debug("cleaning up participant-agnostic streams"),this._streamByStreamId.forEach((e=>{e.getTracks().forEach((e=>{e.stop()}))})),this._streamByStreamId=new Map,this._streamWaitTimerByStreamDescription.forEach((e=>{window.clearTimeout(e)})),this._streamWaitTimerByStreamDescription=new Map,this._streamIdByStreamDescription=new Map,this._sequenceNumberByStreamDescription=new Map,this._cooldownTimestampByStreamDescription=new Map}_cleanupTransport(){this._transport&&(this._transport.destroy(),this._transport=null),this._debugInfo&&(this._debugInfo=null)}_cleanupSpeakerDetector(){this._speakerDetector&&(this._speakerDetector.destroy(),this._speakerDetector=null),this._volumesDetector&&(this._volumesDetector.destroy(),this._volumesDetector=null),this._localVolumeDetector&&(this._localVolumeDetector.destroy(),this._localVolumeDetector=null)}_cleanupSpecListener(){this._specListener&&(this._specListener.destroy(),this._specListener=null)}_cleanupSignaling(){this._signaling.close(),this._signaling.cleanup()}_onAddParticipant(e,t,i){return R(this,null,(function*(){li.debug(`Add new participant [${e}]`);let r=this._participants[e];if(!r||r.state!==$i.ACCEPTED&&r.state!==$i.CALLED){if(!r){let i=Q.composeDecorativeId(t);r=this._registerParticipantInCache(yield this._createParticipant({id:e,externalId:tr.fromSignalingParticipant(t),mediaSettings:Fe(t.mediaSettings),state:t.state,roles:t.roles||[],muteStates:t.muteStates||{},unmuteOptions:t.unmuteOptions||[],observedIds:t.observedIds||[]},i))}this._setParticipantsStatus([r],"WAITING"),i?(r.state=$i.HUNGUP,this._removeParticipant(r,i)):this._transport&&(r.state=$i.CALLED,this._transport.allocate(r.id,!0),w.log(F.ADD_PARTICIPANT),this._invokeRolesChangedCallbackIfNeeded(r))}else li.warn(`Participant [${r.id}:${r.state}] is already in conversation`)}))}_onRemoveParticipant(e){li.debug(`Remove participant [${e}]`);let t=[];for(let i=0;i<=15;i++){let r=Q.compose(e,i),n=this._participants[r];n&&t.push(n)}if(t.length){if(this._transport)for(let e of t)this._transport.close(e.id);w.log(F.REMOVE_PARTICIPANT)}else this._warnParticipantNotInConversation(e)}changeDevice(e){return R(this,null,(function*(){return"audiooutput"===e?this._audioOutput.changeOutput():this._mediaSource?this._mediaSource.changeDevice(e):Promise.reject(U.UNKNOWN)}))}stopVideoTrack(){var e;return null==(e=this._mediaSource)?void 0:e.stopVideoTrack()}toggleScreenCapturing(e){return R(this,null,(function*(){return this._mediaSource?this._mediaSource.toggleScreenCapturing(e):Promise.reject(U.UNKNOWN)}))}disableScreenCapturing(){return R(this,null,(function*(){return this._mediaSource?this._mediaSource.disableScreenCapturing():Promise.reject(U.UNKNOWN)}))}toggleAnimojiCapturing(e){this._mediaSource&&this._mediaSource.toggleAnimojiCapturing(e)}setAnimojiSvg(e,t=null,i=null){if(!this._transport||!this._conversation)return;let r=!t,n=null!=t?t:this._conversation.compositeUserId;if(e instanceof ArrayBuffer){let t=null!=i?i:this._conversation.externalId.id;this._transport.setAnimojiSvg(n,{svg:e,userId:t,isMe:r})}else this._transport.setAnimojiSvg(n,{svg:e,isMe:r})}setAnimojiFill(e){var t;null==(t=this._transport)||t.setAnimojiFill(e)}setVideoStream(e,t=!1){return R(this,null,(function*(){if(this._mediaSource)return this._mediaSource.setVideoStream(e,t)}))}setAudioStream(e){return R(this,null,(function*(){if(this._mediaSource)return this._mediaSource.setAudioStream(e)}))}toggleLocalVideo(e){return R(this,null,(function*(){if(this._mediaSource)return w.log(F.MEDIA_STATUS,e?"video_1":"video_0"),this._mediaSource.toggleVideo(e)}))}toggleLocalAudio(e){return R(this,null,(function*(){if(this._mediaSource)return w.log(F.MEDIA_STATUS,e?"audio_1":"audio_0"),this._mediaSource.toggleAudio(e)}))}changePriorities(e){return R(this,null,(function*(){if(e.length<2||!this._signaling.ready)return;let t={},i={};for(let t of e){let e="object"==typeof t.uid?t.uid:tr.fromId(t.uid);i[tr.toString(e)]=t.priority}for(let e of Object.values(this._participants)){let r=tr.toString(e.externalId);i.hasOwnProperty(r)&&(t[e.id]=i[r])}yield this._signaling.changePriorities(t)}))}changeParticipantState(e,t){return R(this,null,(function*(){for(let[t,i]of Object.entries(e))if(t.length>5||i.length>5)throw new Error("key/value max length is 5 chars, mappings with empty values (null or empty string) are discarded");t&&!this._isCallAdmin()&&(t=void 0),yield this._signaling.changeParticipantState(e,t)}))}putHandsDown(){return R(this,null,(function*(){this._checkAdminRole(),yield this._signaling.putHandsDown()}))}requestKeyFrame(e){return R(this,null,(function*(){let t={};return t[_i(e)]={keyFrameRequested:!0},this._signaling.updateDisplayLayout(t)}))}requestTestMode(e,t){return R(this,null,(function*(){return this._signaling.requestTestMode(e,t)}))}updateDisplayLayout(e){return R(this,null,(function*(){var t;if(e.length<1||!this._signaling.ready||"SERVER"!==(null==(t=this._transport)?void 0:t.getTopology()))return;li.log(`Update display layout request [${this._signaling.getNextCommandSequenceNumber()}]`,e);let i={};for(let t of e){let e="object"==typeof t.uid?t.uid:tr.fromId(t.uid),r=this._api.getCachedOkIdByExternalId(e);if(!r){let t=tr.toString(e);li.log(`Unknown participant external ID ${t}`);continue}let n=_i({participantId:r,mediaType:t.mediaType,streamName:t.streamName}),a=this._participants[r];a?a.lastRequestedLayouts[n]=t:this._isMe(r)&&(this._myLastRequestedLayouts[n]=t),di(t)?(this._isMe(r)&&delete this._myLastRequestedLayouts[n],this._streamIdByStreamDescription.has(n)&&!this._cooldownTimestampByStreamDescription.has(n)&&this._cooldownTimestampByStreamDescription.set(n,Date.now())):(this._cooldownTimestampByStreamDescription.delete(n),!this._streamIdByStreamDescription.has(n)&&Ve.videoTracksCount>0&&this._streamIdByStreamDescription.set(n,null),i[n]=t),"SCREEN"===t.mediaType&&!di(t)&&ce(ue(r))}let r=this._cooldownTimestampByStreamDescription.keys();for(;this._streamIdByStreamDescription.size>Ve.videoTracksCount;){let e=r.next();if(e.done){li.error("Cannot accommodate all streaming requests: tracks available "+Ve.videoTracksCount+"; requested streams: "+Array.from(this._streamIdByStreamDescription.keys()));break}this._stopStreaming(e.value),i[e.value]={stopStream:!0}}yield this._sendUpdateDisplayLayout(i)}))}feedback(e){return R(this,null,(function*(){return this._signaling.feedback(e)}))}userFeedbackStats(e,t,i){if(this._conversation)if(Ve.clientEventsLoggingEnabled){let r={event_type:F.USER_FEEDBACK_RECEIVED,user_response:e};void 0!==t&&(r.reason=t),void 0!==i&&(r.group_call_users_count=i),w.logClientEvent(r,!0)}else this._api.sendUserFeedbackStats(this._conversation.id,e,t,i)}sendClientEvent(e,t={},i=!1){let r=y({event_type:e},t);w.logClientEvent(r,i)}_stopStreaming(e){var t;if(this._cooldownTimestampByStreamDescription.delete(e),this._sequenceNumberByStreamDescription.set(e,this._signaling.getNextCommandSequenceNumber()),this._streamWaitTimerByStreamDescription.has(e)&&(li.log("Client asked to stop streaming before stream became available",e),window.clearTimeout(this._streamWaitTimerByStreamDescription.get(e)),this._streamWaitTimerByStreamDescription.delete(e)),this._streamIdByStreamDescription.get(e)){let i=mi(e),r=this._participants[i.participantId],n=null==(t=this._conversation)?void 0:t.externalId,a=this._isMe(i.participantId);if(r||a){switch(i.mediaType){case"STREAM":case"MOVIE":if(i.streamName){let e={stream:null,streamName:i.streamName,mediaType:i.mediaType};a?nt.onLocalLive(n,e):nt.onRemoteLive(r.externalId,e)}break;case"CAMERA":nt.onRemoteStream(r.externalId,null);break;case"SCREEN":nt.onRemoteScreenStream(r.externalId,null)}w.log(F.PAT_DEALLOCATED)}else li.log(`Cannot find participant to stop streaming: ${i.participantId}`)}this._streamIdByStreamDescription.delete(e)}_sendUpdateDisplayLayout(e){return R(this,null,(function*(){if(0===Object.keys(e).length)return;li.log(`Update display layout send [${this._signaling.getNextCommandSequenceNumber()}]`,e);let t=yield this._signaling.updateDisplayLayout(e);if(!t)return;let i=[];for(let[e,r]of Object.entries(t.errorCodeByParticipantId||{})){let t=mi(e),n=this._participants[t.participantId];if(n){let e;"number"!=typeof r?(li.warn(`Unexpected error code ${r} received for participant ${t.participantId}`),e=Qi.UNKNOWN_ERROR):e=1===r?"no-available-tracks":"unknown-error",i.push({externalId:n.externalId,errorReason:e})}}if(i&&i.length)throw new Vr("Could not allocate one or more participants",i)}))}_cleanupCooldownQueue(){let e={},t=this._cooldownTimestampByStreamDescription.entries();for(;;){let i=t.next();if(i.done)break;let r=i.value;if(r[1]+1e4>Date.now())break;let n=r[0];this._stopStreaming(n),e[n]={stopStream:!0}}this._sendUpdateDisplayLayout(e)}_onParticipantSourcesUpdate(e){if(this._conversation){let t=e.participantUpdateInfos;li.log("Received participant sources update notification",t);for(let e of t)this._waitForStreamIfNeeded(e)}}_onParticipantPromoted(e){return R(this,null,(function*(){this._conversation&&this._conversation.audienceMode?(li.log("Promoted in audience mode",!e.demote),this._conversation.restricted=e.demote,this._processRecordInfos(e),!e.demote&&this._mediaSource&&this._changeMediaSettings(this._mediaSource.getMediaSettings())):(li.log("Promoted in waiting hall",!e.demote),e.demote?(li.log("Kicked from waiting hall"),this._close(new N(b.REMOVED))):(this._updateConversation(e),yield this._onJoinPart2(e))),nt.onPromoted(e.demote)}))}_onChatRoomUpdated(e){return R(this,arguments,(function*(e,t=0,i=[],r,n){li.log(`Chat room updated: ${e}`);let a=[],s=[],o=[],c=[],l=[];if(i.length&&i.forEach((e=>{if(e.externalId){let t=tr.fromSignaling(e.externalId);l.push(t),this._api.cacheExternalId(e.id.id,t)}else{let t=Q.decomposeId(e.id.id).id;a.push(t),c.push(t)}})),null!=r&&r.length&&r.forEach((e=>{let t=Q.decomposeId(e).id;a.push(t),s.push(t)})),null!=n&&n.length&&n.forEach((e=>{let t=Q.decomposeId(e).id;a.push(t),o.push(t)})),!a.length)return void nt.onChatRoomUpdated(e,t,l,[],[]);if(c.length){let e=yield this._api.getExternalIdsByOkIds(c);l.push(...e)}let d=yield this._api.getExternalIdsByOkIds(s),u=yield this._api.getExternalIdsByOkIds(o);nt.onChatRoomUpdated(e,t,l,d,u)}))}_onSharedMovieUpdate(e){return R(this,null,(function*(){var t;let i=null==(t=this._conversation)?void 0:t.externalId;for(let t of e.data)if(this._isMe(t.participantId))nt.onLocalLiveUpdate(i,t);else{let e=yield this._getExternalIdByParticipantId(t.participantId);e&&nt.onRemoteLiveUpdate(e,t)}}))}_onSharedMovieInfoStarted(e){return R(this,null,(function*(){li.log(`Shared movie started data received: ${e.notification}`),yield this._processSharedMovieInfo(e.movieShareInfo,e.roomId)}))}_processSharedMovieInfos(e,t=null){return R(this,null,(function*(){e&&(yield Promise.all(e.map((e=>this._processSharedMovieInfo(e,t)))))}))}_processSharedMovieInfo(e,t=null){return R(this,null,(function*(){var i;if(!e)return;let r=null==(i=this._conversation)?void 0:i.externalId;if(this._isMe(e.initiatorId))nt.onLocalSharedMovieInfo(r,e,t);else{let i=yield this._getExternalIdByParticipantId(e.initiatorId);i&&nt.onRemoteSharedMovieInfo(i,e,t)}this._forceOpenTransportForAloneInCall()}))}_processConnectionSharedMovieInfo(e){return R(this,null,(function*(){var t,i;let r=e.conversation.participants.find((e=>this._isMe(Q.composeId(e))));yield this._processSharedMovieInfos(null==r?void 0:r.movieShareInfos,null!=(i=null==(t=null==e?void 0:e.rooms)?void 0:t.roomId)?i:null)}))}_processConnectionAsrInfo(e){return R(this,null,(function*(){var t,i,r,n,a,s,o,c,l,d;let u=null!=(i=null==e?void 0:e.conversation.asrInfo)?i:null==(t=this._conversation)?void 0:t.asrInfo;if(u&&(null==(r=this._conversation)||r.asrInfoByRoom.set(null,u)),null!=(n=null==e?void 0:e.rooms)&&n.rooms)for(let t of e.rooms.rooms)t.asrInfo&&(null==(a=this._conversation)||a.asrInfoByRoom.set(t.id,t.asrInfo));let h=null!=(l=null!=(c=null==(s=null==e?void 0:e.rooms)?void 0:s.roomId)?c:null==(o=this._conversation)?void 0:o.roomId)?l:null,p=null==(d=this._conversation)?void 0:d.asrInfoByRoom.get(h);if(p){let e=yield this._getExternalIdByParticipantId(p.initiatorId);e&&nt.onAsrSet({externalId:e,movieId:p.movieId},h)}else h&&nt.onAsrSet(null,h)}))}_processConversationUrlSharingInfo(e){return R(this,null,(function*(){if(!this._conversation)return;e&&this._extractConnectionUrlSharingInfo(e);let{urlSharingInfoByRoom:t}=this._conversation,i=this._conversation.roomId,r=t.get(i);if(r&&!this._isMe(r.initiatorId)){let e=yield this._getExternalIdByParticipantId(r.initiatorId);e&&nt.onRemoteSharedUrl(e,r.sharedUrl,i)}}))}_extractConnectionUrlSharingInfo(e){var t;if(!this._conversation)return;let{urlSharingInfoByRoom:i}=this._conversation;if(e.conversation.urlSharingInfo?i.set(null,e.conversation.urlSharingInfo):i.delete(null),null!=(t=e.rooms)&&t.rooms)for(let t of e.rooms.rooms)t.urlSharingInfo?i.set(t.id,t.urlSharingInfo):i.delete(t.id)}_onSharedMovieInfoStopped(e){return R(this,null,(function*(){var t;li.log(`Shared movie stopped data received: ${e.notification}`);let i=null==(t=this._conversation)?void 0:t.externalId,{initiatorId:r,movieId:n,source:a,roomId:s=null}=e,o={initiatorId:r,movieId:n,source:a};if(this._isMe(r))nt.onLocalSharedMovieStoppedInfo(i,o,s);else{let e=yield this._getExternalIdByParticipantId(r);if(e){let t=this._participants[r];null!=t&&t.movieShareInfos&&(t.movieShareInfos=t.movieShareInfos.filter((e=>e&&e.movieId!==n))),nt.onRemoteSharedMovieStoppedInfo(e,o,s)}}}))}_onUrlSharingInfoUpdated(e){return R(this,null,(function*(){if(li.log(`Shared URL data received: ${e.notification}`),!this._conversation)return;let{urlSharingInfoByRoom:t,roomId:i}=this._conversation,{initiatorId:r,sharedUrl:n,roomId:a=null}=e;if(n?t.set(a,{sharedUrl:n,initiatorId:r}):t.delete(a),(n||a===i||!t.has(i))&&(!n||!this._isMe(r))){let e=yield this._getExternalIdByParticipantId(r);e&&nt.onRemoteSharedUrl(e,n,a)}}))}_onFeaturesPerRoleChanged(e){li.log(`Features per role changed: ${e.notification}`),nt.onFeaturesPerRoleChanged(e.featuresPerRole)}_waitForStreamIfNeeded(e){var t,i,r;let n=this._matchStreamDescription(e.participantStreamDescription);if(!n)return;let{mediaType:a,participantId:s}=n;if("ANIMOJI"===a)return;let o=this._participants[s];if(Ve.producerScreenDataChannel&&"SCREEN"===a&&!e.fastScreenShare)return void li.log("skipping participant-sources-update notification since screenshare will be received over datachannel");let c=_i(n),l=this._sequenceNumberByStreamDescription.get(c);if(l&&l>e.sequenceNumber)return li.warn(`Participant ${s} received outdated PAT response: sequence number ${e.sequenceNumber}; last sent sequence number for given participant is ${l}`),void w.log(F.PAT_OUTDATED_RESPONSE);o&&void 0!==e.suspend&&a&&(li.debug(`participant-sources-update: mediaType=${a}, suspend=${e.suspend}`),nt.onRemoteStreamSuspended(o.externalId,a,e.suspend));let d=e.streamId,u=e.rtpTimestamp?this._getWaitingTime(d,e.rtpTimestamp):0;if(u<=0){this._streamWaitTimerByStreamDescription.delete(c);let n=null==(t=this._conversation)?void 0:t.externalId,a=this._isMe(s);if(!o&&!a)return w.log(F.PAT_ERROR,"participantMissing"),void li.error(`Could not find participant by ID: ${s}`);let l=a?n:o.externalId,u=this._streamByStreamId.get(d);if(!u)return w.log(F.PAT_ERROR,"streamNotFound"),void li.error(`Could not find stream by ID: ${d}`);w.log(F.PAT_ALLOCATED),this._streamIdByStreamDescription.set(c,d);let h=null==(i=e.participantStreamDescription)?void 0:i.mediaType;if("STREAM"===h||"MOVIE"===h){if(null!=(r=e.participantStreamDescription)&&r.streamName){let t={streamName:e.participantStreamDescription.streamName,stream:u,mediaType:h};a?nt.onLocalLive(l,t):nt.onRemoteLive(l,t)}}else if(Ve.producerScreenTrack&&"SCREEN"===h)nt.onRemoteScreenStream(o.externalId,u);else if(!a){let e=(Ve.producerScreenTrack?null:o.secondStream)||u;nt.onRemoteStream(o.externalId,e)}}else{li.debug(`Waiting for ${u} until stream ${d} for ${c} is switched`);let t=window.setTimeout(this._waitForStreamIfNeeded.bind(this,e),u);this._streamWaitTimerByStreamDescription.set(c,t)}}_matchStreamDescription(e){if(!e)return null;if(this._streamIdByStreamDescription.has(_i(e)))return e;let t=e.participantId;if(e.mediaType){let e={participantId:t,mediaType:null};if(this._streamIdByStreamDescription.has(_i(e)))return e}else{let e={participantId:t,mediaType:"CAMERA"};if(this._streamIdByStreamDescription.has(_i(e)))return e;let i={participantId:t,mediaType:"SCREEN"};if(this._streamIdByStreamDescription.has(_i(i)))return i}return li.error("Received unrequested allocation",e),null}_getWaitingTime(e,t){if(this._transport)return this._transport.getStreamWaitingTimeMs(e,t);throw new Error("transport is not initialized")}_isCallAdmin(){return!!this._conversation&&Q.includesOneOf(this._conversation.roles,[Zi.ADMIN,Zi.CREATOR])}_checkAdminRole(){if(this._conversation&&!Q.includesOneOf(this._conversation.roles,[Zi.ADMIN,Zi.CREATOR]))throw new Error("You don't have the required permission")}_isCalledState(){return this._participantState===$i.CALLED}grantRoles(e,t,i){return R(this,null,(function*(){this._checkAdminRole(),yield this._signaling.grantRoles(e,t,i)}))}startAsr(e){return R(this,null,(function*(){yield this._signaling.startAsr(e)}))}stopAsr(e){return R(this,null,(function*(){yield this._signaling.stopAsr(e)}))}requestAsr(e){return R(this,null,(function*(){this._isRealTimeAsrRequested=e,e&&this._forceOpenTransportForAloneInCall(),yield this._signaling.requestAsr(e)}))}muteParticipant(){return R(this,arguments,(function*(e=null,t,i=[],r=null){this._checkAdminRole(),yield this._signaling.muteParticipant(e,t,i,r)}))}enableFeatureForRoles(e,t){return R(this,null,(function*(){yield this._signaling.enableFeatureForRoles(e,t)}))}pinParticipant(e,t){return R(this,arguments,(function*(e,t,i=null){var r;this._checkAdminRole(),yield this._signaling.pinParticipant(e,t,i),null==(r=this._conversation)||r.pinnedParticipantIdByRoom.set(i,t?null:e)}))}updateMediaModifiers(e){return R(this,null,(function*(){this._signaling.ready&&this._conversation&&(this._conversation.mediaModifiers=e,yield this._signaling.updateMediaModifiers(e))}))}enableVideoSuspend(e){return R(this,null,(function*(){var t;this._signaling.ready&&this._conversation&&"SERVER"===(null==(t=this._transport)?void 0:t.getTopology())&&(yield this._signaling.enableVideoSuspend(e))}))}enableVideoSuspendSuggest(e){return R(this,null,(function*(){var t;this._signaling.ready&&this._conversation&&"SERVER"===(null==(t=this._transport)?void 0:t.getTopology())&&(yield this._signaling.enableVideoSuspendSuggest(e))}))}changeOptions(e){return R(this,null,(function*(){if(this._signaling.ready&&this._conversation){this._checkAdminRole(),yield this._signaling.changeOptions(e);let t=function(e,t){let i=new Set(e);for(let[e,r]of Object.entries(t))r?i.add(e):i.delete(e);return Array.from(i)}(this._conversation.options,e);this._onOptionsChanged(t)}}))}getWaitingHall(e,t,i){return R(this,null,(function*(){if(!this._signaling)return Promise.reject();let r=null;if(e&&(r=function(e){try{return JSON.parse(atob(e))}catch(t){li.warn("WaitingParticipant: failed convert from string",e,t)}return null}(e),r)){let e=this._api.getDecorativeIdByInitialId(r.id);r.id=e?Q.composeUserId(e):r.id}let n=yield this._signaling.getWaitingHall(r,t,i);if(n.error)return Promise.reject(n.message);let a=n.participants||[],{externalIds:s}=yield this._resolveWaitingHallExternalIds(a),o=null;return a.length&&n.hasMore&&(o=function(e){try{return btoa(JSON.stringify(e))}catch(t){li.warn("WaitingParticipant: failed convert to string",e,t)}return null}(a[a.length-1].id)),{participants:s,pageMarker:o,totalCount:n.totalCount||0}}))}_resolveWaitingHallExternalIds(e){return R(this,null,(function*(){let t=new Map,i=[],r=[];if(e.length){let n=[];e.forEach((e=>{if(t.set(e.id.id,e.id.addedTs),e.externalId){let t=tr.fromSignaling(e.externalId);i.push(e.id.addedTs),r.push(t),this._api.cacheExternalId(e.id.id,t)}else n.push(Q.decomposeId(e.id.id).id)})),n.length&&!r.length&&(r=yield this._api.getExternalIdsByOkIds(n),i=r.map((e=>{let i=this._api.getCachedOkIdByExternalId(e);return(i?t.get(i):void 0)||Date.now()})))}return{externalIds:r,timestamps:i}}))}getAudienceModeHands(){return R(this,null,(function*(){if(!this._signaling.ready)throw new Error("Signaling is not ready");let e=yield this._signaling.getHandQueue();if(e.error)return Promise.reject(e.message);let t=e.participants||[],{externalIds:i,timestamps:r}=yield this._resolveWaitingHallExternalIds(t);return{timestamps:r,participants:i,totalCount:e.totalCount||0}}))}promoteParticipant(e,t){return R(this,null,(function*(){if(this._signaling&&this._conversation)try{if(!Q.includesOneOf(this._conversation.options,[ji.WAITING_HALL,ji.AUDIENCE_MODE]))throw new Error("Unable to promote a participant in the conversation with current options");if(this._checkAdminRole(),!e&&t)throw new Error("participantId is required");yield this._signaling.promoteParticipant(e,t)}catch(t){throw li.warn(`Failed to promote participant ${e}. ${t}`),t}}))}requestPromotion(e=!1){return R(this,null,(function*(){this._signaling.ready&&(yield this._signaling.requestPromotion(e))}))}acceptPromotion(e=!1){return R(this,null,(function*(){this._signaling.ready&&(yield this._signaling.acceptPromotion(e))}))}chatMessage(e,t=null){return R(this,null,(function*(){this._signaling.ready&&(yield this._signaling.chatMessage(e,t))}))}chatHistory(e){return R(this,null,(function*(){if(this._signaling.ready){let t=yield this._signaling.chatHistory(e);for(let e=t.messages.length-1;e>=0;e--){let i=t.messages[e];yield this._onChatMessage(i)}}}))}customData(e,t=null){return R(this,null,(function*(){this._signaling.ready&&(yield this._signaling.customData(e,t))}))}createJoinLink(){return R(this,null,(function*(){if(this._conversation){let e=(yield this._api.createJoinLink(this._conversation.id)).join_link;if(e)return this._conversation.joinLink=e,e}return Promise.reject()}))}removeJoinLink(){return R(this,null,(function*(){if(!this._conversation||!(yield this._api.removeJoinLink(this._conversation.id)).success)return Promise.reject();delete this._conversation.joinLink}))}addMovie(e){return R(this,arguments,(function*({movieId:e,gain:t,metadata:i}){let r={movieId:e};(t||0===t)&&(r.gain=t),i&&(r.metadata=i);let n=yield this._signaling.addMovie(r);if(n.error)throw new Error(n.error);return{movieId:n.movieId,streamType:n.streamType}}))}updateMovie(e){return R(this,null,(function*(){let t=yield this._signaling.updateMovie(e);if(t.error)throw new Error(t.error)}))}removeMovie(e){return R(this,null,(function*(){let t={movieId:e},i=yield this._signaling.removeMovie(t);if(i.error)throw new Error(i.error)}))}startUrlSharing(e){return R(this,null,(function*(){let t=yield this._signaling.startUrlSharing(e);if(t.error)throw new Error(t.error)}))}stopUrlSharing(){return R(this,null,(function*(){let e=yield this._signaling.stopUrlSharing();if(e.error)throw new Error(e.error)}))}updateRooms(e,t){return R(this,null,(function*(){let i=yield this._signaling.updateRooms(e,t);if(i.error)throw new Error(i.error)}))}activateRooms(e,t){return R(this,null,(function*(){let i=yield this._signaling.activateRooms(e,t);if(i.error)throw new Error(i.error)}))}switchRoom(e,t){return R(this,null,(function*(){let i=yield this._signaling.switchRoom(e,t);if(i.error)throw new Error(i.error)}))}removeRooms(e){return R(this,null,(function*(){let t=yield this._signaling.removeRooms(e);if(t.error)throw new Error(t.error)}))}startStream(){return R(this,arguments,(function*(e=!1,t=null,i=null,r="DIRECT_LINK",n=null,a=null){let s={movieId:i,name:t,privacy:r,groupId:n,roomId:a,streamMovie:!e},o=yield this._signaling.startStream(s);if(o.error)return Promise.reject(o.message)}))}stopStream(){return R(this,arguments,(function*(e=null){if((yield this._signaling.stopStream({roomId:e})).error)return Promise.reject()}))}publishStream(){return R(this,arguments,(function*(e=null){if((yield this._signaling.publishStream({roomId:e})).error)return Promise.reject()}))}recordSetConf(e,t){return R(this,arguments,(function*(e,t,i=!1,r=null){let n=yield this._signaling.recordSetConf({king:e,pawns:t,hideParticipantCount:i,roomId:r});if(n.error)throw new Error(n.error)}))}getStreamInfo(){return R(this,null,(function*(){let e=yield this._signaling.getRecordStatus();return{movieId:e.recordMovieId,preview:e.recordMoviePreviewUrl}}))}setLocalResolution(e){return R(this,arguments,(function*({video:e,effect:t}){var i;if(e.width<Ve.videoMinWidth||e.height<Ve.videoMinHeight)throw new Error("Sizes received are less than the `videoMinWidth` or `videoMinHeight`");if(t){if(t.width<Ve.videoMinWidth||t.height<Ve.videoMinHeight)throw new Error("Sizes of effect received are less than the `videoMinWidth` or `videoMinHeight`");Ve.videoEffectMaxHeight=t.height,Ve.videoEffectMaxWidth=t.width}return Ve.videoMaxWidth=e.width,Ve.videoMaxHeight=e.height,li.debug("Set local video resolution:",`video ${e.width}x${e.height}`+(t?`, effect ${t.width}x${t.height}`:"")),null==(i=this._mediaSource)?void 0:i.setResolution({video:e,effect:t})}))}videoEffect(e){return R(this,null,(function*(){var t;return null==(t=this._mediaSource)?void 0:t.videoEffect(e)}))}audioEffect(e,t){return R(this,null,(function*(){var i;return null==(i=this._mediaSource)?void 0:i.audioEffect(e?{effects:e,isPreset:t}:null)}))}_convertExternalIdsToServerExternalIds(e){return e.map((e=>({id:e.id,type:Ve.externalUserType})))}getParticipants(e){return R(this,null,(function*(){var t;let i=this._convertExternalIdsToServerExternalIds(e.externalIds),r=yield this._signaling.getParticipants(i);if(r.error)throw new Error(r.error);let n=r.participants,a=null==(t=this._transport)?void 0:t.getState();return Promise.all(n.map((e=>R(this,null,(function*(){var t;let i=Q.composeId(e);return this._createParticipant({id:i,externalId:tr.fromSignalingParticipant(e),mediaSettings:Fe(e.mediaSettings),participantState:Q.mapParticipantState(e),state:e.state,roles:e.roles||[],status:null!=(t=this._getStatusByTransportState(a))?t:"WAITING",muteStates:e.muteStates||{},unmuteOptions:e.unmuteOptions||[],observedIds:e.observedIds||[],markers:this._denormalizeMarkers(i,e.markers)},e.decorativeUserId)}))))).then(Q.mapSharedParticipants)}))}getParticipantListChunk(e){return R(this,null,(function*(){var t;li.log("Request participant list chunk",e);let i=yield this._signaling.getParticipantListChunk(e);if(i.error)throw new Error(i.error);let r=this._createParticipantListChunk(i.chunk),n=r.participants.filter((e=>{let t=Q.composeId(e);return!this._participants[t]}));yield this._registerParticipants(n);let a=null==(t=this._transport)?void 0:t.getState();return r.participants.forEach((e=>{var t,i;let r=Q.composeId(e),n=this._participants[r];n.status=null!=(t=this._getStatusByTransportState(a))?t:"WAITING",n.movieShareInfos=e.movieShareInfos,Object.assign(n.mediaSettings,Fe(e.mediaSettings)),Object.assign(n.muteStates,e.muteStates),n.unmuteOptions=null!=(i=e.unmuteOptions)?i:n.unmuteOptions,this._openTransport([n],!0)})),this._participantListChunkToExternalChunk(r)}))}_getInitialParticiapntListChunk(){return R(this,null,(function*(){let e=Ve.participantListChunkInitIndex,t=Ve.participantListChunkInitCount,i=yield this._signaling.getParticipantListChunk({listType:"GRID",fromIdx:e,count:t});return li.debug("Get initial participant list chunk",i.chunk),i.chunk}))}_onLocalMediaStreamChanged(e){var t,i;if(!this._conversation||!this._mediaSource)return;let r=this._mediaSource.getMediaSettings();li.debug("Local media stream changed",r),"audio"===e.kind&&this._mediaSource&&(this._audioFix=new lr(this._mediaSource)),nt.onLocalStreamUpdate(r,e.kind),(null==(t=this._conversation)||!t.waitingHall)&&(null==(i=this._conversation)||!i.observer)&&!this._isAudienceModeListener()&&this._changeMediaSettings(r)}_onScreenSharingStatus(e){var t;let i=null==(t=this._mediaSource)?void 0:t.getMediaSettings();if(li.log("Screen sharing changed",e.track,i),Ve.consumerScreenTrack){let t=e.track?new MediaStream([e.track]):null;nt.onScreenStream(t,i)}}_changeRemoteMediaSettings(e,t){var i;li.debug(`Remote media settings changed [${e}]`,t);let r=null==(i=this._conversation)?void 0:i.externalId;if(this._isMe(e)&&r)return void nt.onLocalMediaSettings(r,t);let n=this._participants[e];n?(n.mediaSettings=t,"ACTIVE"===this._state&&nt.onRemoteMediaSettings(n.externalId,t,n.markers),this._specListener&&this._specListener.onChangeRemoteMediaSettings(e,t)):this._warnParticipantNotInConversation(e)}_changeLocalParticipantState(e){li.debug("Local participant state force changed by admin",e),"ACTIVE"===this._state&&nt.onLocalParticipantState(e)}_changeRemoteParticipantState(e,t){li.debug(`Remote participant state changed [${e}]`,t);let i=this._participants[e];i?(i.participantState=t||{},"ACTIVE"===this._state&&nt.onRemoteParticipantState(i.externalId,i.participantState,i.markers)):this._warnParticipantNotInConversation(e)}_changeMultipleParticipantState(e,t){li.debug("Multiple participants state changed",e);let i,r=[];e.forEach(((e,t)=>{if(this._isMe(t))i=e;else{let i=this._participants[t];if(!i)return void this._warnParticipantNotInConversation(t);i.participantState=e,r.push({externalId:i.externalId,participantState:y({},e),markers:i.markers})}})),"ACTIVE"===this._state&&(i&&nt.onLocalParticipantState(i),r.length&&nt.onRemoteParticipantsState(r,t))}_invokeRolesChangedCallbackIfNeeded(e){"ACTIVE"===this._state&&e.roles&&e.roles.length&&(li.debug(`Roles for participant [${e.id}] changed: ${e.roles}`),nt.onRolesChanged(e.externalId,e.roles,!0))}_onSignalingNotification(e){switch(e.notification){case Ai.ACCEPTED_CALL:return this._onAcceptedCall(e);case Ai.HUNGUP:return this._onHungup(e);case Ai.PARTICIPANT_ADDED:return this._onAddedParticipant(e);case Ai.PARTICIPANT_JOINED:return this._onJoinedParticipant(e);case Ai.CLOSED_CONVERSATION:return this._onClosedConversation(e);case Ai.MEDIA_SETTINGS_CHANGED:return this._onMediaSettingsChanged(e);case Ai.PARTICIPANT_STATE_CHANGED:return this._onParticipantStateChanged(e);case Ai.PARTICIPANTS_STATE_CHANGED:return this._onParticipantsStateChanged(e);case Ai.RATE_CALL_DATA:return this._onNeedRate();case Ai.FEATURE_SET_CHANGED:return this._onFeatureSetChanged(e);case Ai.MULTIPARTY_CHAT_CREATED:return this._onMultipartyChatCreated(e);case Ai.FORCE_MEDIA_SETTINGS_CHANGE:return this._onForceMediaSettingsChange(e);case Ai.SETTINGS_UPDATE:return this._onSettingsUpdate(e);case Ai.VIDEO_QUALITY_UPDATE:return this._onVideoQualityUpdate(e);case Ai.REGISTERED_PEER:return this._onPeerRegistered(e);case Ai.SWITCH_MICRO:return this._onMicSwitched(e);case Ai.CHAT_MESSAGE:return this._onChatMessage(e);case Ai.CUSTOM_DATA:return this._onCustomData(e);case Ai.RECORD_STARTED:return this._onRecordInfo(e.recordInfo,e.roomId);case Ai.RECORD_STOPPED:return this._onRecordInfo(null,e.roomId);case Ai.ROLES_CHANGED:return this._onRolesChanged(e.participantId,e.roles||[]);case Ai.MUTE_PARTICIPANT:return this._onMuteParticipant(e);case Ai.PIN_PARTICIPANT:return this._onPinParticipant(e.participantId,e.unpin,e.markers,e.roomId);case Ai.OPTIONS_CHANGED:return this._onOptionsChanged(e.options||[]);case Ai.PARTICIPANT_SOURCES_UPDATE:return this._onParticipantSourcesUpdate(e);case Ai.PROMOTE_PARTICIPANT:return this._onParticipantPromoted(e);case Ai.CHAT_ROOM_UPDATED:return this._onChatRoomUpdated(e.eventType,e.totalCount,e.firstParticipants,e.addedParticipantIds,e.removedParticipantIds);case Ai.JOIN_LINK_CHANGED:return this._onJoinLinkChanged(e);case Ai.FEEDBACK:return this._onFeedback(e);case Ai.MOVIE_UPDATE_NOTIFICATION:return this._onSharedMovieUpdate(e);case Ai.MOVIE_SHARE_STARTED:return this._onSharedMovieInfoStarted(e);case Ai.MOVIE_SHARE_STOPPED:return this._onSharedMovieInfoStopped(e);case Ai.URL_SHARING_INFO_UPDATED:return this._onUrlSharingInfoUpdated(e);case Ai.ROOMS_UPDATED:return this._onRoomsUpdated(e);case Ai.ROOM_UPDATED:return this._onRoomUpdated(e);case Ai.ROOM_PARTICIPANTS_UPDATED:return this._onRoomParticipantsUpdated(e);case Ai.FEATURES_PER_ROLE_CHANGED:return this._onFeaturesPerRoleChanged(e);case Ai.PARTICIPANT_ANIMOJI_CHANGED:return this._onParticipantAnimojiChanged(e);case Ai.ASR_STARTED:return this._onAsrStart(e);case Ai.ASR_STOPPED:return this._onAsrStop(e);case Ai.PROMOTION_APPROVED:return this._onPromotionApproved(e);case Ai.DECORATIVE_PARTICIPANT_ID_CHANGED:return this._onDecorativeParticipantIdChanged(e);case Ai.VIDEO_SUSPEND_SUGGEST:return this._onVideoSuspendSuggest(e)}}_onPromotionApproved(e){return R(this,null,(function*(){let t=yield this._getExternalIdByParticipantId(e.adminId);t?nt.onPromotionApproved(t):this._warnParticipantNotInConversation(e.adminId)}))}_onSignalingReconnect(e){return R(this,null,(function*(){var t,i;if(!this._conversation)return;e.conversation.acceptTime&&(this._conversation.acceptTime=e.conversation.acceptTime),e.conversation.participantsLimit&&(this._conversation.participantsLimit=e.conversation.participantsLimit),e.conversation.features&&(this._conversation.features=e.conversation.features,this._conversation.featuresPerRole=e.conversation.featuresPerRole,this._changeFeatureSet()),this._processPinnedParticipants(e),e.conversation.state;let r=null;if(e.conversation.participants){let t=Object.keys(this._participants),i=[];for(let t of e.conversation.participants){let e=Q.composeId(t),n=t.roles||[];if(this._isMe(e)){er(this._conversation.roles,n)||this._onRolesChanged(e,n),r=()=>{this._registerParticipantLocalMuteState({muteStates:cr(t),unmuteOptions:t.unmuteOptions})};continue}i.push(e);let a=this._participants[e];if(a){let i=Fe(t.mediaSettings);Be(i,a.mediaSettings)||this._changeRemoteMediaSettings(e,i);let r=Q.mapParticipantState(t),s=a.participantState;Q.isEqualParticipantState(r,s)||this._changeRemoteParticipantState(e,r),er(n,a.roles)||this._onRolesChanged(a.id,n)}else yield this._onJoinedParticipant({participantId:t.id,participant:t,mediaSettings:t.mediaSettings})}for(let e of t)i.indexOf(e)<0&&this._removeParticipant(this._participants[e],b.HUNGUP)}let n=null!=(i=null==(t=e.rooms)?void 0:t.roomId)?i:null;this._conversation.roomId!==n?this._onRoomSwitched(n).then(r):(this._processMuteStates(e,!0),null==r||r()),this._processRecordInfos(e),this._onOptionsChanged(e.conversation.options)}))}_onSignalingFailed(e){li.error("Signaling failed",e),this._close(e)}_onAcceptedCall(e){return R(this,null,(function*(){var t;let i=Q.composeMessageId(e),r=Q.getPeerIdString(e.peerId);if(li.debug(`Participant accepted call [${i}]`),this._statFirstMediaReceived.markAcceptedCall(null==(t=this._transport)?void 0:t.getTopology()),this._conversation&&this._isMe(i))return void this._close(new N(b.MISSED),"Call accepted on other device");let n=this._participants[i];if(!n){let t=this._api.getDecorativeIdByInitialId(i),r=t?Q.composeUserId(t,e.participantType):void 0;n=this._registerParticipantInCache(yield this._createParticipant({id:i,mediaSettings:Fe(e.mediaSettings)},r))}n.state=$i.ACCEPTED,n.mediaSettings=Fe(e.mediaSettings),this._logWithMediaSettings(F.ACCEPTED_OUTGOING,n.mediaSettings),this._conversation&&this._conversation.direction===Mi.OUTGOING&&("IDLE"===this._state||"PROCESSING"===this._state)&&(this._state="ACTIVE",this._changeFeatureSet()),"ACTIVE"===this._state&&this._transport&&this._transport.open([n.id],r),this._changeRemoteMediaSettings(i,n.mediaSettings),this._changeRemoteParticipantState(i);let a=Object.keys(n.muteStates);a.length&&this._onMuteParticipant({muteStates:n.muteStates,mediaOptions:a,stateUpdated:!0,participantId:i}),"ACTIVE"===this._state&&nt.onAcceptedCall(n.externalId)}))}_onHungup(e){return R(this,null,(function*(){li.debug(`Participant hungup [${e.participantId}]`,{reason:e.reason});let t=Q.composeMessageId(e);if(this._conversation&&this._isMe(t))return void this._close(new N(e.reason,{remote:!0}));yield this._registerParticipantAndSetMarkersIfChunkEnabled(t,e.markers);let i=this._participants[t];i?(this._transport&&this._transport.close(t),i.state=e.reason===b.REJECTED?$i.REJECTED:$i.HUNGUP,"CLOSE"!==this._state&&this._removeParticipant(i,b.HUNGUP)):this._warnParticipantNotInConversation(t)}))}_onAddedParticipant(e){return R(this,null,(function*(){var t,i;li.debug(`Participant added [${e.participantId}]`);let r=Q.composeMessageId(e),n=this._participants[r];if(n&&n.state!==$i.HUNGUP&&n.state!==$i.REJECTED)li.debug(`Participant [${r}] is already in conversation and is active`);else{if(!n){let{participant:t}=e,i=t.decorativeUserId,a=yield this._createParticipant({id:r,externalId:tr.fromSignalingParticipant(t),mediaSettings:Fe(t.mediaSettings),state:t.state,participantState:Q.mapParticipantState(t),roles:t.roles||[],muteStates:t.muteStates||{},unmuteOptions:t.unmuteOptions||[],observedIds:t.observedIds||[]},i);n=this._registerParticipantInCache(a)}n.state=$i.CALLED,n.mediaSettings=Fe(null==(t=e.participant)?void 0:t.mediaSettings),n.participantState=Q.mapParticipantState(e.participant),n.roles=(null==(i=e.participant)?void 0:i.roles)||[],this._setParticipantsStatus([n],"WAITING"),"IDLE"!==this._state&&this._transport&&this._transport.allocate(n.id,!0),nt.onParticipantAdded(n.externalId,n.markers),this._changeRemoteMediaSettings(r,n.mediaSettings),this._changeRemoteParticipantState(r,n.participantState),this._invokeRolesChangedCallbackIfNeeded(n)}}))}_onJoinedParticipant(e){return R(this,null,(function*(){var t,i,r;li.debug(`Participant joined [${e.participantId}]`),this._statFirstMediaReceived.markParticipantJoined(null==(t=this._transport)?void 0:t.getTopology());let n=Q.composeMessageId(e),a=this._participants[n];if(a&&a.state===$i.ACCEPTED)return void li.warn(`Participant [${n}] is already in conversation and is active`);if(!a){let{participant:t}=e,i=t.decorativeUserId,r=yield this._createParticipant({id:n,externalId:tr.fromSignalingParticipant(t),mediaSettings:Fe(t.mediaSettings),state:t.state,participantState:Q.mapParticipantState(t),roles:t.roles||[],muteStates:t.muteStates||{},movieShareInfos:t.movieShareInfos,unmuteOptions:t.unmuteOptions||[],observedIds:t.observedIds||[],markers:this._denormalizeMarkers(n,t.markers)},i);a=this._registerParticipantInCache(r)}this._conversation&&this._conversation.direction===Mi.OUTGOING&&("IDLE"===this._state||"PROCESSING"===this._state)&&(this._state="ACTIVE",this._changeFeatureSet()),a.state=$i.ACCEPTED,a.mediaSettings=Fe(e.mediaSettings),a.participantState=Q.mapParticipantState(e.participant),a.roles=e.participant.roles||[],null!=(i=this._transport)&&i.isAllocated(a.id)?this._setParticipantsStatus([a],"CONNECTED"):this._setParticipantsStatus([a],"WAITING"),"IDLE"!==this._state&&this._transport&&(this._transport.isAllocated(a.id)||this._transport.allocate(a.id,!0),this._transport.open([a.id],null,!(null==(r=this._conversation)||!r.observer))),nt.onParticipantJoined(a.externalId,a.markers),this._changeRemoteMediaSettings(n,a.mediaSettings),this._changeRemoteParticipantState(n,a.participantState),this._invokeRolesChangedCallbackIfNeeded(a);let s=Object.keys(a.muteStates);s.length&&this._onMuteParticipant({muteStates:a.muteStates,mediaOptions:s,stateUpdated:!0,participantId:n}),yield this._processSharedMovieInfos(a.movieShareInfos)}))}_onClosedConversation(e){this._toggleJoinAvailability(),this._close(new N(e.reason,{remote:!0}))}_onMediaSettingsChanged(e){return R(this,null,(function*(){let t=Q.composeMessageId(e);yield this._registerParticipantAndSetMarkersIfChunkEnabled(t,e.markers),this._changeRemoteMediaSettings(t,Fe(e.mediaSettings))}))}_onParticipantStateChanged(e){return R(this,null,(function*(){let t=Q.composeMessageId(e),i=Q.mapParticipantState(e);this._isMe(t)?this._changeLocalParticipantState(i):(yield this._registerParticipantAndSetMarkersIfChunkEnabled(t,e.markers),this._changeRemoteParticipantState(t,i))}))}_onParticipantsStateChanged(e){return R(this,null,(function*(){let{participants:t,roomId:i}=e,r=t.map((({id:e,markers:t})=>this._registerParticipantAndSetMarkersIfChunkEnabled(e,t)));yield Promise.all(r);let n=new Map,a=t.map((({id:e,participantState:t})=>this._getExternalIdByParticipantId(e).then((i=>[e,i&&Q.mapParticipantState({participantState:t})]))));try{(yield Promise.all(a)).forEach((([e,t])=>{t&&n.set(e,t)})),this._changeMultipleParticipantState(n,i)}catch(e){li.warn(`_onParticipantsStateChanged: Failed to get external ids. ${e}`)}}))}_onNeedRate(){this._conversation&&(this._conversation.needRate=!0,this._changeNeedRate())}_onFeatureSetChanged(e){this._conversation&&(this._conversation.features=e.features,this._conversation.featuresPerRole=e.featuresPerRole,this._changeFeatureSet())}_onMultipartyChatCreated(e){this._conversation&&(this._conversation.chatId=e.chatId,this._toggleJoinAvailability(),nt.onMultipartyChatCreated(this._conversation))}_onForceMediaSettingsChange(e){return R(this,null,(function*(){if(!this._mediaSource)return;let t=this._mediaSource.getMediaSettings(),i=Fe(e.mediaSettings);t.isAudioEnabled!==i.isAudioEnabled&&(yield this._mediaSource.toggleAudio(i.isAudioEnabled)),t.isVideoEnabled!==i.isVideoEnabled&&(yield this._mediaSource.toggleVideo(i.isVideoEnabled)),Ve.consumerScreenTrack&&t.isScreenSharingEnabled!==i.isScreenSharingEnabled&&(yield this._mediaSource.toggleScreenCapturing({captureScreen:i.isScreenSharingEnabled,fastScreenSharing:i.isFastScreenSharingEnabled,captureAudio:i.isAudioSharingEnabled}))}))}_onSettingsUpdate(e){li.debug("Got settings update notification",e);let t={camera:e.camera,screenSharing:e.screenSharing};this._serverSettings=ar(this._serverSettings,t),this._transport&&this._transport.updateSettings(this._serverSettings)}_onVideoQualityUpdate(e){li.debug("Got video quality update notification",e);let t=Math.round(e.quality.maxBitrate/1024),i=e.quality.maxDimension,r={camera:Object.assign({},this._serverSettings.camera,{maxBitrateK:t,maxDimension:i}),screenSharing:null};this._serverSettings=ar(this._serverSettings,r),this._transport&&this._transport.updateSettings(this._serverSettings)}_onPeerRegistered(e){let t=Q.composeMessageId(e);this._participants[t]&&(this._participants[t].clientType=e.clientType,this._participants[t].platform=e.platform),nt.onPeerRegistered()}_onMicSwitched(e){return R(this,null,(function*(){nt.onDeviceSwitched(V.AUDIO,!e.mute),yield this.toggleLocalAudio(!e.mute)}))}_onChatMessage(e){return R(this,null,(function*(){let t=Q.composeMessageId(e),i=yield this._getExternalIdByParticipantId(t);i?nt.onChatMessage(e.message,i,e.direct):this._warnParticipantNotInConversation(t)}))}_onCustomData(e){return R(this,null,(function*(){if(e.data.hasOwnProperty("sdk"))return;let t=Q.composeMessageId(e),i=yield this._getExternalIdByParticipantId(t);i?nt.onCustomData(e.data,i,e.direct):this._warnParticipantNotInConversation(t)}))}_onRecordInfo(e){return R(this,arguments,(function*(e,t=null){if(!this._conversation)return;let i=this._conversation.recordsInfoByRoom.get(t),r=!1;if(!i!=!e?r=!0:i&&e&&(r=i.recordMovieId!==e.recordMovieId||i.recordStartTime!==e.recordStartTime),r)if(this._conversation.recordsInfoByRoom.set(t,e),e){let i=yield this._getExternalIdByParticipantId(e.initiator);i?nt.onRecordStarted(i,e.recordMovieId,e.recordStartTime,e.recordType,e.recordExternalMovieId,e.recordExternalOwnerId,t):this._warnParticipantNotInConversation(e.initiator)}else nt.onRecordStopped(t);e&&this._forceOpenTransportForAloneInCall()}))}_changePinnedParticipantForRoom(){return R(this,null,(function*(){if(!this._conversation)return;let e=this._conversation.roomId,t=this._conversation.pinnedParticipantIdByRoom.get(e);if(t&&!this._isMe(t)){let i=yield this._getExternalIdByParticipantId(t);i&&nt.onPinnedParticipant(i,!1,null,e)}}))}_changeRecordInfoForRoom(){return R(this,null,(function*(){if(!this._conversation)return;let e=this._conversation.roomId,t=this._conversation.recordsInfoByRoom.get(e);if(t){let i=yield this._getExternalIdByParticipantId(t.initiator);i?nt.onRecordStarted(i,t.recordMovieId,t.recordStartTime,t.recordType,t.recordExternalMovieId,t.recordExternalOwnerId,e):this._warnParticipantNotInConversation(t.initiator)}else nt.onRecordStopped(e)}))}_changeAsrInfoForRoom(){return R(this,null,(function*(){if(!this._conversation)return;let e=this._conversation.roomId,t=this._conversation.asrInfoByRoom.get(e);if(t){let i=yield this._getExternalIdByParticipantId(t.initiatorId);i&&nt.onAsrSet({externalId:i,movieId:t.movieId},e)}else nt.onAsrSet(null,e)}))}_changeUrlSharingInfoForRoom(){return R(this,null,(function*(){if(!this._conversation)return;let{roomId:e}=this._conversation,{urlSharingInfoByRoom:t}=this._conversation,i=t.get(e);if(i){let t=yield this._getExternalIdByParticipantId(i.initiatorId);t&&nt.onRemoteSharedUrl(t,i.sharedUrl,e)}}))}_onParticipantAnimojiChanged(e){return R(this,null,(function*(){if(this._conversation){let t=yield this._getExternalIdByParticipantId(e.participantId);if(!t)return void this._warnParticipantNotInConversation(e.participantId);nt.onParticipantVmojiUpdate(t)}}))}_onAsrStart(e){return R(this,null,(function*(){if(!this._conversation)return;let t=e.asrInfo,i=e.roomId||null;this._conversation.asrInfoByRoom.set(i,t);let r=yield this._getExternalIdByParticipantId(t.initiatorId);r?(nt.onAsrStarted(r,t.movieId,i),this._forceOpenTransportForAloneInCall()):this._warnParticipantNotInConversation(t.initiatorId)}))}_onAsrStop(e){if(!this._conversation)return;let t=e.roomId||null;null===t&&(this._conversation.asrInfo=null),this._conversation.asrInfoByRoom.delete(t),nt.onAsrStopped(t)}_onAsrTranscription(e){return R(this,null,(function*(){if(!this._conversation)return;let t=yield this._getExternalIdByParticipantId(e.participantId);t?nt.onAsrTranscription(t,e.text,e.timestamp,e.duration):this._warnParticipantNotInConversation(e.participantId)}))}_onRolesChanged(e,t){if(this._conversation&&this._isMe(e)&&!er(this._conversation.roles,t))return li.debug(`Local roles changed: ${t}`),this._conversation.roles=t,nt.onLocalRolesChanged(t),this._processMuteState({mediaOptions:sr(this._getMuteStatesForCurrentRoom(),Hi.MUTE_PERMANENT),stateUpdated:!0}),void(Q.includesOneOf(t,[Zi.ADMIN,Zi.CREATOR])?this._refreshRooms(!0):t.length||this._onRoomSwitched(null));let i=this._participants[e];i&&!er(i.roles,t)&&(li.debug(`Roles for participant [${e}] changed: ${t}`),i.roles=t,nt.onRolesChanged(i.externalId,t))}_onMuteParticipant(e,t=!1){return R(this,null,(function*(){var i;if(!this._conversation)return;let{muteAll:r,muteStates:n={},unmuteOptions:a=[],mediaOptions:s=[],roomId:o=null}=e,c=e.adminId?this._participants[e.adminId]:null;if(!e.participantId||this._isMe(e.participantId))null!=(i=e.requestedMedia)&&i.length||(r&&!t?this._setMuteStatesForRoomId(n,o):r||(this._conversation.muteStatesPersonal=n)),e.adminId&&this._isMe(e.adminId)?r&&nt.onMuteStates(n,a,s,r,e.unmute,null,this._conversation.externalId,e.stateUpdated,e.requestedMedia,e.roomId):yield this._processMuteState({mediaOptions:s,muteAll:r,unmute:e.unmute,adminId:e.adminId,stateUpdated:e.stateUpdated,requestedMedia:e.requestedMedia,roomId:e.roomId,unmuteOptions:a,muteStates:n});else{if(!this._isCallAdmin())return void li.warn(`Not admin got mute states for participant [${e.participantId}]`);let t=this._participants[e.participantId];t&&(li.debug(`Mute states for participant [${e.participantId}] changed`,n),nt.onMuteStates(n,a,s,r,e.unmute,t.externalId,null==c?void 0:c.externalId,e.stateUpdated,e.requestedMedia,e.roomId))}}))}_changeMuteStatesForRoom(e,t){if(!this._conversation)return;let i=this._getMuteStatesForRoomId(t),r=this._getMuteStatesForRoomId(e),n=Object.keys(i),a=Object.keys(r);this._processMuteState({mediaOptions:Array.from(new Set([...n,...a])),roomId:e,muteAll:!0,stateUpdated:!0})}_processMuteState(e){return R(this,null,(function*(){var t;if(!this._conversation||!this._mediaSource||this._participantState!==$i.ACCEPTED)return;let{mediaOptions:i=[],muteAll:r,unmute:n,stateUpdated:a,requestedMedia:s,roomId:o=null,unmuteOptions:c=[]}=e,l=e.adminId?this._participants[e.adminId]:null,d=Object.assign({},null!=(t=e.muteStates)?t:this._getMuteStatesForRoomId(o)),u=this._mediaSource.getMediaSettings(),h=Object.entries(d);for(let[e,t]of h){let a=Ve.newMuteRules&&this._isCallAdmin()&&r;if(!(t!==Hi.MUTE&&t!==Hi.MUTE_PERMANENT||a)&&(this._isCallAdmin()&&t===Hi.MUTE_PERMANENT&&!r&&(d[e]=Hi.MUTE),i.includes(e)&&!n))switch(e){case V.VIDEO:u.isVideoEnabled&&(nt.onDeviceSwitched(V.VIDEO,!1),yield this.toggleLocalVideo(!1));break;case V.AUDIO:u.isAudioEnabled&&(nt.onDeviceSwitched(V.AUDIO,!1),yield this.toggleLocalAudio(!1));break;case V.SCREEN_SHARING:u.isScreenSharingEnabled&&(nt.onDeviceSwitched(V.SCREEN_SHARING,!1),yield this.disableScreenCapturing());break;case V.AUDIO_SHARING:u.isAudioSharingEnabled&&(nt.onDeviceSwitched(V.AUDIO_SHARING,!1),yield this.toggleScreenCapturing({captureScreen:u.isScreenSharingEnabled,fastScreenSharing:u.isFastScreenSharingEnabled,captureAudio:!1}))}}nt.onMuteStates(d,c,i,r,n,null,null==l?void 0:l.externalId,a,s,o)}))}_onPinParticipant(e){return R(this,arguments,(function*(e,t=!1,i,r=null){if(!this._conversation)return;let n=this._conversation.pinnedParticipantIdByRoom.get(r);if(n&&n!==e)if(this._isMe(n))nt.onLocalPin(!0,r);else{let t=yield this._getExternalIdByParticipantId(n);t&&nt.onPinnedParticipant(t,!0,this._denormalizeMarkers(e,i),r)}if(this._isMe(e))nt.onLocalPin(t,r);else{let n=yield this._getExternalIdByParticipantId(e);n&&nt.onPinnedParticipant(n,t,this._denormalizeMarkers(e,i),r)}this._conversation.pinnedParticipantIdByRoom.set(r,t?null:e)}))}_onOptionsChanged(e){this._conversation&&!function(e,t){if(e.length!==t.length)return!1;for(let i of e)if(!t.includes(i))return!1;return!0}(this._conversation.options,e)&&(this._conversation.options=e,nt.onOptionsChanged(e))}_onNetworkStatus(e){if(this._conversation){let t=[];for(let[i,r]of Object.entries(e)){let e;if(this._isMe(i)||""===i)e=this._conversation.networkRating;else{if(!this._participants[i])continue;e=this._participants[i].networkRating}if(e!==r)if(this._isMe(i)||""===i)this._conversation.networkRating=r,nt.onLocalNetworkStatusChanged(r);else{let e=this._participants[i];e.networkRating=r,t.push({uid:e.externalId,rating:r})}}if(0===t.length)return;li.log("Received network status update: ",e),nt.onNetworkStatusChanged(t)}}_onRemoteStreamSecond(e,t){let i=this._participants[e];if(i){if(Ve.producerScreenTrack)return void nt.onRemoteScreenStream(i.externalId,t);if(i.secondStream=t,Ve.videoTracksCount>0){let t=e;if(!this._streamIdByStreamDescription.has(t))return void li.error("Received remote stream notification for a participant that has no track associated with it",t);let r=this._streamIdByStreamDescription.get(t);if(!r||this._streamWaitTimerByStreamDescription.has(t))return void li.log("Delaying secondary stream start/stop until main stream becomes available",t);let n=this._streamByStreamId.get(r);if(!n)return w.log(F.PAT_ERROR,"streamNotFound"),void li.error(`Could not find stream by ID: ${r}`);nt.onRemoteStream(i.externalId,i.secondStream||n)}else{let e=t||i.remoteStream;e&&nt.onRemoteStream(i.externalId,e)}}}_onAnimojiStream(e,t){if(this._isMe(e)&&this._mediaSource)return void nt.onVmojiStream(t,this._mediaSource.getMediaSettings());let i=this._participants[e];i&&nt.onRemoteVmojiStream(i.externalId,t)}_onAnimojiError(e){return R(this,null,(function*(){try{let t=yield this._getExternalIdByParticipantId(e.participantId);t&&(delete e.participantId,nt.onVmojiError(I(y({},e),{externalId:t})))}catch(e){li.warn("_onAnimojiError failed",e)}}))}_onPeerConnectionClosed(e){"SERVER"===e&&this._cleanupParticipantAgnosticStreams()}_changeFeatureSet(){if(this._conversation){let e="ACTIVE"===this._state,t=this._conversation.features.includes(Bi.ADD_PARTICIPANT);nt.onCallState(e,t,this._conversation)}}_changeNeedRate(){this._conversation&&this._conversation.needRate&&nt.onRateNeeded()}_onVolumesDetected(e){let t=[];for(let[i,r]of Object.entries(e)){let e=this._participants[i];e&&e.externalId&&t.push({uid:e.externalId,volume:r.real})}nt.onVolumesDetected(t)}_onSpeakerChanged(e){this._activeSpeakerId=e,this._participants[e]&&this._lastSignalledActiveSpeakerId!==e&&(nt.onSpeakerChanged(this._participants[e].externalId),this._lastSignalledActiveSpeakerId=e)}_onTransportStateChanged(e,t){return R(this,null,(function*(){li.debug(`Transport state has changed: ${t}`,e);let i=this._getStatusByTransportState(t);if(!i)return;let r=e.reduce(((e,i)=>{if(i in this._participants){let r=this._participants[i];e.push(r),"CONNECTED"===t&&(r.remoteStream||(r.mediaSettings&&this._changeRemoteMediaSettings(i,r.mediaSettings),this._changeRemoteParticipantState(i,r.participantState)),this._updateDisplayLayoutFromCache(i))}else this._warnParticipantNotInConversation(i);return e}),[]);r.length&&this._setParticipantsStatus(r,i)}))}_onTransportLocalStateChanged(e){return R(this,null,(function*(){var t;if(li.debug(`Local transport state has changed: ${e}`),"CONNECTED"===e&&(nt.onLocalStatus("CONNECTED"),"SERVER"===(null==(t=this._transport)?void 0:t.getTopology()))){let e=Object.values(this._myLastRequestedLayouts);yield this.updateDisplayLayout(e)}"CONNECTING"===e&&nt.onLocalStatus("CONNECTING"),"RECONNECTING"===e&&nt.onLocalStatus("RECONNECT"),"FAILED"===e&&this._transport&&0===this._transport.allocated().length&&(this._signaling.ready&&(yield this._signaling.hangup(b.FAILED)),this._close(new N(b.FAILED),"Transport failed"))}))}_onRemoteTrackAdded(e,t,i){return R(this,null,(function*(){if(e.endsWith(Ji.AUDIO_MIX))li.debug("Remote audio mix track added"),this._audioOutput.add(i),nt.onRemoteMixedAudioStream(t);else if(e.startsWith(Ji.PARTICIPANT_AGNOSTIC_TRACK_PREFIX))li.debug(`Participant-agnostic track added: ${e}`),this._streamByStreamId.set(e,t);else{li.debug(`Remote track added on the participant [${e}]`,{kind:i.kind});let r=this._participants[e];if(!r){let t=this._api.getDecorativeIdByInitialId(e),i=t?Q.composeUserId(t):void 0;li.warn(`Conversation: track added before participant [id: ${e}, decorativeId: ${i}]`),r=this._registerParticipantInCache(yield this._createParticipant({id:e},i)),this._setParticipantsStatus([r],"WAITING"),this._activeSpeakerId===e&&this._lastSignalledActiveSpeakerId!==e&&(nt.onSpeakerChanged(r.externalId),this._lastSignalledActiveSpeakerId=e)}if(this._transport&&!this._transport.isAllocated(r.id)&&this._transport.allocate(r.id,!1),"audio"===i.kind&&(this._audioOutput.add(i),Ve.preserveAudioTracks||(r.remoteAudioTrack=i,t.removeTrack(i))),r.remoteStream!==t&&t.getTracks().length){if(r.remoteStream=t,r.secondStream)return;nt.onRemoteStream(r.externalId,t)}r.mediaSettings&&this._changeRemoteMediaSettings(e,r.mediaSettings)}}))}_onRemoteTrackRemoved(e,t,i){switch(li.debug(`[${e}] remote track (removed)`,{track:i}),i.kind){case"audio":this._removeAudioTrack(e,t,i);break;case"video":case"screen":this._removeVideoTrack(e,t,i)}}_removeAudioTrack(e,t,i){if(e!==Ji.AUDIO_MIX){let i=this._participants[e];if(!i||i.remoteStream&&i.remoteStream!==t)return}this._audioOutput.remove(i)}_removeVideoTrack(e,t,i){}_onTopologyChanged(e){"DIRECT"===e&&(this._onRemoteSignalledStall([]),this._onAudioMixStall(!1)),this._conversation&&(this._conversation.topology=e,this._changeFeatureSet(),this._isRealTimeAsrRequested&&this._forceOpenTransportForAloneInCall())}_onAudioMixStall(e){this._audioMixStalled!==e&&(this._audioMixStalled=e,li.debug("Audio mix stalled:",e),nt.onLocalStatus(e?"RECONNECT":"CONNECTED"))}_onRemoteSignalledStall(e){let t={},i=[],r=[];li.debug("Participants stalled:",e);for(let r of e){if(t[r]=!0,!this._lastStalled[r]){let e=this._participants[r];e&&i.push(e)}delete this._lastStalled[r]}for(let e of Object.keys(this._lastStalled)){let t=this._participants[e];t&&r.push(t)}i.length&&this._setParticipantsStatus(i,"RECONNECT"),r.length&&this._setParticipantsStatus(r,"CONNECTED"),this._lastStalled=t}_onRemoteDataStats(e){this._debugInfo&&this._debugInfo.onRemoteDataStats(e,this._participants),this._fixAudioDevice(e.outbound.rtps),this._fixVideoDevice(e.outbound.rtps)}_fixAudioDevice(e){var t;!jt.hasMicrophone()||!this._audioFix||null==(t=this._mediaSource)||!t.getMediaSettings().isAudioEnabled||this._audioFix.fix(e)}_fixVideoDevice(e){var t;!jt.hasCamera()||!this._audioFix||null==(t=this._mediaSource)||!t.getMediaSettings().isVideoEnabled||this._audioFix.fixVideo(e)}_toggleJoinAvailability(){let e=this._conversation&&this._conversation.chatId,t=e&&"CLOSE"!==this._state||!1;e&&(li.debug("Toggle join availability",{available:t,chatId:e}),nt.onJoinStatus(t,e))}_updateDisplayLayoutFromCache(e){return R(this,null,(function*(){var t;if("SERVER"!==(null==(t=this._transport)?void 0:t.getTopology()))return;let i=this._participants[e];i&&i.lastRequestedLayouts&&Object.keys(i.lastRequestedLayouts).length&&(yield this.updateDisplayLayout(Object.values(i.lastRequestedLayouts)))}))}_setParticipantsStatus(e,t,i=null){if(!e.length)return;let r=e.reduce(((e,i)=>(i.status!==t&&(i.status=t,e.push(i.externalId)),e)),[]);r.length&&nt.onRemoteStatus(r,t,i)}_onJoinLinkChanged(e){nt.onJoinLinkChanged(e.joinLink)}_onRoomsUpdated(e){return R(this,null,(function*(){var t;if(this._isCalledState())return;let i={};for(let r of Object.keys(zi)){let n=e.updates[r];n&&(i[r]={rooms:yield Promise.all((null==(t=null==n?void 0:n.rooms)?void 0:t.map(this._convertRoomToExternal.bind(this)))||[]),roomIds:null==n?void 0:n.roomIds,deactivated:null==n?void 0:n.deactivated})}nt.onRoomsUpdated(i)}))}_onRoomUpdated(e){return R(this,null,(function*(){var t,i;let r=yield this._convertRoomToExternal(e.room||null);e.events.some((e=>e===zi.UPDATE))&&(void 0!==e.muteStates&&this._setMuteStatesForRoomId(e.muteStates,e.roomId),void 0!==e.recordInfo&&(null==(t=this._conversation)||t.recordsInfoByRoom.set(e.roomId,e.recordInfo)),void 0!==e.asrInfo&&(null==(i=this._conversation)||i.asrInfoByRoom.set(e.roomId,e.asrInfo))),this._isCalledState()||nt.onRoomUpdated(e.events,e.roomId,r,e.deactivate||null)}))}_convertRoomToExternal(e){return R(this,null,(function*(){var t,i,r,n,a;if(!e)return null;let s=yield Promise.all((null==(t=e.participantIds)?void 0:t.map((e=>this._getExternalIdByParticipantId(e))))||[]),o=yield Promise.all((null==(i=e.addParticipantIds)?void 0:i.map((e=>this._getExternalIdByParticipantId(e))))||[]),c=yield Promise.all((null==(n=null==(r=e.removeParticipantIds)?void 0:r.map)?void 0:n.call(r,(e=>this._getExternalIdByParticipantId(e))))||[]),l=e.pinnedParticipantId?yield this._getExternalIdByParticipantId(e.pinnedParticipantId):void 0;return{id:e.id,name:e.name,participantCount:e.participantCount,participantIds:s,addParticipantIds:o,removeParticipantIds:c,participants:null!=(a=e.participants)&&a.participants?this._participantListChunkToExternalChunk(e.participants):void 0,active:e.active,muteStates:e.muteStates,pinnedParticipantId:l,countdownSec:e.countdownSec,timeoutMs:e.timeoutMs}}))}_onRoomParticipantsUpdated(e){return R(this,null,(function*(){var t,i,r,n,a,s,o,c;let l=null==(t=this._transport)?void 0:t.getState(),d=null!=(i=e.roomId)?i:null,u=(null==(r=e.addedParticipantIds)?void 0:r.map((e=>Q.decomposeId(e).id)))||[],h=yield this._api.getExternalIdsByOkIds(u),p=e.addedParticipants;if(h.length&&(null==p?void 0:p.length)!==h.length&&!this._isCalledState()){let e=this._convertExternalIdsToServerExternalIds(h);p=(yield this._signaling.getParticipants(e)).participants}let _=yield Promise.all((null==p?void 0:p.map((e=>R(this,null,(function*(){var t;let i=Q.composeId(e);return this._createParticipant({id:i,externalId:tr.fromSignalingParticipant(e),mediaSettings:Fe(e.mediaSettings),participantState:Q.mapParticipantState(e),state:e.state,roles:e.roles||[],status:null!=(t=this._getStatusByTransportState(l))?t:"WAITING",muteStates:e.muteStates||{},unmuteOptions:e.unmuteOptions||[],observedIds:e.observedIds||[],markers:this._denormalizeMarkers(i,e.markers),isInRoom:null!==d},e.decorativeUserId)})))))||[]),m=!1;for(let e of _)e.id===(null==(n=this._conversation)?void 0:n.compositeUserId)&&(m=!0),this._registerParticipantInCache(e);"IDLE"===(null==(a=this._transport)?void 0:a.getState())&&!this._isCalledState()&&this._openTransport(_,!0);let f=[],g=[];if(null!=e&&e.removedParticipantMarkers){for(let t of e.removedParticipantMarkers)if(null!=(s=t.GRID)&&s.id){let e=this._getExternalIdByParticipantId(t.GRID.id);g.push(e)}f=yield Promise.all(g)}if(m&&(yield this._onRoomSwitched(d)),f){let e=null==(o=this._conversation)?void 0:o.pinnedParticipantIdByRoom.get(d);if(e){let t=yield this._getExternalIdByParticipantId(e);if(t)for(let e of f)if(tr.compare(t,e)){null==(c=this._conversation)||c.pinnedParticipantIdByRoom.delete(d);break}}}let S={roomId:d,participantCount:e.participantCount,addedParticipantIds:h,addedParticipants:Q.mapSharedParticipants(_),removedParticipantMarkers:null==e?void 0:e.removedParticipantMarkers,removedParticipantIds:f};this._isCalledState()||nt.onRoomParticipantsUpdated(S)}))}_onRoomSwitched(e,t=!1){return R(this,null,(function*(){if(!this._conversation||this._conversation.roomId===e)return;let i=this._conversation.roomId;this._conversation.roomId=e,!t||this._isCalledState()?(this._isCalledState()||nt.onRoomSwitched(e),null!==e&&!this._isCallAdmin()&&(yield this._refreshRooms(!1)),this._changePinnedParticipantForRoom(),this._changeRecordInfoForRoom(),this._changeMuteStatesForRoom(e,i),yield this._changeAsrInfoForRoom(),yield this._changeUrlSharingInfoForRoom()):nt.onRoomStart(e)}))}_refreshRooms(e){return R(this,null,(function*(){var t,i,r,n,a,s,o,c,l,d,u,h;let p;this._isCalledState()||(p=yield this._signaling.getRooms(e));let _=null!=(i=null==(t=null==p?void 0:p.rooms)?void 0:t.rooms)?i:[],m=[];for(let t of _){let i=null!=(r=t.id)?r:null;if(this._setMuteStatesForRoomId(t.muteStates,i),null==(a=this._conversation)||a.recordsInfoByRoom.set(i,null!=(n=t.recordInfo)?n:null),null==(o=this._conversation)||o.pinnedParticipantIdByRoom.set(i,null!=(s=t.pinnedParticipantId)?s:null),t.asrInfo&&(null==(c=this._conversation)||c.asrInfoByRoom.set(i,t.asrInfo)),t.urlSharingInfo?null==(l=this._conversation)||l.urlSharingInfoByRoom.set(i,t.urlSharingInfo):null==(d=this._conversation)||d.urlSharingInfoByRoom.delete(i),e){yield this._registerParticipants((null==(h=null==(u=null==t?void 0:t.participants)?void 0:u.participants)?void 0:h.filter((e=>!this._participants[Q.composeId(e)])))||[],!0);let e=yield this._convertRoomToExternal(t);e&&m.push(e)}}m.length&&!this._isCalledState()&&nt.onRoomsUpdated({[zi.UPDATE]:{rooms:m}})}))}_onFeedback(e){return R(this,null,(function*(){let t=[];for(let i of e.feedback){let e=I(y({},i),{items:[]});for(let t of i.items){let i=yield this._getExternalIdByParticipantId(t.participantId);i?e.items.push(I(y({},t),{participantId:i})):this._warnParticipantNotInConversation(t.participantId)}t.push(e)}nt.onFeedback(t,e.roomId)}))}_onDecorativeParticipantIdChanged(e){return R(this,null,(function*(){if(!this._conversation||!e.decorativeParticipantId||!e.decorativeExternalParticipantId)return;let{participantId:t,decorativeParticipantId:i,decorativeExternalParticipantId:r}=e,n=this._isMe(t);li.debug(`Decorative participant id changed [${t}]`,e);let a=yield this._getExternalIdByParticipantId(t);if(!a)return void this._warnParticipantNotInConversation(t);let s=tr.fromSignaling(r,a.deviceIdx);nt.onParticipantIdChanged(a,s),this._api.cacheExternalId(i,s),this._api.mapDecorativeId(i,t),n?this._conversation.externalId=s:this._participants[t].externalId=s}))}_onVideoSuspendSuggest(e){!this._conversation||"SERVER"!==this._conversation.topology||(li.debug("Video suspend suggested",e),nt.onVideoSuspendSuggest(e.bandwidth))}_isMe(e){var t;return e===(null==(t=this._conversation)?void 0:t.compositeUserId)}_getMuteStatesForRoomId(e=null){var t,i;return null!=(i=null==(t=this._conversation)?void 0:t.muteStates.get(e))?i:{}}_getMuteStatesForCurrentRoom(){var e;return this._getMuteStatesForRoomId(null==(e=this._conversation)?void 0:e.roomId)}_setMuteStatesForRoomId(e={},t=null){var i;null==(i=this._conversation)||i.muteStates.set(t,e)}_forceOpenTransportForAloneInCall(){var e,t,i;"SERVER"===(null==(e=this._transport)?void 0:e.getTopology())&&"IDLE"===(null==(t=this._transport)?void 0:t.getState())&&!this._isCalledState()&&this._transport.open(this._transport.allocated(),null,!(null==(i=this._conversation)||!i.observer),!0)}},Ur=Lr;Ur._delayedHangup=!1;var xr,Vr=class extends Error{constructor(e,t){super(e),Object.setPrototypeOf(this,Vr.prototype),this.participantErrors=t}},Br=class{createJoinLink(e){return R(this,null,(function*(){return{join_link:"nop"}}))}removeJoinLink(e){return R(this,null,(function*(){return{success:!0}}))}getAnonymTokenByLink(e,t){return R(this,null,(function*(){return""}))}log(e){}logClientStats(e){}logClientEvents(e){}getCachedOkIdByExternalId(e){return null}cacheExternalId(e,t){}mapDecorativeId(e,t){}unmapDecorativeId(e){}getDecorativeIdByInitialId(e){}replaceByInitialIdIdIfExists(e){return"string"==typeof e?parseInt(e,10):e}hangupConversation(e){}sendUserFeedbackStats(e,t,i,r){}removeHistoryRecords(e){return R(this,null,(function*(){}))}getServerTime(){return R(this,null,(function*(){return Date.now()}))}cleanup(){}},Fr=null;function jr(e){return R(this,null,(function*(){var t;if("AUTO"!==(null!=e?e:Ve.apiEnv))return Ve.apiEndpoint(e);try{let e=atob("aHR0cHM6Ly9kbnMuZ29vZ2xlL3Jlc29sdmU/bmFtZT12aWRlby5fZW5kcG9pbnQub2sucnUmdHlwZT1UWFQ="),i=yield(yield fetch(e,{method:"GET",mode:"cors",cache:"no-cache"})).json(),r=null==(t=null==i?void 0:i.Answer[0])?void 0:t.data;if(!r)throw new Error("Wrong DNS response");return li.debug("Resolved API endpoint",r),r}catch(t){return li.warn("Failed to resolve API endpoint using DNS, default is used",t),Ve.apiEndpoint(e)}}))}function Gr(){return R(this,null,(function*(){return xr||Fr||(Fr=jr(),xr=yield Fr,Fr=null,xr)}))}function Hr(e){return R(this,arguments,(function*(e,t={},i=!1){if(!window.Blob||!window.navigator.sendBeacon)return;yield Gr();let r=$r(e,t,i),n=new window.Blob([r],{type:"application/x-www-form-urlencoded"});window.navigator.sendBeacon(`${xr}/fb.do`,n)}))}function Wr(e){return R(this,arguments,(function*(e,t={},i=!1,r){return yield Gr(),function(e,t){return R(this,null,(function*(){return new Promise(((i,r)=>{let n=new XMLHttpRequest;n.open("POST",`${null!=t?t:xr}/fb.do`,!0),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=()=>{if(n.readyState!==XMLHttpRequest.DONE)return;let e;try{e=JSON.parse(n.responseText)}catch(t){e={result:n.responseText}}200!==n.status||e.hasOwnProperty("error_msg")?r(e):i(e)},n.send(e)}))}))}($r(e,t,i),r)}))}function $r(e,t={},i=!1){t.method=e,t.format="JSON",t.application_key||(t.application_key=Ve.apiKey),i||(Ue.sessionKey?t.session_key=Ue.sessionKey:Ue.accessToken&&(t.access_token=Ue.accessToken));for(let[e,i]of Object.entries(t))"object"==typeof i&&(t[e]=JSON.stringify(i));let r="";for(let[e,i]of Object.entries(t))r&&(r+="&"),r+=`${e}=${encodeURIComponent(i)}`;return r}var Kr,zr=class extends Br{constructor(){super(...arguments),this._userId=null,this._externalUidsCache=new Map,this._decorativeIdToInitialId=new Map,this._initialIdToDecorativeId=new Map}_callUnsafe(e){return R(this,arguments,(function*(e,t={},i=!1){let r=n=>R(this,null,(function*(){try{return yield Wr(e,t,i)}catch(t){if(!t.hasOwnProperty("error_msg")&&(n++,li.debug(`${e} network error, attempt ${n}...`),n<10))return yield Q.delay(Math.min(700*n,3e3)),r(n);throw li.warn(e,"error",t),t}}));return r(0)}))}_call(e){return R(this,arguments,(function*(e,t={},i=!1){try{return yield this._callUnsafe(e,t,i)}catch(r){li.warn("Api call error",r);let n=U.API;switch(r.error_code){case 102:case 103:case 104:return yield this.authorize(),this._callUnsafe(e,t,i)}let a={message:r.error_msg,code:r.error_code};switch(r.custom_error&&(a.custom_error=r.custom_error),r.error_code){case 1101:n=b.SERVICE_DISABLED;break;case 300:n=b.NOT_FOUND;break;case 1102:n=b.CALLEE_IS_OFFLINE;break;case 1103:n=b.NOT_FRIENDS;break;case 1104:case 1106:n=b.EXTERNAL_API_ERROR;break;case 1113:n=b.CALLER_IS_REJECTED;break;case 1114:n=b.VCHAT_DETAILED_ERROR}throw new N(n,a)}}))}userId(e){return R(this,null,(function*(){let t=Q.extractOkId(e);if(Ue.isEmpty())return tr.fromId(String(t));this._externalUidsCache.has(t)||(yield this._getExternalIdsByOkIds([t]));let i=this.getDecorativeIdByInitialId(t);return i&&(t=i),tr.fromString(this._externalUidsCache.get(t))}))}authorize(){return R(this,null,(function*(){if(this._ensureUuid(),!Ve.apiKey)throw new N(U.API,{message:"Required argument apiAppKey not passed"});let e={session_data:{version:2,device_id:this._uuid,client_version:Ve.appVersion,client_type:"SDK_JS"}};return Ve.authToken&&(e.session_data.auth_token=Ve.authToken,e.session_data.version=3),this._callUnsafe("auth.anonymLogin",e,!0).then((e=>{e.uid&&(this._userId=Number(e.uid)),Ue.sessionKey=e.session_key,Ue.sessionSecretKey=e.session_secret_key})).catch((e=>{throw 401===e.error_code&&nt.onTokenExpired(),new N(U.AUTH,{message:e.error_msg,code:e.error_code})}))}))}log(e){Hr("log.externalLog",{collector:"ok.mobile.apps.video",data:JSON.stringify({application:`${Ve.appName}:${Ve.sdkVersion}`,platform:Ve.platform,items:e})})}logClientStats(e){let t={app_version:String(Ve.appVersion),sdk_type:"WEB",sdk_version:Ve.sdkVersion,version:1,items:e};Ve.clientStatsPlatform&&(t.platform=Ve.clientStatsPlatform),Hr("vchat.clientStats",{data:JSON.stringify(t)})}logClientEvents(e){let t={app_version:String(Ve.appVersion),sdk_type:"WEB",sdk_version:Ve.sdkVersion,version:1,items:e};Ve.clientStatsPlatform&&(t.platform=Ve.clientStatsPlatform),Hr("vchat.clientEvents",{data:JSON.stringify(t)})}uploadDebugLogs(e,t,i,r){return R(this,null,(function*(){let n={conversationId:e,webrtcPlatform:Ve.platform,startTime:t,endTime:i},a=yield this._callUnsafe("vchat.getLogUploadUrl",n),s=new FormData,o=new Blob([r],{type:"application/json"});s.append("file",o,"log.json");let c=new URL(a.upload_url);return c.searchParams.append("size",o.size.toString()),function(e,t){return R(this,null,(function*(){try{let i=yield fetch(e,{method:"POST",body:t});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);let r=yield i.text();li.debug("Form data sent successfully",r)}catch(e){throw li.warn("Failed to send form data",e),e}}))}(c.toString(),s)}))}joinConversation(e,t=!1,i){return R(this,null,(function*(){let r={conversationId:e,isVideo:t,protocolVersion:Ve.protocolVersion};return i&&(r.chatId=i),this._call("vchat.joinConversation",r)}))}createConversation(e){return R(this,arguments,(function*(e,t="",i=!1,{onlyAdminCanShareMovie:r,audienceMode:n,audioOnly:a}={},s){let o=this._preareStartConversationData({conversationId:e,isVideo:!1,joiningAllowed:!0,payload:t,requireAuthToJoin:i,onlyAdminCanShareMovie:r,audienceMode:n,audioOnly:a,speakerIds:s});return this._startConversation(o)}))}startConversation(e,t,i){return R(this,arguments,(function*(e,t,i,r=!1,n="",a=!1,s=!1,{onlyAdminCanShareMovie:o}={}){let c=this._preareStartConversationData({conversationId:e,isVideo:r,joiningAllowed:a,payload:n,requireAuthToJoin:s,onlyAdminCanShareMovie:o});if(t&&t.length)switch(i){case Li.USER:c.uids=t.join(",");break;case Li.GROUP:c.gid=t[0];break;case Li.CHAT:c.chatId=t[0]}return this._startConversation(c)}))}_ensureUuid(){if(!this._uuid){let e=ut.get("uuid");e||(e=Q.uuid(),ut.set("uuid",e)),this._uuid=String(e)}}_preareStartConversationData({conversationId:e,isVideo:t,payload:i="",joiningAllowed:r=!1,requireAuthToJoin:n=!1,onlyAdminCanShareMovie:a,audienceMode:s=!1,audioOnly:o=!1,speakerIds:c=[]}){let l={conversationId:e,isVideo:t,protocolVersion:Ve.protocolVersion};if(r&&(l.createJoinLink=!0),i&&(l.payload=i),Ve.domain&&(l.domainId=Ve.domain),Ve.externalDomain&&(l.externalDomain=Ve.externalDomain),n&&(l.requireAuthToJoin=!0),void 0!==a&&(l.onlyAdminCanShareMovie=a),s&&(l.audienceMode=s),o&&(l.audioOnly=o),c.length){let e=c.map((e=>Q.composeUserId(e)));l.speakerIds=e.join(",")}return l}_startConversation(e){return R(this,null,(function*(){return this._call("vchat.startConversation",e)}))}createJoinLink(e){return R(this,null,(function*(){return this._call("vchat.createJoinLink",{conversationId:e})}))}removeJoinLink(e){return R(this,null,(function*(){return this._call("vchat.removeJoinLink",{conversationId:e})}))}getAnonymTokenByLink(e,t){return R(this,null,(function*(){let i={joinLink:e};t&&(i.anonymName=t);let r=yield this._call("vchat.getAnonymTokenByLink",i);return this._userId=Number(r.uid),r.token}))}joinConversationByLink(e,t=!1,i,r){return R(this,null,(function*(){let n={joinLink:e,isVideo:t,protocolVersion:Ve.protocolVersion};return null!=i&&i.length&&(n.observedIds=i.join(",")),Ve.anonymToken&&(n.anonymToken=Ve.anonymToken),r&&(n.payload=r),this._call("vchat.joinConversationByLink",n)}))}getOkIdsByExternalIds(e){return R(this,null,(function*(){let t=[],i=[],r=new Map,n=Array.from(this._externalUidsCache.keys()),a=Array.from(this._externalUidsCache.values());for(let s of e){let e=tr.toString(s),o=a.indexOf(e);o>-1?t.push(this.replaceByInitialIdIdIfExists(n[o])):(r.set(s.id,e),i.push({id:s.id,ok_anonym:"ANONYM"===s.type}))}return i.length&&(yield this._call("vchat.getOkIdsByExternalIds",{externalIds:i})).ids.forEach(((e,i)=>{let n=Number(e.ok_user_id),a=String(e.external_user_id.id);r.has(a)&&(this.cacheExternalId(n,tr.fromString(r.get(a))),t.push(n))})),t}))}getParticipantIdsByExternalIds(e){return R(this,null,(function*(){yield this.getOkIdsByExternalIds(e);let t=new Map,i=Array.from(this._externalUidsCache.keys()),r=Array.from(this._externalUidsCache.values());for(let n of e){let e=tr.toString(n),a=r.indexOf(e);if(a>-1){let e=Q.composeParticipantId(this.replaceByInitialIdIdIfExists(i[a]),K.USER,n.deviceIdx);t.set(n,e)}}return t}))}getExternalIdsByOkIds(e){return R(this,null,(function*(){let t=[],i=[];for(let r of e)if(this._externalUidsCache.has(r)){let e=this.getDecorativeIdByInitialId(r),i=this._externalUidsCache.get(null!=e?e:r);t.push(tr.fromString(i))}else i.push(r);if(!i.length)return t;let r=yield this._getExternalIdsByOkIds(i);return Array.from(r.values())}))}getCachedOkIdByExternalId(e){let t=Array.from(this._externalUidsCache.keys()),i=Array.from(this._externalUidsCache.values()),r=tr.toString(e),n=i.indexOf(r);return n>-1?Q.composeParticipantId(this.replaceByInitialIdIdIfExists(t[n]),K.USER,e.deviceIdx):n>-1?Q.composeParticipantId(t[n],K.USER,e.deviceIdx):null}cacheExternalId(e,t){let i=Q.extractOkId(e);this._externalUidsCache.set(i,tr.toString(t))}mapDecorativeId(e,t){let i=Q.extractOkId(e),r=Q.extractOkId(t);this._decorativeIdToInitialId.set(i,r),this._initialIdToDecorativeId.set(r,i)}unmapDecorativeId(e){let t=Q.extractOkId(e),i=this.getDecorativeIdByInitialId(t);i&&this._decorativeIdToInitialId.delete(i),this._initialIdToDecorativeId.delete(t)}getDecorativeIdByInitialId(e){let t=Q.extractOkId(e);return this._initialIdToDecorativeId.get(t)}replaceByInitialIdIdIfExists(e){var t;let i=Q.extractOkId(e);return null!=(t=this._decorativeIdToInitialId.get(i))?t:i}getConversationParams(e){return R(this,null,(function*(){let t={};return Ve.anonymToken&&(t.anonymToken=Ve.anonymToken),e&&(t.conversationId=e),this._call("vchat.getConversationParams",t)}))}getUserId(){return this._userId}setUserId(e){this._userId=e}hangupConversation(e){let t={conversationId:e,reason:b.HUNGUP};Ve.anonymToken&&(t.anonymToken=Ve.anonymToken),Hr("vchat.hangupConversation",t)}sendUserFeedbackStats(e,t,i,r){Hr("log.externalLog",{collector:"app.vchat.events.product",data:JSON.stringify({application:`${Ve.appName}:${Ve.sdkVersion}`,platform:Ve.platform,items:[{type:1,operation:F.USER_FEEDBACK_RECEIVED,timestamp:Date.now(),custom:{vcid:e,user_response:t,reason:i,group_call_users_count:r}}]})})}removeHistoryRecords(e){return R(this,null,(function*(){yield this._call("vchat.removeHistoryRecords",{recordIds:e.join(",")})}))}cleanup(){this._decorativeIdToInitialId=new Map,this._initialIdToDecorativeId=new Map}_getExternalIdsByOkIds(e){return R(this,null,(function*(){let t=new Map;e=e.map((e=>{var t;return null!=(t=this.getDecorativeIdByInitialId(e))?t:e}));try{let i=yield this._call("vchat.getExternalIdsByOkIds",{uids:e.join(",")}),r=(e,i)=>{for(let[r,n]of Object.entries(e)){let e=Number(r),a=tr.fromId(n,i);t.set(e,a),this.cacheExternalId(e,a)}};i.external_ids&&r(i.external_ids,"USER"),i.anonym_ids&&r(i.anonym_ids,"ANONYM");for(let i of e){let e=Number(i);if(!t.has(e)){let i=tr.fromId(String(e));t.set(e,i),this.cacheExternalId(e,i)}}return t}catch(e){return t}}))}getServerTime(){return R(this,null,(function*(){return(yield this._call("system.getInfo")).serverTime}))}},qr=(e=>(e.KING="KING",e.PAWN="PAWN",e))(qr||{}),Jr=qr,Yr=class{constructor(e){this._queue=new Array(e).fill(null),this._readCursor=this._writeCursor=this._left=0,this._moveReadCursor=!1}get length(){return this._queue.length}get left(){return this._left}toArray(){return Array.from(this._queue)}add(e){this._moveReadCursor&&(this._readCursor=this.nextCursor(this._readCursor)),null===this._queue[this._writeCursor]&&(this._left+=1),this._queue[this._writeCursor]=e,this._writeCursor=this.nextCursor(this._writeCursor),this._moveReadCursor=this._writeCursor===this._readCursor}nextCursor(e){return(e+1)%this._queue.length}next(){let e=this._queue[this._readCursor];return e&&(this._moveReadCursor=!1,this._queue[this._readCursor]=null,this._readCursor=this.nextCursor(this._readCursor),this._left-=1),e}},Qr=class{constructor(e,t,i){this._uuid=Q.uuid(),this._apiKey=t,this._callToken=i,this._apiEnv=e}authorize(){return R(this,null,(function*(){let e={session_data:{device_id:this._uuid,client_version:Ve.appVersion,client_type:"SDK_JS",auth_token:this._callToken,version:3},application_key:this._apiKey},t=yield jr(this._apiEnv),i=yield Wr("auth.anonymLogin",e,!0,t);return!(!Q.isObject(i)||"error_msg"in i)&&(this._sessionKey=i.session_key,!0)}))}hangupConversation(e){return R(this,null,(function*(){let t={conversationId:e,reason:b.HUNGUP,application_key:this._apiKey,session_key:this._sessionKey},i=yield jr(this._apiEnv);yield Wr("vchat.hangupConversation",t,!0,i)}))}},Xr=null,Zr={getCameras:jt.getCameras,getMicrophones:jt.getMicrophones,getOutput:jt.getOutput,getVideoFacingMode:jt.getVideoFacingMode,hasCamera:jt.hasCamera,hasMicrophone:jt.hasMicrophone,getSavedCamera:jt.getSavedCamera,getSavedMicrophone:jt.getSavedMicrophone,getSavedOutput:jt.getSavedOutput,hasCameraPermission:jt.hasCameraPermission,hasMicrophonePermission:jt.hasMicrophonePermission,hasPermissions:jt.hasPermissions,getUserMedia:jt.getUserMedia,getUserVideo:jt.getUserVideo,getUserAudio:jt.getUserAudio,setResolution:jt.setResolution,isBrowserSupported:jt.isBrowserSupported,isScreenCapturingSupported:jt.isScreenCapturingSupported,os:jt.os,isMobile:jt.isMobile,browserName:jt.browserName,browserVersion:jt.browserVersion,baseChromeVersion:jt.baseChromeVersion,getAudioContext:jt.getAudioContext,isAudioShareSupported:jt.isAudioShareSupported},en={participantMarkerCompare:Q.participantMarkerCompare};function tn(e){Xr=e}function rn(e){Ve.videoEffects=e}function nn(e){Ve.audioEffects=e}function an(e,t=null,i={},r=1){Ve.vmoji=e,Ve.vmojiOptions={protocolVersion:r,renderingOptions:i},t&&e.setSDK(t)}function sn(e){return R(this,null,(function*(){if(Ve.set(e),Kr||(Kr=new zr),l.default.disableLog(!Ve.debug),li.toggle(Ve.debug),li.log(`Calls SDK ${Ve.sdkVersion}`,e),yield jt.init(),!jt.isBrowserSupported())throw new N(U.UNSUPPORTED);li.log("UserAgent:",navigator.userAgent),li.log("Screen resolution:",`${window.screen.width}x${window.screen.height}`),li.log("Permissions:",`Camera: ${jt.hasCameraPermission()}, Mic: ${jt.hasMicrophonePermission()}`)}))}function on(e){return R(this,arguments,(function*(e,t=[V.AUDIO],i="",r=!1,n=!1,a){let s=[],o=[];if(Array.isArray(e)?s=e.length?e:[]:e&&(s=[e]),s.length&&(o=yield Kr.getOkIdsByExternalIds(s),!o.length))throw new N(b.CALLEE_IS_OFFLINE);return cn(o,Li.USER,t,i,r,n,a)}))}function cn(e){return R(this,arguments,(function*(e,t=Li.USER,i,r="",n=!1,a=!1,s){if(Ur.current())throw li.error("There is already active call"),new N(b.FAILED);return new Ur(Kr,Xr).onStart(e,t,i,r,n,a,s)}))}function ln(e){return R(this,null,(function*(){return dn(e)}))}function dn(e){return R(this,arguments,(function*(e,t=K.USER,i){if(e===Ur.id())throw new Error("Push has already been processed");return new Ur(Kr,Xr).onPush(e,t,i)}))}function un(e){return R(this,null,(function*(){return e&&(Ve.authToken=e),Kr.authorize()}))}function hn(){return R(this,arguments,(function*(e=[V.AUDIO]){return Ma().accept(e)}))}function pn(){return R(this,null,(function*(){let e=Ur.current();if(e)return e.decline()}))}function _n(e){return R(this,arguments,(function*(e,t=[V.AUDIO]){return mn(e,t)}))}function mn(e,t,i){return R(this,null,(function*(){if(Ur.current())throw li.error("There is already active call"),new N(b.FAILED);return new Ur(Kr,Xr).onJoin({conversationId:e,mediaOptions:t,chatId:i})}))}function fn(e){return R(this,arguments,(function*(e,t=[V.AUDIO],i,r,n){if(Ur.current())throw li.error("There is already active call"),new N(b.FAILED);return i&&(Ve.anonymToken=i),new Ur(Kr,Xr).onJoin({joinLink:e,mediaOptions:t,observedIds:r,payload:n})}))}function gn(){return R(this,null,(function*(){let e=Ur.current();if(e)return e.hangup();Ur.hangupAfterInit()}))}function Sn(e,t){return R(this,null,(function*(){let i=yield Kr.getOkIdsByExternalIds([e]);if(!i.length)throw new Error("User not found");return vn(i[0],t)}))}function vn(e,t){return R(this,null,(function*(){let i=Ur.current();i&&(yield i.addParticipant(Q.composeUserId(e),t))}))}function En(e,t=!1){return R(this,null,(function*(){return Tn((yield Kr.getOkIdsByExternalIds([e]))[0],t)}))}function Tn(e,t=!1){return R(this,null,(function*(){let i=Ur.current();if(i)try{yield i.removeParticipant(Q.composeUserId(e),t)}catch(t){li.warn(`Failed to remove participant ${e}. Perhaps he is no longer on the call. ${t}`)}}))}function Cn(e,t){return R(this,null,(function*(){let i=Ur.current();if("videoinput"===e&&Nt.contains(t))return Ve.videoFacingMode=t,i?(jt.isMobile()&&i.stopVideoTrack(),i.changeDevice(e)):void 0;if(!(yield jt._saveDeviceId(e,t)))throw new Error(`Device not found: ${t}`);return i?i.changeDevice(e):void 0}))}function yn(e){return R(this,null,(function*(){let t="object"==typeof e?I(y({},e),{fastScreenSharing:e.captureScreen&&e.fastScreenSharing,captureAudio:e.captureScreen&&e.captureAudio&&Ve.audioShare}):{captureScreen:e,fastScreenSharing:!1,captureAudio:!1},i=Ur.current();return i?i.toggleScreenCapturing(t):Promise.reject()}))}function In(e){let t=Ur.current();t&&t.toggleAnimojiCapturing(e)}function Rn(e,t=!1){return R(this,null,(function*(){let i=Ur.current();i&&(yield i.setVideoStream(e,t))}))}function An(e){return R(this,null,(function*(){let t=Ur.current();t&&(yield t.toggleLocalVideo(e))}))}function Pn(e){return R(this,null,(function*(){let t=Ur.current();t&&(yield t.toggleLocalAudio(e))}))}function Dn(e){return R(this,null,(function*(){let t=Ur.current();if(t)return t.setLocalResolution(e)}))}function On(e){return R(this,null,(function*(){let t=Ur.current();t&&(yield t.changePriorities(e))}))}function bn(e,t){return R(this,null,(function*(){let i=Ur.current();if(i){let r;if(t){let[e]=yield Kr.getOkIdsByExternalIds([t]);r=Q.composeParticipantId(e,K.USER,t.deviceIdx)}yield i.changeParticipantState(e,r)}}))}function Nn(){return R(this,null,(function*(){let e=Ur.current();e&&(yield e.putHandsDown())}))}function wn(e){return R(this,null,(function*(){let t=Ur.current();t&&(yield t.updateDisplayLayout(e))}))}function Mn(e,t,i=!1){return R(this,null,(function*(){return kn((yield Kr.getOkIdsByExternalIds([e]))[0],tr.getDeviceIdx(e),t,i)}))}function kn(e,t,i,r=!1){return R(this,null,(function*(){let n=Ur.current();n&&(yield n.grantRoles(Q.composeParticipantId(e,K.USER,t),i,r))}))}function Ln(e){return R(this,arguments,(function*({externalId:e=null,muteStates:t,requestedMedia:i=[],roomId:r=null}){let n=null;return e&&(n=(yield Kr.getOkIdsByExternalIds([e]))[0]),Un({uid:n,muteStates:t,requestedMedia:i,deviceIdx:tr.getDeviceIdx(e),roomId:r})}))}function Un(e){return R(this,arguments,(function*({uid:e=null,muteStates:t,requestedMedia:i=[],deviceIdx:r=0,roomId:n=null}){let a=Ur.current();if(a){let s=e?Q.composeParticipantId(e,K.USER,r):null;yield a.muteParticipant(s,t,i,n)}}))}function xn(e,t=!1,i=null){return R(this,null,(function*(){return Vn((yield Kr.getOkIdsByExternalIds([e]))[0],t,tr.getDeviceIdx(e),i)}))}function Vn(e,t=!1,i=0,r=null){return R(this,null,(function*(){let n=Ur.current();n&&(yield n.pinParticipant(Q.composeParticipantId(e,K.USER,i),t,r))}))}function Bn(e){return R(this,null,(function*(){let t=Ur.current();t&&(yield t.updateMediaModifiers(e))}))}function Fn(e){return R(this,null,(function*(){let t=Ur.current();t&&(yield t.enableVideoSuspend(e))}))}function jn(e){return R(this,null,(function*(){let t=Ur.current();t&&(yield t.enableVideoSuspendSuggest(e))}))}function Gn(e){return R(this,null,(function*(){let t=Ur.current();t&&(yield t.changeOptions(e))}))}function Hn(e,t=null){return R(this,null,(function*(){let i=null;return t&&(i=(yield Kr.getOkIdsByExternalIds([t]))[0]),Wn(e,i)}))}function Wn(e,t=null){return R(this,null,(function*(){let i=Ur.current();if(i){let r=t?Q.composeUserId(t):null;yield i.chatMessage(e,r)}}))}function $n(e=10){return R(this,null,(function*(){let t=Ur.current();if(t)return t.chatHistory(e)}))}function Kn(e,t=null){return R(this,null,(function*(){let i=null;return t&&(i=(yield Kr.getOkIdsByExternalIds([t]))[0]),zn(e,i,tr.getDeviceIdx(t))}))}function zn(e,t=null,i=0){return R(this,null,(function*(){let r=Ur.current();if(r){let n=t?Q.composeParticipantId(t,K.USER,i):null;yield r.customData(e,n)}}))}function qn(){return R(this,arguments,(function*(e="",t=!1,{onlyAdminCanShareMovie:i=!1}={}){return(yield Kr.createConversation(Q.uuid(),e,t,{onlyAdminCanShareMovie:i})).join_link}))}function Jn(){return R(this,arguments,(function*(e="",t=!1,{onlyAdminCanShareMovie:i=!1,audioOnly:r=!1}={},n){let a=tr.fromIds(n),s=yield Kr.getOkIdsByExternalIds(a);return(yield Kr.createConversation(Q.uuid(),e,t,{onlyAdminCanShareMovie:i,audienceMode:!0,audioOnly:r},s)).join_link}))}function Yn(){return R(this,null,(function*(){let e=Ur.current();return e?e.createJoinLink():Promise.reject()}))}function Qn(){return R(this,null,(function*(){let e=Ur.current();return e?e.removeJoinLink():Promise.reject()}))}function Xn(e,t){return R(this,null,(function*(){return Kr.getAnonymTokenByLink(e,t)}))}function Zn(e){let t=Ur.current();t&&t.setVolume(e)}function ea(e){Ve.forceRelayPolicy=e}function ta(e=!1,t=null,i=null,r="DIRECT_LINK",n=null,a=null){return R(this,null,(function*(){let s=Ur.current();return s?s.startStream(e,t,i,r,n,a):Promise.reject()}))}function ia(e=null){return R(this,null,(function*(){let t=Ur.current();return t?t.stopStream(e):Promise.reject()}))}function ra(e=null){return R(this,null,(function*(){let t=Ur.current();return t?t.publishStream(e):Promise.reject()}))}function na(e,t,i=!1,r=null){return R(this,null,(function*(){let n=Ur.current();if(!n)return Promise.reject();let a,s,o=[];if(null!=t&&t.length&&o.push(...t),e&&o.push(e),o.length){let t=yield Kr.getParticipantIdsByExternalIds(o);e&&(a=t.get(e),t.delete(e)),s=Array.from(t.values())}return n.recordSetConf(a,s,i,r)}))}function aa(){return R(this,null,(function*(){let e=Ur.current();return e?e.getStreamInfo():Promise.reject()}))}function sa(e){return R(this,null,(function*(){let t=Ur.current();return t?t.addMovie(e):Promise.reject()}))}function oa(e){return R(this,null,(function*(){let t=Ur.current();return t?t.updateMovie(e):Promise.reject()}))}function ca(e){return R(this,null,(function*(){let t=Ur.current();return t?t.removeMovie(e):Promise.reject()}))}function la(e,t){return R(this,null,(function*(){let i=Ur.current();if(i){let r=[];for(let t of e){let e,i;t.addParticipantIds&&(e=(yield Kr.getOkIdsByExternalIds(t.addParticipantIds)).map((e=>Q.composeUserId(e)))),t.removeParticipantIds&&(i=(yield Kr.getOkIdsByExternalIds(t.removeParticipantIds)).map((e=>Q.composeUserId(e)))),r.push({id:t.id,name:t.name,participantCount:t.participantCount,addParticipantIds:e,removeParticipantIds:i,countdownSec:t.countdownSec})}return i.updateRooms(r,t)}return Promise.reject()}))}function da(e,t){return R(this,null,(function*(){let i=Ur.current();return i?i.activateRooms(e,t):Promise.reject()}))}function ua(e=null,t=null){return R(this,null,(function*(){let i,r=Ur.current();if(!r)return Promise.reject();if(t){let e=yield Kr.getOkIdsByExternalIds([t]),r=tr.getDeviceIdx(t);i=Q.composeParticipantId(e[0],K.USER,r)}return r.switchRoom(e,i)}))}function ha(e){return R(this,null,(function*(){let t=Ur.current();return t?t.removeRooms(e):Promise.reject()}))}function pa(e){Ve.statisticsInterval=e;let t=Ur.current();if(t)return t.updateStatisticsInterval()}function _a(e){l.default.disableLog(!e),li.toggle(e)}function ma(e,...t){Ve.debugLog&&li.send(e,"[external]",...t)}function fa(){return R(this,null,(function*(){let e=Ht.conversationId;if(!e)throw li.error("[uploadDebugLogs]","No conversation id found"),new Error("No conversation id found");let t=Ht.collectLogs();if(0===t.length)throw li.error("[uploadDebugLogs]","No logs found"),new Error("No logs found");let i=Ht.startTime,r=Ht.endTime;try{return null==Kr?void 0:Kr.uploadDebugLogs(e,i,r,JSON.stringify(t))}catch(e){throw li.error("[uploadDebugLogs]","Error while uploading logs",e),new Error("Error while uploading logs",{cause:e})}}))}function ga(e){return R(this,null,(function*(){let t=Ur.current();if(t)return t.videoEffect(e)}))}function Sa(e,t){return R(this,null,(function*(){let i=Ur.current();if(i)return i.audioEffect(e.length>0?e:null,t)}))}function va(e){return R(this,null,(function*(){let t=Ur.current();t&&(yield t.setAudioStream(e))}))}function Ea(e,t=null,i=null){return R(this,null,(function*(){let r=Ur.current();if(!r)return;let n=null!=i?i:null==t?void 0:t.id,a=null;if(t){let e=(yield Kr.getOkIdsByExternalIds([t]))[0];if(!e)throw new Error("Could not get user id to set animoji svg");a=Q.composeParticipantId(e,K.USER,tr.getDeviceIdx(t))}r.setAnimojiSvg(e,a,n)}))}function Ta(e){let t=Ur.current();t&&t.setAnimojiFill(e)}function Ca(e=null,t,i=!1){return R(this,null,(function*(){return Ma().getWaitingHall(e,t,i)}))}function ya(){return R(this,null,(function*(){return Ma().getAudienceModeHands()}))}function Ia(e,t=!1){return R(this,null,(function*(){let i,r=Ma();if(e){let[t]=yield Kr.getOkIdsByExternalIds([e]);i=Q.composeUserId(t)}return r.promoteParticipant(i,t)}))}function Ra(e=!1){return R(this,null,(function*(){return Ma().requestPromotion(e)}))}function Aa(e=!1){return R(this,null,(function*(){return Ma().acceptPromotion(e)}))}function Pa(e){return R(this,null,(function*(){return Ma().getParticipantListChunk(e)}))}function Da(e){return R(this,null,(function*(){return Ma().getParticipants(e)}))}function Oa(e){return R(this,null,(function*(){return Ma().feedback(e)}))}function ba(e,t,i){return Ma().userFeedbackStats(e,t,i)}function Na(e,t={},i=!1){let r=Ur.current();r&&r.sendClientEvent(e,t,i)}function wa(e,t){return R(this,null,(function*(){return Ma().enableFeatureForRoles(e,t)}))}function Ma(){let e=Ur.current();if(!e)throw new Error("Conversation not found");return e}function ka(e){return R(this,null,(function*(){yield Kr.removeHistoryRecords(e)}))}function La(e){return R(this,null,(function*(){let t=Ur.current();t&&(yield t.startAsr(e))}))}function Ua(e){return R(this,null,(function*(){let t=Ur.current();t&&(yield t.stopAsr(e))}))}function xa(e){return R(this,null,(function*(){let t=Ur.current();t&&(yield t.requestAsr(e))}))}function Va(e){return R(this,null,(function*(){let t=Ur.current();return t?t.startUrlSharing(e):Promise.reject()}))}function Ba(){return R(this,null,(function*(){let e=Ur.current();return e?e.stopUrlSharing():Promise.reject()}))}function Fa(){return Ve.sdkVersion}},857468:e=>{var t=function(){"undefined"!=typeof document&&document.currentScript&&document.currentScript.src;return function(e){var t,i,r=void 0!==(e=e||{})?e:{};r.ready=new Promise((function(e,r){t=e,i=r}));var n,a={};for(n in r)r.hasOwnProperty(n)&&(a[n]=r[n]);var s,o=[],c=!0,l=!1,d="";(c||l)&&(l?d=self.location.href:"undefined"!=typeof document&&document.currentScript&&(d=document.currentScript.src),d=0!==d.indexOf("blob:")?d.substr(0,d.lastIndexOf("/")+1):"",function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(null),t.responseText},l&&(s=function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.responseType="arraybuffer",t.send(null),new Uint8Array(t.response)}),function(e,t,i){var r=new XMLHttpRequest;r.open("GET",e,!0),r.responseType="arraybuffer",r.onload=function(){200==r.status||0==r.status&&r.response?t(r.response):i()},r.onerror=i,r.send(null)});var u=r.print||console.log.bind(console),h=r.printErr||console.warn.bind(console);for(n in a)a.hasOwnProperty(n)&&(r[n]=a[n]);a=null,r.arguments&&(o=r.arguments),r.thisProgram&&r.thisProgram,r.quit&&r.quit;var p,_=0;r.wasmBinary&&(p=r.wasmBinary);var m;r.noExitRuntime;"object"!=typeof WebAssembly&&W("no native wasm support detected");var f=!1;var g="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function S(e,t,i){for(var r=t+i,n=t;e[n]&&!(n>=r);)++n;if(n-t>16&&e.subarray&&g)return g.decode(e.subarray(t,n));for(var a="";t<n;){var s=e[t++];if(128&s){var o=63&e[t++];if(192!=(224&s)){var c=63&e[t++];if((s=224==(240&s)?(15&s)<<12|o<<6|c:(7&s)<<18|o<<12|c<<6|63&e[t++])<65536)a+=String.fromCharCode(s);else{var l=s-65536;a+=String.fromCharCode(55296|l>>10,56320|1023&l)}}else a+=String.fromCharCode((31&s)<<6|o)}else a+=String.fromCharCode(s)}return a}function v(e,t){return e?S(C,e,t):""}var E,T,C,y,I,R,A,P,D,O="undefined"!=typeof TextDecoder?new TextDecoder("utf-16le"):void 0;function b(e,t){for(var i=e,r=i>>1,n=r+t/2;!(r>=n)&&I[r];)++r;if((i=r<<1)-e>32&&O)return O.decode(C.subarray(e,i));for(var a="",s=0;!(s>=t/2);++s){var o=y[e+2*s>>1];if(0==o)break;a+=String.fromCharCode(o)}return a}function N(e,t,i){if(void 0===i&&(i=2147483647),i<2)return 0;for(var r=t,n=(i-=2)<2*e.length?i/2:e.length,a=0;a<n;++a){var s=e.charCodeAt(a);y[t>>1]=s,t+=2}return y[t>>1]=0,t-r}function w(e){return 2*e.length}function M(e,t){for(var i=0,r="";!(i>=t/4);){var n=R[e+4*i>>2];if(0==n)break;if(++i,n>=65536){var a=n-65536;r+=String.fromCharCode(55296|a>>10,56320|1023&a)}else r+=String.fromCharCode(n)}return r}function k(e,t,i){if(void 0===i&&(i=2147483647),i<4)return 0;for(var r=t,n=r+i-4,a=0;a<e.length;++a){var s=e.charCodeAt(a);if(s>=55296&&s<=57343)s=65536+((1023&s)<<10)|1023&e.charCodeAt(++a);if(R[t>>2]=s,(t+=4)+4>n)break}return R[t>>2]=0,t-r}function L(e){for(var t=0,i=0;i<e.length;++i){var r=e.charCodeAt(i);r>=55296&&r<=57343&&++i,t+=4}return t}function U(e){E=e,r.HEAP8=T=new Int8Array(e),r.HEAP16=y=new Int16Array(e),r.HEAP32=R=new Int32Array(e),r.HEAPU8=C=new Uint8Array(e),r.HEAPU16=I=new Uint16Array(e),r.HEAPU32=A=new Uint32Array(e),r.HEAPF32=P=new Float32Array(e),r.HEAPF64=D=new Float64Array(e)}r.INITIAL_MEMORY;var x,V=[],B=[],F=[];var j=0,G=null,H=null;function W(e){r.onAbort&&r.onAbort(e),h(e+=""),f=!0,1,e="abort("+e+"). Build with -s ASSERTIONS=1 for more info.";var t=new WebAssembly.RuntimeError(e);throw i(t),t}r.preloadedImages={},r.preloadedAudios={};var $,K,z="data:application/octet-stream;base64,";function q(e){return e.startsWith(z)}function J(e){try{if(e==$&&p)return new Uint8Array(p);if(s)return s(e);throw"both async and sync fetching of the wasm failed"}catch(e){W(e)}}function Y(e){for(;e.length>0;){var t=e.shift();if("function"!=typeof t){var i=t.func;"number"==typeof i?void 0===t.arg?x.get(i)():x.get(i)(t.arg):i(void 0===t.arg?null:t.arg)}else t(r)}}function Q(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+e)}}q($="libvpx.wasm")||(K=$,$=r.locateFile?r.locateFile(K,d):d+K);var X=void 0;function Z(e){for(var t="",i=e;C[i];)t+=X[C[i++]];return t}var ee={},te={},ie={},re=48,ne=57;function ae(e){if(void 0===e)return"_unknown";var t=(e=e.replace(/[^a-zA-Z0-9_]/g,"$")).charCodeAt(0);return t>=re&&t<=ne?"_"+e:e}function se(e,t){return e=ae(e),function(){return t.apply(this,arguments)}}function oe(e,t){var i=se(t,(function(e){this.name=t,this.message=e;var i=new Error(e).stack;void 0!==i&&(this.stack=this.toString()+"\n"+i.replace(/^Error(:[^\n]*)?\n/,""))}));return i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.prototype.toString=function(){return void 0===this.message?this.name:this.name+": "+this.message},i}var ce=void 0;function le(e){throw new ce(e)}var de=void 0;function ue(e){throw new de(e)}function he(e,t,i){function r(t){var r=i(t);r.length!==e.length&&ue("Mismatched type converter count");for(var n=0;n<e.length;++n)pe(e[n],r[n])}e.forEach((function(e){ie[e]=t}));var n=new Array(t.length),a=[],s=0;t.forEach((function(e,t){te.hasOwnProperty(e)?n[t]=te[e]:(a.push(e),ee.hasOwnProperty(e)||(ee[e]=[]),ee[e].push((function(){n[t]=te[e],++s===a.length&&r(n)})))})),0===a.length&&r(n)}function pe(e,t,i){if(i=i||{},!("argPackAdvance"in t))throw new TypeError("registerType registeredInstance requires argPackAdvance");var r=t.name;if(e||le('type "'+r+'" must have a positive integer typeid pointer'),te.hasOwnProperty(e)){if(i.ignoreDuplicateRegistrations)return;le("Cannot register type '"+r+"' twice")}if(te[e]=t,delete ie[e],ee.hasOwnProperty(e)){var n=ee[e];delete ee[e],n.forEach((function(e){e()}))}}function _e(e){if(!(this instanceof Pe))return!1;if(!(e instanceof Pe))return!1;for(var t=this.$$.ptrType.registeredClass,i=this.$$.ptr,r=e.$$.ptrType.registeredClass,n=e.$$.ptr;t.baseClass;)i=t.upcast(i),t=t.baseClass;for(;r.baseClass;)n=r.upcast(n),r=r.baseClass;return t===r&&i===n}function me(e){le(e.$$.ptrType.registeredClass.name+" instance already deleted")}var fe=!1;function ge(e){}function Se(e){e.count.value-=1,0===e.count.value&&function(e){e.smartPtr?e.smartPtrType.rawDestructor(e.smartPtr):e.ptrType.registeredClass.rawDestructor(e.ptr)}(e)}function ve(e){return"undefined"==typeof FinalizationGroup?(ve=function(e){return e},e):(fe=new FinalizationGroup((function(e){for(var t=e.next();!t.done;t=e.next()){var i=t.value;i.ptr?Se(i):console.warn("object already deleted: "+i.ptr)}})),ve=function(e){return fe.register(e,e.$$,e.$$),e},ge=function(e){fe.unregister(e.$$)},ve(e))}function Ee(){if(this.$$.ptr||me(this),this.$$.preservePointerOnDelete)return this.$$.count.value+=1,this;var e,t=ve(Object.create(Object.getPrototypeOf(this),{$$:{value:(e=this.$$,{count:e.count,deleteScheduled:e.deleteScheduled,preservePointerOnDelete:e.preservePointerOnDelete,ptr:e.ptr,ptrType:e.ptrType,smartPtr:e.smartPtr,smartPtrType:e.smartPtrType})}}));return t.$$.count.value+=1,t.$$.deleteScheduled=!1,t}function Te(){this.$$.ptr||me(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&le("Object already scheduled for deletion"),ge(this),Se(this.$$),this.$$.preservePointerOnDelete||(this.$$.smartPtr=void 0,this.$$.ptr=void 0)}function Ce(){return!this.$$.ptr}var ye=void 0,Ie=[];function Re(){for(;Ie.length;){var e=Ie.pop();e.$$.deleteScheduled=!1,e.delete()}}function Ae(){return this.$$.ptr||me(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&le("Object already scheduled for deletion"),Ie.push(this),1===Ie.length&&ye&&ye(Re),this.$$.deleteScheduled=!0,this}function Pe(){}var De={};function Oe(e,t,i){if(void 0===e[t].overloadTable){var r=e[t];e[t]=function(){return e[t].overloadTable.hasOwnProperty(arguments.length)||le("Function '"+i+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+e[t].overloadTable+")!"),e[t].overloadTable[arguments.length].apply(this,arguments)},e[t].overloadTable=[],e[t].overloadTable[r.argCount]=r}}function be(e,t,i){r.hasOwnProperty(e)?((void 0===i||void 0!==r[e].overloadTable&&void 0!==r[e].overloadTable[i])&&le("Cannot register public name '"+e+"' twice"),Oe(r,e,e),r.hasOwnProperty(i)&&le("Cannot register multiple overloads of a function with the same number of arguments ("+i+")!"),r[e].overloadTable[i]=t):(r[e]=t,void 0!==i&&(r[e].numArguments=i))}function Ne(e,t,i,r,n,a,s,o){this.name=e,this.constructor=t,this.instancePrototype=i,this.rawDestructor=r,this.baseClass=n,this.getActualType=a,this.upcast=s,this.downcast=o,this.pureVirtualFunctions=[]}function we(e,t,i){for(;t!==i;)t.upcast||le("Expected null or instance of "+i.name+", got an instance of "+t.name),e=t.upcast(e),t=t.baseClass;return e}function Me(e,t){if(null===t)return this.isReference&&le("null is not a valid "+this.name),0;t.$$||le('Cannot pass "'+dt(t)+'" as a '+this.name),t.$$.ptr||le("Cannot pass deleted object as a pointer of type "+this.name);var i=t.$$.ptrType.registeredClass;return we(t.$$.ptr,i,this.registeredClass)}function ke(e,t){var i;if(null===t)return this.isReference&&le("null is not a valid "+this.name),this.isSmartPointer?(i=this.rawConstructor(),null!==e&&e.push(this.rawDestructor,i),i):0;t.$$||le('Cannot pass "'+dt(t)+'" as a '+this.name),t.$$.ptr||le("Cannot pass deleted object as a pointer of type "+this.name),!this.isConst&&t.$$.ptrType.isConst&&le("Cannot convert argument of type "+(t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name)+" to parameter type "+this.name);var r=t.$$.ptrType.registeredClass;if(i=we(t.$$.ptr,r,this.registeredClass),this.isSmartPointer)switch(void 0===t.$$.smartPtr&&le("Passing raw pointer to smart pointer is illegal"),this.sharingPolicy){case 0:t.$$.smartPtrType===this?i=t.$$.smartPtr:le("Cannot convert argument of type "+(t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name)+" to parameter type "+this.name);break;case 1:i=t.$$.smartPtr;break;case 2:if(t.$$.smartPtrType===this)i=t.$$.smartPtr;else{var n=t.clone();i=this.rawShare(i,ot((function(){n.delete()}))),null!==e&&e.push(this.rawDestructor,i)}break;default:le("Unsupporting sharing policy")}return i}function Le(e,t){if(null===t)return this.isReference&&le("null is not a valid "+this.name),0;t.$$||le('Cannot pass "'+dt(t)+'" as a '+this.name),t.$$.ptr||le("Cannot pass deleted object as a pointer of type "+this.name),t.$$.ptrType.isConst&&le("Cannot convert argument of type "+t.$$.ptrType.name+" to parameter type "+this.name);var i=t.$$.ptrType.registeredClass;return we(t.$$.ptr,i,this.registeredClass)}function Ue(e){return this.fromWireType(A[e>>2])}function xe(e){return this.rawGetPointee&&(e=this.rawGetPointee(e)),e}function Ve(e){this.rawDestructor&&this.rawDestructor(e)}function Be(e){null!==e&&e.delete()}function Fe(e,t,i){if(t===i)return e;if(void 0===i.baseClass)return null;var r=Fe(e,t,i.baseClass);return null===r?null:i.downcast(r)}function je(){return Object.keys(We).length}function Ge(){var e=[];for(var t in We)We.hasOwnProperty(t)&&e.push(We[t]);return e}function He(e){ye=e,Ie.length&&ye&&ye(Re)}var We={};function $e(e,t){return t=function(e,t){for(void 0===t&&le("ptr should not be undefined");e.baseClass;)t=e.upcast(t),e=e.baseClass;return t}(e,t),We[t]}function Ke(e,t){return t.ptrType&&t.ptr||ue("makeClassHandle requires ptr and ptrType"),!!t.smartPtrType!==!!t.smartPtr&&ue("Both smartPtrType and smartPtr must be specified"),t.count={value:1},ve(Object.create(e,{$$:{value:t}}))}function ze(e){var t=this.getPointee(e);if(!t)return this.destructor(e),null;var i=$e(this.registeredClass,t);if(void 0!==i){if(0===i.$$.count.value)return i.$$.ptr=t,i.$$.smartPtr=e,i.clone();var r=i.clone();return this.destructor(e),r}function n(){return this.isSmartPointer?Ke(this.registeredClass.instancePrototype,{ptrType:this.pointeeType,ptr:t,smartPtrType:this,smartPtr:e}):Ke(this.registeredClass.instancePrototype,{ptrType:this,ptr:e})}var a,s=this.registeredClass.getActualType(t),o=De[s];if(!o)return n.call(this);a=this.isConst?o.constPointerType:o.pointerType;var c=Fe(t,this.registeredClass,a.registeredClass);return null===c?n.call(this):this.isSmartPointer?Ke(a.registeredClass.instancePrototype,{ptrType:a,ptr:c,smartPtrType:this,smartPtr:e}):Ke(a.registeredClass.instancePrototype,{ptrType:a,ptr:c})}function qe(e,t,i,r,n,a,s,o,c,l,d){this.name=e,this.registeredClass=t,this.isReference=i,this.isConst=r,this.isSmartPointer=n,this.pointeeType=a,this.sharingPolicy=s,this.rawGetPointee=o,this.rawConstructor=c,this.rawShare=l,this.rawDestructor=d,n||void 0!==t.baseClass?this.toWireType=ke:r?(this.toWireType=Me,this.destructorFunction=null):(this.toWireType=Le,this.destructorFunction=null)}function Je(e,t,i){return e.includes("j")?function(e,t,i){var n=r["dynCall_"+e];return i&&i.length?n.apply(null,[t].concat(i)):n.call(null,t)}(e,t,i):x.get(t).apply(null,i)}function Ye(e,t){var i,r,n,a=(e=Z(e)).includes("j")?(i=e,r=t,n=[],function(){n.length=arguments.length;for(var e=0;e<arguments.length;e++)n[e]=arguments[e];return Je(i,r,n)}):x.get(t);return"function"!=typeof a&&le("unknown function pointer with signature "+e+": "+t),a}var Qe=void 0;function Xe(e){var t=vt(e),i=Z(t);return gt(t),i}function Ze(e,t){var i=[],r={};throw t.forEach((function e(t){r[t]||te[t]||(ie[t]?ie[t].forEach(e):(i.push(t),r[t]=!0))})),new Qe(e+": "+i.map(Xe).join([", "]))}function et(e,t){for(var i=[],r=0;r<e;r++)i.push(R[(t>>2)+r]);return i}function tt(e,t,i,r,n){var a=t.length;a<2&&le("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var s=null!==t[1]&&null!==i,o=!1,c=1;c<t.length;++c)if(null!==t[c]&&void 0===t[c].destructorFunction){o=!0;break}var l="void"!==t[0].name,d=a-2,u=new Array(d),h=[],p=[];return function(){var i;arguments.length!==d&&le("function "+e+" called with "+arguments.length+" arguments, expected "+d+" args!"),p.length=0,h.length=s?2:1,h[0]=n,s&&(i=t[1].toWireType(p,this),h[1]=i);for(var a=0;a<d;++a)u[a]=t[a+2].toWireType(p,arguments[a]),h.push(u[a]);return function(e){if(o)!function(e){for(;e.length;){var t=e.pop();e.pop()(t)}}(p);else for(var r=s?1:2;r<t.length;r++){var n=1===r?i:u[r-2];null!==t[r].destructorFunction&&t[r].destructorFunction(n)}if(l)return t[0].fromWireType(e)}(r.apply(null,h))}}var it=[],rt=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function nt(e){e>4&&0==--rt[e].refcount&&(rt[e]=void 0,it.push(e))}function at(){for(var e=0,t=5;t<rt.length;++t)void 0!==rt[t]&&++e;return e}function st(){for(var e=5;e<rt.length;++e)if(void 0!==rt[e])return rt[e];return null}function ot(e){switch(e){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var t=it.length?it.pop():rt.length;return rt[t]={refcount:1,value:e},t}}function ct(e,t,i){switch(t){case 0:return function(e){var t=i?T:C;return this.fromWireType(t[e])};case 1:return function(e){var t=i?y:I;return this.fromWireType(t[e>>1])};case 2:return function(e){var t=i?R:A;return this.fromWireType(t[e>>2])};default:throw new TypeError("Unknown integer type: "+e)}}function lt(e,t){var i=te[e];return void 0===i&&le(t+" has unknown type "+Xe(e)),i}function dt(e){if(null===e)return"null";var t=typeof e;return"object"===t||"array"===t||"function"===t?e.toString():""+e}function ut(e,t){switch(t){case 2:return function(e){return this.fromWireType(P[e>>2])};case 3:return function(e){return this.fromWireType(D[e>>3])};default:throw new TypeError("Unknown float type: "+e)}}function ht(e,t,i){switch(t){case 0:return i?function(e){return T[e]}:function(e){return C[e]};case 1:return i?function(e){return y[e>>1]}:function(e){return I[e>>1]};case 2:return i?function(e){return R[e>>2]}:function(e){return A[e>>2]};default:throw new TypeError("Unknown integer type: "+e)}}function pt(e){try{return m.grow(e-E.byteLength+65535>>>16),U(m.buffer),1}catch(e){}}var _t={mappings:{},buffers:[null,[],[]],printChar:function(e,t){var i=_t.buffers[e];0===t||10===t?((1===e?u:h)(S(i,0)),i.length=0):i.push(t)},varargs:void 0,get:function(){return _t.varargs+=4,R[_t.varargs-4>>2]},getStr:function(e){return v(e)},get64:function(e,t){return e}};!function(){for(var e=new Array(256),t=0;t<256;++t)e[t]=String.fromCharCode(t);X=e}(),ce=r.BindingError=oe(Error,"BindingError"),de=r.InternalError=oe(Error,"InternalError"),Pe.prototype.isAliasOf=_e,Pe.prototype.clone=Ee,Pe.prototype.delete=Te,Pe.prototype.isDeleted=Ce,Pe.prototype.deleteLater=Ae,qe.prototype.getPointee=xe,qe.prototype.destructor=Ve,qe.prototype.argPackAdvance=8,qe.prototype.readValueFromPointer=Ue,qe.prototype.deleteObject=Be,qe.prototype.fromWireType=ze,r.getInheritedInstanceCount=je,r.getLiveInheritedInstances=Ge,r.flushPendingDeletes=Re,r.setDelayFunction=He,Qe=r.UnboundTypeError=oe(Error,"UnboundTypeError"),r.count_emval_handles=at,r.get_first_emval=st;var mt,ft={y:function(e,t,i,r,n){},H:function(e,t,i,r,n){var a=Q(i);pe(e,{name:t=Z(t),fromWireType:function(e){return!!e},toWireType:function(e,t){return t?r:n},argPackAdvance:8,readValueFromPointer:function(e){var r;if(1===i)r=T;else if(2===i)r=y;else{if(4!==i)throw new TypeError("Unknown boolean type size: "+t);r=R}return this.fromWireType(r[e>>a])},destructorFunction:null})},t:function(e,t,i,n,a,s,o,c,l,d,u,h,p){u=Z(u),s=Ye(a,s),c&&(c=Ye(o,c)),d&&(d=Ye(l,d)),p=Ye(h,p);var _=ae(u);be(_,(function(){Ze("Cannot construct "+u+" due to unbound types",[n])})),he([e,t,i],n?[n]:[],(function(t){var i,a;t=t[0],a=n?(i=t.registeredClass).instancePrototype:Pe.prototype;var o=se(_,(function(){if(Object.getPrototypeOf(this)!==l)throw new ce("Use 'new' to construct "+u);if(void 0===h.constructor_body)throw new ce(u+" has no accessible constructor");var e=h.constructor_body[arguments.length];if(void 0===e)throw new ce("Tried to invoke ctor of "+u+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(h.constructor_body).toString()+") parameters instead!");return e.apply(this,arguments)})),l=Object.create(a,{constructor:{value:o}});o.prototype=l;var h=new Ne(u,o,l,p,i,s,c,d),m=new qe(u,h,!0,!1,!1),f=new qe(u+"*",h,!1,!1,!1),g=new qe(u+" const*",h,!1,!0,!1);return De[e]={pointerType:f,constPointerType:g},function(e,t,i){r.hasOwnProperty(e)||ue("Replacing nonexistant public symbol"),void 0!==r[e].overloadTable&&void 0!==i?r[e].overloadTable[i]=t:(r[e]=t,r[e].argCount=i)}(_,o),[m,f,g]}))},p:function(e,t,i,r,n,a){var s;t>0||W("Assertion failed: "+s);var o=et(t,i);n=Ye(r,n),he([],[e],(function(e){var i="constructor "+(e=e[0]).name;if(void 0===e.registeredClass.constructor_body&&(e.registeredClass.constructor_body=[]),void 0!==e.registeredClass.constructor_body[t-1])throw new ce("Cannot register multiple constructors with identical number of parameters ("+(t-1)+") for class '"+e.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return e.registeredClass.constructor_body[t-1]=function(){Ze("Cannot construct "+e.name+" due to unbound types",o)},he([],o,(function(r){return r.splice(1,0,null),e.registeredClass.constructor_body[t-1]=tt(i,r,null,n,a),[]})),[]}))},e:function(e,t,i,r,n,a,s,o){var c=et(i,r);t=Z(t),a=Ye(n,a),he([],[e],(function(e){var r=(e=e[0]).name+"."+t;function n(){Ze("Cannot call "+r+" due to unbound types",c)}t.startsWith("@@")&&(t=Symbol[t.substring(2)]),o&&e.registeredClass.pureVirtualFunctions.push(t);var l=e.registeredClass.instancePrototype,d=l[t];return void 0===d||void 0===d.overloadTable&&d.className!==e.name&&d.argCount===i-2?(n.argCount=i-2,n.className=e.name,l[t]=n):(Oe(l,t,r),l[t].overloadTable[i-2]=n),he([],c,(function(n){var o=tt(r,n,e,a,s);return void 0===l[t].overloadTable?(o.argCount=i-2,l[t]=o):l[t].overloadTable[i-2]=o,[]})),[]}))},G:function(e,t){pe(e,{name:t=Z(t),fromWireType:function(e){var t=rt[e].value;return nt(e),t},toWireType:function(e,t){return ot(t)},argPackAdvance:8,readValueFromPointer:Ue,destructorFunction:null})},L:function(e,t,i,r){var n=Q(i);function a(){}t=Z(t),a.values={},pe(e,{name:t,constructor:a,fromWireType:function(e){return this.constructor.values[e]},toWireType:function(e,t){return t.value},argPackAdvance:8,readValueFromPointer:ct(t,n,r),destructorFunction:null}),be(t,a)},x:function(e,t,i){var r=lt(e,"enum");t=Z(t);var n=r.constructor,a=Object.create(r.constructor.prototype,{value:{value:i},constructor:{value:se(r.name+"_"+t,(function(){}))}});n.values[i]=a,n[t]=a},r:function(e,t,i){var r=Q(i);pe(e,{name:t=Z(t),fromWireType:function(e){return e},toWireType:function(e,t){if("number"!=typeof t&&"boolean"!=typeof t)throw new TypeError('Cannot convert "'+dt(t)+'" to '+this.name);return t},argPackAdvance:8,readValueFromPointer:ut(t,r),destructorFunction:null})},h:function(e,t,i,r,n){t=Z(t),-1===n&&(n=4294967295);var a=Q(i),s=function(e){return e};if(0===r){var o=32-8*i;s=function(e){return e<<o>>>o}}var c=t.includes("unsigned");pe(e,{name:t,fromWireType:s,toWireType:function(e,i){if("number"!=typeof i&&"boolean"!=typeof i)throw new TypeError('Cannot convert "'+dt(i)+'" to '+this.name);if(i<r||i>n)throw new TypeError('Passing a number "'+dt(i)+'" from JS side to C/C++ side to an argument of type "'+t+'", which is outside the valid range ['+r+", "+n+"]!");return c?i>>>0:0|i},argPackAdvance:8,readValueFromPointer:ht(t,a,0!==r),destructorFunction:null})},g:function(e,t,i){var r=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][t];function n(e){var t=A,i=t[e>>=2],n=t[e+1];return new r(E,n,i)}pe(e,{name:i=Z(i),fromWireType:n,argPackAdvance:8,readValueFromPointer:n},{ignoreDuplicateRegistrations:!0})},s:function(e,t){var i="std::string"===(t=Z(t));pe(e,{name:t,fromWireType:function(e){var t,r=A[e>>2];if(i)for(var n=e+4,a=0;a<=r;++a){var s=e+4+a;if(a==r||0==C[s]){var o=v(n,s-n);void 0===t?t=o:(t+=String.fromCharCode(0),t+=o),n=s+1}}else{var c=new Array(r);for(a=0;a<r;++a)c[a]=String.fromCharCode(C[e+4+a]);t=c.join("")}return gt(e),t},toWireType:function(e,t){var r;t instanceof ArrayBuffer&&(t=new Uint8Array(t));var n="string"==typeof t;n||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int8Array||le("Cannot pass non-string to std::string"),r=i&&n?function(){return function(e){for(var t=0,i=0;i<e.length;++i){var r=e.charCodeAt(i);r>=55296&&r<=57343&&(r=65536+((1023&r)<<10)|1023&e.charCodeAt(++i)),r<=127?++t:t+=r<=2047?2:r<=65535?3:4}return t}(t)}:function(){return t.length};var a=r(),s=St(4+a+1);if(A[s>>2]=a,i&&n)(function(e,t,i,r){if(!(r>0))return 0;for(var n=i,a=i+r-1,s=0;s<e.length;++s){var o=e.charCodeAt(s);if(o>=55296&&o<=57343&&(o=65536+((1023&o)<<10)|1023&e.charCodeAt(++s)),o<=127){if(i>=a)break;t[i++]=o}else if(o<=2047){if(i+1>=a)break;t[i++]=192|o>>6,t[i++]=128|63&o}else if(o<=65535){if(i+2>=a)break;t[i++]=224|o>>12,t[i++]=128|o>>6&63,t[i++]=128|63&o}else{if(i+3>=a)break;t[i++]=240|o>>18,t[i++]=128|o>>12&63,t[i++]=128|o>>6&63,t[i++]=128|63&o}}t[i]=0})(t,C,s+4,a+1);else if(n)for(var o=0;o<a;++o){var c=t.charCodeAt(o);c>255&&(gt(s),le("String has UTF-16 code units that do not fit in 8 bits")),C[s+4+o]=c}else for(o=0;o<a;++o)C[s+4+o]=t[o];return null!==e&&e.push(gt,s),s},argPackAdvance:8,readValueFromPointer:Ue,destructorFunction:function(e){gt(e)}})},m:function(e,t,i){var r,n,a,s,o;i=Z(i),2===t?(r=b,n=N,s=w,a=function(){return I},o=1):4===t&&(r=M,n=k,s=L,a=function(){return A},o=2),pe(e,{name:i,fromWireType:function(e){for(var i,n=A[e>>2],s=a(),c=e+4,l=0;l<=n;++l){var d=e+4+l*t;if(l==n||0==s[d>>o]){var u=r(c,d-c);void 0===i?i=u:(i+=String.fromCharCode(0),i+=u),c=d+t}}return gt(e),i},toWireType:function(e,r){"string"!=typeof r&&le("Cannot pass non-string to C++ string type "+i);var a=s(r),c=St(4+a+t);return A[c>>2]=a>>o,n(r,c+4,a+t),null!==e&&e.push(gt,c),c},argPackAdvance:8,readValueFromPointer:Ue,destructorFunction:function(e){gt(e)}})},I:function(e,t){pe(e,{isVoid:!0,name:t=Z(t),argPackAdvance:0,fromWireType:function(){},toWireType:function(e,t){}})},F:function(){throw"longjmp"},k:nt,l:function(e){e>4&&(rt[e].refcount+=1)},j:function(e,t){return ot((e=lt(e,"_emval_take_value")).readValueFromPointer(t))},E:function(){W()},C:function(e,t,i){C.copyWithin(e,t,t+i)},D:function(e){var t,i,r=C.length,n=2147483648;if((e>>>=0)>n)return!1;for(var a=1;a<=4;a*=2){var s=r*(1+.2/a);if(s=Math.min(s,e+100663296),pt(Math.min(n,((t=Math.max(e,s))%(i=65536)>0&&(t+=i-t%i),t))))return!0}return!1},q:function(e,t,i,r){for(var n=0,a=0;a<i;a++){for(var s=R[t+8*a>>2],o=R[t+(8*a+4)>>2],c=0;c<o;c++)_t.printChar(e,C[s+c]);n+=o}return R[r>>2]=n,0},a:function(){return _},f:function(e){var t=Date.now();return R[e>>2]=t/1e3|0,R[e+4>>2]=t%1e3*1e3|0,0},d:function(e,t,i){var r=Et();try{return x.get(e)(t,i)}catch(e){if(Tt(r),e!==e+0&&"longjmp"!==e)throw e;Ct(1,0)}},n:function(e,t,i,r){var n=Et();try{return x.get(e)(t,i,r)}catch(e){if(Tt(n),e!==e+0&&"longjmp"!==e)throw e;Ct(1,0)}},o:function(e,t,i,r,n){var a=Et();try{return x.get(e)(t,i,r,n)}catch(e){if(Tt(a),e!==e+0&&"longjmp"!==e)throw e;Ct(1,0)}},u:function(e,t,i,r,n,a){var s=Et();try{return x.get(e)(t,i,r,n,a)}catch(e){if(Tt(s),e!==e+0&&"longjmp"!==e)throw e;Ct(1,0)}},K:function(e,t,i,r,n,a,s,o,c){var l=Et();try{return x.get(e)(t,i,r,n,a,s,o,c)}catch(e){if(Tt(l),e!==e+0&&"longjmp"!==e)throw e;Ct(1,0)}},B:function(e,t,i,r,n,a,s,o){var c=Et();try{return yt(e,t,i,r,n,a,s,o)}catch(e){if(Tt(c),e!==e+0&&"longjmp"!==e)throw e;Ct(1,0)}},z:function(e,t,i,r){var n=Et();try{return Rt(e,t,i,r)}catch(e){if(Tt(n),e!==e+0&&"longjmp"!==e)throw e;Ct(1,0)}},i:function(e,t){var i=Et();try{x.get(e)(t)}catch(e){if(Tt(i),e!==e+0&&"longjmp"!==e)throw e;Ct(1,0)}},w:function(e,t,i){var r=Et();try{x.get(e)(t,i)}catch(e){if(Tt(r),e!==e+0&&"longjmp"!==e)throw e;Ct(1,0)}},c:function(e,t,i,r,n){var a=Et();try{x.get(e)(t,i,r,n)}catch(e){if(Tt(a),e!==e+0&&"longjmp"!==e)throw e;Ct(1,0)}},J:function(e,t,i,r,n,a,s){var o=Et();try{x.get(e)(t,i,r,n,a,s)}catch(e){if(Tt(o),e!==e+0&&"longjmp"!==e)throw e;Ct(1,0)}},v:function(e,t,i,r,n,a,s,o,c){var l=Et();try{x.get(e)(t,i,r,n,a,s,o,c)}catch(e){if(Tt(l),e!==e+0&&"longjmp"!==e)throw e;Ct(1,0)}},A:function(e,t,i,r,n,a,s,o,c,l){var d=Et();try{It(e,t,i,r,n,a,s,o,c,l)}catch(e){if(Tt(d),e!==e+0&&"longjmp"!==e)throw e;Ct(1,0)}},b:function(e){_=e}},gt=(function(){var e={a:ft};function t(e,t){var i,n=e.exports;r.asm=n,U((m=r.asm.M).buffer),x=r.asm.Q,i=r.asm.N,B.unshift(i),function(e){if(j--,r.monitorRunDependencies&&r.monitorRunDependencies(j),0==j&&(null!==G&&(clearInterval(G),G=null),H)){var t=H;H=null,t()}}()}function n(e){t(e.instance)}function a(t){return(p||!c&&!l||"function"!=typeof fetch?Promise.resolve().then((function(){return J($)})):fetch($,{credentials:"same-origin"}).then((function(e){if(!e.ok)throw"failed to load wasm binary file at '"+$+"'";return e.arrayBuffer()})).catch((function(){return J($)}))).then((function(t){return WebAssembly.instantiate(t,e)})).then(t,(function(e){h("failed to asynchronously prepare wasm: "+e),W(e)}))}if(j++,r.monitorRunDependencies&&r.monitorRunDependencies(j),r.instantiateWasm)try{return r.instantiateWasm(e,t)}catch(e){return h("Module.instantiateWasm callback failed with error: "+e),!1}(p||"function"!=typeof WebAssembly.instantiateStreaming||q($)||"function"!=typeof fetch?a(n):fetch($,{credentials:"same-origin"}).then((function(t){return WebAssembly.instantiateStreaming(t,e).then(n,(function(e){return h("wasm streaming compile failed: "+e),h("falling back to ArrayBuffer instantiation"),a(n)}))}))).catch(i)}(),r.___wasm_call_ctors=function(){return(r.___wasm_call_ctors=r.asm.N).apply(null,arguments)},r._free=function(){return(gt=r._free=r.asm.O).apply(null,arguments)}),St=r._malloc=function(){return(St=r._malloc=r.asm.P).apply(null,arguments)},vt=r.___getTypeName=function(){return(vt=r.___getTypeName=r.asm.R).apply(null,arguments)},Et=(r.___embind_register_native_and_builtin_types=function(){return(r.___embind_register_native_and_builtin_types=r.asm.S).apply(null,arguments)},r.stackSave=function(){return(Et=r.stackSave=r.asm.T).apply(null,arguments)}),Tt=r.stackRestore=function(){return(Tt=r.stackRestore=r.asm.U).apply(null,arguments)},Ct=r._setThrew=function(){return(Ct=r._setThrew=r.asm.V).apply(null,arguments)},yt=r.dynCall_iiiijj=function(){return(yt=r.dynCall_iiiijj=r.asm.W).apply(null,arguments)},It=(r.dynCall_iiijiii=function(){return(r.dynCall_iiijiii=r.asm.X).apply(null,arguments)},r.dynCall_vijjjid=function(){return(It=r.dynCall_vijjjid=r.asm.Y).apply(null,arguments)}),Rt=r.dynCall_iij=function(){return(Rt=r.dynCall_iij=r.asm.Z).apply(null,arguments)};r.dynCall_jiji=function(){return(r.dynCall_jiji=r.asm._).apply(null,arguments)};function At(e){function i(){mt||(mt=!0,r.calledRun=!0,f||(!0,Y(B),t(r),r.onRuntimeInitialized&&r.onRuntimeInitialized(),function(){if(r.postRun)for("function"==typeof r.postRun&&(r.postRun=[r.postRun]);r.postRun.length;)e=r.postRun.shift(),F.unshift(e);var e;Y(F)}()))}e=e||o,j>0||(!function(){if(r.preRun)for("function"==typeof r.preRun&&(r.preRun=[r.preRun]);r.preRun.length;)e=r.preRun.shift(),V.unshift(e);var e;Y(V)}(),j>0||(r.setStatus?(r.setStatus("Running..."),setTimeout((function(){setTimeout((function(){r.setStatus("")}),1),i()}),1)):i()))}if(H=function e(){mt||At(),mt||(H=e)},r.run=At,r.preInit)for("function"==typeof r.preInit&&(r.preInit=[r.preInit]);r.preInit.length>0;)r.preInit.pop()();return At(),e.ready}}();e.exports=t,t.getUrl=function(e){return"https://st.mycdn.me/static/libvpx/2-0-9/"+e}},774721:function(e,t,i){var r;!function(n){var a=function(e,t,i){if(!(e instanceof ArrayBuffer||"undefined"!=typeof Buffer&&e instanceof Buffer))throw new Error("Must specify a valid ArrayBuffer or Buffer.");t=t||0,i=i||e.byteLength||e.length,this._view=new Uint8Array(e.buffer||e,t,i),this.bigEndian=!1};a._scratch=new DataView(new ArrayBuffer(8)),Object.defineProperty(a.prototype,"buffer",{get:function(){return"undefined"!=typeof Buffer?Buffer.from(this._view.buffer):this._view.buffer},enumerable:!0,configurable:!1}),Object.defineProperty(a.prototype,"byteLength",{get:function(){return this._view.length},enumerable:!0,configurable:!1}),a.prototype._setBit=function(e,t){t?this._view[e>>3]|=1<<(7&e):this._view[e>>3]&=~(1<<(7&e))},a.prototype.getBits=function(e,t,i){var r=8*this._view.length-e;if(t>r)throw new Error("Cannot get "+t+" bit(s) from offset "+e+", "+r+" available");for(var n=0,a=0;a<t;){var s=t-a,o=7&e,c=this._view[e>>3],l=Math.min(s,8-o);this.bigEndian?(n<<=l,n|=c>>8-l-o&~(255<<l)):n|=(c>>o&~(255<<l))<<a,e+=l,a+=l}return i?(32!==t&&n&1<<t-1&&(n|=~((1<<t)-1)),n):n>>>0},a.prototype.setBits=function(e,t,i){var r=8*this._view.length-e;if(i>r)throw new Error("Cannot set "+i+" bit(s) from offset "+e+", "+r+" available");for(var n=0;n<i;){var a,s,o,c=i-n,l=7&e,d=e>>3,u=Math.min(c,8-l);if(this.bigEndian){s=t>>i-n-u&(a=~(-1<<u));var h=8-l-u;o=~(a<<h),this._view[d]=this._view[d]&o|s<<h}else s=t&(a=~(255<<u)),t>>=u,o=~(a<<l),this._view[d]=this._view[d]&o|s<<l;e+=u,n+=u}},a.prototype.getBoolean=function(e){return 0!==this.getBits(e,1,!1)},a.prototype.getInt8=function(e){return this.getBits(e,8,!0)},a.prototype.getUint8=function(e){return this.getBits(e,8,!1)},a.prototype.getInt16=function(e){return this.getBits(e,16,!0)},a.prototype.getUint16=function(e){return this.getBits(e,16,!1)},a.prototype.getInt32=function(e){return this.getBits(e,32,!0)},a.prototype.getUint32=function(e){return this.getBits(e,32,!1)},a.prototype.getFloat32=function(e){return a._scratch.setUint32(0,this.getUint32(e)),a._scratch.getFloat32(0)},a.prototype.getFloat64=function(e){return a._scratch.setUint32(0,this.getUint32(e)),a._scratch.setUint32(4,this.getUint32(e+32)),a._scratch.getFloat64(0)},a.prototype.setBoolean=function(e,t){this.setBits(e,t?1:0,1)},a.prototype.setInt8=a.prototype.setUint8=function(e,t){this.setBits(e,t,8)},a.prototype.setInt16=a.prototype.setUint16=function(e,t){this.setBits(e,t,16)},a.prototype.setInt32=a.prototype.setUint32=function(e,t){this.setBits(e,t,32)},a.prototype.setFloat32=function(e,t){a._scratch.setFloat32(0,t),this.setBits(e,a._scratch.getUint32(0),32)},a.prototype.setFloat64=function(e,t){a._scratch.setFloat64(0,t),this.setBits(e,a._scratch.getUint32(0),32),this.setBits(e+32,a._scratch.getUint32(4),32)},a.prototype.getArrayBuffer=function(e,t){for(var i=new Uint8Array(t),r=0;r<t;r++)i[r]=this.getUint8(e+8*r);return i};var s=function(e,t){return function(){if(this._index+t>this._length)throw new Error("Trying to read past the end of the stream");var i=this._view[e](this._index);return this._index+=t,i}},o=function(e,t){return function(i){this._view[e](this._index,i),this._index+=t}};function c(e,t,i){if(0===t)return"";var r=0,n=[],a=!0,s=!!t;for(t||(t=Math.floor((e._length-e._index)/8));r<t;){var o=e.readUint8();if(0===o&&(a=!1,!s))break;a&&n.push(o),r++}var c=String.fromCharCode.apply(null,n);if(!i)return c;try{return decodeURIComponent(escape(c))}catch(e){return c}}var l=function(e,t,i){var r=e instanceof ArrayBuffer||"undefined"!=typeof Buffer&&e instanceof Buffer;if(!(e instanceof a||r))throw new Error("Must specify a valid BitView, ArrayBuffer or Buffer");this._view=r?new a(e,t,i):e,this._index=0,this._startIndex=0,this._length=8*this._view.byteLength};Object.defineProperty(l.prototype,"index",{get:function(){return this._index-this._startIndex},set:function(e){this._index=e+this._startIndex},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"length",{get:function(){return this._length-this._startIndex},set:function(e){this._length=e+this._startIndex},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"bitsLeft",{get:function(){return this._length-this._index},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"byteIndex",{get:function(){return Math.ceil(this._index/8)},set:function(e){this._index=8*e},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"buffer",{get:function(){return this._view.buffer},enumerable:!0,configurable:!1}),Object.defineProperty(l.prototype,"view",{get:function(){return this._view},enumerable:!0,configurable:!1}),Object.defineProperty(l.prototype,"bigEndian",{get:function(){return this._view.bigEndian},set:function(e){this._view.bigEndian=e},enumerable:!0,configurable:!1}),l.prototype.readBits=function(e,t){var i=this._view.getBits(this._index,e,t);return this._index+=e,i},l.prototype.writeBits=function(e,t){this._view.setBits(this._index,e,t),this._index+=t},l.prototype.readBoolean=s("getBoolean",1),l.prototype.readInt8=s("getInt8",8),l.prototype.readUint8=s("getUint8",8),l.prototype.readInt16=s("getInt16",16),l.prototype.readUint16=s("getUint16",16),l.prototype.readInt32=s("getInt32",32),l.prototype.readUint32=s("getUint32",32),l.prototype.readFloat32=s("getFloat32",32),l.prototype.readFloat64=s("getFloat64",64),l.prototype.writeBoolean=o("setBoolean",1),l.prototype.writeInt8=o("setInt8",8),l.prototype.writeUint8=o("setUint8",8),l.prototype.writeInt16=o("setInt16",16),l.prototype.writeUint16=o("setUint16",16),l.prototype.writeInt32=o("setInt32",32),l.prototype.writeUint32=o("setUint32",32),l.prototype.writeFloat32=o("setFloat32",32),l.prototype.writeFloat64=o("setFloat64",64),l.prototype.readASCIIString=function(e){return function(e,t){return c(e,t,!1)}(this,e)},l.prototype.readUTF8String=function(e){return function(e,t){return c(e,t,!0)}(this,e)},l.prototype.writeASCIIString=function(e,t){!function(e,t,i){for(var r=i||t.length+1,n=0;n<r;n++)e.writeUint8(n<t.length?t.charCodeAt(n):0)}(this,e,t)},l.prototype.writeUTF8String=function(e,t){!function(e,t,i){for(var r=function(e){var t,i,r=[];for(t=0;t<e.length;t++)(i=e.charCodeAt(t))<=127?r.push(i):i<=2047?(r.push(i>>6|192),r.push(63&i|128)):i<=65535?(r.push(i>>12|224),r.push(i>>6&63|128),r.push(63&i|128)):(r.push(i>>18|240),r.push(i>>12&63|128),r.push(i>>6&63|128),r.push(63&i|128));return r}(t),n=i||r.length+1,a=0;a<n;a++)e.writeUint8(a<r.length?r[a]:0)}(this,e,t)},l.prototype.readBitStream=function(e){var t=new l(this._view);return t._startIndex=this._index,t._index=this._index,t.length=e,this._index+=e,t},l.prototype.writeBitStream=function(e,t){var i;for(t||(t=e.bitsLeft);t>0;)i=Math.min(t,32),this.writeBits(e.readBits(i),i),t-=i},l.prototype.readArrayBuffer=function(e){var t=this._view.getArrayBuffer(this._index,e);return this._index+=8*e,t},l.prototype.writeArrayBuffer=function(e,t){this.writeBitStream(new l(e),8*t)},void 0===(r=function(){return{BitView:a,BitStream:l}}.call(t,i,t,e))||(e.exports=r)}()},47654:(e,t,i)=>{var r="__lodash_hash_undefined__",n="[object Function]",a="[object GeneratorFunction]",s=/^\[object .+?Constructor\]$/,o="object"==typeof i.g&&i.g&&i.g.Object===Object&&i.g,c="object"==typeof self&&self&&self.Object===Object&&self,l=o||c||Function("return this")();var d,u=Array.prototype,h=Function.prototype,p=Object.prototype,_=l["__core-js_shared__"],m=(d=/[^.]+$/.exec(_&&_.keys&&_.keys.IE_PROTO||""))?"Symbol(src)_1."+d:"",f=h.toString,g=p.hasOwnProperty,S=p.toString,v=RegExp("^"+f.call(g).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),E=u.splice,T=O(l,"Map"),C=O(Object,"create");function y(e){var t=-1,i=e?e.length:0;for(this.clear();++t<i;){var r=e[t];this.set(r[0],r[1])}}function I(e){var t=-1,i=e?e.length:0;for(this.clear();++t<i;){var r=e[t];this.set(r[0],r[1])}}function R(e){var t=-1,i=e?e.length:0;for(this.clear();++t<i;){var r=e[t];this.set(r[0],r[1])}}function A(e,t){for(var i,r,n=e.length;n--;)if((i=e[n][0])===(r=t)||i!=i&&r!=r)return n;return-1}function P(e){if(!N(e)||(t=e,m&&m in t))return!1;var t,i=function(e){var t=N(e)?S.call(e):"";return t==n||t==a}(e)||function(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}(e)?v:s;return i.test(function(e){if(null!=e){try{return f.call(e)}catch(e){}try{return e+""}catch(e){}}return""}(e))}function D(e,t){var i,r,n=e.__data__;return("string"==(r=typeof(i=t))||"number"==r||"symbol"==r||"boolean"==r?"__proto__"!==i:null===i)?n["string"==typeof t?"string":"hash"]:n.map}function O(e,t){var i=function(e,t){return null==e?void 0:e[t]}(e,t);return P(i)?i:void 0}function b(e,t){if("function"!=typeof e||t&&"function"!=typeof t)throw new TypeError("Expected a function");var i=function(){var r=arguments,n=t?t.apply(this,r):r[0],a=i.cache;if(a.has(n))return a.get(n);var s=e.apply(this,r);return i.cache=a.set(n,s),s};return i.cache=new(b.Cache||R),i}function N(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}y.prototype.clear=function(){this.__data__=C?C(null):{}},y.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},y.prototype.get=function(e){var t=this.__data__;if(C){var i=t[e];return i===r?void 0:i}return g.call(t,e)?t[e]:void 0},y.prototype.has=function(e){var t=this.__data__;return C?void 0!==t[e]:g.call(t,e)},y.prototype.set=function(e,t){return this.__data__[e]=C&&void 0===t?r:t,this},I.prototype.clear=function(){this.__data__=[]},I.prototype.delete=function(e){var t=this.__data__,i=A(t,e);return!(i<0)&&(i==t.length-1?t.pop():E.call(t,i,1),!0)},I.prototype.get=function(e){var t=this.__data__,i=A(t,e);return i<0?void 0:t[i][1]},I.prototype.has=function(e){return A(this.__data__,e)>-1},I.prototype.set=function(e,t){var i=this.__data__,r=A(i,e);return r<0?i.push([e,t]):i[r][1]=t,this},R.prototype.clear=function(){this.__data__={hash:new y,map:new(T||I),string:new y}},R.prototype.delete=function(e){return D(this,e).delete(e)},R.prototype.get=function(e){return D(this,e).get(e)},R.prototype.has=function(e){return D(this,e).has(e)},R.prototype.set=function(e,t){return D(this,e).set(e,t),this},b.Cache=R,e.exports=b},777688:(e,t,i)=>{"use strict";function r(e,t){throw new TypeError(`unexpected tag 0x${e.toString(16)} (${t} expected)`)}function n(e){return 127&e}function a(e){return!(128&e)}function s(e){return!(224&~e)}function o(e){return 160==(224&e)}function c(e){return 144==(240&e)}function l(e){return 128==(240&e)}function d(e,t,i){const r=t.byteLength;if(r<=255)e.putUi8(i),e.putUi8(r);else if(r<=65535)e.putUi8(i+1),e.putUi16(r);else{if(!(r<=4294967295))throw new RangeError("length limit exceeded");e.putUi8(i+2),e.putUi32(r)}e.put(t)}function u(e){const t=e.getUi8();let i;switch(t){case 192:i=0;break;case 196:case 217:i=e.getUi8();break;case 197:case 218:i=e.getUi16();break;case 198:case 219:i=e.getUi32();break;default:o(t)||r(t,"bytes or string"),i=function(e){return 31&e}(t)}return e.get(i)}function h(e,t){t<16?e.putUi8(144|15&t):f(e,220,t)}function p(e,t){const i=e.getUi8(),r=c(i)?function(e){return 15&e}(i):g(e,i,220,"array");if(null!=t&&r!==t)throw new Error(`invalid array header size ${r}`);return r}function _(e,t){t<16?e.putUi8(128|15&t):f(e,222,t)}function m(e,t){const i=e.getUi8(),r=l(i)?function(e){return 15&e}(i):g(e,i,222,"map");if(null!=t&&r!==t)throw new Error(`invalid map header size ${r}`);return r}function f(e,t,i){if(i<=65535)e.putUi8(t),e.putUi16(i);else{if(!(i<=4294967295))throw new RangeError("length limit exceeded");e.putUi8(t+1),e.putUi32(i)}}function g(e,t,i,n){switch(t){case 192:return 0;case i:return e.getUi16();case i+1:return e.getUi32();default:r(t,n)}}i.d(t,{Any:()=>S,Arr:()=>P,Bool:()=>E,Int:()=>T,Nil:()=>v,Str:()=>R,decode:()=>b});const S={enc(e,t){(function(e){switch(typeof e){case"undefined":return v;case"boolean":return E;case"number":return isFinite(e)&&Math.floor(e)===e?e<0?T:C:y;case"string":return R;case"object":return null===e?v:Array.isArray(e)?P:e instanceof Uint8Array||e instanceof ArrayBuffer?I:e instanceof Date?A:O;default:throw new TypeError("unsupported type "+typeof e)}})(t).enc(e,t)},dec:e=>function(e){switch(e){case 192:return v;case 194:case 195:return E;case 208:case 209:case 210:case 211:return T;case 204:case 205:case 206:case 207:return C;case 202:case 203:return y;case 196:case 197:case 198:return I;case 217:case 218:case 219:return R;case 220:case 221:return P;case 222:case 223:return O;case 214:case 215:case 199:return A;default:if(a(e)||s(e))return T;if(o(e))return R;if(c(e))return P;if(l(e))return O;throw new TypeError(`unsupported tag ${e}`)}}(e.peek()).dec(e)},v={enc(e,t){e.putUi8(192)},dec(e){const t=e.getUi8();return 192!==t&&r(t,"nil"),null}},E={enc(e,t){e.putUi8(t?195:194)},dec(e){const t=e.getUi8();switch(t){case 192:case 194:return!1;case 195:return!0;default:r(t,"bool")}}},T={enc(e,t){-128<=t&&t<=127?t>=0?e.putUi8(n(t)):t>-32?e.putUi8(224|31&t):(e.putUi8(208),e.putUi8(t)):-32768<=t&&t<=32767?(e.putI8(209),e.putI16(t)):-2147483648<=t&&t<=2147483647?(e.putI8(210),e.putI32(t)):(e.putI8(211),e.putI64(t))},dec(e){const t=e.getUi8();if(a(t))return function(e){return 127&e}(t);if(s(t))return function(e){return e-256}(t);switch(t){case 192:return 0;case 208:return e.getI8();case 209:return e.getI16();case 210:return e.getI32();case 211:return e.getI64();case 204:return e.getUi8();case 205:return e.getUi16();case 206:return e.getUi32();case 207:return e.getUi64();default:r(t,"int")}}},C={enc(e,t){if(t<0)throw new Error(`not an uint: ${t}`);t<=127?e.putUi8(n(t)):t<=255?(e.putUi8(204),e.putUi8(t)):t<=65535?(e.putUi8(205),e.putUi16(t)):t<=4294967295?(e.putUi8(206),e.putUi32(t)):(e.putUi8(207),e.putUi64(t))},dec(e){const t=T.dec(e);if(t<0)throw new RangeError("uint underflow");return t}},y={enc(e,t){e.putUi8(203),e.putF(t)},dec(e){const t=e.getUi8();switch(t){case 192:return 0;case 202:return e.getF32();case 203:return e.getF64();default:r(t,"float")}}},I={enc(e,t){d(e,t,196)},dec:u},R={enc(e,t){const i=function(e){const t=e.length,i=new Uint8Array(4*t);let r,n=0,a=0;for(;a<t;)r=e.charCodeAt(a++),55296==(64512&r)&&(r=(r<<10)+e.charCodeAt(a++)-56613888),r<128?i[n++]=r:r<2048?(i[n++]=192+(r>>6),i[n++]=128+(63&r)):r<65536?(i[n++]=224+(r>>12),i[n++]=128+(r>>6&63),i[n++]=128+(63&r)):(i[n++]=240+(r>>18),i[n++]=128+(r>>12&63),i[n++]=128+(r>>6&63),i[n++]=128+(63&r));return i.buffer.slice(0,n)}(t);i.byteLength<32?(e.putUi8(160|31&i.byteLength),e.put(i)):d(e,i,217)},dec:e=>function(e){return new TextDecoder("utf-8").decode(e)}(u(e))},A={enc(e,t){const i=t.getTime();e.putUi8(199),e.putUi8(12),e.putI8(-1),e.putUi32(i%1e3*1e6),e.putI64(i/1e3)},dec(e){const t=e.getUi8();switch(t){case 214:if(-1===e.getI8())return new Date(1e3*e.getUi32());break;case 215:if(-1===e.getI8()){const t=e.getUi32(),i=e.getUi32();return new Date(1e3*(i+4294967296*(3&t))+t/4e6)}break;case 199:if(12===e.getUi8()&&-1===e.getI8()){const t=e.getUi32(),i=e.getI64();return new Date(1e3*i+t/1e6)}}r(t,"time")}},P=(D=S,{encHeader:h,decHeader:p,enc(e,t){h(e,t.length),t.forEach((t=>D.enc(e,t)))},dec(e){const t=[];for(let i=p(e);i>0;--i)t.push(D.dec(e));return t}});var D;const O=function(e,t){return{encHeader:_,decHeader:m,enc(i,r){const n=Object.keys(r);_(i,n.length),n.forEach((n=>{e.enc(i,n),t.enc(i,r[n])}))},dec(i){const r={};for(let n=m(i);n>0;--n){r[e.dec(i)]=t.dec(i)}return r}}}(S,S);function b(e,t){return(t||S).dec(function(e){let t=ArrayBuffer.isView(e)?new DataView(e.buffer,e.byteOffset,e.byteLength):new DataView(e),i=0;return{peek:()=>t.getUint8(i),get(e){i+=e;const r=t.byteOffset;return t.buffer.slice(r+i-e,r+i)},getI8:()=>t.getInt8(i++),getI16:()=>(i+=2,t.getInt16(i-2)),getI32:()=>(i+=4,t.getInt32(i-4)),getI64:()=>(i+=8,4294967296*t.getInt32(i-8)+t.getUint32(i-4)),getUi8:()=>t.getUint8(i++),getUi16:()=>(i+=2,t.getUint16(i-2)),getUi32:()=>(i+=4,t.getUint32(i-4)),getUi64:()=>(i+=8,4294967296*t.getUint32(i-8)+t.getUint32(i-4)),getF32:()=>(i+=4,t.getFloat32(i-4)),getF64:()=>(i+=8,t.getFloat64(i-8))}}(e))}},949058:(e,t,i)=>{"use strict";var r=i(337963);function n(e,t,i,n,a){var s=r.writeRtpDescription(e.kind,t);if(s+=r.writeIceParameters(e.iceGatherer.getLocalParameters()),s+=r.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===i?"actpass":a||"active"),s+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?s+="a=sendrecv\r\n":e.rtpSender?s+="a=sendonly\r\n":e.rtpReceiver?s+="a=recvonly\r\n":s+="a=inactive\r\n",e.rtpSender){var o=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=o;var c="msid:"+(n?n.id:"-")+" "+o+"\r\n";s+="a="+c,s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+c,e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+c,s+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+r.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+r.localCName+"\r\n"),s}function a(e,t){var i={codecs:[],headerExtensions:[],fecMechanisms:[]},r=function(e,t){e=parseInt(e,10);for(var i=0;i<t.length;i++)if(t[i].payloadType===e||t[i].preferredPayloadType===e)return t[i]},n=function(e,t,i,n){var a=r(e.parameters.apt,i),s=r(t.parameters.apt,n);return a&&s&&a.name.toLowerCase()===s.name.toLowerCase()};return e.codecs.forEach((function(r){for(var a=0;a<t.codecs.length;a++){var s=t.codecs[a];if(r.name.toLowerCase()===s.name.toLowerCase()&&r.clockRate===s.clockRate){if("rtx"===r.name.toLowerCase()&&r.parameters&&s.parameters.apt&&!n(r,s,e.codecs,t.codecs))continue;(s=JSON.parse(JSON.stringify(s))).numChannels=Math.min(r.numChannels,s.numChannels),i.codecs.push(s),s.rtcpFeedback=s.rtcpFeedback.filter((function(e){for(var t=0;t<r.rtcpFeedback.length;t++)if(r.rtcpFeedback[t].type===e.type&&r.rtcpFeedback[t].parameter===e.parameter)return!0;return!1}));break}}})),e.headerExtensions.forEach((function(e){for(var r=0;r<t.headerExtensions.length;r++){var n=t.headerExtensions[r];if(e.uri===n.uri){i.headerExtensions.push(n);break}}})),i}function s(e,t,i){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(i)}function o(e,t){var i=e.getRemoteCandidates().find((function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type}));return i||e.addRemoteCandidate(t),!i}function c(e,t){var i=new Error(t);return i.name=e,i.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],i}e.exports=function(e,t){function i(t,i){i.addTrack(t),i.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function l(t,i,r,n){var a=new Event("track");a.track=i,a.receiver=r,a.transceiver={receiver:r},a.streams=n,e.setTimeout((function(){t._dispatchEvent("track",a)}))}var d=function(i){var n=this,a=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach((function(e){n[e]=a[e].bind(a)})),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",i=JSON.parse(JSON.stringify(i||{})),this.usingBundle="max-bundle"===i.bundlePolicy,"negotiate"===i.rtcpMuxPolicy)throw c("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(i.rtcpMuxPolicy||(i.rtcpMuxPolicy="require"),i.iceTransportPolicy){case"all":case"relay":break;default:i.iceTransportPolicy="all"}switch(i.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:i.bundlePolicy="balanced"}if(i.iceServers=function(e,t){var i=!1;return(e=JSON.parse(JSON.stringify(e))).filter((function(e){if(e&&(e.urls||e.url)){var r=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var n="string"==typeof r;return n&&(r=[r]),r=r.filter((function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||i?0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp"):(i=!0,!0)})),delete e.url,e.urls=n?r[0]:r,!!r.length}}))}(i.iceServers||[],t),this._iceGatherers=[],i.iceCandidatePoolSize)for(var s=i.iceCandidatePoolSize;s>0;s--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:i.iceServers,gatherPolicy:i.iceTransportPolicy}));else i.iceCandidatePoolSize=0;this._config=i,this.transceivers=[],this._sdpSessionId=r.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(d.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(d.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),d.prototype.onicecandidate=null,d.prototype.onaddstream=null,d.prototype.ontrack=null,d.prototype.onremovestream=null,d.prototype.onsignalingstatechange=null,d.prototype.oniceconnectionstatechange=null,d.prototype.onconnectionstatechange=null,d.prototype.onicegatheringstatechange=null,d.prototype.onnegotiationneeded=null,d.prototype.ondatachannel=null,d.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},d.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},d.prototype.getConfiguration=function(){return this._config},d.prototype.getLocalStreams=function(){return this.localStreams},d.prototype.getRemoteStreams=function(){return this.remoteStreams},d.prototype._createTransceiver=function(e,t){var i=this.transceivers.length>0,r={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&i)r.iceTransport=this.transceivers[0].iceTransport,r.dtlsTransport=this.transceivers[0].dtlsTransport;else{var n=this._createIceAndDtlsTransports();r.iceTransport=n.iceTransport,r.dtlsTransport=n.dtlsTransport}return t||this.transceivers.push(r),r},d.prototype.addTrack=function(t,i){if(this._isClosed)throw c("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var r;if(this.transceivers.find((function(e){return e.track===t})))throw c("InvalidAccessError","Track already exists.");for(var n=0;n<this.transceivers.length;n++)this.transceivers[n].track||this.transceivers[n].kind!==t.kind||(r=this.transceivers[n]);return r||(r=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(i)&&this.localStreams.push(i),r.track=t,r.stream=i,r.rtpSender=new e.RTCRtpSender(t,r.dtlsTransport),r.rtpSender},d.prototype.addStream=function(e){var i=this;if(t>=15025)e.getTracks().forEach((function(t){i.addTrack(t,e)}));else{var r=e.clone();e.getTracks().forEach((function(e,t){var i=r.getTracks()[t];e.addEventListener("enabled",(function(e){i.enabled=e.enabled}))})),r.getTracks().forEach((function(e){i.addTrack(e,r)}))}},d.prototype.removeTrack=function(t){if(this._isClosed)throw c("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var i=this.transceivers.find((function(e){return e.rtpSender===t}));if(!i)throw c("InvalidAccessError","Sender was not created by this connection.");var r=i.stream;i.rtpSender.stop(),i.rtpSender=null,i.track=null,i.stream=null,-1===this.transceivers.map((function(e){return e.stream})).indexOf(r)&&this.localStreams.indexOf(r)>-1&&this.localStreams.splice(this.localStreams.indexOf(r),1),this._maybeFireNegotiationNeeded()},d.prototype.removeStream=function(e){var t=this;e.getTracks().forEach((function(e){var i=t.getSenders().find((function(t){return t.track===e}));i&&t.removeTrack(i)}))},d.prototype.getSenders=function(){return this.transceivers.filter((function(e){return!!e.rtpSender})).map((function(e){return e.rtpSender}))},d.prototype.getReceivers=function(){return this.transceivers.filter((function(e){return!!e.rtpReceiver})).map((function(e){return e.rtpReceiver}))},d.prototype._createIceGatherer=function(t,i){var r=this;if(i&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var n=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(n,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var i=!e.candidate||0===Object.keys(e.candidate).length;n.state=i?"completed":"gathering",null!==r.transceivers[t].bufferedCandidateEvents&&r.transceivers[t].bufferedCandidateEvents.push(e)},n.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),n},d.prototype._gather=function(t,i){var n=this,a=this.transceivers[i].iceGatherer;if(!a.onlocalcandidate){var s=this.transceivers[i].bufferedCandidateEvents;this.transceivers[i].bufferedCandidateEvents=null,a.removeEventListener("localcandidate",this.transceivers[i].bufferCandidates),a.onlocalcandidate=function(e){if(!(n.usingBundle&&i>0)){var s=new Event("icecandidate");s.candidate={sdpMid:t,sdpMLineIndex:i};var o=e.candidate,c=!o||0===Object.keys(o).length;if(c)"new"!==a.state&&"gathering"!==a.state||(a.state="completed");else{"new"===a.state&&(a.state="gathering"),o.component=1,o.ufrag=a.getLocalParameters().usernameFragment;var l=r.writeCandidate(o);s.candidate=Object.assign(s.candidate,r.parseCandidate(l)),s.candidate.candidate=l,s.candidate.toJSON=function(){return{candidate:s.candidate.candidate,sdpMid:s.candidate.sdpMid,sdpMLineIndex:s.candidate.sdpMLineIndex,usernameFragment:s.candidate.usernameFragment}}}var d=r.getMediaSections(n._localDescription.sdp);d[s.candidate.sdpMLineIndex]+=c?"a=end-of-candidates\r\n":"a="+s.candidate.candidate+"\r\n",n._localDescription.sdp=r.getDescription(n._localDescription.sdp)+d.join("");var u=n.transceivers.every((function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state}));"gathering"!==n.iceGatheringState&&(n.iceGatheringState="gathering",n._emitGatheringStateChange()),c||n._dispatchEvent("icecandidate",s),u&&(n._dispatchEvent("icecandidate",new Event("icecandidate")),n.iceGatheringState="complete",n._emitGatheringStateChange())}},e.setTimeout((function(){s.forEach((function(e){a.onlocalcandidate(e)}))}),0)}},d.prototype._createIceAndDtlsTransports=function(){var t=this,i=new e.RTCIceTransport(null);i.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState()};var r=new e.RTCDtlsTransport(i);return r.ondtlsstatechange=function(){t._updateConnectionState()},r.onerror=function(){Object.defineProperty(r,"state",{value:"failed",writable:!0}),t._updateConnectionState()},{iceTransport:i,dtlsTransport:r}},d.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var i=this.transceivers[e].iceTransport;i&&(delete i.onicestatechange,delete this.transceivers[e].iceTransport);var r=this.transceivers[e].dtlsTransport;r&&(delete r.ondtlsstatechange,delete r.onerror,delete this.transceivers[e].dtlsTransport)},d.prototype._transceive=function(e,i,n){var s=a(e.localCapabilities,e.remoteCapabilities);i&&e.rtpSender&&(s.encodings=e.sendEncodingParameters,s.rtcp={cname:r.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(s.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(s)),n&&e.rtpReceiver&&s.codecs.length>0&&("video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach((function(e){delete e.rtx})),e.recvEncodingParameters.length?s.encodings=e.recvEncodingParameters:s.encodings=[{}],s.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(s.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(s.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(s))},d.prototype.setLocalDescription=function(e){var t,i,n=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(c("TypeError",'Unsupported type "'+e.type+'"'));if(!s("setLocalDescription",e.type,n.signalingState)||n._isClosed)return Promise.reject(c("InvalidStateError","Can not set local "+e.type+" in state "+n.signalingState));if("offer"===e.type)t=r.splitSections(e.sdp),i=t.shift(),t.forEach((function(e,t){var i=r.parseRtpParameters(e);n.transceivers[t].localCapabilities=i})),n.transceivers.forEach((function(e,t){n._gather(e.mid,t)}));else if("answer"===e.type){t=r.splitSections(n._remoteDescription.sdp),i=t.shift();var o=r.matchPrefix(i,"a=ice-lite").length>0;t.forEach((function(e,t){var s=n.transceivers[t],c=s.iceGatherer,l=s.iceTransport,d=s.dtlsTransport,u=s.localCapabilities,h=s.remoteCapabilities;if(!(r.isRejected(e)&&0===r.matchPrefix(e,"a=bundle-only").length)&&!s.rejected){var p=r.getIceParameters(e,i),_=r.getDtlsParameters(e,i);o&&(_.role="server"),n.usingBundle&&0!==t||(n._gather(s.mid,t),"new"===l.state&&l.start(c,p,o?"controlling":"controlled"),"new"===d.state&&d.start(_));var m=a(u,h);n._transceive(s,m.codecs.length>0,!1)}}))}return n._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?n._updateSignalingState("have-local-offer"):n._updateSignalingState("stable"),Promise.resolve()},d.prototype.setRemoteDescription=function(n){var d=this;if(-1===["offer","answer"].indexOf(n.type))return Promise.reject(c("TypeError",'Unsupported type "'+n.type+'"'));if(!s("setRemoteDescription",n.type,d.signalingState)||d._isClosed)return Promise.reject(c("InvalidStateError","Can not set remote "+n.type+" in state "+d.signalingState));var u={};d.remoteStreams.forEach((function(e){u[e.id]=e}));var h=[],p=r.splitSections(n.sdp),_=p.shift(),m=r.matchPrefix(_,"a=ice-lite").length>0,f=r.matchPrefix(_,"a=group:BUNDLE ").length>0;d.usingBundle=f;var g=r.matchPrefix(_,"a=ice-options:")[0];return d.canTrickleIceCandidates=!!g&&g.substr(14).split(" ").indexOf("trickle")>=0,p.forEach((function(s,c){var l=r.splitLines(s),p=r.getKind(s),g=r.isRejected(s)&&0===r.matchPrefix(s,"a=bundle-only").length,S=l[0].substr(2).split(" ")[2],v=r.getDirection(s,_),E=r.parseMsid(s),T=r.getMid(s)||r.generateIdentifier();if(g||"application"===p&&("DTLS/SCTP"===S||"UDP/DTLS/SCTP"===S))d.transceivers[c]={mid:T,kind:p,protocol:S,rejected:!0};else{var C,y,I,R,A,P,D,O,b;!g&&d.transceivers[c]&&d.transceivers[c].rejected&&(d.transceivers[c]=d._createTransceiver(p,!0));var N,w,M=r.parseRtpParameters(s);g||(N=r.getIceParameters(s,_),(w=r.getDtlsParameters(s,_)).role="client"),D=r.parseRtpEncodingParameters(s);var k=r.parseRtcpParameters(s),L=r.matchPrefix(s,"a=end-of-candidates",_).length>0,U=r.matchPrefix(s,"a=candidate:").map((function(e){return r.parseCandidate(e)})).filter((function(e){return 1===e.component}));if(("offer"===n.type||"answer"===n.type)&&!g&&f&&c>0&&d.transceivers[c]&&(d._disposeIceAndDtlsTransports(c),d.transceivers[c].iceGatherer=d.transceivers[0].iceGatherer,d.transceivers[c].iceTransport=d.transceivers[0].iceTransport,d.transceivers[c].dtlsTransport=d.transceivers[0].dtlsTransport,d.transceivers[c].rtpSender&&d.transceivers[c].rtpSender.setTransport(d.transceivers[0].dtlsTransport),d.transceivers[c].rtpReceiver&&d.transceivers[c].rtpReceiver.setTransport(d.transceivers[0].dtlsTransport)),"offer"!==n.type||g){if("answer"===n.type&&!g){y=(C=d.transceivers[c]).iceGatherer,I=C.iceTransport,R=C.dtlsTransport,A=C.rtpReceiver,P=C.sendEncodingParameters,O=C.localCapabilities,d.transceivers[c].recvEncodingParameters=D,d.transceivers[c].remoteCapabilities=M,d.transceivers[c].rtcpParameters=k,U.length&&"new"===I.state&&(!m&&!L||f&&0!==c?U.forEach((function(e){o(C.iceTransport,e)})):I.setRemoteCandidates(U)),f&&0!==c||("new"===I.state&&I.start(y,N,"controlling"),"new"===R.state&&R.start(w)),!a(C.localCapabilities,C.remoteCapabilities).codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&C.sendEncodingParameters[0].rtx&&delete C.sendEncodingParameters[0].rtx,d._transceive(C,"sendrecv"===v||"recvonly"===v,"sendrecv"===v||"sendonly"===v),!A||"sendrecv"!==v&&"sendonly"!==v?delete C.rtpReceiver:(b=A.track,E?(u[E.stream]||(u[E.stream]=new e.MediaStream),i(b,u[E.stream]),h.push([b,A,u[E.stream]])):(u.default||(u.default=new e.MediaStream),i(b,u.default),h.push([b,A,u.default])))}}else{(C=d.transceivers[c]||d._createTransceiver(p)).mid=T,C.iceGatherer||(C.iceGatherer=d._createIceGatherer(c,f)),U.length&&"new"===C.iceTransport.state&&(!L||f&&0!==c?U.forEach((function(e){o(C.iceTransport,e)})):C.iceTransport.setRemoteCandidates(U)),O=e.RTCRtpReceiver.getCapabilities(p),t<15019&&(O.codecs=O.codecs.filter((function(e){return"rtx"!==e.name}))),P=C.sendEncodingParameters||[{ssrc:1001*(2*c+2)}];var x,V=!1;if("sendrecv"===v||"sendonly"===v){if(V=!C.rtpReceiver,A=C.rtpReceiver||new e.RTCRtpReceiver(C.dtlsTransport,p),V)b=A.track,E&&"-"===E.stream||(E?(u[E.stream]||(u[E.stream]=new e.MediaStream,Object.defineProperty(u[E.stream],"id",{get:function(){return E.stream}})),Object.defineProperty(b,"id",{get:function(){return E.track}}),x=u[E.stream]):(u.default||(u.default=new e.MediaStream),x=u.default)),x&&(i(b,x),C.associatedRemoteMediaStreams.push(x)),h.push([b,A,x])}else C.rtpReceiver&&C.rtpReceiver.track&&(C.associatedRemoteMediaStreams.forEach((function(t){var i=t.getTracks().find((function(e){return e.id===C.rtpReceiver.track.id}));i&&function(t,i){i.removeTrack(t),i.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}))}(i,t)})),C.associatedRemoteMediaStreams=[]);C.localCapabilities=O,C.remoteCapabilities=M,C.rtpReceiver=A,C.rtcpParameters=k,C.sendEncodingParameters=P,C.recvEncodingParameters=D,d._transceive(d.transceivers[c],!1,V)}}})),void 0===d._dtlsRole&&(d._dtlsRole="offer"===n.type?"active":"passive"),d._remoteDescription={type:n.type,sdp:n.sdp},"offer"===n.type?d._updateSignalingState("have-remote-offer"):d._updateSignalingState("stable"),Object.keys(u).forEach((function(t){var i=u[t];if(i.getTracks().length){if(-1===d.remoteStreams.indexOf(i)){d.remoteStreams.push(i);var r=new Event("addstream");r.stream=i,e.setTimeout((function(){d._dispatchEvent("addstream",r)}))}h.forEach((function(e){var t=e[0],r=e[1];i.id===e[2].id&&l(d,t,r,[i])}))}})),h.forEach((function(e){e[2]||l(d,e[0],e[1],[])})),e.setTimeout((function(){d&&d.transceivers&&d.transceivers.forEach((function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))}))}),4e3),Promise.resolve()},d.prototype.close=function(){this.transceivers.forEach((function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()})),this._isClosed=!0,this._updateSignalingState("closed")},d.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},d.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout((function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}}),0))},d.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&!e.rejected&&t[e.iceTransport.state]++})),e="new",t.failed>0?e="failed":t.checking>0?e="checking":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0?e="connected":t.completed>0&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var i=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",i)}},d.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&e.dtlsTransport&&!e.rejected&&(t[e.iceTransport.state]++,t[e.dtlsTransport.state]++)})),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0&&(e="connected"),e!==this.connectionState){this.connectionState=e;var i=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",i)}},d.prototype.createOffer=function(){var i=this;if(i._isClosed)return Promise.reject(c("InvalidStateError","Can not call createOffer after close"));var a=i.transceivers.filter((function(e){return"audio"===e.kind})).length,s=i.transceivers.filter((function(e){return"video"===e.kind})).length,o=arguments[0];if(o){if(o.mandatory||o.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==o.offerToReceiveAudio&&(a=!0===o.offerToReceiveAudio?1:!1===o.offerToReceiveAudio?0:o.offerToReceiveAudio),void 0!==o.offerToReceiveVideo&&(s=!0===o.offerToReceiveVideo?1:!1===o.offerToReceiveVideo?0:o.offerToReceiveVideo)}for(i.transceivers.forEach((function(e){"audio"===e.kind?--a<0&&(e.wantReceive=!1):"video"===e.kind&&--s<0&&(e.wantReceive=!1)}));a>0||s>0;)a>0&&(i._createTransceiver("audio"),a--),s>0&&(i._createTransceiver("video"),s--);var l=r.writeSessionBoilerplate(i._sdpSessionId,i._sdpSessionVersion++);i.transceivers.forEach((function(n,a){var s=n.track,o=n.kind,c=n.mid||r.generateIdentifier();n.mid=c,n.iceGatherer||(n.iceGatherer=i._createIceGatherer(a,i.usingBundle));var l=e.RTCRtpSender.getCapabilities(o);t<15019&&(l.codecs=l.codecs.filter((function(e){return"rtx"!==e.name}))),l.codecs.forEach((function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),n.remoteCapabilities&&n.remoteCapabilities.codecs&&n.remoteCapabilities.codecs.forEach((function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)}))})),l.headerExtensions.forEach((function(e){(n.remoteCapabilities&&n.remoteCapabilities.headerExtensions||[]).forEach((function(t){e.uri===t.uri&&(e.id=t.id)}))}));var d=n.sendEncodingParameters||[{ssrc:1001*(2*a+1)}];s&&t>=15019&&"video"===o&&!d[0].rtx&&(d[0].rtx={ssrc:d[0].ssrc+1}),n.wantReceive&&(n.rtpReceiver=new e.RTCRtpReceiver(n.dtlsTransport,o)),n.localCapabilities=l,n.sendEncodingParameters=d})),"max-compat"!==i._config.bundlePolicy&&(l+="a=group:BUNDLE "+i.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),l+="a=ice-options:trickle\r\n",i.transceivers.forEach((function(e,t){l+=n(e,e.localCapabilities,"offer",e.stream,i._dtlsRole),l+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===i.iceGatheringState||0!==t&&i.usingBundle||(e.iceGatherer.getLocalCandidates().forEach((function(e){e.component=1,l+="a="+r.writeCandidate(e)+"\r\n"})),"completed"===e.iceGatherer.state&&(l+="a=end-of-candidates\r\n"))}));var d=new e.RTCSessionDescription({type:"offer",sdp:l});return Promise.resolve(d)},d.prototype.createAnswer=function(){var i=this;if(i._isClosed)return Promise.reject(c("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==i.signalingState&&"have-local-pranswer"!==i.signalingState)return Promise.reject(c("InvalidStateError","Can not call createAnswer in signalingState "+i.signalingState));var s=r.writeSessionBoilerplate(i._sdpSessionId,i._sdpSessionVersion++);i.usingBundle&&(s+="a=group:BUNDLE "+i.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),s+="a=ice-options:trickle\r\n";var o=r.getMediaSections(i._remoteDescription.sdp).length;i.transceivers.forEach((function(e,r){if(!(r+1>o)){if(e.rejected)return"application"===e.kind?"DTLS/SCTP"===e.protocol?s+="m=application 0 DTLS/SCTP 5000\r\n":s+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?s+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(s+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(s+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var c;if(e.stream)"audio"===e.kind?c=e.stream.getAudioTracks()[0]:"video"===e.kind&&(c=e.stream.getVideoTracks()[0]),c&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1});var l=a(e.localCapabilities,e.remoteCapabilities);!l.codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,s+=n(e,l,"answer",e.stream,i._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(s+="a=rtcp-rsize\r\n")}}));var l=new e.RTCSessionDescription({type:"answer",sdp:s});return Promise.resolve(l)},d.prototype.addIceCandidate=function(e){var t,i=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise((function(n,a){if(!i._remoteDescription)return a(c("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var s=e.sdpMLineIndex;if(e.sdpMid)for(var l=0;l<i.transceivers.length;l++)if(i.transceivers[l].mid===e.sdpMid){s=l;break}var d=i.transceivers[s];if(!d)return a(c("OperationError","Can not add ICE candidate"));if(d.rejected)return n();var u=Object.keys(e.candidate).length>0?r.parseCandidate(e.candidate):{};if("tcp"===u.protocol&&(0===u.port||9===u.port))return n();if(u.component&&1!==u.component)return n();if((0===s||s>0&&d.iceTransport!==i.transceivers[0].iceTransport)&&!o(d.iceTransport,u))return a(c("OperationError","Can not add ICE candidate"));var h=e.candidate.trim();0===h.indexOf("a=")&&(h=h.substr(2)),(t=r.getMediaSections(i._remoteDescription.sdp))[s]+="a="+(u.type?h:"end-of-candidates")+"\r\n",i._remoteDescription.sdp=r.getDescription(i._remoteDescription.sdp)+t.join("")}else for(var p=0;p<i.transceivers.length&&(i.transceivers[p].rejected||(i.transceivers[p].iceTransport.addRemoteCandidate({}),(t=r.getMediaSections(i._remoteDescription.sdp))[p]+="a=end-of-candidates\r\n",i._remoteDescription.sdp=r.getDescription(i._remoteDescription.sdp)+t.join(""),!i.usingBundle));p++);n()}))},d.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var i=null;if(this.transceivers.forEach((function(e){e.rtpSender&&e.rtpSender.track===t?i=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(i=e.rtpReceiver)})),!i)throw c("InvalidAccessError","Invalid selector.");return i.getStats()}var r=[];return this.transceivers.forEach((function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach((function(t){e[t]&&r.push(e[t].getStats())}))})),Promise.all(r).then((function(e){var t=new Map;return e.forEach((function(e){e.forEach((function(e){t.set(e.id,e)}))})),t}))};["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach((function(t){var i=e[t];if(i&&i.prototype&&i.prototype.getStats){var r=i.prototype.getStats;i.prototype.getStats=function(){return r.apply(this).then((function(e){var t=new Map;return Object.keys(e).forEach((function(i){var r;e[i].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(r=e[i]).type]||r.type,t.set(i,e[i])})),t}))}}}));var u=["createOffer","createAnswer"];return u.forEach((function(e){var t=d.prototype[e];d.prototype[e]=function(){var e=arguments;return"function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then((function(t){"function"==typeof e[0]&&e[0].apply(null,[t])}),(function(t){"function"==typeof e[1]&&e[1].apply(null,[t])})):t.apply(this,arguments)}})),(u=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach((function(e){var t=d.prototype[e];d.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)}),(function(t){"function"==typeof e[2]&&e[2].apply(null,[t])})):t.apply(this,arguments)}})),["getStats"].forEach((function(e){var t=d.prototype[e];d.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)})):t.apply(this,arguments)}})),d}},337963:e=>{"use strict";var t={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((function(e){return e.trim()}))},t.splitSections=function(e){return e.split("\nm=").map((function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"}))},t.getDescription=function(e){var i=t.splitSections(e);return i&&i[0]},t.getMediaSections=function(e){var i=t.splitSections(e);return i.shift(),i},t.matchPrefix=function(e,i){return t.splitLines(e).filter((function(e){return 0===e.indexOf(i)}))},t.parseCandidate=function(e){for(var t,i={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},r=8;r<t.length;r+=2)switch(t[r]){case"raddr":i.relatedAddress=t[r+1];break;case"rport":i.relatedPort=parseInt(t[r+1],10);break;case"tcptype":i.tcpType=t[r+1];break;case"ufrag":i.ufrag=t[r+1],i.usernameFragment=t[r+1];break;default:i[t[r]]=t[r+1]}return i},t.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var i=e.type;return t.push("typ"),t.push(i),"host"!==i&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substr(14).split(" ")},t.parseRtpMap=function(e){var t=e.substr(9).split(" "),i={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),i.name=t[0],i.clockRate=parseInt(t[1],10),i.channels=3===t.length?parseInt(t[2],10):1,i.numChannels=i.channels,i},t.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var i=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==i?"/"+i:"")+"\r\n"},t.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},t.parseFmtp=function(e){for(var t,i={},r=e.substr(e.indexOf(" ")+1).split(";"),n=0;n<r.length;n++)i[(t=r[n].trim().split("="))[0].trim()]=t[1];return i},t.writeFmtp=function(e){var t="",i=e.payloadType;if(void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var r=[];Object.keys(e.parameters).forEach((function(t){e.parameters[t]?r.push(t+"="+e.parameters[t]):r.push(t)})),t+="a=fmtp:"+i+" "+r.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){var t="",i=e.payloadType;return void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((function(e){t+="a=rtcp-fb:"+i+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},t.parseSsrcMedia=function(e){var t=e.indexOf(" "),i={ssrc:parseInt(e.substr(7,t-7),10)},r=e.indexOf(":",t);return r>-1?(i.attribute=e.substr(t+1,r-t-1),i.value=e.substr(r+1)):i.attribute=e.substr(t+1),i},t.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((function(e){return parseInt(e,10)}))}},t.getMid=function(e){var i=t.matchPrefix(e,"a=mid:")[0];if(i)return i.substr(6)},t.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},t.getDtlsParameters=function(e,i){return{role:"auto",fingerprints:t.matchPrefix(e+i,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){var i="a=setup:"+t+"\r\n";return e.fingerprints.forEach((function(e){i+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),i},t.parseCryptoLine=function(e){var t=e.substr(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;var t=e.substr(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,i){return t.matchPrefix(e+i,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,i){var r=t.matchPrefix(e+i,"a=ice-ufrag:")[0],n=t.matchPrefix(e+i,"a=ice-pwd:")[0];return r&&n?{usernameFragment:r.substr(12),password:n.substr(10)}:null},t.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},t.parseRtpParameters=function(e){for(var i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=t.splitLines(e)[0].split(" "),n=3;n<r.length;n++){var a=r[n],s=t.matchPrefix(e,"a=rtpmap:"+a+" ")[0];if(s){var o=t.parseRtpMap(s),c=t.matchPrefix(e,"a=fmtp:"+a+" ");switch(o.parameters=c.length?t.parseFmtp(c[0]):{},o.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+a+" ").map(t.parseRtcpFb),i.codecs.push(o),o.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(o.name.toUpperCase())}}}return t.matchPrefix(e,"a=extmap:").forEach((function(e){i.headerExtensions.push(t.parseExtmap(e))})),i},t.writeRtpDescription=function(e,i){var r="";r+="m="+e+" ",r+=i.codecs.length>0?"9":"0",r+=" UDP/TLS/RTP/SAVPF ",r+=i.codecs.map((function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType})).join(" ")+"\r\n",r+="c=IN IP4 0.0.0.0\r\n",r+="a=rtcp:9 IN IP4 0.0.0.0\r\n",i.codecs.forEach((function(e){r+=t.writeRtpMap(e),r+=t.writeFmtp(e),r+=t.writeRtcpFb(e)}));var n=0;return i.codecs.forEach((function(e){e.maxptime>n&&(n=e.maxptime)})),n>0&&(r+="a=maxptime:"+n+"\r\n"),r+="a=rtcp-mux\r\n",i.headerExtensions&&i.headerExtensions.forEach((function(e){r+=t.writeExtmap(e)})),r},t.parseRtpEncodingParameters=function(e){var i,r=[],n=t.parseRtpParameters(e),a=-1!==n.fecMechanisms.indexOf("RED"),s=-1!==n.fecMechanisms.indexOf("ULPFEC"),o=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute})),c=o.length>0&&o[0].ssrc,l=t.matchPrefix(e,"a=ssrc-group:FID").map((function(e){return e.substr(17).split(" ").map((function(e){return parseInt(e,10)}))}));l.length>0&&l[0].length>1&&l[0][0]===c&&(i=l[0][1]),n.codecs.forEach((function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var t={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&i&&(t.rtx={ssrc:i}),r.push(t),a&&((t=JSON.parse(JSON.stringify(t))).fec={ssrc:c,mechanism:s?"red+ulpfec":"red"},r.push(t))}})),0===r.length&&c&&r.push({ssrc:c});var d=t.matchPrefix(e,"b=");return d.length&&(d=0===d[0].indexOf("b=TIAS:")?parseInt(d[0].substr(7),10):0===d[0].indexOf("b=AS:")?1e3*parseInt(d[0].substr(5),10)*.95-16e3:void 0,r.forEach((function(e){e.maxBitrate=d}))),r},t.parseRtcpParameters=function(e){var i={},r=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute}))[0];r&&(i.cname=r.value,i.ssrc=r.ssrc);var n=t.matchPrefix(e,"a=rtcp-rsize");i.reducedSize=n.length>0,i.compound=0===n.length;var a=t.matchPrefix(e,"a=rtcp-mux");return i.mux=a.length>0,i},t.parseMsid=function(e){var i,r=t.matchPrefix(e,"a=msid:");if(1===r.length)return{stream:(i=r[0].substr(7).split(" "))[0],track:i[1]};var n=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return"msid"===e.attribute}));return n.length>0?{stream:(i=n[0].value.split(" "))[0],track:i[1]}:void 0},t.parseSctpDescription=function(e){var i,r=t.parseMLine(e),n=t.matchPrefix(e,"a=max-message-size:");n.length>0&&(i=parseInt(n[0].substr(19),10)),isNaN(i)&&(i=65536);var a=t.matchPrefix(e,"a=sctp-port:");if(a.length>0)return{port:parseInt(a[0].substr(12),10),protocol:r.fmt,maxMessageSize:i};if(t.matchPrefix(e,"a=sctpmap:").length>0){var s=t.matchPrefix(e,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(s[0],10),protocol:s[1],maxMessageSize:i}}},t.writeSctpDescription=function(e,t){var i=[];return i="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&i.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),i.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,21)},t.writeSessionBoilerplate=function(e,i,r){var n=void 0!==i?i:2;return"v=0\r\no="+(r||"thisisadapterortc")+" "+(e||t.generateSessionId())+" "+n+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.writeMediaSection=function(e,i,r,n){var a=t.writeRtpDescription(e.kind,i);if(a+=t.writeIceParameters(e.iceGatherer.getLocalParameters()),a+=t.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":"active"),a+="a=mid:"+e.mid+"\r\n",e.direction?a+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?a+="a=sendrecv\r\n":e.rtpSender?a+="a=sendonly\r\n":e.rtpReceiver?a+="a=recvonly\r\n":a+="a=inactive\r\n",e.rtpSender){var s="msid:"+n.id+" "+e.rtpSender.track.id+"\r\n";a+="a="+s,a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+s,e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+s,a+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+t.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+t.localCName+"\r\n"),a},t.getDirection=function(e,i){for(var r=t.splitLines(e),n=0;n<r.length;n++)switch(r[n]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[n].substr(2)}return i?t.getDirection(i):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substr(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){var i=t.splitLines(e)[0].substr(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},t.parseOLine=function(e){var i=t.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var i=t.splitLines(e),r=0;r<i.length;r++)if(i[r].length<2||"="!==i[r].charAt(1))return!1;return!0},e.exports=t},578243:(e,t,i)=>{"use strict";var r=i(47654),n=i(698243),a=function(){function e(e){this.bytes=e}return e.prototype.write=function(e,t){return e.set(this.bytes,t),t+this.bytes.length},e.prototype.countSize=function(){return this.bytes.length},e}();t.Value=a;var s=function(){function e(e,i,r){this.id=e,this.children=i;var a=this.children.reduce((function(e,t){return e+t.countSize()}),0);this.sizeMetaData=r?t.UNKNOWN_SIZE:t.vintEncode(n.numberToByteArray(a,t.getEBMLByteLength(a))),this.size=this.id.length+this.sizeMetaData.length+a}return e.prototype.write=function(e,t){return e.set(this.id,t),e.set(this.sizeMetaData,t+this.id.length),this.children.reduce((function(t,i){return i.write(e,t)}),t+this.id.length+this.sizeMetaData.length)},e.prototype.countSize=function(){return this.size},e}();t.Element=s,t.bytes=r((function(e){return new a(e)})),t.number=r((function(e){return t.bytes(n.numberToByteArray(e))})),t.vintEncodedNumber=r((function(e){return t.bytes(t.vintEncode(n.numberToByteArray(e,t.getEBMLByteLength(e))))})),t.string=r((function(e){return t.bytes(n.stringToByteArray(e))})),t.element=function(e,t){return new s(e,Array.isArray(t)?t:[t],!1)},t.unknownSizeElement=function(e,t){return new s(e,Array.isArray(t)?t:[t],!0)},t.build=function(e){var t=new Uint8Array(e.countSize());return e.write(t,0),t},t.getEBMLByteLength=function(e){if(e<127)return 1;if(e<16383)return 2;if(e<2097151)return 3;if(e<268435455)return 4;if(e<34359738367)return 5;if(e<4398046511103)return 6;if(e<562949953421311)return 7;if(e<9007199254740992)return 8;throw e<72057594037927940?new Error("EBMLgetEBMLByteLength: number exceeds Number.MAX_SAFE_INTEGER"):new Error("EBMLgetEBMLByteLength: data size must be less than or equal to "+(Math.pow(2,56)-2))},t.UNKNOWN_SIZE=new Uint8Array([1,255,255,255,255,255,255,255]),t.vintEncode=function(e){return e[0]=t.getSizeMask(e.length)|e[0],e},t.getSizeMask=function(e){return 128>>e-1}},610668:(e,t)=>{"use strict";t.ID={EBML:Uint8Array.of(26,69,223,163),EBMLVersion:Uint8Array.of(66,134),EBMLReadVersion:Uint8Array.of(66,247),EBMLMaxIDLength:Uint8Array.of(66,242),EBMLMaxSizeLength:Uint8Array.of(66,243),DocType:Uint8Array.of(66,130),DocTypeVersion:Uint8Array.of(66,135),DocTypeReadVersion:Uint8Array.of(66,133),Void:Uint8Array.of(236),CRC32:Uint8Array.of(191),Segment:Uint8Array.of(24,83,128,103),SeekHead:Uint8Array.of(17,77,155,116),Seek:Uint8Array.of(77,187),SeekID:Uint8Array.of(83,171),SeekPosition:Uint8Array.of(83,172),Info:Uint8Array.of(21,73,169,102),SegmentUID:Uint8Array.of(115,164),SegmentFilename:Uint8Array.of(115,132),PrevUID:Uint8Array.of(60,185,35),PrevFilename:Uint8Array.of(60,131,171),NextUID:Uint8Array.of(62,185,35),NextFilename:Uint8Array.of(62,131,187),SegmentFamily:Uint8Array.of(68,68),ChapterTranslate:Uint8Array.of(105,36),ChapterTranslateEditionUID:Uint8Array.of(105,252),ChapterTranslateCodec:Uint8Array.of(105,191),ChapterTranslateID:Uint8Array.of(105,165),TimecodeScale:Uint8Array.of(42,215,177),Duration:Uint8Array.of(68,137),DateUTC:Uint8Array.of(68,97),Title:Uint8Array.of(123,169),MuxingApp:Uint8Array.of(77,128),WritingApp:Uint8Array.of(87,65),Cluster:Uint8Array.of(31,67,182,117),Timecode:Uint8Array.of(231),SilentTracks:Uint8Array.of(88,84),SilentTrackNumber:Uint8Array.of(88,215),Position:Uint8Array.of(167),PrevSize:Uint8Array.of(171),SimpleBlock:Uint8Array.of(163),BlockGroup:Uint8Array.of(160),Block:Uint8Array.of(161),BlockAdditions:Uint8Array.of(117,161),BlockMore:Uint8Array.of(166),BlockAddID:Uint8Array.of(238),BlockAdditional:Uint8Array.of(165),BlockDuration:Uint8Array.of(155),ReferencePriority:Uint8Array.of(250),ReferenceBlock:Uint8Array.of(251),CodecState:Uint8Array.of(164),DiscardPadding:Uint8Array.of(117,162),Slices:Uint8Array.of(142),TimeSlice:Uint8Array.of(232),LaceNumber:Uint8Array.of(204),Tracks:Uint8Array.of(22,84,174,107),TrackEntry:Uint8Array.of(174),TrackNumber:Uint8Array.of(215),TrackUID:Uint8Array.of(115,197),TrackType:Uint8Array.of(131),FlagEnabled:Uint8Array.of(185),FlagDefault:Uint8Array.of(136),FlagForced:Uint8Array.of(85,170),FlagLacing:Uint8Array.of(156),MinCache:Uint8Array.of(109,231),MaxCache:Uint8Array.of(109,248),DefaultDuration:Uint8Array.of(35,227,131),DefaultDecodedFieldDuration:Uint8Array.of(35,78,122),MaxBlockAdditionID:Uint8Array.of(85,238),Name:Uint8Array.of(83,110),Language:Uint8Array.of(34,181,156),CodecID:Uint8Array.of(134),CodecPrivate:Uint8Array.of(99,162),CodecName:Uint8Array.of(37,134,136),AttachmentLink:Uint8Array.of(116,70),CodecDecodeAll:Uint8Array.of(170),TrackOverlay:Uint8Array.of(111,171),CodecDelay:Uint8Array.of(86,170),SeekPreRoll:Uint8Array.of(86,187),TrackTranslate:Uint8Array.of(102,36),TrackTranslateEditionUID:Uint8Array.of(102,252),TrackTranslateCodec:Uint8Array.of(102,191),TrackTranslateTrackID:Uint8Array.of(102,165),Video:Uint8Array.of(224),FlagInterlaced:Uint8Array.of(154),FieldOrder:Uint8Array.of(157),StereoMode:Uint8Array.of(83,184),AlphaMode:Uint8Array.of(83,192),PixelWidth:Uint8Array.of(176),PixelHeight:Uint8Array.of(186),PixelCropBottom:Uint8Array.of(84,170),PixelCropTop:Uint8Array.of(84,187),PixelCropLeft:Uint8Array.of(84,204),PixelCropRight:Uint8Array.of(84,221),DisplayWidth:Uint8Array.of(84,176),DisplayHeight:Uint8Array.of(84,186),DisplayUnit:Uint8Array.of(84,178),AspectRatioType:Uint8Array.of(84,179),ColourSpace:Uint8Array.of(46,181,36),Colour:Uint8Array.of(85,176),MatrixCoefficients:Uint8Array.of(85,177),BitsPerChannel:Uint8Array.of(85,178),ChromaSubsamplingHorz:Uint8Array.of(85,179),ChromaSubsamplingVert:Uint8Array.of(85,180),CbSubsamplingHorz:Uint8Array.of(85,181),CbSubsamplingVert:Uint8Array.of(85,182),ChromaSitingHorz:Uint8Array.of(85,183),ChromaSitingVert:Uint8Array.of(85,184),Range:Uint8Array.of(85,185),TransferCharacteristics:Uint8Array.of(85,186),Primaries:Uint8Array.of(85,187),MaxCLL:Uint8Array.of(85,188),MaxFALL:Uint8Array.of(85,189),MasteringMetadata:Uint8Array.of(85,208),PrimaryRChromaticityX:Uint8Array.of(85,209),PrimaryRChromaticityY:Uint8Array.of(85,210),PrimaryGChromaticityX:Uint8Array.of(85,211),PrimaryGChromaticityY:Uint8Array.of(85,212),PrimaryBChromaticityX:Uint8Array.of(85,213),PrimaryBChromaticityY:Uint8Array.of(85,214),WhitePointChromaticityX:Uint8Array.of(85,215),WhitePointChromaticityY:Uint8Array.of(85,216),LuminanceMax:Uint8Array.of(85,217),LuminanceMin:Uint8Array.of(85,218),Audio:Uint8Array.of(225),SamplingFrequency:Uint8Array.of(181),OutputSamplingFrequency:Uint8Array.of(120,181),Channels:Uint8Array.of(159),BitDepth:Uint8Array.of(98,100),TrackOperation:Uint8Array.of(226),TrackCombinePlanes:Uint8Array.of(227),TrackPlane:Uint8Array.of(228),TrackPlaneUID:Uint8Array.of(229),TrackPlaneType:Uint8Array.of(230),TrackJoinBlocks:Uint8Array.of(233),TrackJoinUID:Uint8Array.of(237),ContentEncodings:Uint8Array.of(109,128),ContentEncoding:Uint8Array.of(98,64),ContentEncodingOrder:Uint8Array.of(80,49),ContentEncodingScope:Uint8Array.of(80,50),ContentEncodingType:Uint8Array.of(80,51),ContentCompression:Uint8Array.of(80,52),ContentCompAlgo:Uint8Array.of(66,84),ContentCompSettings:Uint8Array.of(66,85),ContentEncryption:Uint8Array.of(80,53),ContentEncAlgo:Uint8Array.of(71,225),ContentEncKeyID:Uint8Array.of(71,226),ContentSignature:Uint8Array.of(71,227),ContentSigKeyID:Uint8Array.of(71,228),ContentSigAlgo:Uint8Array.of(71,229),ContentSigHashAlgo:Uint8Array.of(71,230),Cues:Uint8Array.of(28,83,187,107),CuePoint:Uint8Array.of(187),CueTime:Uint8Array.of(179),CueTrackPositions:Uint8Array.of(183),CueTrack:Uint8Array.of(247),CueClusterPosition:Uint8Array.of(241),CueRelativePosition:Uint8Array.of(240),CueDuration:Uint8Array.of(178),CueBlockNumber:Uint8Array.of(83,120),CueCodecState:Uint8Array.of(234),CueReference:Uint8Array.of(219),CueRefTime:Uint8Array.of(150),Attachments:Uint8Array.of(25,65,164,105),AttachedFile:Uint8Array.of(97,167),FileDescription:Uint8Array.of(70,126),FileName:Uint8Array.of(70,110),FileMimeType:Uint8Array.of(70,96),FileData:Uint8Array.of(70,92),FileUID:Uint8Array.of(70,174),Chapters:Uint8Array.of(16,67,167,112),EditionEntry:Uint8Array.of(69,185),EditionUID:Uint8Array.of(69,188),EditionFlagHidden:Uint8Array.of(69,189),EditionFlagDefault:Uint8Array.of(69,219),EditionFlagOrdered:Uint8Array.of(69,221),ChapterAtom:Uint8Array.of(182),ChapterUID:Uint8Array.of(115,196),ChapterStringUID:Uint8Array.of(86,84),ChapterTimeStart:Uint8Array.of(145),ChapterTimeEnd:Uint8Array.of(146),ChapterFlagHidden:Uint8Array.of(152),ChapterFlagEnabled:Uint8Array.of(69,152),ChapterSegmentUID:Uint8Array.of(110,103),ChapterSegmentEditionUID:Uint8Array.of(110,188),ChapterPhysicalEquiv:Uint8Array.of(99,195),ChapterTrack:Uint8Array.of(143),ChapterTrackNumber:Uint8Array.of(137),ChapterDisplay:Uint8Array.of(128),ChapString:Uint8Array.of(133),ChapLanguage:Uint8Array.of(67,124),ChapCountry:Uint8Array.of(67,126),ChapProcess:Uint8Array.of(105,68),ChapProcessCodecID:Uint8Array.of(105,85),ChapProcessPrivate:Uint8Array.of(69,13),ChapProcessCommand:Uint8Array.of(105,17),ChapProcessTime:Uint8Array.of(105,34),ChapProcessData:Uint8Array.of(105,51),Tags:Uint8Array.of(18,84,195,103),Tag:Uint8Array.of(115,115),Targets:Uint8Array.of(99,192),TargetTypeValue:Uint8Array.of(104,202),TargetType:Uint8Array.of(99,202),TagTrackUID:Uint8Array.of(99,197),TagEditionUID:Uint8Array.of(99,201),TagChapterUID:Uint8Array.of(99,196),TagAttachmentUID:Uint8Array.of(99,198),SimpleTag:Uint8Array.of(103,200),TagName:Uint8Array.of(69,163),TagLanguage:Uint8Array.of(68,122),TagDefault:Uint8Array.of(68,132),TagString:Uint8Array.of(68,135),TagBinary:Uint8Array.of(68,133)}},28726:(e,t,i)=>{"use strict";function r(e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i])}r(i(578243)),r(i(610668)),r(i(698243))},698243:(e,t,i)=>{"use strict";var r=i(47654);function n(e){if(e<0)throw new Error("EBML.typedArrayUtils.getNumberByteLength: negative number not implemented");if(e<256)return 1;if(e<65536)return 2;if(e<16777216)return 3;if(e<4294967296)return 4;if(e<1099511627776)return 5;if(e<281474976710656)return 6;if(e<9007199254740992)return 7;throw new Error("EBML.typedArrayUtils.getNumberByteLength: number exceeds Number.MAX_SAFE_INTEGER")}t.numberToByteArray=function(e,t){var i;if(void 0===t&&(t=n(e)),1===t)(i=new DataView(new ArrayBuffer(1))).setUint8(0,e);else if(2===t)(i=new DataView(new ArrayBuffer(2))).setUint16(0,e);else if(3===t)(i=new DataView(new ArrayBuffer(3))).setUint8(0,e>>16),i.setUint16(1,65535&e);else if(4===t)(i=new DataView(new ArrayBuffer(4))).setUint32(0,e);else if(e<4294967295)(i=new DataView(new ArrayBuffer(5))).setUint32(1,e);else if(5===t)(i=new DataView(new ArrayBuffer(5))).setUint8(0,e/4294967296|0),i.setUint32(1,e%4294967296);else if(6===t)(i=new DataView(new ArrayBuffer(6))).setUint16(0,e/4294967296|0),i.setUint32(2,e%4294967296);else if(7===t)(i=new DataView(new ArrayBuffer(7))).setUint8(0,e/281474976710656|0),i.setUint16(1,e/4294967296&65535),i.setUint32(3,e%4294967296);else{if(8!==t)throw new Error("EBML.typedArrayUtils.numberToByteArray: byte length must be less than or equal to 8");(i=new DataView(new ArrayBuffer(8))).setUint32(0,e/4294967296|0),i.setUint32(4,e%4294967296)}return new Uint8Array(i.buffer)},t.stringToByteArray=r((function(e){return Uint8Array.from(Array.from(e).map((function(e){return e.codePointAt(0)})))})),t.getNumberByteLength=n,t.int16Bit=r((function(e){var t=new ArrayBuffer(2);return new DataView(t).setInt16(0,e),new Uint8Array(t)})),t.float32bit=r((function(e){var t=new ArrayBuffer(4);return new DataView(t).setFloat32(0,e),new Uint8Array(t)})),t.dumpBytes=function(e){return Array.from(new Uint8Array(e)).map((function(e){return"0x"+e.toString(16)})).join(", ")}},966752:(e,t,i)=>{"use strict";i.d(t,{default:()=>r});const r=(0,i(728525).adapterFactory)({window:"undefined"==typeof window?void 0:window})},728525:(e,t,i)=>{"use strict";i.d(t,{adapterFactory:()=>d});var r=i(452634),n=i(966528),a=i(637190),s=i(186542),o=i(105176),c=i(42824),l=i(27016);function d({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0}){const i=r.log,d=r.detectBrowser(e),u={browserDetails:d,commonShim:l,extractVersion:r.extractVersion,disableLog:r.disableLog,disableWarnings:r.disableWarnings};switch(d.browser){case"chrome":if(!n||!n.shimPeerConnection||!t.shimChrome)return i("Chrome shim is not included in this adapter release."),u;if(null===d.version)return i("Chrome shim can not determine version, not shimming."),u;i("adapter.js shimming chrome."),u.browserShim=n,n.shimGetUserMedia(e),n.shimMediaStream(e),n.shimPeerConnection(e),n.shimOnTrack(e),n.shimAddTrackRemoveTrack(e),n.shimGetSendersWithDtmf(e),n.shimGetStats(e),n.shimSenderReceiverGetStats(e),n.fixNegotiationNeeded(e),l.shimRTCIceCandidate(e),l.shimConnectionState(e),l.shimMaxMessageSize(e),l.shimSendThrowTypeError(e),l.removeAllowExtmapMixed(e);break;case"firefox":if(!s||!s.shimPeerConnection||!t.shimFirefox)return i("Firefox shim is not included in this adapter release."),u;i("adapter.js shimming firefox."),u.browserShim=s,o.shimGetUserMedia(e),s.shimPeerConnection(e),s.shimOnTrack(e),s.shimRemoveStream(e),s.shimSenderGetStats(e),s.shimReceiverGetStats(e),s.shimRTCDataChannel(e),s.shimAddTransceiver(e),s.shimGetParameters(e),s.shimCreateOffer(e),s.shimCreateAnswer(e),l.shimRTCIceCandidate(e),l.shimConnectionState(e),l.shimMaxMessageSize(e),l.shimSendThrowTypeError(e);break;case"edge":if(!a||!a.shimPeerConnection||!t.shimEdge)return i("MS edge shim is not included in this adapter release."),u;i("adapter.js shimming edge."),u.browserShim=a,a.shimGetUserMedia(e),a.shimGetDisplayMedia(e),a.shimPeerConnection(e),a.shimReplaceTrack(e),l.shimMaxMessageSize(e),l.shimSendThrowTypeError(e);break;case"safari":if(!c||!t.shimSafari)return i("Safari shim is not included in this adapter release."),u;i("adapter.js shimming safari."),u.browserShim=c,c.shimRTCIceServerUrls(e),c.shimCreateOfferLegacy(e),c.shimCallbacksAPI(e),c.shimLocalStreamsAPI(e),c.shimRemoteStreamsAPI(e),c.shimTrackEventTransceiver(e),c.shimGetUserMedia(e),c.shimAudioContext(e),l.shimRTCIceCandidate(e),l.shimMaxMessageSize(e),l.shimSendThrowTypeError(e),l.removeAllowExtmapMixed(e);break;default:i("Unsupported browser!")}return u}},966528:(e,t,i)=>{"use strict";i.r(t),i.d(t,{fixNegotiationNeeded:()=>_,shimAddTrackRemoveTrack:()=>h,shimAddTrackRemoveTrackWithNative:()=>u,shimGetDisplayMedia:()=>a.shimGetDisplayMedia,shimGetSendersWithDtmf:()=>c,shimGetStats:()=>l,shimGetUserMedia:()=>n.shimGetUserMedia,shimMediaStream:()=>s,shimOnTrack:()=>o,shimPeerConnection:()=>p,shimSenderReceiverGetStats:()=>d});var r=i(452634),n=i(551293),a=i(198168);function s(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function o(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",(i=>{let r;r=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===i.track.id)):{track:i.track};const n=new Event("track");n.track=i.track,n.receiver=r,n.transceiver={receiver:r},n.streams=[t.stream],this.dispatchEvent(n)})),t.stream.getTracks().forEach((i=>{let r;r=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===i.id)):{track:i};const n=new Event("track");n.track=i,n.receiver=r,n.transceiver={receiver:r},n.streams=[t.stream],this.dispatchEvent(n)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else r.wrapPeerConnectionEvent(e,"track",(e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e)))}function c(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const i=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){let n=i.apply(this,arguments);return n||(n=t(this,e),this._senders.push(n)),n};const r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){r.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach((e=>{this._senders.push(t(this,e))}))};const r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],r.apply(this,[e]),e.getTracks().forEach((e=>{const t=this._senders.find((t=>t.track===e));t&&this._senders.splice(this._senders.indexOf(t),1)}))}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function l(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,i,r]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const n=function(e){const t={};return e.result().forEach((e=>{const i={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((t=>{i[t]=e.stat(t)})),t[i.id]=i})),t},a=function(e){return new Map(Object.keys(e).map((t=>[t,e[t]])))};if(arguments.length>=2){const r=function(e){i(a(n(e)))};return t.apply(this,[r,e])}return new Promise(((e,i)=>{t.apply(this,[function(t){e(a(n(t)))},i])})).then(i,r)}}function d(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>r.filterStats(t,e.track,!0)))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),r.wrapPeerConnectionEvent(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>r.filterStats(t,e.track,!1)))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,i,r;return this.getSenders().forEach((i=>{i.track===e&&(t?r=!0:t=i)})),this.getReceivers().forEach((t=>(t.track===e&&(i?r=!0:i=t),t.track===e))),r||t&&i?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():i?i.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function u(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((e=>this._shimmedLocalStreams[e][0]))};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){if(!i)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const r=t.apply(this,arguments);return this._shimmedLocalStreams[i.id]?-1===this._shimmedLocalStreams[i.id].indexOf(r)&&this._shimmedLocalStreams[i.id].push(r):this._shimmedLocalStreams[i.id]=[i,r],r};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")}));const t=this.getSenders();i.apply(this,arguments);const r=this.getSenders().filter((e=>-1===t.indexOf(e)));this._shimmedLocalStreams[e.id]=[e].concat(r)};const r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],r.apply(this,arguments)};const n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((t=>{const i=this._shimmedLocalStreams[t].indexOf(e);-1!==i&&this._shimmedLocalStreams[t].splice(i,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]})),n.apply(this,arguments)}}function h(e){if(!e.RTCPeerConnection)return;const t=r.detectBrowser(e);if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return u(e);const i=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=i.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map((e=>this._reverseStreams[e.id]))};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){const i=new e.MediaStream(t.getTracks());this._streams[t.id]=i,this._reverseStreams[i.id]=t,t=i}n.apply(this,[t])};const a=e.RTCPeerConnection.prototype.removeStream;function s(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const r=e._reverseStreams[t],n=e._streams[r.id];i=i.replace(new RegExp(n.id,"g"),r.id)})),new RTCSessionDescription({type:t.type,sdp:i})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},a.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,i){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const r=[].slice.call(arguments,1);if(1!==r.length||!r[0].getTracks().find((e=>e===t)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find((e=>e.track===t)))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const n=this._streams[i.id];if(n)n.addTrack(t),Promise.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const r=new e.MediaStream([t]);this._streams[i.id]=r,this._reverseStreams[r.id]=i,this.addStream(r)}return this.getSenders().find((e=>e.track===t))},["createOffer","createAnswer"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],r={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?i.apply(this,[t=>{const i=s(this,t);e[0].apply(null,[i])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):i.apply(this,arguments).then((e=>s(this,e)))}};e.RTCPeerConnection.prototype[t]=r[t]}));const o=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const r=e._reverseStreams[t],n=e._streams[r.id];i=i.replace(new RegExp(r.id,"g"),n.id)})),new RTCSessionDescription({type:t.type,sdp:i})}(this,arguments[0]),o.apply(this,arguments)):o.apply(this,arguments)};const c=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=c.get.apply(this);return""===e.type?e:s(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach((i=>{this._streams[i].getTracks().find((t=>e.track===t))&&(t=this._streams[i])})),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function p(e){const t=r.detectBrowser(e);if(!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),!e.RTCPeerConnection)return;const i=0===e.RTCPeerConnection.prototype.addIceCandidate.length;t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],r={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=r[t]}));const n=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return i||arguments[0]?t.version<78&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}function _(e){const t=r.detectBrowser(e);r.wrapPeerConnectionEvent(e,"negotiationneeded",(e=>{const i=e.target;if(!(t.version<72||i.getConfiguration&&"plan-b"===i.getConfiguration().sdpSemantics)||"stable"===i.signalingState)return e}))}},198168:(e,t,i)=>{"use strict";function r(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(i){return t(i).then((t=>{const r=i.video&&i.video.width,n=i.video&&i.video.height,a=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:a||3}},r&&(i.video.mandatory.maxWidth=r),n&&(i.video.mandatory.maxHeight=n),e.navigator.mediaDevices.getUserMedia(i)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}i.d(t,{shimGetDisplayMedia:()=>r})},551293:(e,t,i)=>{"use strict";i.d(t,{shimGetUserMedia:()=>a});var r=i(452634);const n=r.log;function a(e){const t=e&&e.navigator;if(!t.mediaDevices)return;const i=r.detectBrowser(e),a=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach((i=>{if("require"===i||"advanced"===i||"mediaSource"===i)return;const r="object"==typeof e[i]?e[i]:{ideal:e[i]};void 0!==r.exact&&"number"==typeof r.exact&&(r.min=r.max=r.exact);const n=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==r.ideal){t.optional=t.optional||[];let e={};"number"==typeof r.ideal?(e[n("min",i)]=r.ideal,t.optional.push(e),e={},e[n("max",i)]=r.ideal,t.optional.push(e)):(e[n("",i)]=r.ideal,t.optional.push(e))}void 0!==r.exact&&"number"!=typeof r.exact?(t.mandatory=t.mandatory||{},t.mandatory[n("",i)]=r.exact):["min","max"].forEach((e=>{void 0!==r[e]&&(t.mandatory=t.mandatory||{},t.mandatory[n(e,i)]=r[e])}))})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},s=function(e,r){if(i.version>=61)return r(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=a(e.audio)}if(e&&"object"==typeof e.video){let s=e.video.facingMode;s=s&&("object"==typeof s?s:{ideal:s});const o=i.version<66;if(s&&("user"===s.exact||"environment"===s.exact||"user"===s.ideal||"environment"===s.ideal)&&(!t.mediaDevices.getSupportedConstraints||!t.mediaDevices.getSupportedConstraints().facingMode||o)){let i;if(delete e.video.facingMode,"environment"===s.exact||"environment"===s.ideal?i=["back","rear"]:"user"!==s.exact&&"user"!==s.ideal||(i=["front"]),i)return t.mediaDevices.enumerateDevices().then((t=>{let o=(t=t.filter((e=>"videoinput"===e.kind))).find((e=>i.some((t=>e.label.toLowerCase().includes(t)))));return!o&&t.length&&i.includes("back")&&(o=t[t.length-1]),o&&(e.video.deviceId=s.exact?{exact:o.deviceId}:{ideal:o.deviceId}),e.video=a(e.video),n("chrome: "+JSON.stringify(e)),r(e)}))}e.video=a(e.video)}return n("chrome: "+JSON.stringify(e)),r(e)},o=function(e){return i.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(t.getUserMedia=function(e,i,r){s(e,(e=>{t.webkitGetUserMedia(e,i,(e=>{r&&r(o(e))}))}))}.bind(t),t.mediaDevices.getUserMedia){const e=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(t){return s(t,(t=>e(t).then((e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach((e=>{e.stop()})),new DOMException("","NotFoundError");return e}),(e=>Promise.reject(o(e))))))}}}},27016:(e,t,i)=>{"use strict";i.r(t),i.d(t,{removeAllowExtmapMixed:()=>d,shimConnectionState:()=>l,shimMaxMessageSize:()=>o,shimRTCIceCandidate:()=>s,shimSendThrowTypeError:()=>c});var r=i(337963),n=i.n(r),a=i(452634);function s(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const i=new t(e),r=n().parseCandidate(e.candidate),a=Object.assign(i,r);return a.toJSON=function(){return{candidate:a.candidate,sdpMid:a.sdpMid,sdpMLineIndex:a.sdpMLineIndex,usernameFragment:a.usernameFragment}},a}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,a.wrapPeerConnectionEvent(e,"icecandidate",(t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t)))}function o(e){if(!e.RTCPeerConnection)return;const t=a.detectBrowser(e);"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(function(e){if(!e||!e.sdp)return!1;const t=n().splitSections(e.sdp);return t.shift(),t.some((e=>{const t=n().parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))}(arguments[0])){const e=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const i=parseInt(t[1],10);return i!=i?-1:i}(arguments[0]),i=function(e){let i=65536;return"firefox"===t.browser&&(i=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),i}(e),r=function(e,i){let r=65536;"firefox"===t.browser&&57===t.version&&(r=65535);const a=n().matchPrefix(e.sdp,"a=max-message-size:");return a.length>0?r=parseInt(a[0].substr(19),10):"firefox"===t.browser&&-1!==i&&(r=2147483637),r}(arguments[0],e);let a;a=0===i&&0===r?Number.POSITIVE_INFINITY:0===i||0===r?Math.max(i,r):Math.min(i,r);const s={};Object.defineProperty(s,"maxMessageSize",{get:()=>a}),this._sctp=s}return i.apply(this,arguments)}}function c(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const i=e.send;e.send=function(){const r=arguments[0],n=r.length||r.size||r.byteLength;if("open"===e.readyState&&t.sctp&&n>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return i.apply(e,arguments)}}const i=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=i.apply(this,arguments);return t(e,this),e},a.wrapPeerConnectionEvent(e,"datachannel",(e=>(t(e.channel,e.target),e)))}function l(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((e=>{const i=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const i=new Event("connectionstatechange",e);t.dispatchEvent(i)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}}))}function d(e){if(!e.RTCPeerConnection)return;const t=a.detectBrowser(e);if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t.version>=605)return;const i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(e){return e&&e.sdp&&-1!==e.sdp.indexOf("\na=extmap-allow-mixed")&&(e.sdp=e.sdp.split("\n").filter((e=>"a=extmap-allow-mixed"!==e.trim())).join("\n")),i.apply(this,arguments)}}},637190:(e,t,i)=>{"use strict";i.r(t),i.d(t,{shimGetDisplayMedia:()=>c.shimGetDisplayMedia,shimGetUserMedia:()=>o.shimGetUserMedia,shimPeerConnection:()=>l,shimReplaceTrack:()=>d});var r=i(452634),n=i(920018),a=i(949058),s=i.n(a),o=i(558684),c=i(757959);function l(e){const t=r.detectBrowser(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){const t=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set(e){t.set.call(this,e);const i=new Event("enabled");i.enabled=e,this.dispatchEvent(i)}})}e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)&&Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);const i=s()(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=(0,n.filterIceServers)(e.iceServers,t.version),r.log("ICE servers after filtering:",e.iceServers)),new i(e)},e.RTCPeerConnection.prototype=i.prototype}function d(e){e.RTCRtpSender&&!("replaceTrack"in e.RTCRtpSender.prototype)&&(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)}},920018:(e,t,i)=>{"use strict";i.d(t,{filterIceServers:()=>n});var r=i(452634);function n(e,t){let i=!1;return(e=JSON.parse(JSON.stringify(e))).filter((e=>{if(e&&(e.urls||e.url)){let t=e.urls||e.url;e.url&&!e.urls&&r.deprecated("RTCIceServer.url","RTCIceServer.urls");const n="string"==typeof t;return n&&(t=[t]),t=t.filter((e=>{if(0===e.indexOf("stun:"))return!1;const t=e.startsWith("turn")&&!e.startsWith("turn:[")&&e.includes("transport=udp");return t&&!i?(i=!0,!0):t&&!i})),delete e.url,e.urls=n?t[0]:t,!!t.length}}))}},757959:(e,t,i)=>{"use strict";function r(e){"getDisplayMedia"in e.navigator&&e.navigator.mediaDevices&&(e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=e.navigator.getDisplayMedia.bind(e.navigator)))}i.d(t,{shimGetDisplayMedia:()=>r})},558684:(e,t,i)=>{"use strict";function r(e){const t=e&&e.navigator,i=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return i(e).catch((e=>Promise.reject(function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString(){return this.name}}}(e))))}}i.d(t,{shimGetUserMedia:()=>r})},186542:(e,t,i)=>{"use strict";i.r(t),i.d(t,{shimAddTransceiver:()=>h,shimCreateAnswer:()=>m,shimCreateOffer:()=>_,shimGetDisplayMedia:()=>a.shimGetDisplayMedia,shimGetParameters:()=>p,shimGetUserMedia:()=>n.shimGetUserMedia,shimOnTrack:()=>s,shimPeerConnection:()=>o,shimRTCDataChannel:()=>u,shimReceiverGetStats:()=>l,shimRemoveStream:()=>d,shimSenderGetStats:()=>c});var r=i(452634),n=i(105176),a=i(382187);function s(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function o(e){const t=r.detectBrowser(e);if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;if(!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],r={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=r[t]})),t.version<68){const t=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?arguments[0]&&""===arguments[0].candidate?Promise.resolve():t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}const i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,r,a]=arguments;return n.apply(this,[e||null]).then((e=>{if(t.version<53&&!r)try{e.forEach((e=>{e.type=i[e.type]||e.type}))}catch(t){if("TypeError"!==t.name)throw t;e.forEach(((t,r)=>{e.set(r,Object.assign({},t,{type:i[t.type]||t.type}))}))}return e})).then(r,a)}}function c(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function l(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),r.wrapPeerConnectionEvent(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function d(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){r.deprecated("removeStream","removeTrack"),this.getSenders().forEach((t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)}))})}function u(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function h(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];const e=arguments[1],i=e&&"sendEncodings"in e;i&&e.sendEncodings.forEach((e=>{if("rid"in e){if(!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const r=t.apply(this,arguments);if(i){const{sender:t}=r,i=t.getParameters();(!("encodings"in i)||1===i.encodings.length&&0===Object.keys(i.encodings[0]).length)&&(i.encodings=e.sendEncodings,t.sendEncodings=e.sendEncodings,this.setParametersPromises.push(t.setParameters(i).then((()=>{delete t.sendEncodings})).catch((()=>{delete t.sendEncodings}))))}return r})}function p(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function _(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function m(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}},382187:(e,t,i)=>{"use strict";function r(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===i.video?i.video={mediaSource:t}:i.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(i)})}i.d(t,{shimGetDisplayMedia:()=>r})},105176:(e,t,i)=>{"use strict";i.d(t,{shimGetUserMedia:()=>n});var r=i(452634);function n(e){const t=r.detectBrowser(e),i=e&&e.navigator,n=e&&e.MediaStreamTrack;if(i.getUserMedia=function(e,t,n){r.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(e).then(t,n)},!(t.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){const e=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])},t=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(i){return"object"==typeof i&&"object"==typeof i.audio&&(i=JSON.parse(JSON.stringify(i)),e(i.audio,"autoGainControl","mozAutoGainControl"),e(i.audio,"noiseSuppression","mozNoiseSuppression")),t(i)},n&&n.prototype.getSettings){const t=n.prototype.getSettings;n.prototype.getSettings=function(){const i=t.apply(this,arguments);return e(i,"mozAutoGainControl","autoGainControl"),e(i,"mozNoiseSuppression","noiseSuppression"),i}}if(n&&n.prototype.applyConstraints){const t=n.prototype.applyConstraints;n.prototype.applyConstraints=function(i){return"audio"===this.kind&&"object"==typeof i&&(i=JSON.parse(JSON.stringify(i)),e(i,"autoGainControl","mozAutoGainControl"),e(i,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[i])}}}}},42824:(e,t,i)=>{"use strict";i.r(t),i.d(t,{shimAudioContext:()=>h,shimCallbacksAPI:()=>s,shimConstraints:()=>c,shimCreateOfferLegacy:()=>u,shimGetUserMedia:()=>o,shimLocalStreamsAPI:()=>n,shimRTCIceServerUrls:()=>l,shimRemoteStreamsAPI:()=>a,shimTrackEventTransceiver:()=>d});var r=i(452634);function n(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach((i=>t.call(this,i,e))),e.getVideoTracks().forEach((i=>t.call(this,i,e)))},e.RTCPeerConnection.prototype.addTrack=function(e,...i){return i&&i.forEach((e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]})),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const i=e.getTracks();this.getSenders().forEach((e=>{i.includes(e.track)&&this.removeTrack(e)}))})}}function a(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach((e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)}))})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const i=new Event("addstream");i.stream=t,e.dispatchEvent(i)}))}),t.apply(e,arguments)}}}function s(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,i=t.createOffer,r=t.createAnswer,n=t.setLocalDescription,a=t.setRemoteDescription,s=t.addIceCandidate;t.createOffer=function(e,t){const r=arguments.length>=2?arguments[2]:arguments[0],n=i.apply(this,[r]);return t?(n.then(e,t),Promise.resolve()):n},t.createAnswer=function(e,t){const i=arguments.length>=2?arguments[2]:arguments[0],n=r.apply(this,[i]);return t?(n.then(e,t),Promise.resolve()):n};let o=function(e,t,i){const r=n.apply(this,[e]);return i?(r.then(t,i),Promise.resolve()):r};t.setLocalDescription=o,o=function(e,t,i){const r=a.apply(this,[e]);return i?(r.then(t,i),Promise.resolve()):r},t.setRemoteDescription=o,o=function(e,t,i){const r=s.apply(this,[e]);return i?(r.then(t,i),Promise.resolve()):r},t.addIceCandidate=o}function o(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,i=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>i(c(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,i,r){t.mediaDevices.getUserMedia(e).then(i,r)}.bind(t))}function c(e){return e&&void 0!==e.video?Object.assign({},e,{video:r.compactObject(e.video)}):e}function l(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,i){if(e&&e.iceServers){const t=[];for(let i=0;i<e.iceServers.length;i++){let n=e.iceServers[i];!n.hasOwnProperty("urls")&&n.hasOwnProperty("url")?(r.deprecated("RTCIceServer.url","RTCIceServer.urls"),n=JSON.parse(JSON.stringify(n)),n.urls=n.url,delete n.url,t.push(n)):t.push(e.iceServers[i])}e.iceServers=t}return new t(e,i)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function d(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function u(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find((e=>"audio"===e.receiver.track.kind));!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const i=this.getTransceivers().find((e=>"video"===e.receiver.track.kind));!1===e.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==e.offerToReceiveVideo||i||this.addTransceiver("video")}return t.apply(this,arguments)}}function h(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}},452634:(e,t,i)=>{"use strict";i.d(t,{compactObject:()=>p,deprecated:()=>d,detectBrowser:()=>u,disableLog:()=>o,disableWarnings:()=>c,extractVersion:()=>a,filterStats:()=>m,log:()=>l,wrapPeerConnectionEvent:()=>s});let r=!0,n=!0;function a(e,t,i){const r=e.match(t);return r&&r.length>=i&&parseInt(r[i],10)}function s(e,t,i){if(!e.RTCPeerConnection)return;const r=e.RTCPeerConnection.prototype,n=r.addEventListener;r.addEventListener=function(e,r){if(e!==t)return n.apply(this,arguments);const a=e=>{const t=i(e);t&&(r.handleEvent?r.handleEvent(t):r(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(r,a),n.apply(this,[e,a])};const a=r.removeEventListener;r.removeEventListener=function(e,i){if(e!==t||!this._eventMap||!this._eventMap[t])return a.apply(this,arguments);if(!this._eventMap[t].has(i))return a.apply(this,arguments);const r=this._eventMap[t].get(i);return this._eventMap[t].delete(i),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,a.apply(this,[e,r])},Object.defineProperty(r,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function o(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(r=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function c(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(n=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function l(){if("object"==typeof window){if(r)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function d(e,t){n&&console.warn(e+" is deprecated, please use "+t+" instead.")}function u(e){const t={browser:null,version:null};if(void 0===e||!e.navigator)return t.browser="Not a browser.",t;const{navigator:i}=e;if(i.mozGetUserMedia)t.browser="firefox",t.version=a(i.userAgent,/Firefox\/(\d+)\./,1);else if(i.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)t.browser="chrome",t.version=a(i.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(i.mediaDevices&&i.userAgent.match(/Edge\/(\d+).(\d+)$/))t.browser="edge",t.version=a(i.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!i.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=a(i.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t}function h(e){return"[object Object]"===Object.prototype.toString.call(e)}function p(e){return h(e)?Object.keys(e).reduce((function(t,i){const r=h(e[i]),n=r?p(e[i]):e[i],a=r&&!Object.keys(n).length;return void 0===n||a?t:Object.assign(t,{[i]:n})}),{}):e}function _(e,t,i){t&&!i.has(t.id)&&(i.set(t.id,t),Object.keys(t).forEach((r=>{r.endsWith("Id")?_(e,e.get(t[r]),i):r.endsWith("Ids")&&t[r].forEach((t=>{_(e,e.get(t),i)}))})))}function m(e,t,i){const r=i?"outbound-rtp":"inbound-rtp",n=new Map;if(null===t)return n;const a=[];return e.forEach((e=>{"track"===e.type&&e.trackIdentifier===t.id&&a.push(e)})),a.forEach((t=>{e.forEach((i=>{i.type===r&&i.trackId===t.id&&_(e,i,n)}))})),n}}}]);try{stManager?.done("dist/web/chunks/1d7e5880.4fde8f61.js")}catch(e){}